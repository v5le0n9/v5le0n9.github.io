<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon16.ico">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":{"gitalk":{"order":-2}},"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="1. 课前预习 熟悉OD字符串插件的使用右键或插件-&gt;中文搜索引擎-&gt;智能搜索，Ctrl+F搜索字符串。  熟悉OD如何下断点Ctrl+G，直接搜索API下断Ctrl+N，输入表搜索API-&gt;右键-&gt;在每个参考上设置断点利用插件，ApiBreak和API断点设置工具都可以">
<meta property="og:type" content="article">
<meta property="og:title" content="第五六课——解除程序重启验证，程序打补丁">
<meta property="og:url" content="http://example.com/posts/bb44dc0.html">
<meta property="og:site_name" content="v5le0n9&#39;s garden">
<meta property="og:description" content="1. 课前预习 熟悉OD字符串插件的使用右键或插件-&gt;中文搜索引擎-&gt;智能搜索，Ctrl+F搜索字符串。  熟悉OD如何下断点Ctrl+G，直接搜索API下断Ctrl+N，输入表搜索API-&gt;右键-&gt;在每个参考上设置断点利用插件，ApiBreak和API断点设置工具都可以">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E7%A4%BA%E4%BE%8B.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E6%B3%A8%E5%86%8C%E8%A1%A8.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E6%90%9C%E7%B4%A2%E5%AD%97%E7%AC%A6%E4%B8%B2.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/nop.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E6%B3%A8%E5%86%8C%E7%A0%81.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E5%BD%A9%E8%9B%8B.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E7%BC%96%E7%A0%81%E8%BD%AC%E6%8D%A2.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E5%BD%A9%E8%9B%8B3.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9A.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E6%90%9C%E7%B4%A2%E5%AD%97%E7%AC%A6%E4%B8%B22.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/txt%E6%96%87%E4%BB%B6.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/-.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E5%BD%A9%E8%9B%8B2.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E6%88%91%E6%98%AF%E5%BD%A9%E8%9B%8B.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E6%90%9C%E7%B4%A2%E5%AD%97%E7%AC%A6%E4%B8%B22.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E6%B3%A8%E5%86%8C%E5%A4%B1%E8%B4%A5.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E8%A1%A5%E4%B8%81.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E8%A1%A5%E4%B8%81%E6%88%90%E5%8A%9F.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E6%B3%A8%E5%86%8C%E6%9C%BA.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E6%B3%A8%E5%86%8C%E7%A0%812.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E6%97%A0%E6%B3%95%E5%AE%9A%E4%BD%8D%E6%95%B0%E6%8D%AE.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E8%BF%9E%E6%8E%A5%E5%AD%97%E7%AC%A6%E4%B8%B2.png">
<meta property="og:image" content="http://example.com/posts/bb44dc0/%E7%94%9F%E6%88%90%E6%B3%A8%E5%86%8C%E7%A0%81.png">
<meta property="article:published_time" content="2022-04-05T01:29:28.122Z">
<meta property="article:modified_time" content="2022-04-11T05:26:08.364Z">
<meta property="article:author" content="v5le0n9">
<meta property="article:tag" content="OllyDbg">
<meta property="article:tag" content="吾爱破解培训">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/posts/bb44dc0/%E7%A4%BA%E4%BE%8B.png">

<link rel="canonical" href="http://example.com/posts/bb44dc0.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>第五六课——解除程序重启验证，程序打补丁 | v5le0n9's garden</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="v5le0n9's garden" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">v5le0n9's garden</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">小凉的秘密基地</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/v5le0n9" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/posts/bb44dc0.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="v5le0n9">
      <meta itemprop="description" content="小呀小二郎呀背着个书包上学堂">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="v5le0n9's garden">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          第五六课——解除程序重启验证，程序打补丁
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-05 09:29:28" itemprop="dateCreated datePublished" datetime="2022-04-05T09:29:28+08:00">2022-04-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-11 13:26:08" itemprop="dateModified" datetime="2022-04-11T13:26:08+08:00">2022-04-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Windows%E9%80%86%E5%90%91/" itemprop="url" rel="index"><span itemprop="name">Windows逆向</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>18k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>17 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="1-课前预习"><a href="#1-课前预习" class="headerlink" title="1. 课前预习"></a>1. 课前预习</h1><ul>
<li><p>熟悉OD字符串插件的使用<br>右键或插件-&gt;中文搜索引擎-&gt;智能搜索，Ctrl+F搜索字符串。</p>
</li>
<li><p>熟悉OD如何下断点<br>Ctrl+G，直接搜索API下断<br>Ctrl+N，输入表搜索API-&gt;右键-&gt;在每个参考上设置断点<br>利用插件，ApiBreak和API断点设置工具都可以</p>
</li>
</ul>
<span id="more"></span>
<ul>
<li><p>熟悉procmon的使用<br>可以监控文件，注册表，网络，进线程信息<br>排除进程:Exclude<br>查看指定进程:Include</p>
</li>
<li><p>熟悉文件操作API的使用<br>CreateFileA(W):创建文件<br>ReadFile:读取文件<br>WriteFile:写入文件<br>CloseHandle:关闭句柄<br>读取文件:CreateFile-&gt;ReadFile-&gt;CloseHandle<br>写入文件:CreateFile-&gt;WriteFile-&gt;CloseHandle</p>
</li>
<li><p>熟悉注册表操作API的使用<br>创建注册表Key:RegCreateKey<br>打开注册表Key:RegOpenKey<br>查询注册表键值:RegQueryValueExA<br>写入注册表键值:RegSetValueEx</p>
</li>
</ul>
<h1 id="2-重启验证"><a href="#2-重启验证" class="headerlink" title="2. 重启验证"></a>2. 重启验证</h1><p>什么是重启验证</p>
<ul>
<li>重启验证顾名思义就是在程序启动时验证注册信息。 </li>
</ul>
<p>执行流程</p>
<ul>
<li><p>基本的执行流程：注册信息输入—&gt;程序重启—&gt;执行验证机制—&gt;正常执行</p>
</li>
<li><p>扩展的执行流程：注册信息输入—&gt;执行部分验证机制/执行假验证机制—&gt;程序重启—&gt;执行真验证机制—&gt;正常执行</p>
</li>
<li>对于有经验的作者来说，可以在注册信息输入和程序重启之间加入假的验证机制，假的验证机制一般比较简单，比如说只是当单纯的明码比较，当我们输入假的注册码，程序一般会提示注册成功，此时程序就会知道我们是逆向者，在程序重启时就会假装注册成功，在执行程序功能时就会报错或是无反应，这就是所谓的暗桩。</li>
</ul>
<p>重启验证的类型</p>
<ul>
<li>重启验证根据写入信息位置的不同一般分两类，一类是将注册信息写入文件中，一类是将注册信息写入注册表中。</li>
</ul>
<p>定位关键代码</p>
<ol>
<li>字符串定位<br>通过OD字符串插件扫描敏感字符串，一般出现的文件路径或是注册表路径都可能是验证信息的保存位置</li>
<li>监控工具定位<br>通过procmon等监控工具监控注册信息的写入位置</li>
<li>API定位<br>通过定位CreateFile，RegCreateKey，GetPrivateProfileStringA等API来获取注册信息的写入位置</li>
</ol>
<h1 id="3-重启验证示例"><a href="#3-重启验证示例" class="headerlink" title="3. 重启验证示例"></a>3. 重启验证示例</h1><p>运行一下程序查看它的操作机制。</p>
<img src="/posts/bb44dc0/%E7%A4%BA%E4%BE%8B.png" class="" title="示例">
<p>输入任意字符串，点击重启验证1，出现弹窗，在程序的本目录下生成一个.txt文件，程序退出。里面是我们输入的字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">888888888</span><br></pre></td></tr></table></figure>
<p>再次，点击重启验证2，出现弹窗，在程序的本目录下生成一个.ini文件，程序退出。里面是我们输入的字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[验证]</span><br><span class="line">Key=888888888</span><br></pre></td></tr></table></figure>
<p>再次，点击重启验证3，出现弹窗，在本机注册表里写入信息，程序退出。徽标键+R打开运行窗口，输入<code>regedit</code>打开注册表，在下图看到输入的字符串。</p>
<img src="/posts/bb44dc0/%E6%B3%A8%E5%86%8C%E8%A1%A8.png" class="" title="注册表">
<p>将所有生成的文件和注册表信息删除，载入OD，搜索敏感字符串。</p>
<img src="/posts/bb44dc0/%E6%90%9C%E7%B4%A2%E5%AD%97%E7%AC%A6%E4%B8%B2.png" class="" title="搜索字符串">
<p>首先看重启验证1，双击进入反汇编代码，找到函数开头下断。运行，输入假码，选择重启验证1，OD停在断点处。F8往下走走，遇到call先用enter探探路再考虑是否跟进去。这个call里面有很多API函数，程序经过这条指令后，eax变成我们输入的字符串，所以这个函数是取出输入框里的字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0040275B  |.  E8 C8590100   call 52PoJie?00418128;eax=888888888</span><br><span class="line">00402760  |.  8B45 EC             mov eax,[local.5]</span><br><span class="line">00402763  |.  8378 F4 00          cmp dword ptr ds:[eax-0xC],0x0;判断字符串是否为空</span><br><span class="line">00402767  |.  74 74               je short 52PoJie?004027DD</span><br></pre></td></tr></table></figure>
<p>继续F8，到<code>CreateFileA</code>函数，创建一个52Pojie.txt文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">00402769  |.  6A 00               push 0x0                                     ; /hTemplateFile = NULL</span><br><span class="line">0040276B  |.  6A 00               push 0x0                                     ; |Attributes = 0</span><br><span class="line">0040276D  |.  6A 02               push 0x2                                     ; |Mode = CREATE_ALWAYS</span><br><span class="line">0040276F  |.  6A 00               push 0x0                                     ; |pSecurity = NULL</span><br><span class="line">00402771  |.  6A 01               push 0x1                                     ; |ShareMode = FILE_SHARE_READ</span><br><span class="line">00402773  |.  68 00000040         push 0x40000000                              ; |Access = GENERIC_WRITE</span><br><span class="line">00402778  |.  FFB6 BC000000       push dword ptr ds:[esi+0xBC]                 ; |FileName = &quot;C:\Documents and Settings\Administrator\桌面\吾爱破解培训第五课例子\52Pojie.txt&quot;</span><br><span class="line">0040277E  |.  FF15 10345400       call dword ptr ds:[&lt;&amp;KERNEL32.CreateFileA&gt;]  ; \CreateFileA</span><br></pre></td></tr></table></figure>
<p>F8到<code>WriteFileA</code>函数，将我们输入的字符串写入52Pojie.txt文件中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">004027AD  |&gt; \6A 00               push 0x0                                     ; /pOverlapped = NULL</span><br><span class="line">004027AF  |.  8D45 E8             lea eax,[local.6]                            ; |</span><br><span class="line">004027B2  |.  50                  push eax                                     ; |pBytesWritten = 00000009</span><br><span class="line">004027B3  |.  57                  push edi                                     ; |nBytesToWrite = 0x9</span><br><span class="line">004027B4  |.  51                  push ecx                                     ; |Buffer = 00161100</span><br><span class="line">004027B5  |.  56                  push esi                                     ; |hFile = 000000D4 (window)</span><br><span class="line">004027B6  |.  FF15 2C345400       call dword ptr ds:[&lt;&amp;KERNEL32.WriteFile&gt;]    ; \WriteFile</span><br></pre></td></tr></table></figure>
<p>继续F8，<code>004027C9</code>执行弹窗，退出，关闭句柄。再之后就退出程序了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">004027C0  |.  6A 00               push 0x0</span><br><span class="line">004027C2  |.  6A 00               push 0x0</span><br><span class="line">004027C4  |.  68 60465400         push 52PoJie?00544660                        ;  你选择的验证类型是重启验证1</span><br><span class="line">004027C9  |.  E8 B17F0000         call 52PoJie?0040A77F</span><br><span class="line">004027CE  |.  6A 00               push 0x0                                     ; /ExitCode = 0x0</span><br><span class="line">004027D0  |.  FF15 40385400       call dword ptr ds:[&lt;&amp;USER32.PostQuitMessage&gt;&gt;; \PostQuitMessage</span><br><span class="line">004027D6  |&gt;  56                  push esi                                     ; /hObject = 000000D4 (window)</span><br><span class="line">004027D7  |.  FF15 24345400       call dword ptr ds:[&lt;&amp;KERNEL32.CloseHandle&gt;]  ; \CloseHandle</span><br></pre></td></tr></table></figure>
<p>因为它是重启验证，所以在这个函数中找不到验证算法。而是在主程序出来前就已经运行验证算法了。再次打开程序时，程序会在相应的.txt，.ini或注册表里找注册码进行验证。</p>
<p>重载，找敏感字符串有关“52Pojie.txt”的双击进去反汇编代码，在函数开头下断。F9运行至断点处，F8路过这个函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00402AE2  |.  50            push eax                                 ; /Buffer = 00174B68</span><br><span class="line">00402AE3  |.  68 04010000   push 0x104                               ; |BufSize = 104 (260.)</span><br><span class="line">00402AE8  |.  FF15 14345400 call dword ptr ds:[&lt;&amp;KERNEL32.GetCurrent&gt;; \GetCurrentDirectoryA 获取当前目录</span><br></pre></td></tr></table></figure>
<p>继续F8，发现这个跳转跳过了“验证通过”。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">00402BC0  |.  E8 1BF4FFFF   call 52PoJie?00401FE0</span><br><span class="line">00402BC5  |.  85C0          test eax,eax</span><br><span class="line">00402BC7  |. /74 15         je short 52PoJie?00402BDE</span><br><span class="line">00402BC9  |. |8B8D DCFEFFFF mov ecx,[local.73]</span><br><span class="line">00402BCF  |. |68 18465400   push 52PoJie?00544618                    ;  验证通过</span><br><span class="line">00402BD4  |. |E8 E7980100   call 52PoJie?0041C4C0</span><br><span class="line">00402BD9  |. |BB 01000000   mov ebx,0x1</span><br><span class="line">00402BDE  |&gt; \8B85 E0FEFFFF mov eax,[local.72]</span><br></pre></td></tr></table></figure>
<p>如果是爆破的话，直接将跳转指令nop掉。保存，运行一下，成功。</p>
<img src="/posts/bb44dc0/nop.png" class="" title="验证1通过">
<p>如果想逆向分析，跟进去第1行的call指令，那个就是算法函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">00401FF7  |.  56            push esi                                 ; /hTemplateFile = 00174B68</span><br><span class="line">00401FF8  |.  56            push esi                                 ; |Attributes = ARCHIVE|TEMPORARY|COMPRESSED|174248</span><br><span class="line">00401FF9  |.  6A 03         push 0x3                                 ; |Mode = OPEN_EXISTING</span><br><span class="line">00401FFB  |.  56            push esi                                 ; |pSecurity = 00174B68</span><br><span class="line">00401FFC  |.  6A 01         push 0x1                                 ; |ShareMode = FILE_SHARE_READ</span><br><span class="line">00401FFE  |.  6A 01         push 0x1                                 ; |Access = 1</span><br><span class="line">00402000  |.  FFB1 BC000000 push dword ptr ds:[ecx+0xBC]             ; |FileName = &quot;C:\Documents and Settings\Administrator\桌面\吾爱破解培训第五课例子\52Pojie.txt&quot;</span><br><span class="line">00402006  |.  FF15 10345400 call dword ptr ds:[&lt;&amp;KERNEL32.CreateFile&gt;; \CreateFileA 创建或打开文件，这里是打开文件</span><br></pre></td></tr></table></figure>
<p>ReadFile函数，当程序运行到<code>00402046</code>时，Buffer指针指向文件内容首地址<code>0012F348</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00402039  |.  56            push esi                                 ; /pOverlapped = NULL</span><br><span class="line">0040203A  |.  50            push eax                                 ; |pBytesRead = 0012F348</span><br><span class="line">0040203B  |.  68 04010000   push 0x104                               ; |BytesToRead = 104 (260.)</span><br><span class="line">00402040  |.  8D85 F4FEFFFF lea eax,[local.67]                       ; |</span><br><span class="line">00402046  |.  50            push eax                                 ; |Buffer = 0012F348</span><br><span class="line">00402047  |.  57            push edi                                 ; |hFile = 000000AC (window)</span><br><span class="line">00402048  |.  FF15 28345400 call dword ptr ds:[&lt;&amp;KERNEL32.ReadFile&gt;] ; \ReadFile 读文件内容</span><br></pre></td></tr></table></figure>
<p>在信息窗口选中右键-&gt;数据窗口跟随，发现全是空数据，执行完这个函数时，<code>0012F348</code>出现我们输入的字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">00402048  |.  FF15 28345400 call dword ptr ds:[&lt;&amp;KERNEL32.ReadFile&gt;] ; \ReadFile</span><br><span class="line">0040204E  |.  85C0          test eax,eax;返回值为1，表明文件不为空</span><br><span class="line">00402050  |.  74 3D         je short 52PoJie?0040208F</span><br><span class="line">00402052  |.  B9 24465400   mov ecx,52PoJie?00544624                 ;  JXU2MjExJXU2</span><br><span class="line">00402057  |.  8D85 F4FEFFFF lea eax,[local.67]</span><br><span class="line">0040205D  |.  8D49 00       lea ecx,dword ptr ds:[ecx]</span><br><span class="line">00402060  |&gt;  8A10          /mov dl,byte ptr ds:[eax];这个循环执行的是strcmp函数，比较eax和ecx是否相等。执行到这一句时，eax是我们输入的字符串，ecx是上面的注释JXU2MjExJXU2</span><br><span class="line">00402062  |.  3A11          |cmp dl,byte ptr ds:[ecx]</span><br><span class="line">00402064  |.  75 1A         |jnz short 52PoJie?00402080</span><br><span class="line">00402066  |.  84D2          |test dl,dl</span><br><span class="line">00402068  |.  74 12         |je short 52PoJie?0040207C</span><br><span class="line">0040206A  |.  8A50 01       |mov dl,byte ptr ds:[eax+0x1]</span><br><span class="line">0040206D  |.  3A51 01       |cmp dl,byte ptr ds:[ecx+0x1]</span><br><span class="line">00402070  |.  75 0E         |jnz short 52PoJie?00402080</span><br><span class="line">00402072  |.  83C0 02       |add eax,0x2</span><br><span class="line">00402075  |.  83C1 02       |add ecx,0x2</span><br><span class="line">00402078  |.  84D2          |test dl,dl</span><br><span class="line">0040207A  |.^ 75 E4         \jnz short 52PoJie?00402060</span><br><span class="line">0040207C  |&gt;  33C0          xor eax,eax</span><br></pre></td></tr></table></figure>
<p>所以很容易就知道重启验证1的注册码是<code>JXU2MjExJXU2</code>。将生成的.txt文件内容改为这个，再打开原程序发现验证通过。</p>
<p>验证2、3一样操作，但需要注意，一定要先生成一个配置文件或写入注册表再进行重启验证调试。验证1生成的.txt文件不影响验证2和验证3的调试，可以不删除。</p>
<p>验证2：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">00402C34  |.  E8 77F4FFFF   call 52PoJie?004020B0</span><br><span class="line">00402C39  |.  85C0          test eax,eax</span><br><span class="line">00402C3B  |.  74 11         je short 52PoJie?00402C4E</span><br><span class="line">00402C3D  |.  68 18465400   push 52PoJie?00544618                    ;  验证通过</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0040210C  |.  B9 40465400   mov ecx,52PoJie?00544640                 ;  NjJGJXU3NTI</span><br></pre></td></tr></table></figure>
<p>验证3：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">00402CB2  |.  E8 B9F4FFFF   call 52PoJie?00402170</span><br><span class="line">00402CB7  |.  85C0          test eax,eax</span><br><span class="line">00402CB9  |.  74 37         je short 52PoJie?00402CF2</span><br><span class="line">00402CBB  |.  68 18465400   push 52PoJie?00544618                    ;  验证通过</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">004021FE  |.  B9 54465400   mov ecx,52PoJie?00544654                 ;  4JXU2MjM3</span><br></pre></td></tr></table></figure>
<p>细心一点就会在字符串列表发现这三个注册码</p>
<img src="/posts/bb44dc0/%E6%B3%A8%E5%86%8C%E7%A0%81.png" class="" title="注册码">
<p>最后，重启验证的普通思路</p>
<ol>
<li><p>如果是写进.txt文件，一般都是这个步骤：</p>
<p>CreateFileA-&gt;WriteFile-&gt;ReadFile-&gt;比较算法</p>
</li>
<li><p>如果是写进.ini文件，一般都是这个步骤：</p>
<p>WritePrivateProfileStringA(写入配置信息)-&gt;GetPrivateProfileStringA(读取配置信息)</p>
</li>
<li><p>如果是写进注册表，一般都是这个步骤：</p>
<p>创建注册表Key:RegCreateKey-&gt;打开注册表Key:RegOpenKey-&gt;写入注册表键值:RegSetValueEx-&gt;查询注册表键值:RegQueryValue(Ex)</p>
</li>
</ol>
<p>三个都通过后，会出现一个彩蛋，输入字符串后，弹出消息框。</p>
<img src="/posts/bb44dc0/%E5%BD%A9%E8%9B%8B.png" class="" title="彩蛋">
<p>输入不同字符串弹窗显示不同的内容。彩蛋很简单，其实就是把三个验证码拼接，Base64解码，UTF-8转换，得到“我是用户”。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JXU2MjExJXU2NjJGJXU3NTI4JXU2MjM3</span><br><span class="line"></span><br><span class="line">Base64解码：</span><br><span class="line">%u6211%u662F%u7528%u6237</span><br><span class="line"></span><br><span class="line">Unicode转换：</span><br><span class="line">我是用户</span><br></pre></td></tr></table></figure>
<img src="/posts/bb44dc0/%E7%BC%96%E7%A0%81%E8%BD%AC%E6%8D%A2.png" class="" title="编码转换">
<p>把三个验证码拼接，弹窗。</p>
<img src="/posts/bb44dc0/%E5%BD%A9%E8%9B%8B3.png" class="" title="彩蛋">
<h1 id="4-重启验证作业"><a href="#4-重启验证作业" class="headerlink" title="4. 重启验证作业"></a>4. 重启验证作业</h1><p>输入假码没什么反应。</p>
<img src="/posts/bb44dc0/%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9A.png" class="" title="课后作业">
<p>拉去OD看看，搜索字符串，发现只有一个验证码<code>ITN3UXJGJ</code>显示。</p>
<img src="/posts/bb44dc0/%E6%90%9C%E7%B4%A2%E5%AD%97%E7%AC%A6%E4%B8%B22.png" class="" title="搜索字符串">
<p>双击进去发现有<code>CreateFile</code>和<code>ReadFile</code>，所以判定这个是写入<code>.txt</code>文件的注册码。</p>
<img src="/posts/bb44dc0/txt%E6%96%87%E4%BB%B6.png" class="" title="txt文件">
<p>用<code>GetPrivateProfileStringA</code>函数找到<code>.ini</code>文件的比较注册码算法。Ctrl+N，搜索<code>GetPrivateProfileStringA</code>右键-&gt;在每个参考上设置断点。或者在反汇编窗口右键-&gt;查找-&gt;所有模块间的调用，搜索函数，右键-&gt;在每个调用到<code>GetPrivateProfileStringA</code>上设置断点。一个一个断点点进去看，找到一个最像比较算法的(有循环、比较、跳转指令)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">0040218F  |.  66:C785 F0FEF&gt;mov word ptr ss:[ebp-0x110],0x1A28       ; |</span><br><span class="line">00402198  |.  FF15 1C345400 call dword ptr ds:[&lt;&amp;KERNEL32.GetPrivate&gt;; \GetPrivateProfileStringA</span><br><span class="line">0040219E  |.  5E            pop esi                                  ;  kernel32.7C817077</span><br><span class="line">0040219F  |.  85C0          test eax,eax</span><br><span class="line">004021A1  |.  74 4D         je short 吾爱破解.004021F0</span><br><span class="line">004021A3  |.  8D8D F4FEFFFF lea ecx,[local.67]</span><br><span class="line">004021A9  |.  8D51 01       lea edx,dword ptr ds:[ecx+0x1]</span><br><span class="line">004021AC  |.  8D6424 00     lea esp,dword ptr ss:[esp]</span><br><span class="line">004021B0  |&gt;  8A01          /mov al,byte ptr ds:[ecx]    </span><br><span class="line">004021B2  |.  41            |inc ecx                       </span><br><span class="line">004021B3  |.  84C0          |test al,al</span><br><span class="line">004021B5  |.^ 75 F9         \jnz short 吾爱破解.004021B0</span><br><span class="line">004021B7  |.  2BCA          sub ecx,edx                              ;  ntdll.KiFastSystemCallRet</span><br><span class="line">004021B9  |.  83F9 0E       cmp ecx,0xE                   </span><br><span class="line">004021BC  |.  75 32         jnz short 吾爱破解.004021F0</span><br><span class="line">004021BE  |.  33C0          xor eax,eax                   </span><br><span class="line">004021C0  |&gt;  0FB69405 E4FE&gt;/movzx edx,byte ptr ss:[ebp+eax-0x11C]</span><br><span class="line">004021C8  |.  0FBE8C05 F4FE&gt;|movsx ecx,byte ptr ss:[ebp+eax-0x10C]</span><br><span class="line">004021D0  |.  83C2 30       |add edx,0x30                 </span><br><span class="line">004021D3  |.  3BD1          |cmp edx,ecx                   </span><br><span class="line">004021D5  |.  75 19         |jnz short 吾爱破解.004021F0</span><br><span class="line">004021D7  |.  40            |inc eax</span><br><span class="line">004021D8  |.  83F8 0E       |cmp eax,0xE</span><br><span class="line">004021DB  |.^ 72 E3         \jb short 吾爱破解.004021C0</span><br></pre></td></tr></table></figure>
<p>由于这个断点程序没有被经过，很难分析它的算法(我目前能力有限)。要想经过这段算法，就要看一下我们输入字符串后，程序怎么运行的。反汇编窗口右键-&gt;查找-&gt;所有模块间的调用，搜索<code>GetWindowTextA</code>，在每个调用到<code>GetWindowTextA</code>上设置断点。输入字符串后运行，程序停在某断点处。养成好习惯，把其它的<code>GetWindowTextA</code>断点取消。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0041837E  |.  FF15 2C365400 call dword ptr ds:[&lt;&amp;USER32.GetWindowTex&gt;; \GetWindowTextA</span><br><span class="line">00418384  |.  8B4D 08       mov ecx,[arg.1]</span><br><span class="line">00418387  |.  6A FF         push -0x1</span><br><span class="line">00418389  |.  E8 AEFEFEFF   call 吾爱破解.0040823C</span><br><span class="line">0041838E  |.  5E            pop esi                                  ;  00940796</span><br><span class="line">0041838F  |.  5D            pop ebp                                  ;  00940796</span><br><span class="line">00418390  |.  C2 0400       retn 0x4</span><br></pre></td></tr></table></figure>
<p>返回上一级函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">004029D3  |.  E8 7F590100   call 吾爱破解.00418357                       ;  GetWindowTextA函数所在</span><br><span class="line">004029D8  |.  8B4D EC       mov ecx,[local.5]                        ;  字符串存进ecx</span><br><span class="line">004029DB  |.  8B79 F4       mov edi,dword ptr ds:[ecx-0xC]           ;  字符串长度存进edi</span><br><span class="line">004029DE  |.  85FF          test edi,edi</span><br><span class="line">004029E0  |.  74 1A         je short 吾爱破解.004029FC                   ;  字符串长度为0跳转</span><br><span class="line">004029E2  |.  33D2          xor edx,edx                              ;  edx清零</span><br><span class="line">004029E4  |.  85FF          test edi,edi</span><br><span class="line">004029E6  |.  7E 14         jle short 吾爱破解.004029FC                  ;  字符串长度小于等于0跳转</span><br><span class="line">004029E8  |&gt;  85D2          /test edx,edx</span><br><span class="line">004029EA  |.  78 36         |js short 吾爱破解.00402A22                  ;  结果为负跳转</span><br><span class="line">004029EC  |.  3BD7          |cmp edx,edi</span><br><span class="line">004029EE  |.  7F 32         |jg short 吾爱破解.00402A22                  ;  大于跳转</span><br><span class="line">004029F0  |.  803C0A 2D     |cmp byte ptr ds:[edx+ecx],0x2D          ;  判断字符是否是“-”</span><br><span class="line">004029F4  |.  75 01         |jnz short 吾爱破解.004029F7                 ;  不是指向下一个字符</span><br><span class="line">004029F6  |.  46            |inc esi                                 ;  是就+1</span><br><span class="line">004029F7  |&gt;  42            |inc edx</span><br><span class="line">004029F8  |.  3BD7          |cmp edx,edi</span><br><span class="line">004029FA  |.^ 7C EC         \jl short 吾爱破解.004029E8                  ;  遍历完字符串退出循环</span><br><span class="line">004029FC  |&gt;  C1E6 04       shl esi,0x4</span><br><span class="line">004029FF  |.  83EE 02       sub esi,0x2</span><br><span class="line">00402A02  |.  B8 CDCCCCCC   mov eax,0xCCCCCCCD</span><br><span class="line">00402A07  |.  F7E6          mul esi</span><br><span class="line">			;	执行完这条指令后edx的值被覆盖，所以下面的0x18不能看作是字符串长度，字符串长度存储在edi里</span><br><span class="line">00402A09  |.  C1EA 03       shr edx,0x3                              ;  根据edx右移3位后要等于3，所以3左移3位等于0x18</span><br><span class="line">00402A0C  |.  BE FFFFFFFF   mov esi,-0x1                  </span><br><span class="line">00402A11  |.  83EA 03       sub edx,0x3                              ;  根据下面跳转判断edx=3</span><br><span class="line">00402A14  |.  0F85 C8020000 jnz 吾爱破解.00402CE2                        ;  不为0跳转，这里跳转绕过注册成功</span><br><span class="line">00402A1A  |.  85FF          test edi,edi</span><br><span class="line">00402A1C  |.  7F 0E         jg short 吾爱破解.00402A2C</span><br><span class="line">00402A1E  |.  0BF6          or esi,esi</span><br><span class="line">00402A20  |.  EB 23         jmp short 吾爱破解.00402A45</span><br><span class="line">00402A22  |&gt;  68 57000780   push 0x80070057</span><br><span class="line">00402A27  |.  E8 C4E9FFFF   call 吾爱破解.004013F0</span><br><span class="line">00402A2C  |&gt;  6A 2D         push 0x2D</span><br><span class="line">00402A2E  |.  51            push ecx</span><br><span class="line">00402A2F  |.  E8 D4921100   call 吾爱破解.0051BD08</span><br></pre></td></tr></table></figure>
<p>进一步分析这几条指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">004029FC  |&gt; \C1E6 04       shl esi,0x4                              ;  从下面逆推0x20右移4位为2，所以“-”的个数为2</span><br><span class="line">004029FF  |.  83EE 02       sub esi,0x2                              ;  要使下面的edx=0x18,这里esi=0x1E+2=0x20才对</span><br><span class="line">		 ;  esi=18 66666666除以CCCCCCCD=0X1E</span><br><span class="line">00402A02  |.  B8 CDCCCCCC   mov eax,0xCCCCCCCD                       ;  eax=CCCCCCCD</span><br><span class="line">00402A07  |.  F7E6          mul esi                                  ;  edx拼接eax=esi*eax要等于00000018 66666666</span><br><span class="line">00402A09  |.  C1EA 03       shr edx,0x3                              ;  根据edx右移3位后要等于3，所以3左移3位等于0x18</span><br></pre></td></tr></table></figure>
<p>懂了，所以字符串中需要两个“-”号。输入<code>1234567-89012345-6789012</code>试试(“-”号位置任意)。</p>
<img src="/posts/bb44dc0/-.png" class="" title="输入字符串">
<p>发现注册成功。注册成功后会在目录下生成.txt，.ini文件，写入注册表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">52pojie.txt</span><br><span class="line">1234567</span><br><span class="line"></span><br><span class="line">52pojie.ini</span><br><span class="line">[验证]</span><br><span class="line">Key=89012345</span><br><span class="line"></span><br><span class="line">注册表</span><br><span class="line">6789012</span><br></pre></td></tr></table></figure>
<p>从上面的分析中已经知道.txt文件的注册码是<code>ITN3UXJGJ</code>，改了再说，这里是9个字符。这时再下断<code>GetPrivateProfileStringA</code>函数，程序就会经过这个算法。此时就可以分析算法了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">00402198  |.  FF15 1C345400 call dword ptr ds:[&lt;&amp;KERNEL32.GetPrivate&gt;; \GetPrivateProfileStringA</span><br><span class="line">0040219E  |.  5E            pop esi</span><br><span class="line">0040219F  |.  85C0          test eax,eax                             ;  ini文件的字符串长度</span><br><span class="line">004021A1  |.  74 4D         je short 吾爱破解.004021F0                   ;  字符串长度为0跳转</span><br><span class="line">004021A3  |.  8D8D F4FEFFFF lea ecx,[local.67]                       ;  ecx等于字符串</span><br><span class="line">004021A9  |.  8D51 01       lea edx,dword ptr ds:[ecx+0x1]</span><br><span class="line">004021AC  |.  8D6424 00     lea esp,dword ptr ss:[esp]</span><br><span class="line">004021B0  |&gt;  8A01          /mov al,byte ptr ds:[ecx]</span><br><span class="line">004021B2  |.  41            |inc ecx                                 ;  指针+1指向下个字符</span><br><span class="line">004021B3  |.  84C0          |test al,al</span><br><span class="line">004021B5  |.^ 75 F9         \jnz short 吾爱破解.004021B0                 ;  遍历字符串</span><br><span class="line">004021B7  |.  2BCA          sub ecx,edx                              ;  ecx存进字符串长度</span><br><span class="line">004021B9  |.  83F9 0E       cmp ecx,0xE                              ;  ini文件中字符串长度为14</span><br><span class="line">004021BC  |.  75 32         jnz short 吾爱破解.004021F0</span><br><span class="line">004021BE  |.  33C0          xor eax,eax                              ;  eax清零</span><br><span class="line">004021C0  |&gt;  0FB69405 E4FE&gt;/movzx edx,byte ptr ss:[ebp+eax-0x11C]   ;  将真正的注册码存入edx</span><br><span class="line">004021C8  |.  0FBE8C05 F4FE&gt;|movsx ecx,byte ptr ss:[ebp+eax-0x10C]   ;  将输入的字符串存入ecx</span><br><span class="line">004021D0  |.  83C2 30       |add edx,0x30                            ;  将真正的注册码+0x30</span><br><span class="line">004021D3  |.  3BD1          |cmp edx,ecx                             ;  与输入的字符串对比</span><br><span class="line">004021D5  |.  75 19         |jnz short 吾爱破解.004021F0</span><br><span class="line">004021D7  |.  40            |inc eax</span><br><span class="line">004021D8  |.  83F8 0E       |cmp eax,0xE</span><br><span class="line">004021DB  |.^ 72 E3         \jb short 吾爱破解.004021C0</span><br></pre></td></tr></table></figure>
<p>在数据窗口Ctrl+G输入<code>ebp+eax-0x11c</code>，第1行就是真正的注册码，第2行是输入的字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0012F33C  3A 1E 02 25 28 1A 48 15 3A 1D 02 25 28 1A 00 00  :%(H:%(..</span><br><span class="line">0012F34C  38 39 30 31 34 35 36 37 38 39 30 31 32 31 00 00  89014567890121..</span><br></pre></td></tr></table></figure>
<p>将真正的注册码+0x30就是我们要输入的字符串<code>jN2UXJxEjM2UXJ</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">6A 4E 32 55 58 4A 78 45 6A 4D 32 55 58 4A</span><br></pre></td></tr></table></figure>
<p>将目录下的.ini文件信息修改为以上字符串。</p>
<p>注册表部分。在反汇编窗口右键-&gt;查找-&gt;所有模块间的调用，搜索<code>RegQueryValueExA</code>函数，右键-&gt;在每个调用到<code>RegQueryValueExA</code>上设置断点。找到有比较算法那个，分析。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">00402285  |.  FF15 24305400 call dword ptr ds:[&lt;&amp;ADVAPI32.RegQueryVa&gt;; \RegQueryValueExA</span><br><span class="line">0040228B  |.  85C0          test eax,eax</span><br><span class="line">0040228D  |.  0F85 E1000000 jnz 吾爱破解.00402374</span><br><span class="line">00402293  |.  8D8D F4FEFFFF lea ecx,[local.67]                       ;  输入的字符串</span><br><span class="line">00402299  |.  8D51 01       lea edx,dword ptr ds:[ecx+0x1]</span><br><span class="line">0040229C  |.  8D6424 00     lea esp,dword ptr ss:[esp]</span><br><span class="line">004022A0  |&gt;  8A01          /mov al,byte ptr ds:[ecx]</span><br><span class="line">004022A2  |.  41            |inc ecx</span><br><span class="line">004022A3  |.  84C0          |test al,al</span><br><span class="line">004022A5  |.^ 75 F9         \jnz short 吾爱破解.004022A0                 ;  遍历字符串</span><br><span class="line">004022A7  |.  2BCA          sub ecx,edx                              ;  ecx=字符串长度=9</span><br><span class="line">004022A9  |.  83C1 06       add ecx,0x6                              ;  所以ecx=字符串长度+6=0xF</span><br><span class="line">004022AC  |.  B8 CDCCCCCC   mov eax,0xCCCCCCCD                       ;  eax=CCCCCCCD</span><br><span class="line">004022B1  |.  F7E1          mul ecx                                  ;  要使得edx拼接eax=ecx*eax=C 33333336</span><br><span class="line">004022B3  |.  C1EA 02       shr edx,0x2                              ;  edx=0x0C</span><br><span class="line">004022B6  |.  83EA 03       sub edx,0x3                              ;  edx=0x3</span><br><span class="line">004022B9  |.  0F85 B5000000 jnz 吾爱破解.00402374                        ;  退出函数，不能跳</span><br><span class="line">004022BF  |.  E8 D82D0000       call 吾爱破解.0040509C</span><br></pre></td></tr></table></figure>
<p>所以注册表的注册码是9个字符，修改修改再继续。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">004022BF  |.  E8 D82D0000       call 吾爱破解.0040509C                       ;  mov eax=lJT</span><br><span class="line">004022C4  |.  8BC8              mov ecx,eax</span><br><span class="line">004022C6  |.  85C9              test ecx,ecx</span><br><span class="line">004022C8  |.  0F84 C3000000     je 吾爱破解.00402391</span><br><span class="line">004022CE  |.  8B01              mov eax,dword ptr ds:[ecx]               ;  eax=lJT.</span><br><span class="line">004022D0  |.  FF50 0C           call dword ptr ds:[eax+0xC]              ;  eax指向地址58E5E0,也就是lJT.的下一地址</span><br><span class="line">004022D3  |.  8A95 F8FEFFFF     mov dl,byte ptr ss:[ebp-0x108]           ;  dl指向输入的字符第五个字符的地址</span><br><span class="line">004022D9  |.  8D70 10           lea esi,dword ptr ds:[eax+0x10]          ;  esi=58e5f0</span><br><span class="line">004022DC  |.  0FBE85 F4FEFFFF   movsx eax,byte ptr ss:[ebp-0x10C]        ;  eax=字符串的第1个字符</span><br><span class="line">004022E3  |.  0FBECA            movsx ecx,dl                             ;  ecx=字符串的第5个字符</span><br><span class="line">004022E6  |.  48                dec eax                                  ;  eax=eax-1</span><br><span class="line">004022E7  |.  89B5 E4FEFFFF     mov [local.71],esi                       ;  吾爱破解.0058E5F0</span><br><span class="line">004022ED  |.  3BC1              cmp eax,ecx                              ;  str[0]-1==str[4]</span><br><span class="line">004022EF  |.  75 69             jnz short 吾爱破解.0040235A                  ;  不能跳</span><br></pre></td></tr></table></figure>
<p>字符串中第1个字符要比第5个字符大1，修改修改继续。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">004022F1  |.  0FBE85 FCFEFFFF   movsx eax,byte ptr ss:[ebp-0x104]        ;  eax=输入的第9个字符</span><br><span class="line">004022F8  |.  83C1 02           add ecx,0x2</span><br><span class="line">004022FB  |.  3BC8              cmp ecx,eax                              ;  str[8]==str[4]+2</span><br><span class="line">004022FD  |.  75 5B             jnz short 吾爱破解.0040235A</span><br></pre></td></tr></table></figure>
<p>字符串中第9个字符要比第5个字符大2，修改修改继续。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">004022FF  |.  80F2 54           xor dl,0x54                              ;  dl是第5个字符</span><br><span class="line">00402302  |.  80FA 66           cmp dl,0x66                              ;  第5个字符与0x54异或要等于0x66</span><br><span class="line">00402305  |.  75 53             jnz short 吾爱破解.0040235A</span><br></pre></td></tr></table></figure>
<p>所以第5个字符是0x32(‘2’)，也可以推算出，第1个字符是’3’，第9个字符是’4’。修改修改再继续。push了3个参数，第一个参数是长度，第二个参数是”MjM”，第三个参数是字符串的第2个字符的地址。猜测这个函数是比较2-4位是否为”MjM”。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">00402307  |.  6A 03             push 0x3</span><br><span class="line">00402309  |.  8D85 F5FEFFFF     lea eax,dword ptr ss:[ebp-0x10B]         ;  eax=字符串的第2个字符地址</span><br><span class="line">0040230F  |.  68 3C465400       push 吾爱破解.0054463C                       ;  MjM</span><br><span class="line">00402314  |.  50                push eax</span><br><span class="line">00402315  |.  E8 76991100       call 吾爱破解.0051BC90</span><br><span class="line">0040231A  |.  83C4 0C           add esp,0xC</span><br><span class="line">0040231D  |.  85C0              test eax,eax</span><br><span class="line">0040231F  |.  75 39             jnz short 吾爱破解.0040235A</span><br></pre></td></tr></table></figure>
<p>修改一下试试。跳转没有实现，猜测正确。下面是一样的步骤。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">00402321  |.  6A 03             push 0x3</span><br><span class="line">00402323  |.  8D85 F9FEFFFF     lea eax,dword ptr ss:[ebp-0x107]         ;  eax=第6个字符地址</span><br><span class="line">00402329  |.  68 40465400       push 吾爱破解.00544640                       ;  UXJ</span><br><span class="line">0040232E  |.  50                push eax</span><br><span class="line">0040232F  |.  E8 5C991100       call 吾爱破解.0051BC90</span><br><span class="line">00402334  |.  83C4 0C           add esp,0xC</span><br><span class="line">00402337  |.  85C0              test eax,eax</span><br><span class="line">00402339  |.  75 1F             jnz short 吾爱破解.0040235A</span><br></pre></td></tr></table></figure>
<p>综上，注册表的注册码为<code>3MjM2UXJ4</code>。</p>
<p>完整注册码为<code>ITN3UXJGJ-jN2UXJxEjM2UXJ-3MjM2UXJ4</code>，得到彩蛋。</p>
<img src="/posts/bb44dc0/%E5%BD%A9%E8%9B%8B2.png" class="" title="彩蛋2">
<img src="/posts/bb44dc0/%E6%88%91%E6%98%AF%E5%BD%A9%E8%9B%8B.png" class="" title="彩蛋2">
<p>点击“我是彩蛋”有一连串的弹窗提示。这些弹窗语句早在我们搜索字符串的时候就已经看到了。</p>
<img src="/posts/bb44dc0/%E6%90%9C%E7%B4%A2%E5%AD%97%E7%AC%A6%E4%B8%B22.png" class="" title="搜索字符串">
<p>Key1=ITN3UXJGJ-jN2UXJxEjM2UXJ-3MjM2UXJ4</p>
<p>Key2_1=4JXU2MjM3-JXU2MjExJXU2Nj-JGJXU3NTl</p>
<p>Key2_2=3MjM2UXJ4-jN2UXJxEjM2UXJ-ITN3UXJGJ</p>
<p>Key2_3=JGJXU3NTl-JXU2MjExJXU2Nj-4JXU2MjM3</p>
<p>Key2的所有数字之和长度之间的差为4，且比长度大。所以彩蛋Key长度为12。</p>
<p>Key的倒数第二位为2，最后一位为=。Key=00000000002=</p>
<p>Key的第一位是什么呢？B，我们经常说的，NB！Key=N0000000002=</p>
<p>Key的倒数第三位是Key2的第三位？J、j、X？</p>
<p>Key的第二位为管理员名字的首字母，管理员是Hmily，所以是H，Key=NH000000002=</p>
<p>Key的第三位和第九位一样，都是第五位的小写字母。</p>
<p>好难猜啊…我看到答案是NHlkLXpdIU2=，但完全不知道怎么得来的。</p>
<h1 id="5-给程序打补丁"><a href="#5-给程序打补丁" class="headerlink" title="5. 给程序打补丁"></a>5. 给程序打补丁</h1><p>吾爱破解内存补丁生成器V1.00：做程序补丁</p>
<p>KeyMake V2.0 修改版：做内存注册机</p>
<img src="/posts/bb44dc0/%E6%B3%A8%E5%86%8C%E5%A4%B1%E8%B4%A5.png" class="" title="注册失败">
<p>拉进OD，查找敏感字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0040342B  |. /75 07         jnz short 第六课例.00403434</span><br><span class="line">0040342D  |. |68 78E15700   push 第六课例.0057E178                       ;  注册成功</span><br><span class="line">00403432  |. |EB 10         jmp short 第六课例.00403444</span><br><span class="line">00403434  |&gt; \68 84E15700   push 第六课例.0057E184                       ;  注册失败</span><br><span class="line">00403439  |.  EB 09         jmp short 第六课例.00403444</span><br><span class="line">0040343B  |&gt;  6A 00         push 0x0</span><br><span class="line">0040343D  |.  6A 00         push 0x0</span><br><span class="line">0040343F  |.  68 6CE15700   push 第六课例.0057E16C                       ;  输入为空</span><br><span class="line">00403444  |&gt;  E8 67080100   call 第六课例.00413CB0</span><br></pre></td></tr></table></figure>
<p>爆破补丁版：将地址为<code>40342B</code>的<code>jnz</code>直接修改为<code>jz</code>或<code>nop</code>即可。</p>
<p>那如果使用吾爱破解内存补丁生成器V1.00爆破要怎么操作呢？找到需要修改的地址后，打开补丁生成器，将程序拖入补丁生成器中，输入内存地址和需要修改成什么指令，添加指令，导出补丁。</p>
<img src="/posts/bb44dc0/%E8%A1%A5%E4%B8%81.png" class="" title="打补丁">
<p>关闭OD后打开补丁程序，点击“开始补丁”就会自动运行补丁程序，此时输入什么都可以注册成功了。</p>
<img src="/posts/bb44dc0/%E8%A1%A5%E4%B8%81%E6%88%90%E5%8A%9F.png" class="" title="打补丁">
<p>注册机版：向上划到段首下断运行，F8单步到此处。寄存器窗口和堆栈窗口都可看到真正的注册码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">00403400  |&gt; /8A10          /mov dl,byte ptr ds:[eax]                ;  eax指向真正的注册码</span><br><span class="line">00403402  |. |3A11          |cmp dl,byte ptr ds:[ecx]                ;  ecx指向输入的注册码</span><br><span class="line">00403404  |. |75 1A         |jnz short 第六课例.00403420</span><br><span class="line">00403406  |. |84D2          |test dl,dl</span><br><span class="line">00403408  |. |74 12         |je short 第六课例.0040341C</span><br><span class="line">0040340A  |. |8A50 01       |mov dl,byte ptr ds:[eax+0x1]</span><br><span class="line">0040340D  |. |3A51 01       |cmp dl,byte ptr ds:[ecx+0x1]</span><br><span class="line">00403410  |. |75 0E         |jnz short 第六课例.00403420</span><br><span class="line">00403412  |. |83C0 02       |add eax,0x2</span><br><span class="line">00403415  |. |83C1 02       |add ecx,0x2</span><br><span class="line">00403418  |. |84D2          |test dl,dl</span><br><span class="line">0040341A  |.^\75 E4         \jnz short 第六课例.00403400</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0012F6EC   186B4420</span><br><span class="line">0012F6F0   00000111</span><br><span class="line">0012F6F4   00000000</span><br><span class="line">0012F6F8   00194078  ASCII &quot;202CB962AC59075B964B07152D234B70&quot;</span><br><span class="line">0012F6FC   00194078  ASCII &quot;202CB962AC59075B964B07152D234B70&quot;</span><br><span class="line">0012F700   00192828  ASCII &quot;852&quot;</span><br><span class="line">0012F704   001927B8  ASCII &quot;123&quot;</span><br></pre></td></tr></table></figure>
<p>记下运行到<code>403400</code>，真正的注册码存在了寄存器窗口的eax的值(注册码字符串的首地址)里。</p>
<p>打开Keymake，其它-&gt;内存注册机，将需要制作注册机的程序加载进来，添加。编辑信息-&gt;添加-&gt;生成。</p>
<img src="/posts/bb44dc0/%E6%B3%A8%E5%86%8C%E6%9C%BA.png" class="" title="注册机">
<p>运行注册机，发现需要两个框都填了才能给注册码，否则提示“输入为空”。为了美观，也可将<code>004033A7</code>的跳转指令nop掉。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">00403384  |.  50            push eax                                 ;  将用户名入栈</span><br><span class="line">00403385  |.  8D8F 30010000 lea ecx,dword ptr ds:[edi+0x130]</span><br><span class="line">0040338B  |.  E8 12630100   call 第六课例.004196A2</span><br><span class="line">00403390  |.  8B45 EC       mov eax,[local.5]                        ;  eax=用户名</span><br><span class="line">00403393  |.  83CF FF       or edi,-0x1</span><br><span class="line">00403396  |.  8378 F4 00    cmp dword ptr ds:[eax-0xC],0x0</span><br><span class="line">0040339A  |.  0F84 9B000000 je 第六课例.0040343B                         ;  用户名为空跳转</span><br><span class="line">004033A0  |.  8B45 E8       mov eax,[local.6]</span><br><span class="line">004033A3  |.  8378 F4 00    cmp dword ptr ds:[eax-0xC],0x0</span><br><span class="line">004033A7  |.  0F84 8E000000 je 第六课例.0040343B                         ;  注册码为空跳转</span><br></pre></td></tr></table></figure>
<p>nop掉后再生成注册机。虽然不会提示“输入为空”，但也会提示“注册失败”字样，暂时没有什么好的办法，就这样吧。(提示“输入为空”比“注册失败”要好，还是别改了吧)</p>
<img src="/posts/bb44dc0/%E6%B3%A8%E5%86%8C%E7%A0%812.png" class="" title="注册码">
<p>也可以用Keymake制作内存补丁，<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1cw411Z7Ab?p=22">Shark恒 制作内存补丁</a> 。</p>
<h1 id="6-打补丁作业"><a href="#6-打补丁作业" class="headerlink" title="6. 打补丁作业"></a>6. 打补丁作业</h1><p>程序加了VMProtect壳。VMProtect 是软件保护系统，将保护后的代码放到虚拟机中运行，这将使分析反编译后的代码和破解变得极为困难。这个我目前还不会手脱，那就在有壳的基础上修改吧。</p>
<p>F9运行程序跑起来，进入OD的<code>E</code>模块，双击进入程序代码块(.exe)。取消分析，智能搜索发现字符串都能看到了。搜索敏感字符串进入反汇编代码，还是熟悉的位置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0040346B   /75 07           jnz short 吾爱破解.00403474</span><br><span class="line">0040346D   |68 80E15700     push 吾爱破解.0057E180                       ; 注册成功</span><br><span class="line">00403472   |EB 10           jmp short 吾爱破解.00403484</span><br><span class="line">00403474   \68 8CE15700     push 吾爱破解.0057E18C                       ; 注册失败</span><br><span class="line">00403479    EB 09           jmp short 吾爱破解.00403484</span><br><span class="line">0040347B    6A 00           push 0x0</span><br><span class="line">0040347D    6A 00           push 0x0</span><br><span class="line">0040347F    68 6CE15700     push 吾爱破解.0057E16C                       ; 输入为空</span><br><span class="line">00403484    E8 78080100     call 吾爱破解.00413D01</span><br></pre></td></tr></table></figure>
<p>爆破补丁版：</p>
<p>但发现这样nop后保存文件会提示“无法定位数据”。</p>
<img src="/posts/bb44dc0/%E6%97%A0%E6%B3%95%E5%AE%9A%E4%BD%8D%E6%95%B0%E6%8D%AE.png" class="" title="无法定位数据">
<p>这时就需要吾爱破解内存补丁生成器V1.00了。<code>jnz</code>的机器码为0x75，<code>je</code>指令为0x74，<code>nop</code>的机器码为0x90。关闭OD再运行补丁。</p>
<p>注册机版：</p>
<p>由于程序有壳，无法重新载入，但还是可以在这个函数中一步步运行程序到算法处，按照5的方法生成注册机即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">00403440  |&gt;  8A10          /mov dl,byte ptr ds:[eax];真正注册码</span><br><span class="line">00403442  |. |3A11          |cmp dl,byte ptr ds:[ecx];输入的字符串</span><br><span class="line">00403444  |. |75 1A         |jnz short 吾爱破解.00403460</span><br><span class="line">00403446  |. |84D2          |test dl,dl</span><br><span class="line">00403448  |. |74 12         |je short 吾爱破解.0040345C</span><br><span class="line">0040344A  |. |8A50 01       |mov dl,byte ptr ds:[eax+0x1]</span><br><span class="line">0040344D  |. |3A51 01       |cmp dl,byte ptr ds:[ecx+0x1]</span><br><span class="line">00403450  |. |75 0E         |jnz short 吾爱破解.00403460</span><br><span class="line">00403452  |. |83C0 02       |add eax,0x2</span><br><span class="line">00403455  |. |83C1 02       |add ecx,0x2</span><br><span class="line">00403458  |. |84D2          |test dl,dl</span><br><span class="line">0040345A  |.^\75 E4         \jnz short 吾爱破解.00403440</span><br></pre></td></tr></table></figure>
<p>分析算法：</p>
<p>在段首下断，输入用户名和注册码后运行，程序停在断点处。F8一步步跟，分析每一步程序做了什么。执行完<code>4033BF</code>地址的指令后，可以看到堆栈窗口中用户名和“123456”拼接在一起。</p>
<img src="/posts/bb44dc0/%E8%BF%9E%E6%8E%A5%E5%AD%97%E7%AC%A6%E4%B8%B2.png" class="" title="连接字符串">
<p>执行完<code>4033FE</code>地址的指令后，堆栈窗口出现真正的注册码。</p>
<img src="/posts/bb44dc0/%E7%94%9F%E6%88%90%E6%B3%A8%E5%86%8C%E7%A0%81.png" class="" title="真正的注册码">
<p>那我们进去看看它是怎么生成的。看到这一大段就应该意识到这是MD5的初始化处理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">00401B55    C745 D8 0000000&gt;mov dword ptr ss:[ebp-0x28],0x0</span><br><span class="line">00401B5C    C745 D4 0000000&gt;mov dword ptr ss:[ebp-0x2C],0x0</span><br><span class="line">00401B63    C745 DC 0123456&gt;mov dword ptr ss:[ebp-0x24],0x67452301</span><br><span class="line">00401B6A    C745 E0 89ABCDE&gt;mov dword ptr ss:[ebp-0x20],0xEFCDAB89</span><br><span class="line">00401B71    C745 E4 FEDCBA9&gt;mov dword ptr ss:[ebp-0x1C],0x98BADCFE</span><br><span class="line">00401B78    C745 E8 7654321&gt;mov dword ptr ss:[ebp-0x18],0x10325476</span><br><span class="line">00401B7F    C645 FC 02      mov byte ptr ss:[ebp-0x4],0x2</span><br><span class="line">00401B83    8B45 08         mov eax,dword ptr ss:[ebp+0x8]</span><br><span class="line">00401B86    8B70 F4         mov esi,dword ptr ds:[eax-0xC]</span><br></pre></td></tr></table></figure>
<p>传入的参数是用户名和“123456”拼接，所以密码是MD5(用户名+”123456”)。</p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="v5le0n9 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpg" alt="v5le0n9 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/OllyDbg/" rel="tag"><i class="fa fa-tag"></i> OllyDbg</a>
              <a href="/tags/%E5%90%BE%E7%88%B1%E7%A0%B4%E8%A7%A3%E5%9F%B9%E8%AE%AD/" rel="tag"><i class="fa fa-tag"></i> 吾爱破解培训</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/7cd35487.html" rel="prev" title="第二三课——去弹窗、主页锁定及DIY">
      <i class="fa fa-chevron-left"></i> 第二三课——去弹窗、主页锁定及DIY
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/4b9d65e0.html" rel="next" title="第八九课——深入浅出探讨脱壳细节">
      第八九课——深入浅出探讨脱壳细节 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E8%AF%BE%E5%89%8D%E9%A2%84%E4%B9%A0"><span class="nav-text">1. 课前预习</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E9%87%8D%E5%90%AF%E9%AA%8C%E8%AF%81"><span class="nav-text">2. 重启验证</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E9%87%8D%E5%90%AF%E9%AA%8C%E8%AF%81%E7%A4%BA%E4%BE%8B"><span class="nav-text">3. 重启验证示例</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E9%87%8D%E5%90%AF%E9%AA%8C%E8%AF%81%E4%BD%9C%E4%B8%9A"><span class="nav-text">4. 重启验证作业</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-%E7%BB%99%E7%A8%8B%E5%BA%8F%E6%89%93%E8%A1%A5%E4%B8%81"><span class="nav-text">5. 给程序打补丁</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-%E6%89%93%E8%A1%A5%E4%B8%81%E4%BD%9C%E4%B8%9A"><span class="nav-text">6. 打补丁作业</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="v5le0n9"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">v5le0n9</p>
  <div class="site-description" itemprop="description">小呀小二郎呀背着个书包上学堂</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">64</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/Leong_Vinson" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;Leong_Vinson" rel="noopener" target="_blank"><i class="fab fa-cuttlefish fa-fw"></i>CSDN</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/v5le0n9" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;v5le0n9" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:v5le0n9@163.com" title="E-Mail → mailto:v5le0n9@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      友链
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.zz1syyd.com/" title="https:&#x2F;&#x2F;www.zz1syyd.com&#x2F;" rel="noopener" target="_blank">zz1syyd</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://one-null-pointer.github.io/" title="https:&#x2F;&#x2F;one-null-pointer.github.io&#x2F;" rel="noopener" target="_blank">liaoyue</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">v5le0n9</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.2m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">18:26</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '7c58e80079a2457b610d',
      clientSecret: 'fc16b1b0fdfb278016ebe41c20f3743c3c927466',
      repo        : 'comments.github.io',
      owner       : 'v5le0n9',
      admin       : ['v5le0n9'],
      id          : '9cb29e370669b2f29a8e764123fdd141',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
